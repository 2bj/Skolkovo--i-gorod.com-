<?php
define("UPDATE_SERVER",       base64_decode('aHR0cDovL3VwZGF0ZXMudW1pLWNtcy5ydS9zbXVzL3NlcnZlci5waHA='));define("LOCAL_PACKAGE_STORE", dirname(__FILE__).'/packages/');define("UPDATE_TEMP_STORE",   dirname(__FILE__).'/install-temp/');define("PROCESS_SAVE_FILE",   dirname(__FILE__).'/uprocess.ssd');define("CONFIGURATION_FILE",  dirname(__FILE__).'/configuration.xml');function __dbg($_message) {}class SMUException extends Exception {const ERR_NOTAUTHORIZED = 1001;const MSG_NOTAUTHORIZED = "Not authorized";const ERR_NOSTEPDEFINED = 1101;const MSG_NOSTEPDEFINED = "No step defined";const ERR_CANTWRITEPACKAGEFILE = 1102;const MSG_CANTWRITEPACKAGEFILE = "Cant write package file";const ERR_WRONGRESPONSE     = 1201;const MSG_WRONGRESPONSE     = "Wrong response";const ERR_INCORRECTTRANSFER = 1202;const MSG_INCORRECTTRANSFER = "Incorrect transfer";const ERR_UNKNOWN       = 1999;const MSG_UNKNOWN       = "Unknown error";protected $type = "";public function __construct($_message = "", $_code = "", $_type = "exception") {parent::__construct($_message, $_code);$this->type = $_type;}public function getType() {return $this->type;}public function setType($_type) {$this->type = $_type;}};class SMUCore {private $configuration = null;private $stepState     = null;public function __construct() {if(!file_exists(CONFIGURATION_FILE)) {$this->writeConfiguration();}if(!is_dir(LOCAL_PACKAGE_STORE)) {mkdir(LOCAL_PACKAGE_STORE);}$this->configuration = new umiSimpleXML( file_get_contents(CONFIGURATION_FILE) );$this->loadStepState();}public function __destruct() {$this->saveStepState();}public function doUpdate() {try {$v7aa28ed115707345d0274032757e8991 = true;$v2764ca9d34e90313978d044f27ae433b   = $this->getStepInstance();$result = $v2764ca9d34e90313978d044f27ae433b->run($this->configuration, $this->stepState['parameters'], $v7aa28ed115707345d0274032757e8991);$this->stepState['sid'] = $v2764ca9d34e90313978d044f27ae433b->getSID();$v0f635d0e0f3874fff8b581c132e6c7a7    = new xmlTranslator();$result = $v0f635d0e0f3874fff8b581c132e6c7a7->translateToXml($result);echo substr($result, strpos($result, '?>')+2);if(!$v7aa28ed115707345d0274032757e8991) {$this->getNextStep();}}catch(Exception $ve1671797c52e15f763380b45e841ec32) {if($ve1671797c52e15f763380b45e841ec32->getCode() == 202) {$this->stepState = null;}if($ve1671797c52e15f763380b45e841ec32 instanceof SMUException) {$v599dcce2998a6b40b1e38e8c6006cb0a  = $ve1671797c52e15f763380b45e841ec32->getType();$v04a75036e9d520bb983c5ed03b8d0182 = '';}else {$v599dcce2998a6b40b1e38e8c6006cb0a  = 'exception';$v04a75036e9d520bb983c5ed03b8d0182 = "\n\t\t<trace>" . $ve1671797c52e15f763380b45e841ec32->getTraceAsString() . "</trace>\n";}echo <<<XML
<response type="{$v599dcce2998a6b40b1e38e8c6006cb0a}">
	<error code="{$ve1671797c52e15f763380b45e841ec32->getCode()}">{$ve1671797c52e15f763380b45e841ec32->getMessage()}{$v04a75036e9d520bb983c5ed03b8d0182}</error>
</response>
XML;   return false;}return true;}private function writeConfiguration() {$vb1444fb0c07653567ad325aa25d4e37a = regedit::getInstance();$v0eb9b3af2e4a00837a1b1a854c9ea18c = $vb1444fb0c07653567ad325aa25d4e37a->getList("//modules");$v0eb9b3af2e4a00837a1b1a854c9ea18c = array_map(create_function("\$a", "return \"\t\t\t<module>\".\$a[0].\"</module>\";"), $v0eb9b3af2e4a00837a1b1a854c9ea18c);$v0eb9b3af2e4a00837a1b1a854c9ea18c = implode("\r\n",$v0eb9b3af2e4a00837a1b1a854c9ea18c);$v0f635d0e0f3874fff8b581c132e6c7a7     = "<"."?xml version=\"1.0\" encoding=\"utf-8\" ?".">\n" . <<<XML
<configuration>
	<systeminfo>
		<domainkey></domainkey>
		<version>{$vb1444fb0c07653567ad325aa25d4e37a->getVal('//modules/autoupdate/system_version')}</version>
		<build>{$vb1444fb0c07653567ad325aa25d4e37a->getVal('//modules/autoupdate/system_build')}</build>
		<line>pro</line>		
		<edition>{$vb1444fb0c07653567ad325aa25d4e37a->getVal('//modules/autoupdate/system_edition')}</edition>		
		<modules>
{$v0eb9b3af2e4a00837a1b1a854c9ea18c}			
		</modules>
	</systeminfo>	
</configuration>
XML;  file_put_contents(CONFIGURATION_FILE, $v0f635d0e0f3874fff8b581c132e6c7a7);}private function loadStepState() {if(file_exists(PROCESS_SAVE_FILE)) {$vbdd166af3a63f7be696dd17a218a6ffb = file_get_contents(PROCESS_SAVE_FILE);if($vbdd166af3a63f7be696dd17a218a6ffb !== false) {$this->stepState = unserialize($vbdd166af3a63f7be696dd17a218a6ffb);}}if(!is_array($this->stepState)) $this->stepState = array('step' => 'init', 'sid' => '', 'parameters' => array());return $this->stepState;}private function saveStepState() {if($this->stepState['step'] != 'done') {$vbdd166af3a63f7be696dd17a218a6ffb = serialize($this->stepState);file_put_contents(PROCESS_SAVE_FILE, $vbdd166af3a63f7be696dd17a218a6ffb);}}private function getStepInstance() {if(isset($_GET['cancel']) &&            !($this->stepState['step'] == 'cleanup' || $this->stepState['step'] == 'finalize')) {$this->stepState['parameters']['cancel'] = true;$this->stepState['step']   = 'cleanup';}switch($this->stepState['step']) {case 'init'     : return new InitStep($this->stepState['sid']);case 'download'   : return new DownloadPackageStep($this->stepState['sid']);case 'unpack'   : return new UnpackStep($this->stepState['sid']);case 'install'   : return new InstallUpdateStep($this->stepState['sid']);case 'cleanup'   : return new ClearTemporaryFiles($this->stepState['sid']);case 'finalize'   : return new FinalizeUpdateStep($this->stepState['sid']);default         : throw new SMUException(SMUException::MSG_NOSTEPDEFINED, SMUException::ERR_NOSTEPDEFINED);return null;}}private function getNextStep() {switch($this->stepState['step']) {case 'init'   : $this->stepState['step'] = 'download';break;case 'download' : $this->stepState['step'] = 'unpack';break;case 'unpack'  : $this->stepState['step'] = 'install';break;case 'install'  : $this->stepState['step'] = 'cleanup';break;case 'cleanup'  : $this->stepState['step'] = 'finalize';break;case 'finalize' : $this->stepState['step'] = 'done';break;}return $this->stepState['step'];}};interface IUpdateStep {public function run($_Configuration, &$v166e64f6c3677d0c513901242a3e702d, &$v7aa28ed115707345d0274032757e8991);public function getSID();};abstract class UpdateStep implements IUpdateStep {protected $sid = "";public function __construct($_sid = "") {$this->sid = $_sid;}public function getSID() {return $this->sid;}};class InitStep extends UpdateStep {public function run($_Configuration, &$v166e64f6c3677d0c513901242a3e702d, &$v7aa28ed115707345d0274032757e8991) {$this->checkUpdatePossibility();$vcaf9b6b99962bf5c2264824231d7a40c = $_Configuration->systeminfo;$v9d6e24ec78d309695833f4c9f8310d7a = ($vfa816edb83e95bf0c8da580bdfd491ef = domainsCollection::getInstance()->getDefaultDomain()) ? $vfa816edb83e95bf0c8da580bdfd491ef->getHost() : '';$v8d777f385d3dfec8815d20f7496026dc = array(      'attribute:type'    => 'update-init',      'nodes:system-info' => array(array(               'nodes:version' => array(array('attribute:version' => $vcaf9b6b99962bf5c2264824231d7a40c->version->value(),                          'attribute:build'   => $vcaf9b6b99962bf5c2264824231d7a40c->build->value())),               'nodes:last-update-time' => array(array('node:name' => regedit::getInstance()->getVal('//modules/autoupdate/last_updated'))),               'nodes:license' => array(array('attribute:edition' => $vcaf9b6b99962bf5c2264824231d7a40c->edition->value(),                          'attribute:key'     => regedit::getInstance()->getVal('//settings/keycode'),                          'attribute:domain'  => $v9d6e24ec78d309695833f4c9f8310d7a)),               'nodes:server' => array(array('attribute:domain' => $_SERVER['SERVER_NAME'],                         'attribute:ip'   => $_SERVER['SERVER_ADDR'],                         'nodes:os'     => array(array('node:name' => php_uname())),                         'nodes:web-server' => array(array('node:name' => $_SERVER['SERVER_SOFTWARE'])),                         'nodes:db-driver'  => array(array('node:name' => $this->getDriverString()))                         )),               'nodes:modules' => array(array('nodes:module'=>array()))                ))      );foreach($vcaf9b6b99962bf5c2264824231d7a40c->modules->module as $v52a43e48ec4649dee819dadabcab1bde) {$v8d777f385d3dfec8815d20f7496026dc['nodes:system-info'][0]['nodes:modules'][0]['nodes:module'][] = array('node:name' => $v52a43e48ec4649dee819dadabcab1bde);}$v0f635d0e0f3874fff8b581c132e6c7a7 = new xmlTranslator('request');$v58309fbfe87fa90ec9f4b9d78ead9d77 = $v0f635d0e0f3874fff8b581c132e6c7a7->translateToXml($v8d777f385d3dfec8815d20f7496026dc);$v10573b873d2fa5a365d558a45e328e47   = getServerRequest();$v10573b873d2fa5a365d558a45e328e47->addPostVariable('rdata', $v58309fbfe87fa90ec9f4b9d78ead9d77);$result    = $v10573b873d2fa5a365d558a45e328e47->execute(UPDATE_SERVER);$v1d00577841aee16183d6b04693e786c8 = new umiSimpleXML($result);if($v1d00577841aee16183d6b04693e786c8->name() != 'response') {throw new SMUException(SMUException::MSG_WRONGRESPONSE, SMUException::ERR_WRONGRESPONSE, "update-init");}$this->sid = $v1d00577841aee16183d6b04693e786c8->attribute('smu_sid');if(!$v1d00577841aee16183d6b04693e786c8->package) {$v71a864829b5022c4a59d402f3e3f7960 = SMUException::MSG_UNKNOWN;$v0279985cdca9ad2836b5dc949af215c8    = SMUException::ERR_UNKNOWN;if($v1d00577841aee16183d6b04693e786c8->error) {$vcb5e100e5a9a3e7f6d1fd97512215282 = is_array( $vfa816edb83e95bf0c8da580bdfd491ef = $v1d00577841aee16183d6b04693e786c8->error ) ? $vfa816edb83e95bf0c8da580bdfd491ef[0] : $vfa816edb83e95bf0c8da580bdfd491ef;$v71a864829b5022c4a59d402f3e3f7960 = (string)$vcb5e100e5a9a3e7f6d1fd97512215282->value();$v0279985cdca9ad2836b5dc949af215c8    = $vcb5e100e5a9a3e7f6d1fd97512215282->attribute('code');}$v166e64f6c3677d0c513901242a3e702d['last-error']   = $v71a864829b5022c4a59d402f3e3f7960;$v166e64f6c3677d0c513901242a3e702d['last-error-code']  = $v0279985cdca9ad2836b5dc949af215c8;throw new SMUException($v71a864829b5022c4a59d402f3e3f7960, $v0279985cdca9ad2836b5dc949af215c8, $v1d00577841aee16183d6b04693e786c8->attribute("type"));}else {$v7aa28ed115707345d0274032757e8991 = false;}return $result;}private function getDriverString() {if(defined('DB_DRIVER')) {switch(DB_DRIVER) {case 'xml' : return 'xml';default    : return 'default MySQL';}}else {return 'default MySQL';}}private function checkUpdatePossibility() {session_start();$v8e44f0089b076e18a718eb9ca3d94674 = isset($_SESSION['user_id']) ? $_SESSION['user_id'] : null;if($v8e44f0089b076e18a718eb9ca3d94674 != 14 && !$this->checkServer()) {throw new SMUException(SMUException::MSG_NOTAUTHORIZED, SMUException::ERR_NOTAUTHORIZED, "update-init");}return true;}private function checkServer() {$ve5cefdd861d187435e8eaad7930be3d2 = array(base64_decode('dWRvZC51bWlob3N0LnJ1'), base64_decode('ZHlhdGVsLnVtaWhvc3QucnU='), base64_decode('dW1paG9zdC5ydQ=='));$v616db828ac0b2892610654c134ddd4ee    = $_SERVER['REMOTE_ADDR'];foreach($ve5cefdd861d187435e8eaad7930be3d2 as $vcf1e8c14e54505f60aa10ceb8d5d8ab3) {if($v616db828ac0b2892610654c134ddd4ee == gethostbyname($vcf1e8c14e54505f60aa10ceb8d5d8ab3)) {return true;}}return false;}};class DownloadPackageStep extends UpdateStep {public function run($_Configuration, &$v166e64f6c3677d0c513901242a3e702d, &$v7aa28ed115707345d0274032757e8991) {$result = null;if(!isset($v166e64f6c3677d0c513901242a3e702d['version'])) {if(!isset($_REQUEST['package_version'])) {$ve37f0136aa3ffaf149b351f6a4c948e9     = new InitStep($this->getSID());$result   = $ve37f0136aa3ffaf149b351f6a4c948e9->run($_Configuration, $v166e64f6c3677d0c513901242a3e702d, $v7aa28ed115707345d0274032757e8991);$v7aa28ed115707345d0274032757e8991 = true;return $result;}$v166e64f6c3677d0c513901242a3e702d['version'] = $_REQUEST['package_version'];}$v2af72f100c356273d46284f6fd1dfc08   = $v166e64f6c3677d0c513901242a3e702d['version'];$v58309fbfe87fa90ec9f4b9d78ead9d77 = "<?xml version=\"1.0\" encoding=\"utf-8\"?><request type=\"update-download\" smu_sid=\"".$this->sid."\"><require version=\"".$v2af72f100c356273d46284f6fd1dfc08."\" /></request>";$v10573b873d2fa5a365d558a45e328e47   = getServerRequest();$v10573b873d2fa5a365d558a45e328e47->addPostVariable('smu_sid', $this->sid);$v10573b873d2fa5a365d558a45e328e47->addPostVariable('rdata', $v58309fbfe87fa90ec9f4b9d78ead9d77);$result    = $v10573b873d2fa5a365d558a45e328e47->execute(UPDATE_SERVER."?smu_sid=".$this->sid);$v1d00577841aee16183d6b04693e786c8 = new umiSimpleXML($result);if($v84a0f3455dcca894ace136be62efa292 = $v1d00577841aee16183d6b04693e786c8->xpath("binary-transfer")) {$vb068931cc450442b63f5b3d276ea4297  = $v84a0f3455dcca894ace136be62efa292->name;$v37b19816109a32106d109e83bbb3c97d = $v84a0f3455dcca894ace136be62efa292->range;$vf7bd60b75b29d79b660a2859395c1a24  = $v84a0f3455dcca894ace136be62efa292->size;$v8d777f385d3dfec8815d20f7496026dc  = $v84a0f3455dcca894ace136be62efa292->data;if(!($vb068931cc450442b63f5b3d276ea4297 && $v37b19816109a32106d109e83bbb3c97d && $v8d777f385d3dfec8815d20f7496026dc)) {$v71a864829b5022c4a59d402f3e3f7960 = SMUException::MSG_INCORRECTTRANSFER;$v0279985cdca9ad2836b5dc949af215c8    = SMUException::ERR_INCORRECTTRANSFER;$v166e64f6c3677d0c513901242a3e702d['last-error']   = $v71a864829b5022c4a59d402f3e3f7960;$v166e64f6c3677d0c513901242a3e702d['last-error-code']  = $v0279985cdca9ad2836b5dc949af215c8;throw new SMUException($v71a864829b5022c4a59d402f3e3f7960, $v0279985cdca9ad2836b5dc949af215c8, $v1d00577841aee16183d6b04693e786c8->attribute("type"));}$v435ed7e9f07f740abf511a62c00eef6e = LOCAL_PACKAGE_STORE . $vb068931cc450442b63f5b3d276ea4297->value();$vea2b2676c28c0db26d39331a336c6b92    = (int) $v37b19816109a32106d109e83bbb3c97d->attribute('start');$v2fa47f7c65fec19cc163b195725e3844   = (int) $v37b19816109a32106d109e83bbb3c97d->attribute('size');try{$this->WriteFilePiece($v435ed7e9f07f740abf511a62c00eef6e, base64_decode($v8d777f385d3dfec8815d20f7496026dc->value()), $vea2b2676c28c0db26d39331a336c6b92, $v2fa47f7c65fec19cc163b195725e3844);}catch(Exception $ve1671797c52e15f763380b45e841ec32) {$v71a864829b5022c4a59d402f3e3f7960 = SMUException::MSG_CANTWRITEPACKAGEFILE;$v0279985cdca9ad2836b5dc949af215c8    = SMUException::ERR_CANTWRITEPACKAGEFILE;$v166e64f6c3677d0c513901242a3e702d['last-error']   = $v71a864829b5022c4a59d402f3e3f7960;$v166e64f6c3677d0c513901242a3e702d['last-error-code']  = $v0279985cdca9ad2836b5dc949af215c8;throw $ve1671797c52e15f763380b45e841ec32;}if(!isset($v166e64f6c3677d0c513901242a3e702d['recieved-bytes'])) {$v166e64f6c3677d0c513901242a3e702d['recieved-bytes'] = $v2fa47f7c65fec19cc163b195725e3844;}else {$v166e64f6c3677d0c513901242a3e702d['recieved-bytes']+= $v2fa47f7c65fec19cc163b195725e3844;}$v166e64f6c3677d0c513901242a3e702d['filename'] = $vb068931cc450442b63f5b3d276ea4297->value();$result = array('attribute:type'=>'update-download', 'nodes:downloaded'=>array(array('attribute:total'=>$vf7bd60b75b29d79b660a2859395c1a24->value(),'attribute:recieved'=>$v166e64f6c3677d0c513901242a3e702d['recieved-bytes'])));if($v166e64f6c3677d0c513901242a3e702d['recieved-bytes'] >= $vf7bd60b75b29d79b660a2859395c1a24->value() || $v37b19816109a32106d109e83bbb3c97d->attribute("complete") == "1") {$v7aa28ed115707345d0274032757e8991 = false;$result['nodes:downloaded'][0]['attribute:status'] = "complete";}}else if($v1d00577841aee16183d6b04693e786c8->retry) {$result = array('nodes:wait'=>array(array('attribute:timeout'=>$v165e6d21e0a2cc9ebb32ca05f90e0fa7->item(0)->attributes->getNamedItem('timeout')->nodeValue)));}else {$v71a864829b5022c4a59d402f3e3f7960 = SMUException::MSG_UNKNOWN;$v0279985cdca9ad2836b5dc949af215c8    = SMUException::ERR_UNKNOWN;if($v1d00577841aee16183d6b04693e786c8->error) {$vcb5e100e5a9a3e7f6d1fd97512215282 = is_array( $vfa816edb83e95bf0c8da580bdfd491ef = $v1d00577841aee16183d6b04693e786c8->error ) ? $vfa816edb83e95bf0c8da580bdfd491ef[0] : $vfa816edb83e95bf0c8da580bdfd491ef;$v71a864829b5022c4a59d402f3e3f7960 = (string)$vcb5e100e5a9a3e7f6d1fd97512215282->value();$v0279985cdca9ad2836b5dc949af215c8    = $vcb5e100e5a9a3e7f6d1fd97512215282->attribute('code');}$v166e64f6c3677d0c513901242a3e702d['last-error']   = $v71a864829b5022c4a59d402f3e3f7960;$v166e64f6c3677d0c513901242a3e702d['last-error-code']  = $v0279985cdca9ad2836b5dc949af215c8;throw new SMUException($v71a864829b5022c4a59d402f3e3f7960, $v0279985cdca9ad2836b5dc949af215c8, $v1d00577841aee16183d6b04693e786c8->attribute("type"));}return $result;}private function WriteFilePiece($vb068931cc450442b63f5b3d276ea4297, $v8d777f385d3dfec8815d20f7496026dc, $vea2b2676c28c0db26d39331a336c6b92, $v2fa47f7c65fec19cc163b195725e3844) {if(($ve1260894f59eeae98c8440899de4df8d = @fopen($vb068931cc450442b63f5b3d276ea4297, "a")) === false)  throw new SMUException("Can not open update package file", SMUException::ERR_CANTWRITEPACKAGEFILE, "update-download");if(fseek($ve1260894f59eeae98c8440899de4df8d, $vea2b2676c28c0db26d39331a336c6b92) != 0)      throw new SMUException("Can not seek {$vea2b2676c28c0db26d39331a336c6b92} bytes from the begining of the update package file", SMUException::ERR_CANTWRITEPACKAGEFILE, "update-download");if(fwrite($ve1260894f59eeae98c8440899de4df8d, $v8d777f385d3dfec8815d20f7496026dc, $v2fa47f7c65fec19cc163b195725e3844) != $v2fa47f7c65fec19cc163b195725e3844)  throw new SMUException("Can not write {$v2fa47f7c65fec19cc163b195725e3844} bytes to the update package file", SMUException::ERR_CANTWRITEPACKAGEFILE, "update-download");if(!fclose($ve1260894f59eeae98c8440899de4df8d))        throw new SMUException("Can not close update package file", SMUException::ERR_CANTWRITEPACKAGEFILE, "update-download");}};class UnpackStep extends UpdateStep {public function run($_Configuration, &$v166e64f6c3677d0c513901242a3e702d, &$v7aa28ed115707345d0274032757e8991) {if(!isset($v166e64f6c3677d0c513901242a3e702d['check_done']))   $v166e64f6c3677d0c513901242a3e702d['check_done']  = false;if(!isset($v166e64f6c3677d0c513901242a3e702d['check_result'])) $v166e64f6c3677d0c513901242a3e702d['check_result'] = true;if(!isset($v166e64f6c3677d0c513901242a3e702d['check_repeat'])) $v166e64f6c3677d0c513901242a3e702d['check_repeat'] = 0;if(isset($_REQUEST['recheck'])) {$v166e64f6c3677d0c513901242a3e702d['check_repeat']++;$v166e64f6c3677d0c513901242a3e702d['check_result'] = true;$v166e64f6c3677d0c513901242a3e702d['check_done'] = false;}else if($v166e64f6c3677d0c513901242a3e702d['check_result']&&$v166e64f6c3677d0c513901242a3e702d['check_done']) {$v7aa28ed115707345d0274032757e8991 = false;return "<?xml version=\"1.0\" encoding=\"utf-8\"?><response type=\"check-poll-response\" smu_sid=\"".$this->sid."\"><checking result=\"success\"></checking></response>";}$v435ed7e9f07f740abf511a62c00eef6e = LOCAL_PACKAGE_STORE . $v166e64f6c3677d0c513901242a3e702d['filename'];$v9bcf0edc75944b260de8279d7a6d8174  = new packageChecker($v435ed7e9f07f740abf511a62c00eef6e, dirname(__FILE__) . "/..");$result   = 'progress';$v9acb44549b41563697bb490144ec6258   = array('check_repeat' => $v166e64f6c3677d0c513901242a3e702d['check_repeat'], 'result' => isset($v166e64f6c3677d0c513901242a3e702d['check_result']) ? $v166e64f6c3677d0c513901242a3e702d['check_result'] : true);if($v9bcf0edc75944b260de8279d7a6d8174->check($v9acb44549b41563697bb490144ec6258)) {if($v9acb44549b41563697bb490144ec6258['result'] == true) {$result   = 'success';}else {$result   = 'fail';}$v166e64f6c3677d0c513901242a3e702d['check_done'] = true;}$v166e64f6c3677d0c513901242a3e702d['check_result'] = $v9acb44549b41563697bb490144ec6258['result'];return "<?xml version=\"1.0\" encoding=\"utf-8\"?><response type=\"check-poll-response\" smu_sid=\"".$this->sid."\"><checking result=\"{$result}\">".$this->prepareFileList($v9acb44549b41563697bb490144ec6258['errors'])."</checking></response>";}private function prepareFileList($v07213a0161f52846ab198be103b5ab43) {$result = "";if(!empty($v07213a0161f52846ab198be103b5ab43['folders']))  $result .= "<folder>" . implode("</folder><folder>", $v07213a0161f52846ab198be103b5ab43["folders"]) . "</folder>";if(!empty($v07213a0161f52846ab198be103b5ab43['files']))  $result .= "<file>"   . implode("</file><file>", $v07213a0161f52846ab198be103b5ab43["files"]) . "</file>";return $result;}};class InstallUpdateStep extends UpdateStep {public function run($_Configuration, &$v166e64f6c3677d0c513901242a3e702d, &$v7aa28ed115707345d0274032757e8991) {$v435ed7e9f07f740abf511a62c00eef6e  = LOCAL_PACKAGE_STORE . $v166e64f6c3677d0c513901242a3e702d['filename'];$v97384261b8bbf966df16e5ad509922db = new packageInstaller($v435ed7e9f07f740abf511a62c00eef6e, dirname(__FILE__) . "/..");$vb2fdab230a2c39f3595a947861863cb7     = 0;$v9acb44549b41563697bb490144ec6258    = array();if($v97384261b8bbf966df16e5ad509922db->install($v9acb44549b41563697bb490144ec6258)) {$v7aa28ed115707345d0274032757e8991 = false;$vb2fdab230a2c39f3595a947861863cb7 = "done";}else {$vb2fdab230a2c39f3595a947861863cb7 = $v9acb44549b41563697bb490144ec6258['percent'];}header("Content-type: text/xml; charset=utf-8");if(!isset($v9acb44549b41563697bb490144ec6258['component'])) {$v9acb44549b41563697bb490144ec6258['component'] = null;$v9acb44549b41563697bb490144ec6258['part'] = null;}return "<?xml version=\"1.0\" encoding=\"utf-8\"?><response type=\"poll-response\" smu_sid=\"".$this->sid."\"><status ready=\"{$vb2fdab230a2c39f3595a947861863cb7}\"><component name=\"{$v9acb44549b41563697bb490144ec6258['component']}\" part=\"{$v9acb44549b41563697bb490144ec6258['part']}\" /></status></response>";}};class ClearTemporaryFiles extends UpdateStep {private $timeCounter   = null;const TIME_LIMIT       = 8.0;public function __construct($_sid = "") {parent::__construct($_sid);$this->timeCounter = microtime(true);}public function run($_Configuration, &$v166e64f6c3677d0c513901242a3e702d, &$v7aa28ed115707345d0274032757e8991) {try {$v435ed7e9f07f740abf511a62c00eef6e  = substr(LOCAL_PACKAGE_STORE, 0, -1);$this->cleanupPackage($v435ed7e9f07f740abf511a62c00eef6e);$v435ed7e9f07f740abf511a62c00eef6e  = substr(UPDATE_TEMP_STORE, 0, -1);$this->cleanupPackage($v435ed7e9f07f740abf511a62c00eef6e);}catch(Exception $ve1671797c52e15f763380b45e841ec32) {if($ve1671797c52e15f763380b45e841ec32->getCode() == 8888) {return '<'.'?xml version="1.0" encoding="utf-8" ?'.'><response type="temp-cleanup"><status ready="progress" /></response>';}else {throw $ve1671797c52e15f763380b45e841ec32;}}$v7aa28ed115707345d0274032757e8991 = false;return '<'.'?xml version="1.0" encoding="utf-8" ?'.'><response type="temp-cleanup"><status ready="done" /></response>';}private function cleanupPackage($v851148b4fd8fd7ae74bd9100c5c0c898) {$v10ae9fc7d453b0dd525d0edf2ede7961 = glob($v851148b4fd8fd7ae74bd9100c5c0c898 . "/*");if(is_array($v10ae9fc7d453b0dd525d0edf2ede7961))  foreach($v10ae9fc7d453b0dd525d0edf2ede7961 as $vd6fe1d0be6347b8ef2427fa629c04485) {if(is_dir($vd6fe1d0be6347b8ef2427fa629c04485)) {$this->cleanupPackage($vd6fe1d0be6347b8ef2427fa629c04485);rmdir($vd6fe1d0be6347b8ef2427fa629c04485);}else {unlink($vd6fe1d0be6347b8ef2427fa629c04485);}if((microtime(true) - $this->timeCounter) > self::TIME_LIMIT) {throw new Exception("Time limit exceed", 8888);}}@unlink($v851148b4fd8fd7ae74bd9100c5c0c898.'/.htaccess');}};class FinalizeUpdateStep extends UpdateStep {public function run($_Configuration, &$v166e64f6c3677d0c513901242a3e702d, &$v7aa28ed115707345d0274032757e8991) {if( !(isset($v166e64f6c3677d0c513901242a3e702d['cancel']) && $v166e64f6c3677d0c513901242a3e702d['cancel']) ) {$v58309fbfe87fa90ec9f4b9d78ead9d77 = "<?xml version=\"1.0\" encoding=\"utf-8\"?><request type=\"update-success\" smu_sid=\"".$this->sid."\"><status ready=\"done\" /></request>";$v10573b873d2fa5a365d558a45e328e47   = getServerRequest();$v10573b873d2fa5a365d558a45e328e47->addPostVariable('smu_sid', $this->sid);$v10573b873d2fa5a365d558a45e328e47->addPostVariable('rdata', $v58309fbfe87fa90ec9f4b9d78ead9d77);$result    = $v10573b873d2fa5a365d558a45e328e47->execute(UPDATE_SERVER);$vd1fc8eaf36937be0c3ba8cfe0a2c1bfe  = new umiSimpleXML($result);$v718779752b851ac0dc6281a8c8d77e7e   = $vd1fc8eaf36937be0c3ba8cfe0a2c1bfe->license;if($v718779752b851ac0dc6281a8c8d77e7e) {$vb1444fb0c07653567ad325aa25d4e37a = regedit::getInstance();$vb1444fb0c07653567ad325aa25d4e37a->setVal('//modules/autoupdate/system_version', $v718779752b851ac0dc6281a8c8d77e7e->attribute('version'));$vb1444fb0c07653567ad325aa25d4e37a->setVal('//modules/autoupdate/system_build',   $v718779752b851ac0dc6281a8c8d77e7e->attribute('build'));$vb1444fb0c07653567ad325aa25d4e37a->setVal('//modules/autoupdate/last_updated', time());}}else {$v58309fbfe87fa90ec9f4b9d78ead9d77 = "<?xml version=\"1.0\" encoding=\"utf-8\"?><response type=\"update-success\" smu_sid=\"".$this->sid."\"><status ready=\"cancelled\" /></response>";}$this->systemCleanup(dirname(__FILE__) . "/..", $v166e64f6c3677d0c513901242a3e702d);$v7aa28ed115707345d0274032757e8991 = false;return $result;}private function systemCleanup($vffa63171cdd50d0e6f9805f721e650cd, $v166e64f6c3677d0c513901242a3e702d) {$v435ed7e9f07f740abf511a62c00eef6e  = LOCAL_PACKAGE_STORE . $v166e64f6c3677d0c513901242a3e702d['filename'];unlink(PROCESS_SAVE_FILE);unlink(CONFIGURATION_FILE);$v10ae9fc7d453b0dd525d0edf2ede7961 = glob($vffa63171cdd50d0e6f9805f721e650cd . "/cache/*");if(is_array($v10ae9fc7d453b0dd525d0edf2ede7961))  foreach($v10ae9fc7d453b0dd525d0edf2ede7961 as $vd6fe1d0be6347b8ef2427fa629c04485) {if(is_file($vd6fe1d0be6347b8ef2427fa629c04485) && basename($vd6fe1d0be6347b8ef2427fa629c04485) != "trash") {unlink($vd6fe1d0be6347b8ef2427fa629c04485);}}}private function cleanupPackage($v851148b4fd8fd7ae74bd9100c5c0c898) {$v10ae9fc7d453b0dd525d0edf2ede7961 = glob($v851148b4fd8fd7ae74bd9100c5c0c898 . "/*");if(is_array($v10ae9fc7d453b0dd525d0edf2ede7961))  foreach($v10ae9fc7d453b0dd525d0edf2ede7961 as $vd6fe1d0be6347b8ef2427fa629c04485) {if(is_dir($vd6fe1d0be6347b8ef2427fa629c04485)) $this->cleanupPackage($vd6fe1d0be6347b8ef2427fa629c04485);if(basename($vd6fe1d0be6347b8ef2427fa629c04485) == "index.xml") unlink($vd6fe1d0be6347b8ef2427fa629c04485);}}};?>