<?php
 class order extends umiObjectProxy {protected $items = Array(), $actualPrice, $originalPrice, $totalAmount, $discount, $domain;public static function get($v61e9abeaa2ba0e1296555c135d818e6e = false) {if($v61e9abeaa2ba0e1296555c135d818e6e == false) {return $va8cfde6331bd59eb2ac96f8911c4b666 = self::create();}$v5891da2d64975cae48d175d1e001f5da = umiObjectsCollection::getInstance();$va8cfde6331bd59eb2ac96f8911c4b666 = $v5891da2d64975cae48d175d1e001f5da->getObject($v61e9abeaa2ba0e1296555c135d818e6e);if($va8cfde6331bd59eb2ac96f8911c4b666 instanceof iUmiObject) {return new order($va8cfde6331bd59eb2ac96f8911c4b666);}else {return null;}}public static function create() {$v0e8133eb006c0f85ed9444ae07a60842 = umiObjectTypesCollection::getInstance();$v5891da2d64975cae48d175d1e001f5da = umiObjectsCollection::getInstance();$permissions = permissionsCollection::getInstance();$v8b1dc169bf460ee884fceef66c6607d6 = cmsController::getInstance();$v1635ec3814daef50e91f9445b0ff2861 = $v0e8133eb006c0f85ed9444ae07a60842->getBaseType('emarket', 'order');$vad5f82e879a9c5d6b5b442eb37e50551 = $v8b1dc169bf460ee884fceef66c6607d6->getCurrentDomain();$v72ee76c5c29383b7c9f9225c1fa4d10b = $vad5f82e879a9c5d6b5b442eb37e50551->getId();$v36002b0c0e5bc0ab9cb9dfc430553cca = 0;$v03c07d5bea3270c79066ec0a8b6b5d28 = self::getStatusByCode('basket');$vc7fe6c0da028dabd8e96b311aeb9eedc = customer::get()->getId();$v1ed2e1b19b6e55d52d2473be17a4afd9 = time();$v61e9abeaa2ba0e1296555c135d818e6e = $v5891da2d64975cae48d175d1e001f5da->addObject('', $v1635ec3814daef50e91f9445b0ff2861);$v70a17ffa722a3985b86d30b034ad06d7 = $v5891da2d64975cae48d175d1e001f5da->getObject($v61e9abeaa2ba0e1296555c135d818e6e);if($v70a17ffa722a3985b86d30b034ad06d7 instanceof iUmiObject == false) {throw new publicException("Can't load created object for order #{$v61e9abeaa2ba0e1296555c135d818e6e}");}$v70a17ffa722a3985b86d30b034ad06d7->domain_id = $v72ee76c5c29383b7c9f9225c1fa4d10b;$v70a17ffa722a3985b86d30b034ad06d7->manager_id = $v36002b0c0e5bc0ab9cb9dfc430553cca;$v70a17ffa722a3985b86d30b034ad06d7->status_id = $v03c07d5bea3270c79066ec0a8b6b5d28;$v70a17ffa722a3985b86d30b034ad06d7->customer_id = $vc7fe6c0da028dabd8e96b311aeb9eedc;$v70a17ffa722a3985b86d30b034ad06d7->order_create_date = $v1ed2e1b19b6e55d52d2473be17a4afd9;$v70a17ffa722a3985b86d30b034ad06d7->commit();return self::get($v61e9abeaa2ba0e1296555c135d818e6e);}public static function getStatusByCode($v903931b3a9d25a70683f51ab9d363d2e, $v617cd80fd2d7a9a94240393ac602f43e = 'order_status') {$v8be74552df93e31bbdd6b36ed74bdb6a = new selector('objects');$v8be74552df93e31bbdd6b36ed74bdb6a->types('object-type')->name('emarket', $v617cd80fd2d7a9a94240393ac602f43e);$v8be74552df93e31bbdd6b36ed74bdb6a->where('codename')->equals($v903931b3a9d25a70683f51ab9d363d2e);return $v8be74552df93e31bbdd6b36ed74bdb6a->first ? $v8be74552df93e31bbdd6b36ed74bdb6a->first->id : false;}public static function getCodeByStatus($vb80bb7740288fda1f201890375a60c8f) {$v9acb44549b41563697bb490144ec6258 = selector::get('object')->id($vb80bb7740288fda1f201890375a60c8f);return $v9acb44549b41563697bb490144ec6258 ? $v9acb44549b41563697bb490144ec6258->codename : false ;}public function getItems() {return $this->items;}public function appendItem(orderItem $v39b91a7e3e05f526a19899c65efe3675) {foreach($this->items as $v447b7147e84be512208dcc0995d67ebc) {if($v447b7147e84be512208dcc0995d67ebc->getId() == $v39b91a7e3e05f526a19899c65efe3675->getId()) {return false;}}$v39b91a7e3e05f526a19899c65efe3675->refresh();$this->items[] = $v39b91a7e3e05f526a19899c65efe3675;}public function removeItem(orderItem $v39b91a7e3e05f526a19899c65efe3675) {foreach($this->items as $v865c0c0b4ab0e063e5caa3387c1a8741 => $v447b7147e84be512208dcc0995d67ebc) {if($v447b7147e84be512208dcc0995d67ebc->getId() == $v39b91a7e3e05f526a19899c65efe3675->getId()) {unset($this->items[$v865c0c0b4ab0e063e5caa3387c1a8741]);return true;}}return false;}public function getItem($v59a814aa020a1b32c4674a5887a35022) {foreach($this->items as $v447b7147e84be512208dcc0995d67ebc) {if($v447b7147e84be512208dcc0995d67ebc->getId() == $v59a814aa020a1b32c4674a5887a35022) return $v447b7147e84be512208dcc0995d67ebc;}return false;}public function isEmpty() {return (sizeof($this->items) == 0);}public function earse() {$this->items = Array();}public function getOrderStatus() {return $this->object->status_id;}public function setOrderStatus($v2089d007183d40bc4d7d37aa8fc8dedc) {if($v2089d007183d40bc4d7d37aa8fc8dedc && !is_numeric($v2089d007183d40bc4d7d37aa8fc8dedc)) {$v2089d007183d40bc4d7d37aa8fc8dedc = self::getStatusByCode($v2089d007183d40bc4d7d37aa8fc8dedc, 'order_status');}$v46cbdabcc8b11ae9fd02ac1e854b63a6 = $this->object->status_id;$v4119639092e62c55ea8be348e4d9260d = new umiEventPoint('order-status-changed');$v4119639092e62c55ea8be348e4d9260d->addRef('order', $this);$v4119639092e62c55ea8be348e4d9260d->setParam('old-status-id', $v46cbdabcc8b11ae9fd02ac1e854b63a6);$v4119639092e62c55ea8be348e4d9260d->setParam('new-status-id', $v2089d007183d40bc4d7d37aa8fc8dedc);if($v46cbdabcc8b11ae9fd02ac1e854b63a6 != $v2089d007183d40bc4d7d37aa8fc8dedc) {$v4119639092e62c55ea8be348e4d9260d->setMode('before');$v4119639092e62c55ea8be348e4d9260d->call();}$this->object->status_id = $v2089d007183d40bc4d7d37aa8fc8dedc;if($v46cbdabcc8b11ae9fd02ac1e854b63a6 != $v2089d007183d40bc4d7d37aa8fc8dedc) {$v4119639092e62c55ea8be348e4d9260d->setMode('after');$v4119639092e62c55ea8be348e4d9260d->call();$v9acb44549b41563697bb490144ec6258 = selector::get('object')->id($v2089d007183d40bc4d7d37aa8fc8dedc);switch($v9acb44549b41563697bb490144ec6258->codename) {case 'waiting': {$this->reserve();break;}case 'canceled': {$this->unreserve();break;}case 'ready': {$this->writeOff();break;}}}}public function getPaymentStatus() {return $this->object->payment_status_id;}public function setPaymentStatus($v2089d007183d40bc4d7d37aa8fc8dedc) {if($v2089d007183d40bc4d7d37aa8fc8dedc && !is_numeric($v2089d007183d40bc4d7d37aa8fc8dedc)) {$vf9a31c6b3670c772d11230c8d4d1f33f  = $v2089d007183d40bc4d7d37aa8fc8dedc;$v2089d007183d40bc4d7d37aa8fc8dedc = self::getStatusByCode($v2089d007183d40bc4d7d37aa8fc8dedc, 'order_payment_status');}else {$vf9a31c6b3670c772d11230c8d4d1f33f  = self::getCodeByStatus($v2089d007183d40bc4d7d37aa8fc8dedc);}$v46cbdabcc8b11ae9fd02ac1e854b63a6 = $this->object->payment_status_id;$v4119639092e62c55ea8be348e4d9260d = new umiEventPoint('order-payment-status-changed');$v4119639092e62c55ea8be348e4d9260d->addRef('order', $this);$v4119639092e62c55ea8be348e4d9260d->setParam('old-status-id', $v46cbdabcc8b11ae9fd02ac1e854b63a6);$v4119639092e62c55ea8be348e4d9260d->setParam('new-status-id', $v2089d007183d40bc4d7d37aa8fc8dedc);if($v46cbdabcc8b11ae9fd02ac1e854b63a6 != $v2089d007183d40bc4d7d37aa8fc8dedc) {$v4119639092e62c55ea8be348e4d9260d->setMode('before');$v4119639092e62c55ea8be348e4d9260d->call();}$this->object->payment_status_id = $v2089d007183d40bc4d7d37aa8fc8dedc;if($v46cbdabcc8b11ae9fd02ac1e854b63a6 != $v2089d007183d40bc4d7d37aa8fc8dedc) {$v4119639092e62c55ea8be348e4d9260d->setMode('after');$v4119639092e62c55ea8be348e4d9260d->call();}switch($vf9a31c6b3670c772d11230c8d4d1f33f) {case 'initialized' : $this->setOrderStatus('payment');break;case 'declined'    : $this->setOrderStatus('execution');break;case 'accepted'    : {$this->object->payment_date = new umiDate();$this->order();break;}}}public function getDeliveryStatus() {return $this->object->order_delivery_props;}public function setDeliveryStatus($v2089d007183d40bc4d7d37aa8fc8dedc) {if($v2089d007183d40bc4d7d37aa8fc8dedc && !is_numeric($v2089d007183d40bc4d7d37aa8fc8dedc))    $v2089d007183d40bc4d7d37aa8fc8dedc = self::getStatusByCode($v2089d007183d40bc4d7d37aa8fc8dedc, 'order_delivery_status');$v46cbdabcc8b11ae9fd02ac1e854b63a6 = $this->object->delivery_status_id;$v4119639092e62c55ea8be348e4d9260d = new umiEventPoint('order-delivery-status-changed');$v4119639092e62c55ea8be348e4d9260d->addRef('order', $this);$v4119639092e62c55ea8be348e4d9260d->setParam('old-status-id', $v46cbdabcc8b11ae9fd02ac1e854b63a6);$v4119639092e62c55ea8be348e4d9260d->setParam('new-status-id', $v2089d007183d40bc4d7d37aa8fc8dedc);if($v46cbdabcc8b11ae9fd02ac1e854b63a6 != $v2089d007183d40bc4d7d37aa8fc8dedc) {$v4119639092e62c55ea8be348e4d9260d->setMode('before');$v4119639092e62c55ea8be348e4d9260d->call();}$this->object->delivery_status_id = $v2089d007183d40bc4d7d37aa8fc8dedc;if($v46cbdabcc8b11ae9fd02ac1e854b63a6 != $v2089d007183d40bc4d7d37aa8fc8dedc) {$v4119639092e62c55ea8be348e4d9260d->setMode('after');$v4119639092e62c55ea8be348e4d9260d->call();}}public function getActualPrice() {return $this->actualPrice;}public function getOriginalPrice() {return $this->originalPrice;}public function getTotalAmount() {return $this->totalAmount;}public function refresh() {$va8cfde6331bd59eb2ac96f8911c4b666 = $this->object;$v691d502cfd0e0626cd3b058e5682ad1c = $this->getItems();$v26b9632b8ee118c32a553473c2e43969 = 0;$vba1ab1f527cb86ed46733ee90be3d58e = 0;foreach($v691d502cfd0e0626cd3b058e5682ad1c as $v447b7147e84be512208dcc0995d67ebc) {$v447b7147e84be512208dcc0995d67ebc->refresh();$v26b9632b8ee118c32a553473c2e43969 += $v447b7147e84be512208dcc0995d67ebc->getTotalActualPrice();$vba1ab1f527cb86ed46733ee90be3d58e += $v447b7147e84be512208dcc0995d67ebc->getAmount();}$ve2dc6c48c56de466f6d13781796abf3d = $this->searchDiscount();if($ve2dc6c48c56de466f6d13781796abf3d instanceof orderDiscount) {$v928419bc24fdb7d83103496423c71f5c = $ve2dc6c48c56de466f6d13781796abf3d->recalcPrice($v26b9632b8ee118c32a553473c2e43969);}else {$v928419bc24fdb7d83103496423c71f5c = $v26b9632b8ee118c32a553473c2e43969;}$v928419bc24fdb7d83103496423c71f5c += (float) $this->delivery_price;$this->originalPrice = $v26b9632b8ee118c32a553473c2e43969;$this->actualPrice = $v928419bc24fdb7d83103496423c71f5c;$this->totalAmount = $vba1ab1f527cb86ed46733ee90be3d58e;$this->discount = $ve2dc6c48c56de466f6d13781796abf3d;$this->commit();}public function getCustomerId() {return $this->object->customer_id;}public function getDomain() {return $this->domain;}public function setDomainId(domain $v2ce4c32d5c5005cc481b10533511bef1) {$this->domain = $vad5f82e879a9c5d6b5b442eb37e50551;}public function getDiscount() {return $this->discount;}public function setDiscount(discount $ve2dc6c48c56de466f6d13781796abf3d = null) {if($ve2dc6c48c56de466f6d13781796abf3d && ($ve2dc6c48c56de466f6d13781796abf3d->validate($this) == false)) {$ve2dc6c48c56de466f6d13781796abf3d = null;}$this->discount = $ve2dc6c48c56de466f6d13781796abf3d;}public function generateNumber() {$v2245023265ae4cf87d02c8b6ba991139 = mainConfiguration::getInstance();$v6f66e878c62db60568a3487869695820 = $v2245023265ae4cf87d02c8b6ba991139->get('modules', 'emarket.numbers') . 'OrderNumber';if(class_exists($v6f66e878c62db60568a3487869695820)) {$va8cfde6331bd59eb2ac96f8911c4b666 = new $v6f66e878c62db60568a3487869695820($this);return $va8cfde6331bd59eb2ac96f8911c4b666->number();}else {throw new coreException("Can't load order numbers generator. Check modules.emarket.numbers config setting");}}public function order() {$v9acb44549b41563697bb490144ec6258 = $this->getOrderStatus();if(is_null($v9acb44549b41563697bb490144ec6258) || self::getCodeByStatus($v9acb44549b41563697bb490144ec6258) == 'payment') {$this->generateNumber();$this->object->order_date = time();$this->setOrderStatus('waiting');$this->object->commit();return true;}else return false;}public function commit() {$va8cfde6331bd59eb2ac96f8911c4b666 = $this->object;$va8cfde6331bd59eb2ac96f8911c4b666->total_original_price = $this->originalPrice;$va8cfde6331bd59eb2ac96f8911c4b666->total_price = $this->actualPrice;$va8cfde6331bd59eb2ac96f8911c4b666->total_amount = $this->totalAmount;$va8cfde6331bd59eb2ac96f8911c4b666->domain_id = ($this->domain) ? $this->domain->getId() : false;$va8cfde6331bd59eb2ac96f8911c4b666->order_discount_id = ($this->discount ? $this->discount->getId() : false);$this->applyItems();parent::commit();}protected function __construct(umiObject $va8cfde6331bd59eb2ac96f8911c4b666) {parent::__construct($va8cfde6331bd59eb2ac96f8911c4b666);$ve4e46deb7f9cc58c7abfb32e5570b6f3 = domainsCollection::getInstance();$this->totalAmount = (int) $va8cfde6331bd59eb2ac96f8911c4b666->total_amount;$this->originalPrice = (float) $va8cfde6331bd59eb2ac96f8911c4b666->total_original_price;$this->actualPrice = (float) $va8cfde6331bd59eb2ac96f8911c4b666->total_price;$this->domain = $ve4e46deb7f9cc58c7abfb32e5570b6f3->getDomain($ve4e46deb7f9cc58c7abfb32e5570b6f3->getDomainId($va8cfde6331bd59eb2ac96f8911c4b666->domain_id));$this->discount = orderDiscount::get($va8cfde6331bd59eb2ac96f8911c4b666->order_discount_id);$this->readItems();}protected function readItems() {$v28894d31b008cdb059b629ad31369de8 = $this->object->order_items;$v691d502cfd0e0626cd3b058e5682ad1c = array();foreach($v28894d31b008cdb059b629ad31369de8 as $v16b2b26000987faccb260b9d39df1269) {try {$v691d502cfd0e0626cd3b058e5682ad1c[] = orderItem::get($v16b2b26000987faccb260b9d39df1269);}catch (privateException $ve1671797c52e15f763380b45e841ec32) {}}$this->items = $v691d502cfd0e0626cd3b058e5682ad1c;}protected function applyItems() {$vf09cc7ee3a9a93273f4b80601cafb00c = Array();foreach($this->items as $v447b7147e84be512208dcc0995d67ebc) {$vf09cc7ee3a9a93273f4b80601cafb00c[] = $v447b7147e84be512208dcc0995d67ebc->getId();}$this->object->order_items = $vf09cc7ee3a9a93273f4b80601cafb00c;}public function searchDiscount() {$ve2dc6c48c56de466f6d13781796abf3d = orderDiscount::search($this);return ($ve2dc6c48c56de466f6d13781796abf3d instanceof orderDiscount) ? $ve2dc6c48c56de466f6d13781796abf3d : null;}public function reserve($v9c3b62949032a7361e2f0642fcb118d6 = true) {if($this->is_reserved == $v9c3b62949032a7361e2f0642fcb118d6) {return false;}$va406a0478598ef044f5f26632d4abac2 = $this->getPrimaryStore();if(!$va406a0478598ef044f5f26632d4abac2) return false;foreach($this->getItems() as $v447b7147e84be512208dcc0995d67ebc) {if($v8e2dcfd7e7e24b1ca76c1193f645902b = $v447b7147e84be512208dcc0995d67ebc->getItemElement()) {$ve9f40e1f1d1658681dad2dac4ae0971e = $v447b7147e84be512208dcc0995d67ebc->getAmount();$vc8a0892f4c2271ddf7d446720e35e4df = $v8e2dcfd7e7e24b1ca76c1193f645902b->getValue('stores_state', array('filter' => array('rel' => $va406a0478598ef044f5f26632d4abac2->id)));if(sizeof($vc8a0892f4c2271ddf7d446720e35e4df)) {$vfbb44b4487415b134bce9c790a27fe5e = $vc8a0892f4c2271ddf7d446720e35e4df[0];$vfbb44b4487415b134bce9c790a27fe5e = (int) getArrayKey($vfbb44b4487415b134bce9c790a27fe5e, 'int');}else {$vfbb44b4487415b134bce9c790a27fe5e = 0;}$v7f005c3fa691e77c52d3297cc2699072 = (int) $v8e2dcfd7e7e24b1ca76c1193f645902b->reserved + $ve9f40e1f1d1658681dad2dac4ae0971e * ($v9c3b62949032a7361e2f0642fcb118d6 ? 1 : -1);$v8e2dcfd7e7e24b1ca76c1193f645902b->reserved = ($v7f005c3fa691e77c52d3297cc2699072 > 0) ? ($v7f005c3fa691e77c52d3297cc2699072 > $vfbb44b4487415b134bce9c790a27fe5e ? $vfbb44b4487415b134bce9c790a27fe5e : $v7f005c3fa691e77c52d3297cc2699072) : 0;$v8e2dcfd7e7e24b1ca76c1193f645902b->commit();}}$this->is_reserved = $v9c3b62949032a7361e2f0642fcb118d6;$this->commit();return true;}public function unreserve() {return $this->reserve(false);}public function writeOff() {if(!$this->is_reserved) return false;$va406a0478598ef044f5f26632d4abac2 = $this->getPrimaryStore();if(!$va406a0478598ef044f5f26632d4abac2) return false;foreach($this->getItems() as $v447b7147e84be512208dcc0995d67ebc) {if($v8e2dcfd7e7e24b1ca76c1193f645902b = $v447b7147e84be512208dcc0995d67ebc->getItemElement()) {$ve9f40e1f1d1658681dad2dac4ae0971e = $v447b7147e84be512208dcc0995d67ebc->getAmount();$vc8a0892f4c2271ddf7d446720e35e4df = $v8e2dcfd7e7e24b1ca76c1193f645902b->getValue('stores_state');foreach($vc8a0892f4c2271ddf7d446720e35e4df as $v865c0c0b4ab0e063e5caa3387c1a8741 => $v731d17c996ed223f88dd9e2e78fa5508) {$vfbb44b4487415b134bce9c790a27fe5e = getArrayKey($v731d17c996ed223f88dd9e2e78fa5508, 'int');$vb80bb7740288fda1f201890375a60c8f = getArrayKey($v731d17c996ed223f88dd9e2e78fa5508, 'rel');if($va406a0478598ef044f5f26632d4abac2->id == $vb80bb7740288fda1f201890375a60c8f) {$vc8a0892f4c2271ddf7d446720e35e4df[$v865c0c0b4ab0e063e5caa3387c1a8741]['int'] = $vfbb44b4487415b134bce9c790a27fe5e - $ve9f40e1f1d1658681dad2dac4ae0971e;$v8e2dcfd7e7e24b1ca76c1193f645902b->setValue('stores_state', $vc8a0892f4c2271ddf7d446720e35e4df);break;}}$v7f005c3fa691e77c52d3297cc2699072 = (int) $v8e2dcfd7e7e24b1ca76c1193f645902b->reserved - $ve9f40e1f1d1658681dad2dac4ae0971e;$v8e2dcfd7e7e24b1ca76c1193f645902b->reserved = ($v7f005c3fa691e77c52d3297cc2699072 > 0) ? ($v7f005c3fa691e77c52d3297cc2699072) : 0;$v8e2dcfd7e7e24b1ca76c1193f645902b->commit();}}$this->is_reserved = false;$this->commit();return true;}private function getPrimaryStore() {$v61af09f34bc001f3b6d9139687a723fd = new selector('objects');$v61af09f34bc001f3b6d9139687a723fd->types('object-type')->name('emarket', 'store');$v61af09f34bc001f3b6d9139687a723fd->where('primary')->equals(true);return $v61af09f34bc001f3b6d9139687a723fd->first;}};?>