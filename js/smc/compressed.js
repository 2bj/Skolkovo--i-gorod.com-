function filter(){this.AllText=new Array();this.Props=new Object();this.EntIDs=new Array();this.Parents=new Array();this.Langs=new Array();this.Domains=new Array();this.Orders=new Object();this.Perms=true;this.Full=true;this.FldsOr=false;this.Depth=null;this.CheckVirtual=true;this.Page=null;this.setAllTextSearch=function(_Value){if(_Value instanceof Array){if(this.AllText.length)this.AllText.splice(this.AllText.length,_Value.length,_Value);else this.AllText=_Value}else{this.AllText.push(_Value)}};this.setPropertyEqual=function(_PropName,_Value){if(this.Props[_PropName]==undefined)this.Props[_PropName]=new Object();this.Props[_PropName]['eq']=_Value};this.setPropertyNotEqual=function(_PropName,_Value){if(this.Props[_PropName]==undefined)this.Props[_PropName]=new Object();this.Props[_PropName]['ne']=_Value};this.setPropertyLike=function(_PropName,_Value){if(this.Props[_PropName]==undefined)this.Props[_PropName]=new Object();this.Props[_PropName]['like']=_Value};this.setPropertyLess=function(_PropName,_Value){if(this.Props[_PropName]==undefined)this.Props[_PropName]=new Object();this.Props[_PropName]['lt']=_Value};this.setPropertyGreater=function(_PropName,_Value){if(this.Props[_PropName]==undefined)this.Props[_PropName]=new Object();this.Props[_PropName]['gt']=_Value};this.setPropertyBetween=function(_PropName,_Floor,_Ceil){if(this.Props[_PropName]==undefined)this.Props[_PropName]=new Object();this.Props[_PropName]['gt']=_Floor;this.Props[_PropName]['lt']=_Ceil};this.removeProperty=function(_PropName){this.Props[_PropName]=undefined};this.addOrder=function(_PropName,_Direction){var _Asc=true;if(_Direction!=undefined&&(_Direction===false||_Direction.toUpperCase()=='DESC'||_Direction.toUpperCase()=='BACKWARD')){_Asc=false}this.Orders[_PropName]=_Asc};this.setOrder=function(_PropName,_Direction){var _Asc=true;if(_Direction!=undefined&&(_Direction===false||_Direction.toUpperCase()=='DESC'||_Direction.toUpperCase()=='BACKWARD')){_Asc=false}this.Orders=new Object();this.Orders[_PropName]=_Asc};this.setPermissions=function(_Use){if(_Use==undefined)this.Perms=true;else this.Perms=_Use?true:false};this.setParentElements=function(_ParentElements){if(_ParentElements instanceof Array){this.Parents=_ParentElements}else{this.Parents.push(_ParentElements)}};this.setDepth=function(_iDepth){if(typeof(_iDepth)!=='undefined'){this.Depth=parseInt(_iDepth)}};this.setEntityIDs=function(_aIDs){if(_aIDs instanceof Array){this.EntIDs=_aIDs}else{this.EntIDs.push(_aIDs)}};this.setDomain=function(_Domain){if(_Domain instanceof Array){this.Domains=_Domain}else{this.Domains.push(_Domain)}};this.setLang=function(_Lang){if(_Lang instanceof Array){this.Langs=_Lang}else{this.Langs.push(_Lang)}};this.setVirtualCopyChecking=function(_Check){if(typeof(_Check)=='undefined'){this.CheckVirtual=true}else{this.CheckVirtual=_Check?true:false}};this.setViewMode=function(_Full){if(typeof(_Full)=='undefined'){this.Full=true}else{this.Full=_Full?true:false}};this.setConditionModeOr=function(_Or){if(typeof(_Or)=='undefined'){this.FldsOr=true}else{this.FldsOr=_Or?true:false}};this.getParents=function(){return this.Parents};this.setPage=function(_Page){this.Page=parseInt(_Page)};this.getPage=function(){return this.Page};this.getQueryString=function(_MergeFilter){var QueryPieces=new Array();var i=0;if(_MergeFilter instanceof Object){var o=new Object();for(i in _MergeFilter.Props)o[i]=_MergeFilter.Props[i];for(i in this.Props)o[i]=this.Props[i];for(i in o){for(var j in o[i]){if(o[i][j]instanceof Array){for(var k=0;k<o[i][j].length;k++)QueryPieces.push('fields_filter['+i+']['+j+'][]='+encodeURIComponent(o[i][j][k]))}else{QueryPieces.push('fields_filter['+i+']['+j+']='+encodeURIComponent(o[i][j]))}}}for(i=0;i<this.AllText.length;i++){QueryPieces.push('search-all-text[]='+encodeURIComponent(this.AllText[i]))}for(i=0;i<_MergeFilter.AllText.length;i++){QueryPieces.push('search-all-text[]='+encodeURIComponent(_MergeFilter.AllText[i]))}for(i=0;i<this.EntIDs.length;i++){QueryPieces.push('id[]='+this.EntIDs[i])}for(i=0;i<_MergeFilter.EntIDs.length;i++){QueryPieces.push('id[]='+_MergeFilter.EntIDs[i])}for(i=0;i<this.Parents.length;i++){QueryPieces.push('rel[]='+this.Parents[i])}for(i=0;i<_MergeFilter.Parents.length;i++){QueryPieces.push('rel[]='+_MergeFilter.Parents[i])}for(i=0;i<this.Domains.length;i++){QueryPieces.push('domain_id[]='+this.Domains[i])}for(i=0;i<_MergeFilter.Domains.length;i++){QueryPieces.push('domain_id[]='+_MergeFilter.Domains[i])}for(i=0;i<this.Langs.length;i++){QueryPieces.push('lang_id[]='+this.Langs[i])}for(i=0;i<_MergeFilter.Langs.length;i++){QueryPieces.push('lang_id[]='+_MergeFilter.Langs[i])}o=new Object();for(i in _MergeFilter.Orders)o[i]=_MergeFilter.Orders[i];for(i in this.Orders)o[i]=this.Orders[i];for(i in o)QueryPieces.push('order_filter['+i+']='+(o[i]?'asc':'desc'));if(this.Perms!==null)if(this.Perms)QueryPieces.push('permissions');else if(_MergeFilter.Perms)QueryPieces.push('permissions');if(this.CheckVirtual!==null)if(this.CheckVirtual)QueryPieces.push('virtuals');else if(_MergeFilter.CheckVirtual)QueryPieces.push('virtuals');if(this.Depth!==null)QueryPieces.push('depth='+this.Depth);else if(_MergeFilter.Depth!==null)QueryPieces.push('depth='+_MergeFilter.Depth);if(this.Page!==null)QueryPieces.push('p='+this.Page);else if(_MergeFilter.Page!==null)QueryPieces.push('p='+_MergeFilter.Page);if(this.FldsOr||_MergeFilter.FldsOd)QueryPieces.push('or-mode');if(this.Full||_MergeFilter.Full)QueryPieces.push('viewMode=full')}else{for(i in this.Props){for(var j in this.Props[i]){if(this.Props[i][j]instanceof Array){for(var k=0;k<this.Props[i][j].length;k++)QueryPieces.push('fields_filter['+i+']['+j+'][]='+encodeURIComponent(this.Props[i][j][k]))}else{QueryPieces.push('fields_filter['+i+']['+j+']='+encodeURIComponent(this.Props[i][j]))}}}for(i=0;i<this.AllText.length;i++){QueryPieces.push('search-all-text[]='+encodeURIComponent(this.AllText[i]))}for(i=0;i<this.EntIDs.length;i++){QueryPieces.push('id[]='+this.EntIDs[i])}for(i=0;i<this.Parents.length;i++){QueryPieces.push('rel[]='+this.Parents[i])}for(i=0;i<this.Domains.length;i++){QueryPieces.push('domain_id[]='+this.Domains[i])}for(i=0;i<this.Langs.length;i++){QueryPieces.push('lang_id[]='+this.Langs[i])}for(i in this.Orders){QueryPieces.push('order_filter['+i+']='+(this.Orders[i]?'asc':'desc'))}if(this.Perms)QueryPieces.push('permissions');if(this.CheckVirtual)QueryPieces.push('virtuals');if(this.Depth!==null)QueryPieces.push('depth='+this.Depth);if(this.Page!==null)QueryPieces.push('p='+this.Page);if(this.FldsOr)QueryPieces.push('or-mode');if(this.Full)QueryPieces.push('viewMode=full')}QueryPieces.push('childs');QueryPieces.push('links');QueryPieces.push('templates');return'?'+QueryPieces.join('&')};this.clear=function(){this.AllText=new Array();this.Props=new Object();this.EntIDs=new Array();this.Parents=new Array();this.Langs=new Array();this.Domains=new Array();this.Orders=new Object();this.Perms=true;this.Depth=null;this.Page=null;this.Full=true;this.FldsOr=false;this.CheckVirtual=null};this.empty=function(){var propsCount=0;var ordersCount=0;for(var i in this.Props){propsCount++;if(propsCount)break}for(var i in this.Orders){ordersCount++;if(ordersCount)break}return!this.AllText.length&&!this.EntIDs.length&&!this.Parents.length&&!this.Langs.length&&!this.Domains.length&&!propsCount&&!ordersCount&&this.Perms&&this.Full&&!this.Depth&&!this.Page&&!this.FldsOr&&!this.CheckVirtual};var cloneObject=function(o){if(!o||'object'!==typeof o){return o}var c='function'===typeof o.pop?[]:{};var p,v;for(p in o){if(o.hasOwnProperty(p)){v=o[p];if(v&&'object'===typeof v){c[p]=cloneObject(v)}else{c[p]=v}}}return c};this.clone=function(){return cloneObject(this)}}var TableItem=function(_oControl,_oParent,_oData,_oSiblingItem,_sInsertMode){var id=parseInt(_oData.id);var __self=this;var Data=_oData;var Parent=_oParent;var SiblingItem=_oSiblingItem||null;var InsertMode=_sInsertMode||'after';var ForceDraw=typeof(_oData['force-draw'])!=='undefined'?parseInt(_oData['force-draw']):1;var CountChilds=typeof(_oData['childs'])!=='undefined'?parseInt(_oData['childs']):0;var baseModule=(typeof(_oData['basetype'])!=='undefined'&&typeof(_oData['basetype']['module'])==='string')?_oData['basetype']['module']:"content";var baseMethod=(typeof(_oData['basetype'])!=='undefined'&&typeof(_oData['basetype']['method'])==='string')?_oData['basetype']['method']:"";var typeName=(typeof(_oData['basetype'])!=='undefined'&&typeof(_oData['basetype']['_value'])==='string')?_oData['basetype']['_value']:"";var IconsPath=_oControl.iconsPath;var iconSrc=typeof(_oData['iconbase'])!=='undefined'?_oData['iconbase']:IconsPath+'ico_'+baseModule+'_'+baseMethod+'.png';var toggleCtrl=null;var labelCtrl=null;var labelText=null;var itemIcon=null;var dropIndicator=null;var Settings=SettingsStore.getInstance();var AutoexpandAllowed=true;var oldClassName=null;var selected=false;var flatMode=_oControl.flatMode;var objectTypesMode=_oControl.objectTypesMode;var pagesBar=null;var filterRow=null;this.element=null;this.control=_oControl;this.childsContainer=null;this.id=id;this.name=typeof(_oData['name'])!=='undefined'?_oData['name']:getLabel('js-smc-noname-page');this.isRoot=Parent?false:true;this.loaded=false;this.viewLink=typeof(_oData['link'])!=='undefined'?_oData['link']:false;this.editLink=typeof(_oData['edit-link'])!=='undefined'?_oData['edit-link']:false;this.createLink=typeof(_oData['create-link'])!=='undefined'?_oData['create-link']:false;this.permissions=typeof(_oData['permissions'])!=='undefined'?parseInt(_oData['permissions']):0;this.isActive=typeof(_oData['is-active'])!=='undefined'?parseInt(_oData['is-active']):0;if(objectTypesMode){this.isActive=true}this.isVirtualCopy=typeof(_oData['virtual-copy'])!=='undefined'?true:false;this.lockedBy=typeof(_oData['locked-by'])==='object'?_oData['locked-by']:null;this.expiration=typeof(_oData['expiration'])==='object'?_oData['expiration']:null;this.templateId=typeof(_oData['template-id'])!=='undefined'?_oData['template-id']:null;this.langId=typeof(_oData['lang-id'])!=='undefined'?_oData['lang-id']:null;this.domainId=typeof(_oData['domain-id'])!=='undefined'?_oData['domain-id']:null;this.allowCopy=typeof(_oData['allow-copy'])!=='undefined'?parseInt(_oData['allow-copy']):true;this.allowActivity=typeof(_oData['allow-activity'])!=='undefined'?parseInt(_oData['allow-activity']):true;this.allowDrag=typeof(_oData['allow-drag'])!=='undefined'?_oData['allow-drag']:true;this.parent=Parent;this.childs=[];this.hasChilds=(CountChilds>0||id==0);this.labelControl=null;this.position=false;this.isExpanded=false;this.filter=new filter;this.filter.setParentElements(id);this.level=Parent?Parent.level+1:0;this.ignoreEmptyFilter=false;this.pageing={'total':0,'limit':0,'offset':0};this.baseModule=(typeof(_oData['basetype'])!=='undefined'&&typeof(_oData['basetype']['module'])==='string')?_oData['basetype']['module']:"content";this.baseMethod=(typeof(_oData['basetype'])!=='undefined'&&typeof(_oData['basetype']['method'])==='string')?_oData['basetype']['method']:"";var __constructor=function(){if(_oParent){_oParent.childs.push(id);if(ForceDraw)__draw(Parent.childsContainer)}else{if(ForceDraw)__drawRoot()}};var isObjectActivated=function(item,defaultActivity){if(flatMode&&__self.control.contentType!='pages'){if(__self.control.enableObjectsActivity){return(defaultActivity||item.getValue('is_activated')||item.getValue('is_active')||item.getValue('activated'))!==""}else{return true}}else{return defaultActivity}};var __draw=function(_oContainerEl){__self.isActive=isObjectActivated(__self,__self.isActive);var usedColumns=__getUsedColumns();var columnsMenu=__getColumnsMenu();var element=document.createElement('tr');element.setAttribute('rel',id);element.className='ti';element.rel=id;element.className='ti';labelCtrl=element;__self.labelControl=labelCtrl;var toggleColumn=document.createElement('td');toggleColumn.className='ti-toggle';toggleCtrl=document.createElement('img');toggleCtrl.className='ti-toggle';var tsrc=__self.hasChilds?IconsPath+'expand.png':IconsPath+'collapse-disabled.png';toggleCtrl.setAttribute('src',tsrc);toggleCtrl.onclick=function(){__self.toggle();return false};toggleColumn.appendChild(toggleCtrl);var nameColumn=usedColumns['name'];var cLabel=document.createElement('td');cLabel.className='ti column';cLabel.id='c_'+__self.control.id+'_'+__self.id+'_name';var size=parseInt(nameColumn['params'][0]);if(!flatMode)size-=20*(__self.level-1);cLabel.style.width=size+'px';cLabel.style.owerflow='hidden';cLabel.name='name';var labelColumn=document.createElement('div');labelColumn.style.width=size+'px';labelColumn.style.owerflow='hidden';cLabel.appendChild(labelColumn);if(!objectTypesMode)new editableCell(__self,cLabel,usedColumns['name']);itemIcon=document.createElement('img');itemIcon.style.border='0px';itemIcon.setAttribute('alt',typeName);itemIcon.setAttribute('title',typeName);itemIcon.setAttribute('src',iconSrc);itemIcon.className='ti-icon';itemIcon.onmousedown=function(){return false};if(__self.control.allowDrag&&__self.allowDrag)itemIcon.style.cursor='move';if(!__self.control.flatMode&&!__self.control.objectTypesMode){labelColumn.appendChild(itemIcon)}else{itemIcon=null}if(__self.expiration){var oStatus=__self.expiration['status'];if(oStatus){var statusSID=oStatus['id'];var statusName=oStatus['_value'];if(statusSID){var expInd=document.createElement('img');var ico=IconsPath+'ico_'+statusSID+'.png';expInd.setAttribute("src",ico);expInd.setAttribute("alt",statusName);expInd.setAttribute("title",statusName);expInd.className='page-status';labelColumn.appendChild(expInd)}}}labelText=document.createElement('a');var t=__self.getValue('name');var val=new String((t.length)?t:"");if(!val.length){val=getLabel('js-smc-noname-page')}if(val.length>45){val=val.substring(0,45)+"&#8230;"}labelColumn.title=(__self.viewLink)?__self.viewLink:val.replace(/<[^>]+>/g,'');labelText.innerHTML=val;if(__self.editLink){labelText.setAttribute('href',__self.editLink)}else{labelText.className='unactive';labelText.onclick=function(){return false}}labelColumn.appendChild(labelText);if(!__self.isActive&&!__self.control.objectTypesMode){if(!__self.control.flatMode){if(itemIcon)$(itemIcon).fadeTo(300,0.5);if(toggleCtrl)$(toggleCtrl).fadeTo(300,0.5)}$(labelText).fadeTo(300,0.5)}if(!flatMode)element.appendChild(toggleColumn);element.appendChild(cLabel);var colSpan=2;for(var name in usedColumns){var column=columnsMenu[name];var params=usedColumns[name]['params'];if(params[1]=='static'){column=usedColumns[name]}if(!column)continue;colSpan++;var col=document.createElement('td');col.id='c_'+__self.control.id+'_'+__self.id+'_'+name;col.className='column';col.style.width=params[0];col.name=name;col.style.cursor='text';var val=__self.getValue(name);col.innerHTML='<div style="width:'+usedColumns[name]['params'][0]+'">'+val+'</div>';element.appendChild(col);if(column.dataType){new editableCell(__self,col,column)}}var autoCol=document.createElement('td');autoCol.className='auto-column';autoCol.innerHTML='&nbsp;';autoCol.style.width='auto';element.appendChild(autoCol);if(SiblingItem){var prevEl=null;if(InsertMode.toLowerCase()=='after'){prevEl=SiblingItem.element.nextSibling}else{prevEl=SiblingItem.element}if(prevEl){__self.element=_oContainerEl.insertBefore(element,prevEl)}else{__self.element=_oContainerEl.appendChild(element)}}else{__self.element=_oContainerEl.appendChild(element)}var childsRow=document.createElement('tr');childsRow.style.display='none';{var childsCol=document.createElement('td');childsCol.colSpan=colSpan;{var childsTable=document.createElement('table');childsTable.cellSpacing="0";{var childsTableBody=document.createElement('tbody');childsTable.appendChild(childsTableBody);childsTableBody.className='ti-childs-container';var pagesRow=document.createElement('tr');pagesRow.style.display='none';{pagesBar=document.createElement('td');pagesBar.id='pb_'+__self.control.id+'_'+__self.id;pagesBar.className='pages-bar';if(!flatMode)colSpan++;pagesBar.colSpan=colSpan;pagesRow.appendChild(pagesBar)}childsTableBody.appendChild(pagesRow);__self.childsContainer=childsTableBody}childsCol.appendChild(childsTable)}if(!flatMode){var emptyCol=document.createElement('td');emptyCol.className='ti-toggle';childsRow.appendChild(emptyCol)}childsRow.appendChild(childsCol)}_oContainerEl.appendChild(childsRow)};var __getUsedColumns=function(){if(__self.control.usedColumns)return __self.control.usedColumns;var usedColumns={};var setColumns=Settings.get(__self.control.id,"used-columns");if(setColumns===false){var setColumns=__self.control.dataSet.getDefaultFields();if(!setColumns)setColumns=""}if(setColumns.length){var arrCols=setColumns.split("|");for(var i=0;i<arrCols.length;i++){var info=arrCols[i];var colName=arrCols[i];var colParams=[];var offset=info.indexOf('[');if(offset){colName=info.substring(0,offset);colParams=info.substring(offset+1,info.length-1).split(',')}usedColumns[colName]={'name':colName,'params':colParams}}}if(!usedColumns['name']){usedColumns['name']={'name':'name','params':['250px']}}__self.control.usedColumns=usedColumns;return usedColumns};var __setUsedColumns=function(){var usedColumns=__getUsedColumns();var cols=[];for(name in usedColumns){var col=usedColumns[name];if(!col)continue;cols[cols.length]=name+'['+col.params.join(',')+"]"}Settings.set(__self.control.id,cols.join('|'),"used-columns")};var __getColumnsMenu=function(){if(__self.control.columnsMenu)return __self.control.columnsMenu;var commonGroups=__self.control.dataSet.getCommonFields();var usedColumns=__getUsedColumns();var stopList=__self.control.dataSet.getFieldsStoplist();var ColumnsMenu={};__self.control.needColumnsMenu=false;var num=1,usedNum=0;for(var i=0;i<commonGroups.length;i++){num++;var groupFields=commonGroups[i].getElementsByTagName('field');var needSeparator=false;for(var j=0;j<groupFields.length;j++){var field=groupFields[j];var title=field.getAttribute('title');var fieldId=field.getAttribute('id');var name=field.getAttribute('name');var tnodes=field.getElementsByTagName('type');var dataType=tnodes[0].getAttribute('data-type');var guideId=field.getAttribute('guide-id');if(dataType=="symlink"||dataType=="password"||dataType=='wysiwyg'){continue}var deny=false;for(var s=0;s<stopList.length;s++){if(stopList[s]==name){deny=true;break}}if(deny)continue;__self.control.needColumnsMenu=true;var used=false;if(usedColumns[name])var used=true;ColumnsMenu[name]={'caption':title,'icon':used?'checked':'undefined','id':fieldId,'title':title,'fieldName':name,'dataType':dataType,'guideId':guideId,'checked':used,'execute':function(item){var mitm=item;item.checked?__self.removeColumn(item.fieldName):__self.appendColumn(item.fieldName);Control.recalcItemsPosition()}};num++;if(i<groupFields.length-1)needSeparator=true;if(used)usedNum++}if(needSeparator){ColumnsMenu[num+'-sep']='-'}}__self.control.columnsMenu=ColumnsMenu;return ColumnsMenu};this.resizeColumn=function(fieldName,size){var usedColumns=__getUsedColumns();var columnsMenu=__getColumnsMenu();var column=usedColumns[fieldName];if(!column)return false;for(var j=0;j<__self.childs.length;j++){var ch=__self.control.items[__self.childs[j]];if(ch)ch.resizeColumn(fieldName,size)}if(__self.isRoot){var el=document.getElementById('h_'+__self.control.id+'_'+fieldName);if(!el)return false;el.style.width=size+'px';el.firstChild.style.width=size+'px';usedColumns[fieldName].params[0]=size+'px';__self.control.usedColumns=usedColumns;__setUsedColumns();var fltr=document.getElementById('f_'+__self.control.id+'_'+fieldName);if(fltr){fltr.style.width=size+'px';if(fltr.firstChild){fltr.firstChild.style.width=size+'px'}}}else{var el=document.getElementById('c_'+__self.control.id+'_'+__self.id+'_'+fieldName);if(!el)return false;if(!flatMode&&fieldName=="name")size-=20*(__self.level-1);el.style.width=size+'px';el.firstChild.style.width=size+'px'}return true};this.startResizeColumn=function(fieldName,evnt){var columnEl=document.getElementById('h_'+this.control.id+'_'+fieldName);if(!columnEl)return false;var cHeight=this.control.initContainer.offsetHeight;var cpos=$(this.control.initContainer).position();var colPos=$(columnEl).position();colPos.left-=this.control.initContainer.scrollLeft;var colWidth=columnEl.offsetWidth;var colRightPos=colPos.left+colWidth;var resizer=document.createElement('div');resizer.className='resizer';$(resizer).css({'z-index':1,'position':'absolute','width':'1px','height':cHeight,'borderLeft':'1px dotted #CCC','top':colPos.top+cpos.top,'left':colRightPos+cpos.left});var deltaX=colRightPos-evnt.clientX;resizer.style.left=deltaX+'px';var newColWidth=colWidth;var onMouseMove=function(mEvent){try{document.body.style['-moz-user-select']='none';document.body.style['-khtml-user-select']='none';document.body.onselectstart=function(){return false};document.selection.empty()}catch(err){}var mX=mEvent.clientX+deltaX;newColWidth=colWidth+mX-colRightPos;if(newColWidth>TableItem.maxColumnWidth)newColWidth=TableItem.maxColumnWidth;if(newColWidth<TableItem.minColumnWidth)newColWidth=TableItem.minColumnWidth;resizer.style.left=cpos.left+colPos.left+newColWidth+'px'};var onMouseUp=function(event){$(document).unbind("mousemove",onMouseMove);$(document).unbind("mouseup",onMouseUp);document.body.removeChild(resizer);if(newColWidth!=colWidth){__self.resizeColumn(fieldName,newColWidth);Control.recalcItemsPosition()}};$(document).bind('mousemove',onMouseMove);$(document).bind('mouseup',onMouseUp);document.body.appendChild(resizer)};this.appendColumn=function(fieldName){var usedColumns=__getUsedColumns();var columnsMenu=__getColumnsMenu();var column=columnsMenu[fieldName];if(!column||usedColumns[fieldName])return false;for(var j=0;j<__self.childs.length;j++){var ch=__self.control.items[__self.childs[j]];if(ch)ch.appendColumn(fieldName)}if(__self.isRoot){var col=document.createElement('th');col.className='column';col.setAttribute("id",'h_'+__self.control.id+'_'+fieldName);col.setAttribute("name",name);col.name=fieldName;col.width='100px';var header=document.createElement('div');header.title=column.title;header.innerHTML='&nbsp;&nbsp;&nbsp;&nbsp;'+column.title;col.appendChild(header);var resizer=document.createElement('span');resizer.onmousedown=function(event){if(!event)event=window.event;__self.startResizeColumn(fieldName,event)};header.appendChild(resizer);__self.element.firstChild.insertBefore(col,__self.element.firstChild.lastChild);usedColumns[fieldName]={'name':fieldName,'params':['100px']};__self.control.usedColumns=usedColumns;columnsMenu[fieldName].checked=true;columnsMenu[fieldName].icon='checked';__self.control.columnsMenu=columnsMenu;var colFltr=document.createElement('th');colFltr.setAttribute("id",'f_'+__self.control.id+'_'+fieldName);colFltr.style.width=usedColumns[fieldName]['params'][0];__self.control.onDrawFieldFilter(columnsMenu[fieldName],colFltr,usedColumns[fieldName].params);filterRow.insertBefore(colFltr,filterRow.lastChild);var pgBar=document.getElementById('pb_'+__self.control.id+'_'+__self.id);if(pgBar)pgBar.colSpan+=1;__setUsedColumns();__toggleFilterRow()}else{var col=document.createElement('td');col.id='c_'+__self.control.id+'_'+__self.id+'_'+fieldName;col.style.width='100px';col.className='column';col.name=fieldName;var val=__self.getValue(fieldName);col.innerHTML='<div>'+val+'</div>';__self.element.insertBefore(col,__self.element.lastChild);__self.childsContainer.parentNode.parentNode.colSpan+=1;new editableCell(__self,col,column)}return true};this.removeColumn=function(fieldName){var usedColumns=__getUsedColumns();var columnsMenu=__getColumnsMenu();var column=columnsMenu[fieldName];if(!column||!usedColumns[fieldName])return false;for(var j=0;j<__self.childs.length;j++){var ch=__self.control.items[__self.childs[j]];if(ch)ch.removeColumn(fieldName)}if(__self.isRoot){var el=document.getElementById('h_'+__self.control.id+'_'+fieldName);if(!el)return false;el.parentNode.removeChild(el);var fCell=document.getElementById('f_'+__self.control.id+'_'+fieldName);if(fCell){fCell.parentNode.removeChild(fCell)}var usedCols={};for(var name in usedColumns){if(name==fieldName)continue;usedCols[name]=usedColumns[name]}__self.control.usedColumns=usedCols;columnsMenu[fieldName].checked=false;columnsMenu[fieldName].icon='undefined';__self.control.columnsMenu=columnsMenu;__self.control.onRemoveColumn(column);__self.childsContainer.parentNode.parentNode.colSpan-=1;var pgBar=document.getElementById('pb_'+__self.control.id+'_'+__self.id);if(pgBar)pgBar.colSpan-=1;__setUsedColumns();__toggleFilterRow()}else{var el=document.getElementById('c_'+__self.control.id+'_'+__self.id+'_'+fieldName);if(!el)return false;el.parentNode.removeChild(el);__self.childsContainer.parentNode.parentNode.colSpan-=1}return true};var __toggleFilterRow=function(){var usedColumns=__getUsedColumns();var columnsMenu=__getColumnsMenu();var i=0;for(var name in usedColumns){var column=columnsMenu[name];var params=usedColumns[name]['params'];if(params[1]=='static'){column=usedColumns[name];column.title=getLabel('js-smc-'+name)}if(!column)continue;i++}if(filterRow){filterRow.style.display=(i>0)?'':'none'}};var __drawRoot=function(){var usedColumns=__getUsedColumns();var columnsMenu=__getColumnsMenu();var possibleColumnsCount=0,usedColumnsCount=0;for(var i in columnsMenu){++possibleColumnsCount}var tHead=document.createElement('thead');{tHead.setAttribute('name',__self.control.id);var hRow=document.createElement('tr');hRow.className='header-row';filterRow=document.createElement('tr');filterRow.className='filter-row';{var getResizeCallback=function(fieldName){return function(event){if(!event)event=window.event;__self.startResizeColumn(fieldName,event);return true}};var cVoid=document.createElement('th');cVoid.colspan="1";cVoid.className='void';var nameColumn=usedColumns['name'];var cName=document.createElement('th');cName.className='column';cName.setAttribute("id",'h_'+__self.control.id+'_name');cName.setAttribute("name",'name');cName.name='name';cName.style.width=nameColumn['params'][0];var header=document.createElement('div');header.style.width=nameColumn['params'][0];header.innerHTML='&nbsp;&nbsp;&nbsp;&nbsp;'+getLabel('js-smc-name-column');header.title=getLabel('js-smc-name-column');var resizer=document.createElement('span');resizer.onmousedown=getResizeCallback('name');header.appendChild(resizer);cName.appendChild(header);if(!flatMode){hRow.appendChild(cVoid);filterRow.appendChild(cVoid.cloneNode(true));filterRow.firstChild.className='filter-void'}hRow.appendChild(cName);var cNameFltr=document.createElement('th');cNameFltr.setAttribute("id",'f_'+__self.control.id+'_name');cNameFltr.style.width=nameColumn['params'][0];__self.control.onDrawFieldFilter('name',cNameFltr,nameColumn.params);filterRow.appendChild(cNameFltr);var colSpan=2;for(var name in usedColumns){var column=columnsMenu[name];var params=usedColumns[name]['params'];if(params[1]=='static'){column=usedColumns[name];column.title=getLabel('js-smc-'+name)}if(!column)continue;colSpan++;var col=document.createElement('th');col.className='column';col.setAttribute("id",'h_'+__self.control.id+'_'+name);col.setAttribute("name",name);col.style.width=usedColumns[name]['params'][0];col.name=name;var header=document.createElement('div');header.style.width=usedColumns[name]['params'][0];header.title=column.title;header.innerHTML='&nbsp;&nbsp;&nbsp;&nbsp;'+column.title;col.appendChild(header);var resizer=document.createElement('span');resizer.onmousedown=getResizeCallback(name);header.appendChild(resizer);hRow.appendChild(col);var colFltr=document.createElement('th');colFltr.setAttribute("id",'f_'+__self.control.id+'_'+name);colFltr.style.width=usedColumns[name]['params'][0];__self.control.onDrawFieldFilter(column,colFltr,usedColumns[name].params);filterRow.appendChild(colFltr);++usedColumnsCount}var autoCol=document.createElement('th');autoCol.style.width='auto';filterRow.appendChild(autoCol.cloneNode(true));if(!__self.control.objectTypesMode&&__self.control.needColumnsMenu){var invokeBtn=document.createElement('div');invokeBtn.className='invoke-btn';autoCol.appendChild(invokeBtn);$(invokeBtn).bind("click",function(event){$.cmenu.lockHiding=true;$.cmenu.show($.cmenu.getMenu(__self.control.columnsMenu),__self.control.initContainer.offsetParent,event);return});$(invokeBtn).bind('mousedown',function(event){if(event.altKey){$.cmenu.lockHiding=true;$.cmenu.show($.cmenu.getMenu(__self.control.columnsMenu),__self.control.initContainer.offsetParent,event);return}});$(invokeBtn).bind('mouseout',function(){$.cmenu.lockHiding=false})}hRow.appendChild(autoCol)}tHead.appendChild(hRow);if(!__self.control.objectTypesMode)tHead.appendChild(filterRow);__toggleFilterRow()}$(tHead).bind("click",function(event){var el=event.target;if(el.parentNode.tagName.toUpperCase()!='TH')return;TableItem.orderByColumn(el.parentNode.name,__self.control,el)});var tBody=document.createElement('tbody');tBody.className="table-container";var pagesRow=document.createElement('tr');pagesRow.style.display='none';{pagesBar=document.createElement('td');pagesBar.id='pb_'+__self.control.id+'_'+__self.id;pagesBar.className='pages-bar';if(!flatMode)colSpan++;pagesBar.colSpan=colSpan;pagesRow.appendChild(pagesBar);tBody.appendChild(pagesRow)}__self.element=__self.control.container.appendChild(tHead);__self.childsContainer=__self.control.container.appendChild(tBody);__self.control.initContainer=__self.control.container;__self.control.container=__self.childsContainer;if(flatMode&&!objectTypesMode){var exportCallback=function(){var link=__self.getExportLink();window.location=link};var importCallback=function(){var link=__self.getImportLink();__self.callCsvImport(link);return false};__self.showCsvButtons(exportCallback,importCallback)}__self.expand()};this.showCsvButtons=function(exportCallback,importCallback){if(this.control.disableCSVButtons)return;__self.hideCsvButtons();var csvButtons=document.createElement('div');csvButtons.id='csv-buttons';var aExportCsv=document.createElement('a');aExportCsv.appendChild(document.createTextNode(getLabel('js-csv-export')));aExportCsv.href="#";aExportCsv.className="csvLink csvExport";aExportCsv.onclick=exportCallback;csvButtons.appendChild(aExportCsv);if(!this.control.hideCsvImportButton){var aImportCsv=document.createElement('a');aImportCsv.appendChild(document.createTextNode(getLabel('js-csv-import')));aImportCsv.href="#";aImportCsv.className="csvLink csvImport";aImportCsv.onclick=importCallback;csvButtons.appendChild(aImportCsv)}__self.control.container.parentNode.parentNode.appendChild(csvButtons);__self.csvButtons=csvButtons};this.hideCsvButtons=function(){if(__self.csvButtons){$(__self.csvButtons).remove();__self.csvButtons=false}$('#csv-buttons').remove()};this.getExportLink=function(elementId){var usedColumns=__getUsedColumns();var filterQueryString=this.control.getCurrentFilter().getQueryString();var link=document.location['pathname']+filterQueryString+"&xmlMode=force&export=csv";for(var i in usedColumns){var columnName=usedColumns[i]['name'];if(columnName!="name"){link+="&used-fields[]="+columnName}}if(elementId){link+="&rel[]="+elementId}return link};this.getImportLink=function(elementId){var filterQueryString=this.control.getCurrentFilter().getQueryString();var link=document.location['pathname'];link+=filterQueryString+"&xmlMode=force&import=csv";if(elementId){link+="&rel[]="+elementId}return link};this.callCsvImport=function(link){var html="<form method='post' id='import-csv-form' enctype='multipart/form-data' action='"+link+"' mime-type='text/html'";html+=" target='import-iframe'>";html+="<label for='csv-file'>"+getLabel('js-csv-import-question')+"</label> ";html+="<input type='file' name='csv-file' id='csv-file' size='28' />";html+="</form>";html+="<iframe name='import-iframe' id='import-iframe' src='' style='display: none;'></iframe>";window.csvQuickImportCallback=function(){if(__self.id){__self.ignoreEmptyFilter=false;__self.control.dataSet.refresh(__self.id)}else{__self.ignoreEmptyFilter=true;__self.control.applyFilter(__self.control.getCurrentFilter())}closeDialog()};openDialog({text:html,OKText:getLabel('js-csv-import-button'),OKCallback:function(){$("#import-csv-form").submit();return false}})};var __autoExpandSelf=function(){if(AutoexpandAllowed&&__self===Control.HandleItem){__self.expand()}};this.draw=function(){if(_oParent){if(!ForceDraw)__draw(Parent.childsContainer)}else{if(!ForceDraw)__drawRoot()}};this.appendChild=function(_oChildData){return new TableItem(this.control,__self,_oChildData)};this.appendAfter=function(_oChildData,oItem){return new TreeItem(this.control,__self,_oChildData,oItem,'after')};this.appendBefore=function(_oChildData,oItem){return new TreeItem(this.control,__self,_oChildData,oItem,'before')};this.appendFirst=function(_oChildData){if(!this.childsContainer.childNodes.length){return this.appendChild(_oChildData)}else if(typeof(this.childsContainer.childNodes[0].rel)!='undefined'){return this.appendBefore(_oChildData,this.control.getItem(this.childsContainer.childNodes[0].rel))}};this.getPreviousSibling=function(){var prevEl=this.element.previousSibling;if(prevEl&&prevEl.rel){return this.control.getItem(prevEl.rel)}return null};this.getNextSibling=function(){var prevEl=this.element.nextSibling;if(prevEl&&prevEl.rel){return this.control.getItem(prevEl.rel)}return null};this.clear=function(){if(this.isRoot){this.element.parentNode.innerHTML=''}else if(this.element.parentNode){this.element.parentNode.removeChild(this.element.nextSibling);this.element.parentNode.removeChild(this.element)}};this.checkIsChild=function(oItem){var parent=this.parent;while(parent){if(oItem===parent)return true;parent=parent.parent}return false};this.recalcPosition=function(){if(__self.isRoot){return false}try{var parent=this.parent;while(parent){if(!parent.isExpanded){this.position=false;return false}parent=parent.parent}var container=this.control.getRoot().childsContainer;var pos=$(labelCtrl).position();this.position={'left':pos.left,'top':pos.top,'right':pos.left+container.offsetWidth,'bottom':pos.top+$(labelCtrl).height()};return this.position}catch(e){this.position=false;return false}};this.setLoaded=function(loaded){this.loaded=loaded;var ico=loaded?IconsPath+'collapse.png':IconsPath+'expand.png';if(toggleCtrl)toggleCtrl.setAttribute('src',IconsPath+'collapse.png')};var __renderProperty=function(propEl){if(!propEl)return"";if(!propEl['type'])return"";var val="";var _v=function(el,def){return el.value._value||(el.value||(def||''))};switch(propEl['type']){case"int":case"float":case"price":case"counter":val=_v(propEl,0);break;case"tags":case"string":val=_v(propEl);if(typeof val=="array"){var tmp=val.join(", ");val=tmp}if(/http:\/\//.test(val)){val="<a href=\""+val+"\" title=\""+val+"\" class=\"link\">"+val+"</a>"}else{val='<span title="'+val+'">'+val+'</span>'}break;case"text":{val=_v(propEl);if(val){val='<span title="'+val+'">'+val.substring(0,255)+'</span>'}break}case"boolean":val=_v(propEl,false)?'<img alt="" style="width:13px;height:13px;" src="/images/cms/admin/mac/tree/checked.png" />':'';break;case"img_file":val=propEl.value;if(val){var ext=val.ext;var src=val._value;var path=src.substring(0,src.lastIndexOf('.'));var thumbSrc="/autothumbs.php?img="+path+'_sl_180_120.'+ext;var filename="";if(typeof src=="string"){var tmp=src.split(/\//);filename=tmp[tmp.length-1]}val='<img alt="" style="width:13px;height:13px;" src="/images/cms/image.png" onmouseover="TableItem.showPreviewImage(event, \''+thumbSrc+'\')" />';if(filename){val+='&nbsp;&nbsp;<span title=\"'+src+'\">'+filename+"</span>"}}break;case"file":val=propEl.value;if(val){var src=val._value;val=src?('<span title="'+src+'">'+src+'</span>'):''}break;case"relation":var o=_v(propEl,null);if(o){if(o.item[0]){for(var i=0;i<o.item.length;i++){val+=o.item[i].name;if(i<o.item.length-1)val+=', '}}else{val=o.item.name}val='<span title="'+val+'">'+val+'</span>'}break;case"date":val=_v(propEl,null);if(val){var dt=new Date(val);var hours=dt.getHours();var minutes=dt.getMinutes();var year=dt.getFullYear();var month=dt.getMonth()+1;var day=dt.getDate();hours=(hours>=10)?hours:"0"+hours;minutes=(minutes>=10)?minutes:"0"+minutes;month=(month>=10)?month:"0"+month;day=(day>=10)?day:"0"+day;val=day+"."+month+"."+year+" "+hours+":"+minutes}else{val=""}break;default:return"";break}return val};this.getValue=function(fieldName){var usedColumns=__getUsedColumns();var col=usedColumns[fieldName];if(fieldName=='name'){return this.control.onGetValueCallback(this.name,fieldName,this)}if(col){if(col.params[1]=='static')return this.control.onGetValueCallback(col,fieldName,this)}if(!Data['properties'])return'';if(!Data['properties']['group'])return'';var Groups=typeof(Data['properties']['group'][0])!='undefined'?Data['properties']['group']:[Data['properties']['group']];for(var i=0;i<Groups.length;i++){if(!Groups[i]['property'])continue;var Props=typeof(Groups[i]['property'][0])!='undefined'?Groups[i]['property']:[Groups[i]['property']];for(var j=0;j<Props.length;j++){if(Props[j]['name']==fieldName){Props[j]=this.control.onGetValueCallback(Props[j],fieldName,this);return __renderProperty(Props[j])}}}return''};this.getData=function(){return Data};this.setPageing=function(pageing){if(!pageing||!pagesBar)return false;this.pageing=pageing;pagesBar.parentNode.style.display='none';pagesBar.innerHTML='';pagesBar.style.textAlign='left';if(pageing.total==0){pagesBar.parentNode.style.display='';var emptyResult=document.createElement('span');emptyResult.className='empty-result';if(this.isRoot){pagesBar.style.textAlign='center'}emptyResult.appendChild(document.createTextNode(getLabel('js-smc-empty-result')));pagesBar.appendChild(emptyResult)}if(pageing.total>pageing.limit){var pagesLabel=document.createElement('span');pagesLabel.appendChild(document.createTextNode(getLabel('js-pages-label')));pagesLabel.className='pagesLabel';pagesBar.appendChild(pagesLabel);pagesBar.parentNode.style.display='';var pages=Math.ceil(pageing.total/pageing.limit);var curr_page=Math.ceil(pageing.offset/pageing.limit);var getCallback=function(page){return function(){__self.filter.setPage(page);__self.applyFilter(__self.filter,true);return false}};var skippedPrevious=false;for(var i=0;i<pages;i++){if(i!=0&&i!=(Math.ceil(pageing.total/pageing.limit)-1)){if(Math.abs(i-curr_page)>15){if(!skippedPrevious){var nextPage=document.createElement('a');nextPage.href="#";if(curr_page==i){nextPage.className='current'}nextPage.innerHTML="&#8230;";nextPage.className='current';nextPage.onclick=function(){return false};pagesBar.appendChild(nextPage)}skippedPrevious=true;continue}}skippedPrevious=false;var nextPage=document.createElement('a');nextPage.href="#";if(curr_page==i){nextPage.className='current'}nextPage.innerHTML=i+1;nextPage.onclick=getCallback(i);pagesBar.appendChild(nextPage)}}};this.expand=function(){if(!this.hasChilds)return false;this.isExpanded=true;if(!this.loaded){this.loaded=true;this.control.load(this.filter);if(toggleCtrl)toggleCtrl.setAttribute('src',IconsPath+'loading.gif')}else{if(toggleCtrl)toggleCtrl.setAttribute('src',IconsPath+'collapse.png')}this.childsContainer.parentNode.parentNode.parentNode.style.display='';if(this.loaded)Control.recalcItemsPosition();this.control.saveItemState(this.id)};this.collapse=function(){if(!this.hasChilds)return false;this.isExpanded=false;if(toggleCtrl)toggleCtrl.setAttribute('src',IconsPath+'expand.png');this.childsContainer.parentNode.parentNode.parentNode.style.display='none';Control.recalcItemsPosition();this.control.saveItemState(this.id)};this.toggle=function(){if(this.hasChilds){this.isExpanded?this.collapse():this.expand()}};this.update=function(_oNewData){if(_oNewData){if(this.id!=_oNewData.id)return false;Data=_oNewData;if(typeof(_oNewData['template-id'])!=='undefined')this.templateId=_oNewData['template-id'];if(typeof(_oNewData['link'])!=='undefined'&&_oNewData['link']!=this.viewLink){this.viewLink=_oNewData['link'];labelCtrl.setAttribute('href',this.viewLink)}if(typeof(_oNewData['childs'])!=='undefined'&&parseInt(_oNewData['childs'])!==CountChilds){CountChilds=parseInt(_oNewData['childs']);this.hasChilds=CountChilds>0||id==0;var tsrc=IconsPath+'collapse-disabled.png';if(this.hasChilds){tsrc=this.isExpanded?IconsPath+'collapse.png':IconsPath+'expand.png'}if(toggleCtrl)toggleCtrl.setAttribute('src',tsrc)}var newActive=typeof(_oNewData['is-active'])!=='undefined'?parseInt(_oNewData['is-active']):0;if(newActive!==this.isActive){this.isActive=newActive;this.isActive=isObjectActivated(this,this.isActive);if(!this.isActive&&!__self.control.objectTypesMode){if(!__self.control.flatMode){$(itemIcon).fadeTo(300,0.5);$(toggleCtrl).fadeTo(300,0.5)}$(labelText).fadeTo(300,0.5)}else{if(!__self.control.flatMode&&!__self.control.objectTypesMode){$(itemIcon).fadeTo(300,1);$(toggleCtrl).fadeTo(300,1)}$(labelText).fadeTo(300,1)}}if(typeof(_oNewData['name'])!=='undefined'&&_oNewData['name']!=this.name){this.name=_oNewData['name'].length?_oNewData['name']:"";labelText.innerHTML=this.name.length?this.name:getLabel('js-smc-noname-page')}}};this.applyFilter=function(_Filter,ignoreHierarchy){if(_Filter instanceof Object){this.filter=_Filter}else{this.filter.clear()}if(!ignoreHierarchy)this.filter.setParentElements(id);if(this.loaded){this.control.removeItem(id,true);this.loaded=false;if(this.isExpanded)this.expand()}if(this.isRoot){if(this.control.getCurrentFilter().empty()&&!this.ignoreEmptyFilter&&!(this.control.flatMode&&!this.control.objectTypesMode)){}else{var exportCallback=function(){var link=__self.getExportLink();if(__self.control.contentType=='pages'){link+="&force-hierarchy=1"}window.location=link};var importCallback=function(){var link=__self.getImportLink();if(__self.control.contentType=='pages'){link+="&force-hierarchy=1"}link+="&rnd="+Math.round(Math.random()*1000%1000);__self.callCsvImport(link);return false};if(this.control.contentType!='objectTypes'){__self.showCsvButtons(exportCallback,importCallback)}}}};this.setSelected=function(_selected){if(_selected){if(!oldClassName){oldClassName='ti';labelCtrl.className='ti selected-highlight'}selected=true}else{if(oldClassName){labelCtrl.className=oldClassName;oldClassName=null}selected=false}};this.getSelected=function(){return selected};__constructor()};TableItem.minColumnWidth=110;TableItem.maxColumnWidth=800;TableItem.orderByColumn=function(_FieldName,_Control,_ColumnEl){if(!_Control||!_FieldName||!_ColumnEl)return false;var direction="asc";if(_Control.orderColumn===_ColumnEl){direction=_ColumnEl.className=="asc"?"desc":"asc";_ColumnEl.className=direction}else{if(_Control.orderColumn){_Control.orderColumn.className=''}_Control.orderColumn=_ColumnEl;_Control.orderColumn.className=direction}var defFilter=_Control.dataSet.getDefaultFilter();defFilter.setOrder(_FieldName,direction);_Control.dataSet.setDefaultFilter(defFilter);_Control.applyFilter()};TableItem.showPreviewImage=function(event,src){if(!event||!src)return;var el=event.target;var x=event.pageX;var y=event.pageY;var img=document.createElement('img');img.setAttribute('src',src);img.src=src;img.className='img-fieled-preview';img.style.position='absolute';img.style.width='180px';img.style.height='120px';img.style.top=y+10+'px';img.style.left=x+10+'px';img.style.border='1px solid #666';document.body.appendChild(img);el.onmouseout=function(){img.parentNode.removeChild(img)}};var TreeToolbar=function(_oControl){var __self=this;var Control=_oControl;var HandleItem=null;var cDepth=parseInt(Control.container.style.zIndex)||0;var IconsPath=Control.iconsPath;var DataSet=Control.dataSet;this.highlight=null;this.element=null;this.buttons=new Array();var __drawButtons=function(){var btns=document.createElement('div');btns.style.position='absolute';btns.style.display='none';btns.className='tree_toolbar';__appendButton(btns,{name:'ico_del',hint:getLabel('js-del-str'),init:function(button){var e=button.element;if(HandleItem!==null&&HandleItem.permissions&8){var icon=IconsPath+'ico_del.png';var hint=getLabel('js-del-str');if(HandleItem.lockedBy){var locker=HandleItem.lockedBy;var lname=typeof(locker['lname'])=='string'?locker['lname']:'';var fname=typeof(locker['lname'])=='string'?locker['fname']:'';icon=IconsPath+'ico_locked.png';hint=getLabel('js-page-is-locked')}e.setAttribute('title',hint);e.style.background="url('"+icon+"') no-repeat";e.setAttribute('href','#');e.style.visibility='visible'}else{e.style.visibility='hidden'}},release:function(button){if(HandleItem!==null){if(HandleItem.lockedBy){alert(getLabel('js-page-is-locked'))}else{DataSet.execute('tree_delete_element',{'childs':1,'element':HandleItem.id,'handle_item':HandleItem})}}return false}});__appendButton(btns,{name:'ico_add',hint:getLabel('js-add-subpage'),init:function(button){if(HandleItem!==null&&HandleItem.createLink!==false&&(HandleItem.permissions&&HandleItem.permissions&4||!HandleItem.permissions)){button.element.setAttribute('href',HandleItem.createLink);button.element.style.visibility='visible'}else{button.element.style.visibility='hidden'}}});__appendButton(btns,{name:'ico_edit',hint:getLabel('js-edit-page'),init:function(button){var e=button.element;if(HandleItem!==null&&HandleItem.editLink!==false&&HandleItem.permissions&2){var icon=IconsPath+'ico_edit.png';var hint=getLabel('js-edit-page');var href=HandleItem.editLink;if(HandleItem.lockedBy){var locker=HandleItem.lockedBy;var lname=typeof(locker['lname'])=='string'?locker['lname']:'';var fname=typeof(locker['lname'])=='string'?locker['fname']:'';icon=IconsPath+'ico_locked.png';hint=getLabel('js-page-is-locked');href='#'}e.setAttribute('title',hint);e.style.background="url('"+icon+"') no-repeat";e.setAttribute('href',href);e.style.visibility='visible'}else{e.style.visibility='hidden'}},release:function(button){if(HandleItem!==null){if(HandleItem.lockedBy){alert(getLabel('js-page-is-locked'));return false}}return true}});__appendButton(btns,{name:'blocking',hint:getLabel('js-disable-page'),icon:IconsPath+'ico_block.png',init:function(button){if(HandleItem!==null&&HandleItem.allowActivity){var icon=HandleItem.isActive?IconsPath+'ico_unblock.png':IconsPath+'ico_block.png';var hint=HandleItem.isActive?getLabel('js-disable-page'):getLabel('js-enable-page');button.element.style.background="url('"+icon+"') no-repeat";button.element.setAttribute('href','#');button.element.setAttribute('title',hint);button.element.style.visibility='visible'}else{button.element.style.visibility='hidden'}},release:function(button){if(HandleItem!==null){var icon=HandleItem.isActive?IconsPath+'ico_block.png':IconsPath+'ico_unblock.png';var hint=HandleItem.isActive?getLabel('js-enable-page'):getLabel('js-disable-page');button.element.setAttribute('title',hint);button.element.style.background="url('"+icon+"') no-repeat";DataSet.execute('tree_set_activity',{'element':HandleItem.id,'active':HandleItem.isActive?0:1,'handle_item':HandleItem})}return false}});__appendButton(btns,{name:'copy',hint:getLabel('js-vcopy-str'),init:function(button){if(HandleItem!==null&&HandleItem.allowCopy){button.element.style.visibility='visible'}else{button.element.style.visibility='hidden'}},release:function(button){if(HandleItem!==null){HandleItem.className='ti virtual';if(HandleItem.isDefault)HandleItem.labelControl.className+=' main-page';HandleItem.isVirtualCopy=true;DataSet.execute('tree_copy_element',{'element':HandleItem.id,'childs':1,'links':1,'virtuals':1,'permissions':1,'handle_item':HandleItem,'copy_all':0})}return false}});__appendButton(btns,{name:'clone',hint:getLabel('js-copy-str'),init:function(button){if(HandleItem!==null&&HandleItem.allowCopy){button.element.style.visibility='visible'}else{button.element.style.visibility='hidden'}},release:function(button){if(HandleItem!==null){DataSet.execute('tree_copy_element',{'element':HandleItem.id,'childs':1,'links':1,'permissions':1,'handle_item':HandleItem,'copy_all':0,'clone_mode':1})}return false}});__appendButton(btns,{name:'view',hint:getLabel('js-view-page'),init:function(button){if(HandleItem!==null&&HandleItem.viewLink!==false){button.element.setAttribute('href',HandleItem.viewLink);button.element.style.visibility='visible'}else{button.element.style.visibility='hidden'}}});__self.element=document.body.appendChild(btns)};var __initButtons=function(){for(var i=0;i<__self.buttons.length;i++){__self.buttons[i].init(__self.buttons[i])}};var __appendButton=function(container,options){var b=document.createElement('a');var name=options.name||'toolbtn';var href=options.href||'#';var icon=options.icon||IconsPath+name+".png";var init=options.init||function(){};var title=options.hint||'';var el=container.appendChild(b);var button={'name':name,'href':href,'icon':icon,'init':init,'element':el};__self.buttons[__self.buttons.length]=button;el.setAttribute('href',href);el.setAttribute('title',title);el.className=options.className||'tree_toolbtn';if(typeof(options.release)==='function'){el.onclick=function(){if(!DataSet.isAvailable())return false;return options.release(button)}}else{el.onclick=function(){if(!DataSet.isAvailable())return false;if(HandleItem.focus)HandleItem.focus();return true}}el.name=name;el.style.background="url('"+icon+"') no-repeat"};var __draw=function(){var el=document.createElement('div');el.className='tree-highlight';el.style.display='none';el.style.position='absolute';el.style.zIndex=cDepth-1;__self.highlight=Control.container.appendChild(el);__drawButtons()};this.show=function(_HandleItem,bForce){var bForce=bForce||false;if(typeof(_HandleItem)==='undefined'||(HandleItem===_HandleItem&&!bForce))return false;if(HandleItem){HandleItem.labelControl.className='ti';if(HandleItem.isDefault)HandleItem.labelControl.className+=' main-page'}HandleItem=_HandleItem;HandleItem.labelControl.className=HandleItem.getSelected()?'ti selected-highlight':'ti hightlight';if(HandleItem.isDefault)HandleItem.labelControl.className+=' main-page';__initButtons();var iroot=HandleItem.control.getRootNodeId();var container=HandleItem.control.initContainer;var cpos=$(container).position();this.element.style.top=HandleItem.position.top+cpos.top+'px';this.element.style.left=cpos.left+container.offsetWidth-230+'px';this.element.style.display=''};this.hide=function(){if(HandleItem){HandleItem.labelControl.className=HandleItem.getSelected()?'ti selected':(HandleItem.isVirtualCopy?'ti virtual':'ti');if(HandleItem.isDefault)HandleItem.labelControl.className+=' main-page';this.element.style.display='none';HandleItem=null}};if(typeof(Control)==='object'){__draw()}else{alert('Can\'t create toolbar without control object')}};var TableToolbar=function(_oControl){var __self=this;var Control=_oControl;var HandleItem=null;var cDepth=parseInt(Control.container.style.zIndex)||0;var IconsPath=Control.iconsPath;var DataSet=Control.dataSet;this.highlight=null;this.element=null;this.buttons=new Array();var __drawButtons=function(){var btns=document.createElement('div');btns.style.position='absolute';btns.style.display='none';btns.className='tree_toolbar';btns.style.width='160px';__appendButton(btns,{name:'ico_del',hint:getLabel('js-delete'),init:function(button){var e=button.element;var hint=getLabel('js-delete');if(HandleItem!==null&&(HandleItem.permissions&&HandleItem.permissions&8||!HandleItem.permissions)){var icon=IconsPath+'ico_del.png';e.setAttribute('title',hint);e.style.background="url('"+icon+"') no-repeat";e.setAttribute('href','#');e.style.visibility='visible'}else{e.style.visibility='hidden'}},release:function(button){if(HandleItem!==null){DataSet.execute('tree_delete_element',{'childs':1,'element':HandleItem.id,'handle_item':HandleItem})}return false}});__appendButton(btns,{name:'ico_edit',hint:getLabel('js-edit-item'),init:function(button){var e=button.element;if(HandleItem!==null&&HandleItem.editLink!==false&&(HandleItem.permissions&&HandleItem.permissions&2||!HandleItem.permissions)){var icon=IconsPath+'ico_edit.png';var hint=getLabel('js-edit-item');var href=HandleItem.editLink;e.setAttribute('title',hint);e.style.background="url('"+icon+"') no-repeat";e.setAttribute('href',href);e.style.visibility='visible'}else{e.style.visibility='hidden'}},release:function(button){return true}});if(!TableToolbar.disableAddButton){__appendButton(btns,{name:'ico_add',hint:getLabel('js-add-page'),init:function(button){if(HandleItem!==null&&HandleItem.createLink!==false){button.element.setAttribute('href',HandleItem.createLink);button.element.style.visibility='visible'}else{button.element.style.visibility='hidden'}}})}__appendButton(btns,{name:'blocking',hint:getLabel('js-disable-page'),icon:IconsPath+'ico_block.png',init:function(button){if(HandleItem!==null&&HandleItem.allowActivity&&HandleItem.viewLink!==false){var icon=HandleItem.isActive?IconsPath+'ico_unblock.png':IconsPath+'ico_block.png';var hint=HandleItem.isActive?getLabel('js-disable-page'):getLabel('js-enable-page');button.element.style.background="url('"+icon+"') no-repeat";button.element.setAttribute('href','#');button.element.setAttribute('title',hint);button.element.style.visibility='visible'}else{button.element.style.visibility='hidden'}},release:function(button){if(HandleItem!==null){var icon=HandleItem.isActive?IconsPath+'ico_block.png':IconsPath+'ico_unblock.png';var hint=HandleItem.isActive?getLabel('js-enable-page'):getLabel('js-disable-page');button.element.setAttribute('title',hint);button.element.style.background="url('"+icon+"') no-repeat";DataSet.execute('tree_set_activity',{'element':HandleItem.id,'active':HandleItem.isActive?0:1,'handle_item':HandleItem})}return false}});__appendButton(btns,{name:'view',hint:getLabel('js-view-page'),init:function(button){if(HandleItem!==null&&HandleItem.getData().guide=="guide"){button.element.setAttribute('href',window.pre_lang+"/admin/data/guide_items/"+HandleItem.id+"/");button.element.style.visibility='visible'}else if(HandleItem!==null&&HandleItem.viewLink!==false){button.element.setAttribute('href',HandleItem.viewLink);button.element.style.visibility='visible'}else{button.element.style.visibility='hidden'}}});__self.element=document.body.appendChild(btns)};var __initButtons=function(){for(var i=0;i<__self.buttons.length;i++){__self.buttons[i].init(__self.buttons[i])}};var __appendButton=function(container,options){var b=document.createElement('a');var name=options.name||'toolbtn';var href=options.href||'#';var icon=options.icon||IconsPath+name+".png";var init=options.init||function(){};var title=options.hint||'';var el=container.appendChild(b);var button={'name':name,'href':href,'icon':icon,'init':init,'element':el};__self.buttons[__self.buttons.length]=button;el.setAttribute('href',href);el.setAttribute('title',title);el.className=options.className||'tree_toolbtn';if(typeof(options.release)==='function'){el.onclick=function(){if(!DataSet.isAvailable())return false;return options.release(button)}}else{el.onclick=function(){if(!DataSet.isAvailable())return false;if(HandleItem.focus)HandleItem.focus();return true}}el.name=name;el.style.background="url('"+icon+"') no-repeat"};var __draw=function(){var el=document.createElement('div');el.className='tree-highlight';el.style.display='none';el.style.position='absolute';el.style.zIndex=cDepth-1;__self.highlight=Control.container.appendChild(el);__drawButtons()};this.show=function(_HandleItem,bForce){var bForce=bForce||false;if(typeof(_HandleItem)==='undefined'||(HandleItem===_HandleItem&&!bForce))return false;if(HandleItem){HandleItem.labelControl.className='ti'}HandleItem=_HandleItem;HandleItem.labelControl.className=HandleItem.getSelected()?'ti selected-highlight':'ti hightlight';__initButtons();var iroot=HandleItem.control.getRootNodeId();var container=HandleItem.control.initContainer.parentNode;var cpos=$(container).position();this.element.style.top=HandleItem.position.top+cpos.top+'px';this.element.style.left=container.offsetWidth-160+'px';this.element.style.display=''};this.hide=function(){if(HandleItem){HandleItem.labelControl.className=HandleItem.getSelected()?'ti selected':(HandleItem.isVirtualCopy?'ti virtual':'ti');this.element.style.display='none';HandleItem=null}};if(typeof(Control)==='object'){__draw()}else{alert('Can\'t create toolbar without control object')}};TableToolbar.disableAddButton=false;var Control=function(_oDataSet,_ItemClass,options){var __self=this;var DataSet=_oDataSet;var ItemClass=_ItemClass;var options=typeof(options)=='object'?options:{};var ForceDraw=typeof(options['draw'])=='boolean'?options['draw']:false;var ExpandAll=typeof(options['expandAll'])=='boolean'?options['expandAll']:false;var Toolbar=typeof(options['toolbar'])==='function'?options['toolbar']:false;var RootNodeId=null;var RootData=null;var CurrentFilter=new filter();var Settings=SettingsStore.getInstance();var SelectBehaviour=typeof(options['onItemClick'])==='function'?options['onItemClick']:function(){return true};var SelectCallback=typeof(options['onItemSelect'])==='function'?options['onItemSelect']:function(){return true};var TargetCallback=typeof(options['onTargetSelect'])==='function'?options['onTargetSelect']:function(){return true};Control.instances[Control.instances.length]=this;this.container=typeof(options['container'])=='object'?options['container']:document.body;this.dataSet=DataSet;this.toolbar=null;this.items={};this.id=options['id']||Math.random();this.iconsPath=options['iconsPath']||'/images/cms/admin/mac/tree/';this.flatMode=options['flatMode']||false;this.defaultRootMode=options['defaultRootMode']||false;this.objectTypesMode=options['objectTypesMode']||false;this.contentType=options['contentType']||'pages';this.enableObjectsActivity=options['enableObjectsActivity']||false;this.lastClicked=null;this.selectedList={};this.targetsList={};this.dragAllowed=typeof(options['allowDrag'])=='boolean'?options['allowDrag']:true;this.onGetValueCallback=typeof(options['onGetValueCallback'])==='function'?options['onGetValueCallback']:function(value,name,item){return value};this.onDrawFieldFilter=typeof(options['onDrawFieldFilter'])==='function'?options['onDrawFieldFilter']:function(field,th){return false};this.onRemoveColumn=typeof(options['onRemoveColumn'])==='function'?options['onRemoveColumn']:function(field){return false};this.initContainer=this.container;this.disableCSVButtons=options['disableCSVButtons']||false;this.hideCsvImportButton=options['hideCsvImportButton']||false;var __constructor=function(){if(ForceDraw){__self.init()}};var __DataSetInitComplete=function(){if(typeof(__self.items[RootNodeId])==='undefined'){__self.items[RootNodeId]=new ItemClass(__self,null,{'id':(RootNodeId?RootNodeId:0),'iconbase':'/images/cms/admin/mac/tree/ico_domain.png'})}__self.items[RootNodeId].draw();if(Toolbar){__self.toolbar=new Toolbar(__self)}if(__self.getItemState(RootNodeId)){__self.items[RootNodeId].expand()}};var __arraySearch=function(arrList,vVal){for(var i=0;i<arrList.length;i++){if(arrList[i]===vVal)return arrList[i]}return null};var __buildItems=function(arrNodes,oCurrItem,ignoreHirearchy){if(typeof(oCurrItem)!='object'||typeof(arrNodes)=='undefined')return false;if(!ignoreHirearchy)ignoreHierarchy=false;var currId=oCurrItem.id;for(var i=0;i<arrNodes.length;i++){var parentId=(typeof(arrNodes[i]['parentId'])!='undefined')?parseInt(arrNodes[i]['parentId']):0;if(parentId==currId||ignoreHirearchy){var newItemId=parseInt(arrNodes[i]['id']);if(__self.items[newItemId]){__self.items[newItemId].update(arrNodes[i])}else{__self.items[newItemId]=oCurrItem.appendChild(arrNodes[i]);if(ExpandAll||__self.getItemState(newItemId)){__self.items[newItemId].expand()}}__buildItems(arrNodes,__self.items[newItemId])}}};var __DataSetAfterLoad=function(arrParams){var arrObjs=arrParams['objects'];var oFilter=arrParams['filter'];var pageing=arrParams['paging'];var arrParents=oFilter.getParents();var ignoreHierarchy=false;if(!arrParents.length){arrParents=[(RootNodeId?RootNodeId:0)];ignoreHierarchy=true}for(var i=0;i<arrParents.length;i++){var parentId=parseInt(arrParents[i]);var parent=(typeof(__self.items[parentId])!='undefined')?__self.items[parentId]:__self.items[RootNodeId];__buildItems(arrObjs,parent,ignoreHierarchy);if(parent){parent.setLoaded(true);parent.setPageing(pageing)}}Control.recalcItemsPosition();if(Control.HandleItem){__self.toolbar.show(Control.HandleItem,true)}};var __DataSetBeforeRefresh=function(){__self.removeItem(RootNodeId);if(RootData){if(__self.initContainer)__self.container=__self.initContainer;var root=__self.setRootNode(RootData,true);root.draw()}Control.recalcItemsPosition()};var __DataSetAfterExecute=function(arrData){var arrObjs=arrData['objects'];var error=arrData['error'];var arrParams=arrData['params'];var pageing=arrParams['paging'];var hItem=arrParams['handle_item'];var selItems=arrParams['selected_items'];var items={};if(selItems){items=selItems}else if(hItem){items[hItem.id]=hItem}var method=arrData['method'];if(!error){switch(method.toLowerCase()){case'restore_element':case'tree_delete_element':{for(var id in items){var itm=items[id];__self.removeItem(id);delete __self.selectedList[id];if(itm.parent&&itm.parent.parent){__buildItems(arrObjs,itm.parent.parent)}}Control.HandleItem=null;if(__self.toolbar){__self.toolbar.hide()}break}case'export':{var i,res="";if(arrData.objects[0].file){window.location=arrData.objects[0].file}break}case"tree_move_element":{var receiver=arrParams['receiver_item'];var before=arrParams['before']?receiver.control.getItem(arrParams['before']):null;if(arrObjs.length&&hItem&&receiver){var itmData=arrObjs[0]||[];var newRelData=arrObjs[1]||[];var oldRelData=arrObjs[2]||[];if(hItem.parent)hItem.parent.update(oldRelData);receiver.update(newRelData);hItem.control.removeItem(hItem.id);var itm=null;if(arrParams['as-sibling']){if(before){itm=receiver.appendBefore(itmData,before)}else{itm=receiver.appendChild(itmData)}}else{if(receiver.loaded){itm=receiver.appendFirst(itmData)}}if(itm){receiver.control.items[itm.id]=itm}}break}default:{for(var id in items){var parentId=__self.items[id].parent;ignoreHierarchy=(!__self.items[parentId]);__buildItems(arrObjs,parentId,ignoreHierarchy)}}}if(__self.toolbar&&hItem===Control.HandleItem){__self.toolbar.show(Control.HandleItem,true)}Control.recalcItemsPosition();Control.PrepareDrag=false;Control.startDragItem=null;Control.PrepareDrag=false;Control.DragMode=false}else{alert(error)}};DataSet.addEventHandler('onAfterLoad',__DataSetAfterLoad);DataSet.addEventHandler('onAfterPieceLoad',__DataSetAfterLoad);DataSet.addEventHandler('onInitComplete',__DataSetInitComplete);DataSet.addEventHandler('onBeforeRefresh',__DataSetBeforeRefresh);DataSet.addEventHandler('onAfterExecute',__DataSetAfterExecute);this.initContainer.style.position='relative';this.init=function(){DataSet.init()};this.load=function(_oFilter,_bNeedDraw){DataSet.load(_oFilter)};this.getItemByPosition=function(mX,mY){var hItem=null;for(var id in this.items){if(!this.items[id])continue;var pos=this.items[id].position;if(mY>pos.top){if(mY<=pos.bottom){if(mX>pos.left){if(mX<=pos.right){hItem=this.items[id];break}}}}}return hItem};this.getItem=function(_ID){if(typeof(this.items[parseInt(_ID)])=='object'){return this.items[parseInt(_ID)]}else{return false}};this.setRootNode=function(_RootData,_skipLoad){RootData=_RootData;RootNodeId=_RootData['id'];this.items[RootNodeId]=new ItemClass(__self,null,_RootData);if(_skipLoad)this.items[RootNodeId].loaded=true;return this.items[RootNodeId]};this.getRootNodeId=function(){return RootNodeId};this.getRoot=function(){return this.items[RootNodeId]};this.applyBehaviour=function(Item){if(SelectBehaviour)return SelectBehaviour(Item);return true};this.saveItemState=function(_ID){var itemId=parseInt(_ID);if(this.items[itemId]){var itm=this.items[itemId];var expanded=Settings.get(__self.id,"expanded");var val="{"+itm.id+"}";if(typeof(expanded)!='string')expanded="";if(expanded.indexOf(val)!==-1&&!itm.isExpanded){expanded=expanded.replace(val,"");Settings.set(__self.id,expanded,"expanded");return true}else if(expanded.indexOf(val)===-1&&itm.isExpanded){expanded+=val;Settings.set(__self.id,expanded,"expanded");return true}else{return false}}};this.applyFilter=function(_oFilter){this.selectItems([]);if(_oFilter!=undefined&&(_oFilter instanceof Object)){CurrentFilter=_oFilter}if(!CurrentFilter)return;var hasTargets=false;for(var i in this.targetsList){this.targetsList[i].applyFilter(CurrentFilter.clone());hasTargets=true}if(!hasTargets)__self.items[RootNodeId].applyFilter(CurrentFilter.clone(),true)};this.getCurrentFilter=function(){return CurrentFilter};this.toggleItemSelection=function(_oItem){if(_oItem){if(_oItem.getSelected()){_oItem.setSelected();delete this.selectedList[_oItem.id];SelectCallback(_oItem,false)}else{_oItem.setSelected(true);this.selectedList[_oItem.id]=_oItem;SelectCallback(_oItem,true)}}};this.toggleRangeSelection=function(_oItem){if(_oItem){if(!this.lastClicked)return;var element=_oItem.element;var oldElement=this.lastClicked.element;var wrk=element.parentNode.firstChild;var last=null;var selList=[];while(wrk){if(!last&&wrk==element){last=oldElement}if(!last&&wrk==oldElement){last=element}if(last){selList.push(this.items[wrk.rel])}if(wrk==last)break;wrk=wrk.nextSibling}this.selectItems(selList)}};this.setSelectionCallback=function(_Callback,_Replace){if(typeof(_Callback)==='function'){if(_Replace){SelectCallback=_Callback}else{var h=SelectCallback;SelectCallback=function(a,b){h(a,b);_Callback(a,b)}}}};this.getSelectionCallback=function(){return SelectCallback};this.selectItems=function(Items){if(!(Items instanceof Array))Items=[Items];for(var i in this.selectedList)this.toggleItemSelection(this.selectedList[i]);this.selectedList=new Object;for(var i=0;i<Items.length;i++)this.toggleItemSelection(Items[i])};this.setTargetItems=function(Targets){this.targetsList={};for(var i in Targets)this.targetsList[i]=Targets[i];TargetCallback(this.targetsList)};this.isTarget=function(Item){for(var i in this.targetsList)if(this.targetsList[i]==Item)return true;return false};this.setTargetSelectCallback=function(_Callback){if(typeof(_Callback)==='function')TargetCallback=_Callback};this.getItemState=function(_ID){var itemId=parseInt(_ID);if(this.items[itemId]){var itm=this.items[itemId];if(!itm.hasChilds)return false;var expanded=Settings.get(__self.id,"expanded");var val="{"+itm.id+"}";if(typeof(expanded)!='string')expanded="";return(expanded.indexOf(val)!==-1)}};this.removeItem=function(_ID,keepSelf){var itemId=parseInt(_ID);if(this.items[itemId]){var itm=this.items[itemId];var parent=itm.parent;for(var j=0;j<itm.childs.length;j++){this.removeItem(itm.childs[j])}itm.childs=[];if(!keepSelf){this.items[itemId]=false;itm.clear()}}};this.expandAll=function(){ExpandAll=true;for(id in this.items){this.items[id].expand()}};this.collapseAll=function(){ExpandAll=false;for(id in this.items){this.items[id].collapse()}};this.recalcItemsPosition=function(){for(id in this.items){if(this.items[id])this.items[id].recalcPosition()}};__constructor()};Control.DragMode=false;Control.PrepareDrag=false;Control.startDragX=0;Control.startDragY=0;Control.startDragItem=null;Control.DragSensitivity=7;Control.HandleItem=null;Control.DraggableItem=null;Control.instances=new Array();Control.enabled=true;Control.getInstanceById=function(sId){for(var i=0;i<Control.instances.length;i++){if(Control.instances[i].id===sId)return Control.instances[i]}return null};Control.recalcItemsPosition=function(){for(var i=0;i<Control.instances.length;i++){Control.instances[i].recalcItemsPosition()}};Control.detectItemByMousePointer=function(x,y){var HandleItem=Control.HandleItem;if(HandleItem){var cpos=$(HandleItem.control.initContainer).position();var pos=HandleItem.position;if(y>pos.top+cpos.top&&y<=pos.bottom+cpos.top&&x>pos.left+cpos.left&&x<=pos.right+cpos.left){return HandleItem}}var hItem=null;for(var i=0;i<Control.instances.length;i++){var Inst=Control.instances[i];var cpos=$(Inst.initContainer).position();hItem=Inst.getItemByPosition(x-cpos.left,y-cpos.top);if(hItem)break}return hItem};Control.recalcSelectedItems=function(event){if(!Control.instances.length)return;if(Control.DragMode)return;if(!Control.enabled)return;var el=event.target;var tn=el.tagName.toLowerCase();if(tn=='textarea'||tn=='input'||tn=='select'||tn=='option')return;var x=event.pageX;var y=event.pageY;var hItem=Control.detectItemByMousePointer(x,y);Control.HandleItem=hItem;for(var i=0;i<Control.instances.length;i++){if(Control.instances[i].toolbar){Control.instances[i].toolbar.hide()}}if(hItem){var tshow=true;if(hItem.control.toolbar&&tshow){hItem.control.toolbar.show(hItem)}}};$(document).bind('mousemove',Control.recalcSelectedItems);$(document).bind('mousedown',function(event){Control.recalcSelectedItems(event);if(!Control.HandleItem)return;if(event.button!=0)return;if(!Control.enabled)return;var el=event.target;if(el.className.toLowerCase()!='ti-toggle'){Control.PrepareDrag=true;Control.startDragItem=Control.HandleItem;Control.startDragX=event.pageX;Control.startDragY=event.pageY}});$(document).bind('mouseup',function(event){if(!Control.enabled)return;if(!Control.DragMode&&Control.HandleItem){if(event.altKey){}else if(event.ctrlKey||event.metaKey){Control.HandleItem.control.toggleItemSelection(Control.HandleItem)}else if(event.shiftKey){Control.HandleItem.control.toggleRangeSelection(Control.HandleItem)}else{var el=event.target;if(el.className.toLowerCase()!='ti-toggle'){var doSelect=true;if(event.button==2){for(var i in Control.HandleItem.control.selectedList){if(Control.HandleItem.control.selectedList[i].id==Control.HandleItem.id)doSelect=false}}if(doSelect)Control.HandleItem.control.selectItems(Control.HandleItem)}}Control.HandleItem.control.lastClicked=Control.HandleItem}Control.PrepareDrag=false;Control.startDragItem=null;Control.DragMode=false});$(window).bind('resize',function(event){Control.recalcItemsPosition()});function createAddButton(oButton,oControl,sAddLink,aTypes){oButton.ControlInstance=oControl;var _SelectionCallback=function(){var Count=0;var id=null;var Allow=false;var i;for(i in oControl.selectedList){Count++;id=i}for(i=0;i<aTypes.length;i++){if((id==null&&aTypes[i]===true)||(id!=null&&(aTypes[i]===oControl.selectedList[id].baseMethod||aTypes[i]==='*'))){Allow=true;break}}var _sAddLink=sAddLink.replace(/\{id\}/,(id||'0'));_sAddLink=_sAddLink.replace(/\{\$param0\}/,(id||'0'));_sAddLink=_sAddLink.replace(/\{\$pre_lang\}/,window.pre_lang);var domainSelect=document.getElementById("domainSelect"+oControl.id);if(domainSelect){var domain=domainSelect.options[domainSelect.selectedIndex].text;if(_sAddLink.indexOf("?")!=-1)_sAddLink=_sAddLink+"&domain="+domain;else _sAddLink=_sAddLink+"?domain="+domain}oButton.addLink=_sAddLink;for(var i=0;i<oButton.linkCache.length;i++){oButton.linkCache[i].href=oButton.addLink;oButton.linkCache[i]['param0']=(id||'0')}if(oButton.tagName.toLowerCase()=='a'){oButton.href=oButton.addLink;oButton.param0=(id||'0')}var needPositionRecalc=false;if(Count>1||!Allow){if(oButton.style.display!='none'){oButton.style.display='none';needPositionRecalc=true}}else{if(oButton.style.display=='none'){oButton.style.display='';needPositionRecalc=true}}if(needPositionRecalc){Control.recalcItemsPosition()}};oControl.setSelectionCallback(function(a,b){setTimeout(_SelectionCallback,100)});var _sAddLink=sAddLink.replace(/\{id\}/,'0');_sAddLink=_sAddLink.replace(/\{\$param0\}/,'0');_sAddLink=_sAddLink.replace(/\{\$pre_lang\}/,window.pre_lang);oButton.addLink=_sAddLink;oButton.linkCache=oButton.getElementsByTagName('a');_SelectionCallback()};function filterController(_oControll,_iTypeId,_bSuspendInit,_oContainerEl,_Params){var __self=this;var quickSearch=null;var quickSearchContainer=null;var formContainer=null;var logicContainer=null;var radioLogicAnd=null;var radioLogicOr=null;var form=null;var addSelect=null;var modeButton=null;var expandButton=null;var targetsList=null;var TypeId=_iTypeId;var ControlInst=null;var errorCount=0;var tipShowTime=5000;var UsedFields=new Object();var UsedInputs=new Object();var fcId=_oControll.id+'_fc';var iconsPath=null;var guideCache=new Object();var currentParent=null;var quickMode=true;var containerEl=_oContainerEl;var nativeModeChange=(_Params&&_Params.nativeAdvancedMode);var DrawFieldFilter=function(_Field,_Placer,_Params){if(_Field!='name'){if(_Params&&_Params[1]==='static')return;var id=fcId+'_'+'id_'+_Field.fieldName;if(!_Field.dataType){_Field.dataType="string"}var input=createInputByDataType(_Field.dataType,id,_Field.fieldName,_Field.guideId,false);if(input){UsedFields[_Field.fieldName]=_Field;UsedInputs[_Field.fieldName]=input;if(_Params&&_Params[0]){input.style.width=_Params[0]}_Placer.appendChild(input)}else{}}};var onRemoveColumn=function(_Field){if(_Field!='name'){delete UsedFields[_Field.fieldName];delete UsedInputs[_Field.fieldName]}};this.control=null;this.getId=function(){return fcId};this.changeMode=function(){if(quickMode){quickMode=false;formContainer.style.display='block';quickSearchContainer.style.display='none';modeButton.childNodes[0].nodeValue=getLabel('js-filter-normal-mode')}else{quickMode=true;formContainer.style.display='none';quickSearchContainer.style.display='';modeButton.childNodes[0].nodeValue=getLabel('js-filter-extended-mode')}Control.recalcItemsPosition()};var applyOnEnterQuickSearch=function(e){var KeyID=(window.event)?event.keyCode:e.keyCode;if(KeyID==13)__self.applyFilter()};var applyOnEnterEvent=function(e){var KeyID=(window.event)?event.keyCode:e.keyCode;if(KeyID==13){if(nativeModeChange)__self.applyFilter();else __self.applyFilterAdvanced()}};var applyOnChangeEvent=function(e){if(nativeModeChange){}else{__self.applyFilterAdvanced()}};this.applyFilterAdvanced=function(){if(errorCount>0)return;var oFilter=new filter();for(var name in UsedInputs){if(UsedInputs[name].tagName.toLowerCase()=='select'){var value=UsedInputs[name].options[UsedInputs[name].selectedIndex].value;if(value!=-2){oFilter.setPropertyEqual(name,value)}}else{switch(UsedInputs[name].type){case'button':break;case'checkbox':oFilter.setPropertyEqual(name,UsedInputs[name].checked?1:0);break;case'text':{var type=UsedFields[name].dataType;switch(type){case'tags':{var values=UsedInputs[name].value.split(',');for(var j=0;j<values.length;j++)values[j]=values[j].replace(/^\s+|\s+$/,'');if(values.length)oFilter.setPropertyLike(name,values);break}case'float':case'price':case'counter':case'int':{var value=UsedInputs[name].value.replace(/^\s+|\s+$/,'');if(!value.length)break;if(value[0]=="<"){oFilter.setPropertyLess(name,value.replace(/[^\d.]*/,''))}else if(value[0]==">"){oFilter.setPropertyGreater(name,value.replace(/[^\d.]*/,''))}else{value=value.split("-");if(value.length>1)oFilter.setPropertyBetween(name,value[0].replace(/[^\d.]*/,''),value[1].replace(/[^\d.]*/,''));else oFilter.setPropertyEqual(name,value[0].replace(/[^\d.]*/,''))}break}case'date':{var pieces=[];var value=UsedInputs[name].value;if(UsedInputs[name].isEmpty!=undefined&&UsedInputs[name].isEmpty==true)break;if(value.length>0){var index=-1;var lastindex=value.indexOf('-');if((index=value.indexOf('<'))!=-1){oFilter.setPropertyLess(name,(lastindex!=-1)?value.substring(index+1,lastindex-1):value.substring(index+1))}else if((index=value.indexOf('>'))!=-1){oFilter.setPropertyGreater(name,(lastindex!=-1)?value.substring(index+1,lastindex-1):value.substring(index+1))}else{if(lastindex!=-1){pieces=value.split(/\s-\s/)}if(pieces.length==2){oFilter.setPropertyBetween(name,pieces[0],pieces[1])}else{oFilter.setPropertyEqual(name,value)}}}break}case"relation":if(UsedInputs[name].value.length)oFilter.setPropertyEqual(name,UsedInputs[name].value);break;default:if(UsedInputs[name].value.length)oFilter.setPropertyLike(name,UsedInputs[name].value)}break}default:if(UsedInputs[name].value.length)oFilter.setPropertyEqual(name,UsedInputs[name].value)}}}oFilter.setConditionModeOr(false);ControlInst.applyFilter(oFilter)};this.applyFilter=function(){var oFilter=new filter();if(quickMode){var value=quickSearch.value.replace(/^\s*|\s*$/,"");if(value.length==0){if(!(ControlInst.flatMode||ControlInst.objectTypesMode||ControlInst.defaultRootMode))oFilter.setParentElements(0)}else{if(/^".*"$|^'.*'$/.test(value)){value=value.substr(1,value.length-2)}else{value=value.split(" ")}oFilter.setAllTextSearch(value)}oFilter.setConditionModeOr(true)}else{var inputs=formContainer.getElementsByTagName('input');for(var i=0;i<inputs.length;i++){switch(inputs[i].type){case'button':break;case'checkbox':oFilter.setPropertyEqual(inputs[i].name,inputs[i].checked?1:0);break;case'text':{var type=UsedFields['row_'+inputs[i].id].field.getElementsByTagName('type')[0].getAttribute('data-type');switch(type){case'tags':{var values=inputs[i].value.split(',');for(var j=0;j<values.length;j++)values[j]=values[j].replace(/^\s+|\s+$/,'');oFilter.setPropertyEqual(inputs[i].name,values);break}case'float':case'price':case'int':{var value=inputs[i].value.replace(/^\s+|\s+$/,'');if(value[0]=="<"){oFilter.setPropertyLess(inputs[i].name,value.replace(/[^\d.]*/,''))}else if(value[0]==">"){oFilter.setPropertyGreater(inputs[i].name,value.replace(/[^\d.]*/,''))}else{value=value.split("-");if(value.length>1)oFilter.setPropertyBetween(inputs[i].name,value[0].replace(/[^\d.]*/,''),value[1].replace(/[^\d.]*/,''));else oFilter.setPropertyEqual(inputs[i].name,value[0].replace(/[^\d.]*/,''))}break}case'date':{var pieces=[];var value=inputs[i].value;if(inputs[i].isEmpty!=undefined&&inputs[i].isEmpty==true)break;if(value.length>0){var index=-1;var lastindex=value.indexOf('-');if((index=value.indexOf('<'))!=-1){oFilter.setPropertyLess(inputs[i].name,(lastindex!=-1)?value.substring(index+1,lastindex-1):value.substring(index+1))}else if((index=value.indexOf('>'))!=-1){oFilter.setPropertyGreater(inputs[i].name,(lastindex!=-1)?value.substring(index+1,lastindex-1):value.substring(index+1))}else{if(lastindex!=-1){pieces=value.split(/\s-\s/)}if(pieces.length==2){oFilter.setPropertyBetween(inputs[i].name,pieces[0],pieces[1])}else{oFilter.setPropertyEqual(inputs[i].name,value)}}}break}case"relation":{oFilter.setPropertyLike(inputs[i].name,inputs[i].value);break}default:oFilter.setPropertyLike(inputs[i].name,inputs[i].value)}break}default:oFilter.setPropertyEqual(inputs[i].name,inputs[i].value)}}inputs=formContainer.getElementsByTagName('select');for(var i=0;i<inputs.length;i++){if(inputs[i].id=='select_'+fcId)continue;var values=new Array();for(var j=0;j<inputs[i].options.length;j++){if(inputs[i].options[j].selected)values.push(inputs[i].options[j].value)}oFilter.setPropertyEqual(inputs[i].name,values)}if(nativeModeChange)oFilter.setConditionModeOr(!radioLogicAnd.checked);else oFilter.setConditionModeOr(true)}ControlInst.applyFilter(oFilter)};var createDeleteRowCallback=function(_RowId){return function(){var Row=document.getElementById(_RowId);if(Row){Row.parentNode.removeChild(Row);UsedFields[_RowId].used=false;while(addSelect.childNodes.length)addSelect.removeChild(addSelect.firstChild);var usedIDs=new Array();var usedCount=0;for(var i in UsedFields){if(UsedFields[i].used){usedIDs.push(UsedFields[i].field.getAttribute('id'));usedCount++}else{var option=document.createElement('option');option.value=i;option.appendChild(document.createTextNode(UsedFields[i].field.getAttribute('title')));addSelect.appendChild(option);var usedIDs=new Array()}}SettingsStore.getInstance().set(fcId,usedIDs.join(','),currentParent?""+currentParent:"default");if(usedCount>1){logicContainer.style.display=''}else{logicContainer.style.display='none'}addSelect.style.display='none';addSelect.style.display=''}Control.recalcItemsPosition()}};var addField=function(){if(!addSelect.options.length)return;var id=addSelect.options[addSelect.selectedIndex].value;var row=buildFormRow(UsedFields[id].field);if(row){UsedFields[id].used=true;formContainer.getElementsByTagName('table')[0].tBodies[1].appendChild(row);addSelect.removeChild(addSelect.options[addSelect.selectedIndex]);var usedIDs=new Array();for(var i in UsedFields){if(UsedFields[i].used)usedIDs.push(UsedFields[i].field.getAttribute('id'))}SettingsStore.getInstance().set(fcId,usedIDs.join(','),currentParent?""+currentParent:"default");if(usedIDs.length>1){logicContainer.style.display=''}else{logicContainer.style.display='none'}Control.recalcItemsPosition();addSelect.style.display='none';addSelect.style.display=''}};var createFieldTip=function(Field,Message){var element=Field;var p={x:element.offsetLeft||0,y:element.offsetTop||0};while(element=element.offsetParent){p.x+=element.offsetLeft;p.y+=element.offsetTop}p.x+=Field.offsetWidth;p.y+=Field.offsetHeight;var id='tip_'+fcId+Math.random();var tip=document.createElement('div');tip.id=id;tip.className='fcTip';tip.style.zIndex=50;tip.style.position='absolute';tip.style.left=p.x+'px';tip.style.top=p.y+'px';tip.appendChild(document.createTextNode(Message));document.body.appendChild(tip);setTimeout(function(){tip.parentNode.removeChild(tip)},tipShowTime)};var createValidator=function(_Input,_DataType){var re=null;var message='';switch(_DataType){case'int':re=new RegExp("^[<>]?[ ]?\\d*( ?- ?\\d*)?$");message=getLabel('js-filter-enter-natural-number');break;case'float':re=new RegExp("^[<>]?[ ]?\\d*[\\.]*\\d*( ?- ?\\d*[\\.]*\\d*)?$");message=getLabel('js-filter-enter-float-number');break;case'date':re=/(^[<>]{1}.*)|(^(((\d\d?[.]\d\d?([.]\d\d(\d\d)?)?)?((\s+|^\s*)\d\d?:\d\d)?)|позавчера|вчера|сегодня|завтра|послезавтра)?(\s*-\s*(((\d\d?[.]\d\d?([.]\d\d(\d\d)?)?)?(\s+\d\d?:\d\d)?)|позавчера|вчера|сегодня|завтра|послезавтра))?)$/i;break}var vCallback=function(){if(_Input){var pos=_Input.className.indexOf('_error');if(!re.test(_Input.value)){if(pos<0){_Input.className+='_error';errorCount++}}else{if(pos>=0){_Input.className=_Input.className.substr(0,pos);errorCount--}}}};return vCallback};var loadGuide=function(_Select,_GuideId){if(guideCache[_GuideId]==undefined){var callback=function(_XML){if(!_XML.responseXML.getElementsByTagName('empty').length){var objects=_XML.responseXML.getElementsByTagName('object');var guide=[];if(!nativeModeChange)guide.push({id:-2,value:''});for(var i=0;i<objects.length;i++){guide.push({id:objects[i].getAttribute('id'),value:objects[i].getAttribute('name')})}guideCache[_GuideId]=guide}else{guideCache[_GuideId]="empty"}loadGuide(_Select,_GuideId)};var url='/admin/data/guide_items_all/'+_GuideId+'.xml?allow-empty';requestGet(url,callback);return}if(guideCache[_GuideId]!=="empty"){for(var j in guideCache[_GuideId]){var option=document.createElement('option');option.value=guideCache[_GuideId][j].id;option.appendChild(document.createTextNode(guideCache[_GuideId][j].value));_Select.appendChild(option)}}else{var name=_Select.name;var id=_Select.id;var input=createInputByDataType('string',id,name,_GuideId,false);var parent=_Select.parentNode;parent.removeChild(_Select);parent.appendChild(input);if(UsedInputs[name])UsedInputs[name]=input}};var addEvent=function(el,event,callback){if(typeof(el[event])=='function'){var h=el[event];el[event]=function(e){h(e);callback(e)}}else{el[event]=callback}};var buildInput=function(_Attributes){var input=document.createElement('input');if(_Attributes instanceof Object){for(i in _Attributes){input.setAttribute(i,_Attributes[i])}}return input};var createInputByDataType=function(_DataType,_Id,_Name,_GuideId,_DisallowMultiple){var input=null;switch(_DataType){case'string':case'wysiwyg':case'text':case'password':case'tags':input=buildInput({'type':'text','class':'fcStringInput','name':_Name,'id':_Id});input.className='fcStringInput';break;case'date':input=buildInput({'type':'text','class':'fcStringInput','name':_Name,'id':_Id});input.className='fcStringInput';input.onkeyup=createValidator(input,'date');var helpString=getLabel('js-filter-date-format');input.value=helpString;input.isEmpty=true;input.onfocus=function(){if(this.isEmpty){this.value='';this.isEmpty=false}};input.onblur=function(){if(this.value.length==0){this.value=helpString;this.isEmpty=true}};break;case'boolean':var bool_no='0';case'file':case'img_file':case'swf_file':var no_value=bool_no||'-1';if(!nativeModeChange){input=document.createElement('select');input.className='fcSelectInput';input.name=_Name;input.id=_Id;input.multiple=false;var yes=document.createElement('option');var no=document.createElement('option');var nothing=document.createElement('option');yes.value='1';no.value=no_value;nothing.value='-2';var yesLabel=(_DataType=='boolean')?getLabel('js-value-yes'):getLabel('js-value-file-yes');var noLabel=getLabel('js-value-no');yes.appendChild(document.createTextNode(yesLabel));no.appendChild(document.createTextNode(noLabel));nothing.appendChild(document.createTextNode(' '));input.appendChild(nothing);input.appendChild(yes);input.appendChild(no);break}input=buildInput({'type':'checkbox','class':'fcBooleanInput','name':_Name,'id':_Id});input.className='fcBooleanInput';break;case'int':case'counter':input=buildInput({'type':'text','class':'fcStringInput','name':_Name,'id':_Id});input.className='fcStringInput';input.onkeyup=createValidator(input,'int');break;case'float':case'price':input=buildInput({'type':'text','class':'fcStringInput','name':_Name,'id':_Id});input.className='fcStringInput';input.onkeyup=createValidator(input,'float');break;case'relation':input=document.createElement('select');input.className='fcSelectInput';input.name=_Name;input.id=_Id;input.multiple=(_DisallowMultiple!=undefined&&_DisallowMultiple==false)?false:true;loadGuide(input,_GuideId);break}if(input){addEvent(input,'onkeyup',applyOnEnterEvent);if(input.tagName.toLowerCase()=='select')input.onchange=applyOnChangeEvent}return input};var buildFormRow=function(_Field){var type=_Field.getElementsByTagName('type')[0];var input=null;var name=_Field.getAttribute('name');var id=fcId+'_'+'id_'+name;var rowId='row_'+id;input=createInputByDataType(type.getAttribute('data-type'),id,name,_Field.getAttribute('guide-id'));if(input==null)return null;var row=document.createElement('tr');var titleCell=document.createElement('td');var valueCell=document.createElement('td');var deleteCell=document.createElement('td');var label=document.createElement('label');label.setAttribute('for',id);label.appendChild(document.createTextNode(_Field.getAttribute('title')));titleCell.className='fcTitleCell';titleCell.appendChild(label);valueCell.className='fcValueCell';valueCell.appendChild(input);var deleteLink=document.createElement('img');deleteLink.className='fcDeleteImage';deleteLink.src=iconsPath+'field_delete.png';deleteLink.alt=getLabel('js-filter-remove-field');deleteLink.title=getLabel('js-filter-remove-field');deleteLink.onclick=createDeleteRowCallback(rowId);deleteCell.className='fcDeleteCell';deleteCell.appendChild(deleteLink);row.id=rowId;row.appendChild(titleCell);row.appendChild(valueCell);row.appendChild(deleteCell);return row};var buildFields=function(){if(!nativeModeChange)return;while(form.tBodies[1].childNodes.length)form.tBodies[1].removeChild(form.tBodies[1].firstChild);while(addSelect.childNodes.length)addSelect.removeChild(addSelect.firstChild);var usedCount=0;for(var i in UsedFields){if(UsedFields[i].used){var row=buildFormRow(UsedFields[i].field);if(row){form.tBodies[1].appendChild(row);usedCount++}}else{var option=document.createElement('option');option.value=i;option.appendChild(document.createTextNode(UsedFields[i].field.getAttribute('title')));addSelect.appendChild(option)}}addSelect.disabled=false;if(logicContainer){if(usedCount>1){logicContainer.style.display=''}else{logicContainer.style.display='none'}}Control.recalcItemsPosition()};var buildFilterForm=function(_TypeDOM){if(nativeModeChange){var modeContainer=document.createElement('div');modeButton=document.createElement('a');modeButton.href="javascript:filterController.getInstanceById('"+fcId+"').changeMode();";modeContainer.className='fcModeContainer';modeContainer.appendChild(modeButton);modeButton.appendChild(document.createTextNode(getLabel('js-filter-extended-mode')))}quickSearchContainer=document.createElement('div');quickSearchContainer.className='fcContainer';quickSearch=buildInput({'type':'text','class':'fcQuicksearchInput','name':'quicksearch','id':fcId+'_id_quicksearch'});var searchButton=buildInput({'type':'button','value':getLabel('js-filter-do')});quickSearch.className='fcQuicksearchInput';searchButton.className='fcApplyButton';searchButton.onclick=__self.applyFilter;quickSearch.onkeyup=applyOnEnterQuickSearch;quickSearchContainer.appendChild(quickSearch);quickSearchContainer.appendChild(searchButton);if(nativeModeChange){formContainer=document.createElement('div');form=document.createElement('table');form.className="fcTable";form.appendChild(document.createElement('tbody'));form.appendChild(document.createElement('tbody'));form.appendChild(document.createElement('tbody'));var addRow=document.createElement('tr');var dscrCell=document.createElement('td');var addCell=document.createElement('td');var btnCell=document.createElement('td');var addImage=document.createElement('img');addSelect=document.createElement('select');addSelect.className='fcAddSelect';addSelect.id='select_'+fcId;addSelect.style.width="100%";addImage.className='fcAddImage';addImage.src=iconsPath+'field_add.png';addImage.alt=getLabel('js-filter-add-field');addImage.title=getLabel('js-filter-add-field');addImage.onclick=addField;addCell.className='fcFreeFieldsCell';btnCell.className='fcAddCell';dscrCell.appendChild(document.createTextNode(getLabel('js-filter-fields-list')));addCell.colSpan=1;addCell.appendChild(addSelect);btnCell.appendChild(addImage);addRow.appendChild(dscrCell);addRow.appendChild(addCell);addRow.appendChild(btnCell);form.tBodies[0].appendChild(addRow);var emptyRow=document.createElement('tr');var emptyCell=document.createElement('td');emptyCell.colSpan=3;emptyCell.innerHTML='&nbsp;';emptyRow.appendChild(emptyCell);form.tBodies[0].appendChild(emptyRow);addRow.className='fcAddRow';var logicRow=document.createElement('tr');var logicCell=document.createElement('td');logicCell.colSpan=3;logicCell.className='fcLogicCell';logicContainer=document.createElement('div');radioLogicAnd=buildInput({'type':'radio','class':'fcLogicInput','value':'and','name':fcId+'_logic','id':fcId+'_logic_and','checked':true,'selected':true});radioLogicOr=buildInput({'type':'radio','class':'fcLogicInput','value':'or','name':fcId+'_logic','id':fcId+'_logic_or'});var logicTitle=document.createElement('span');var labelLogicAnd=document.createElement('label');var labelLogicOr=document.createElement('label');var lineLogicAnd=document.createElement('span');var lineLogicOr=document.createElement('span');logicTitle.className='fcLogicTitle';logicTitle.appendChild(document.createTextNode(getLabel('js-filter-search-matches')));logicContainer.appendChild(logicTitle);radioLogicAnd.style.border="0";radioLogicOr.style.border="0";labelLogicAnd.className='fcLogicLabel';labelLogicAnd.htmlFor=fcId+'_logic_and';lineLogicAnd.className='fcLogicLine';labelLogicAnd.appendChild(document.createTextNode(getLabel('js-filter-with-all-fields')));lineLogicAnd.appendChild(labelLogicAnd);lineLogicAnd.appendChild(radioLogicAnd);logicContainer.appendChild(lineLogicAnd);lineLogicOr.className='fcLogicLine';labelLogicOr.className='fcLogicLabel';labelLogicOr.htmlFor=fcId+'_logic_or';labelLogicOr.appendChild(document.createTextNode(getLabel('js-filter-one-at-least')));lineLogicOr.appendChild(labelLogicOr);lineLogicOr.appendChild(radioLogicOr);logicContainer.appendChild(lineLogicOr);logicCell.appendChild(logicContainer);logicRow.appendChild(logicCell);form.tBodies[2].appendChild(logicRow);var applyRow=document.createElement('tr');var applyCell=document.createElement('td');applyButton=buildInput({'type':'button','value':getLabel('js-filter-do')});applyButton.onclick=__self.applyFilter;applyButton.className='fcApplyButton';applyCell.colSpan=3;applyCell.className='fcApplyCell';applyCell.appendChild(applyButton);applyRow.appendChild(applyCell);form.tBodies[2].appendChild(applyRow);formContainer.className='fcContainer';formContainer.style.display='none';formContainer.appendChild(form)}var targets=document.createElement('div');var targetsTitle=document.createElement('span');targetsList=document.createElement('span');targetsTitle.appendChild(document.createTextNode(getLabel('js-filter-current-rubrics')));targets.appendChild(targetsTitle);targets.appendChild(targetsList);targets.className='fcTargetContainer';putEmptyTarget();var splitter=document.createElement('div');splitter.style.clear='both';splitter.innerHTML='&nbsp;';if(containerEl){containerEl.appendChild(quickSearchContainer);if(nativeModeChange){containerEl.appendChild(modeContainer);containerEl.appendChild(formContainer)}containerEl.appendChild(targets)}else{containerEl=document.createElement("div");containerEl.className="filter-container";containerEl.appendChild(quickSearchContainer);if(nativeModeChange){containerEl.appendChild(modeContainer);containerEl.appendChild(formContainer)}containerEl.appendChild(targets);ControlInst.container.parentNode.insertBefore(containerEl,ControlInst.container)}var clearBlock=document.createElement('div');clearBlock.className='clear';ControlInst.container.parentNode.insertBefore(clearBlock,ControlInst.container);if(nativeModeChange){radioLogicAnd.checked=true;buildFields()}};var createRequestObject=function(){if(window.XMLHttpRequest){try{return new XMLHttpRequest()}catch(e){}}else if(window.ActiveXObject){try{return new ActiveXObject('Msxml2.XMLHTTP')}catch(e){}try{return new ActiveXObject('Microsoft.XMLHTTP')}catch(e){}}return null};var requestGet=function(_sUrl,_Callback){var Request=createRequestObject();Request.onreadystatechange=function(){if(Request.readyState!=4)return;if(Request.status==200){_Callback(Request)}else{errorHandler('Request failed')}};Request.open('GET',_sUrl,true);Request.send(null)};this.init=function(){if(nativeModeChange){var Callback=function(_Req){var fields=_Req.responseXML.getElementsByTagName('field');parseFields(fields);buildFilterForm(_Req.responseXML)};var tmp=ControlInst.dataSet.getCommonTypeId();if(tmp>0)TypeId=tmp;if(TypeId)sUrl='/utype/'+TypeId+'/';else sUrl='/utype/dominant/'+TypeId+'/';requestGet(sUrl,Callback)}else{buildFilterForm(null)}};var parseFields=function(_FieldNodes){var fields=_FieldNodes;var excludeTypes=['symlink'];var dataType=null;var skipField=false;var stringIDs=SettingsStore.getInstance().get(fcId,(currentParent)?""+currentParent:"default");var usedIDs=(stringIDs===false)?new Array():stringIDs.split(',');var used=false;var stoplist=ControlInst.dataSet.getFieldsStoplist();for(var i=0;i<fields.length;i++){var name=fields[i].getAttribute('name');skipField=false;dataType=fields[i].getElementsByTagName('type')[0].getAttribute('data-type');for(var j=0;j<stoplist.length;j++){if(name==stoplist[j]){skipField=true;break}}for(var j=0;j<excludeTypes.length&&!skipField;j++){if(dataType==excludeTypes[j]){skipField=true;break}}if(!skipField){var id='row_'+fcId+'_id_'+fields[i].getAttribute('name');var fid=fields[i].getAttribute('id');used=false;for(var k=0;k<usedIDs.length;k++){if(fid==usedIDs[k]){used=true;break}}UsedFields[id]={'used':used,'field':fields[i]}}}};var errorHandler=function(_Description){};var singleType=false;var removeTarget=function(){var id=this.id.substr((fcId+'_link_').length);delete ControlInst.targetsList[id];onTargetSelect({});return false};var putTarget=function(_Id,_Name){var link=document.createElement('a');link.className='fcTarget';link.id=fcId+'_link_'+_Id;link.href="#";link.title=getLabel('js-filter-delete-category');link.onclick=removeTarget;link.appendChild(document.createTextNode(_Name));if(targetsList.childNodes.length)targetsList.appendChild(document.createTextNode(', '));targetsList.appendChild(link)};var putEmptyTarget=function(){targetsList.parentNode.style.display='none'};var onTargetSelect=function(_Items){var singleTypeCurrent=false;var itemId=null;var counter=0;while(targetsList.firstChild)targetsList.removeChild(targetsList.firstChild);for(var i in ControlInst.targetsList){counter++;itemId=ControlInst.targetsList[i].id;putTarget(ControlInst.targetsList[i].id,ControlInst.targetsList[i].name)}if(!counter)putEmptyTarget();else targetsList.parentNode.style.display='';if(nativeModeChange){if(counter==1){sUrl='/utype/dominant/'+itemId+'/';singleTypeCurrent=true;currentParent=itemId}else{sUrl='/utype/'+TypeId+'/';singleTypeCurrent=false;currentParent=null}if(singleType!=singleTypeCurrent){UsedFields=new Object();addSelect.disabled=true;requestGet(sUrl,function(_Req){if(_Req.responseXML){var fields=_Req.responseXML.getElementsByTagName('field');if(fields.length)parseFields(fields);buildFields()}});singleType=singleTypeCurrent}}};if(!(_oControll==undefined||_iTypeId==undefined)){filterController.instances[filterController.instances.length]=this;ControlInst=_oControll;this.control=ControlInst;TypeId=!_iTypeId?0:_iTypeId;iconsPath=ControlInst.iconsPath;if(!nativeModeChange){ControlInst.onDrawFieldFilter=DrawFieldFilter;ControlInst.onRemoveColumn=onRemoveColumn}ControlInst.setTargetSelectCallback(onTargetSelect);if(_bSuspendInit==undefined||_bSuspendInit==false)this.init();else ControlInst.dataSet.addEventHandler('onInitComplete',this.init)}};filterController.instances=new Array();filterController.getInstanceById=function(sId){for(var i=0;i<filterController.instances.length;i++){if(filterController.instances[i].getId()===sId)return filterController.instances[i]}return null};function TemplatesDataSet(){var templates=null,domains=null,langs=null;var createRequestObject=function(){if(window.XMLHttpRequest){try{return new XMLHttpRequest()}catch(e){}}else if(window.ActiveXObject){try{return new ActiveXObject('Msxml2.XMLHTTP')}catch(e){}try{return new ActiveXObject('Microsoft.XMLHTTP')}catch(e){}}return null};var loadXml=function(){var url="/admin/content/domainTemplates.xml";var xmlRequest=createRequestObject();var onRequestReady=function(){if(xmlRequest.readyState!=4)return;if(xmlRequest.status==200){onLoadXml(xmlRequest)}else{return false}};xmlRequest.onreadystatechange=onRequestReady;xmlRequest.open('GET',url,true);xmlRequest.send(null)};var onLoadXml=function(xmlResponse){var xml=xmlResponse.responseXML;templates=parseCollection(xml.getElementsByTagName('template'));domains=parseCollection(xml.getElementsByTagName('domain'));langs=parseCollection(xml.getElementsByTagName('lang'))};var getAttributes=function(node){var result=[];result['nodeValue']=(node.textContent||node.text);for(var i=0;i<node.attributes.length;i++){var attr=node.attributes.item(i);result[attr.nodeName]=attr.nodeValue}return result};var parseCollection=function(collection){var result=new Array();for(var i=0;i<collection.length;i++){var item=collection[i];var info=getAttributes(item);result.push(info)}return result};this.getLangsList=function(){return langs};this.getDomainsList=function(){return domains};this.getTemplatesList=function(domainId,langId){if(!domainId&&!langId){return templates}var result=new Array();for(var i=0;i<templates.length;i++){var item=templates[i];if(item['domain-id']==domainId&&item['lang-id']==langId){result.push(item)}}return result};loadXml()};TemplatesDataSet.instance=null;TemplatesDataSet.getInstance=function(){if(!TemplatesDataSet.instance){TemplatesDataSet.instance=new TemplatesDataSet}return TemplatesDataSet.instance};function dataSet(_sModuleName,_bSuspendInit,_sInitParam){var ModuleName=_sModuleName;var InitParam=(_sInitParam!=undefined)?_sInitParam:"";var LoadMethod='';var DefaultFilter=null;var StoredFilters=new Array();var Available=false;var Inited=false;var MethodList=new Array();var CommonFields=new Array();var CommonTypeId=0;var FieldsStoplist=new Array();var DefaultFields="";var LoadedTree=new Array();var ReqCounter=0;var onInitComplete=new Array();var onBeforeLoad=new Array();var onAfterLoad=new Array();var onBeforeExecute=new Array();var onAfterExecute=new Array();var onBeforeRefresh=new Array();var onAfterRefresh=new Array();var onAfterPieceLoad=new Array();var onRequestFailed=new Array();this.init=function(){if(Inited)return true;Inited=true;var onLoadType=function(_Type){if(_Type.responseXML){CommonFields=_Type.responseXML.getElementsByTagName('group')}Available=true;if(!processEvents('onInitComplete'))return false};var onLoadConfig=function(_Conf){var Methods=_Conf.responseXML.getElementsByTagName('method');for(var i=0;i<Methods.length;i++){var MethodDOM=Methods[i];if(MethodDOM.getAttribute('forload')=='true'){LoadMethod=MethodDOM.childNodes[0].nodeValue;continue}var MethodDesc=new Object();for(var j=0;j<MethodDOM.attributes.length;j++){var Attribute=MethodDOM.attributes[j];if(Attribute.nodeName=="aliases")continue;MethodDesc[Attribute.nodeName]=Attribute.nodeValue}MethodDesc['name']=MethodDOM.childNodes[0].nodeValue;var aliasesString=MethodDOM.getAttribute('aliases');if(aliasesString){MethodDesc['aliases']=aliasesString.split(',');for(var k=0;k<MethodDesc.aliases.length;k++)MethodDesc.aliases[k]=MethodDesc.aliases[k].replace(/^\s+|\s+$/,'')}else{MethodDesc['aliases']=[]}MethodList.push(MethodDesc)}var Excluded=_Conf.responseXML.getElementsByTagName('exclude');if(Excluded.length){for(var i=0;i<Excluded.length;i++){if(Excluded[i].childNodes.length){FieldsStoplist.push(Excluded[i].childNodes[0].nodeValue)}}}var Columns=_Conf.responseXML.getElementsByTagName('default');if(Columns.length&&Columns[0].childNodes.length){DefaultFields=Columns[0].childNodes[0].nodeValue}var Types=_Conf.responseXML.getElementsByTagName('type');if(Types.length){for(var i=0;i<Types.length;i++){if(!Types[i].getAttribute('common'))continue;var v=Types[i].getAttribute('common').toLowerCase();if(v=="1"||v=="true"){CommonTypeId=Types[i].getAttribute('id');var sUrl='/utype/'+CommonTypeId+'/';requestGet(sUrl,onLoadType);break}else if(v=='custom'){CommonTypeId=Types[i].getAttribute('id');var sUrl=CommonTypeId;requestGet(sUrl,onLoadType)}}}else{Available=true;if(!processEvents('onInitComplete'))return false}};var sUrl='/admin/'+ModuleName+'/dataset_config.xml'+(InitParam.length?('?param='+InitParam):'');requestGet(sUrl,onLoadConfig);return Inited};this.load=function(_Filter){if(!Available)return false;if(!processEvents('onBeforeLoad'))return false;var Callback=function(_Req){var paging=new Object();var Objects=ParseDOM(_Req.responseXML,false,paging);var Params={'objects':Objects,'filter':_Filter,'paging':paging};if((typeof(Objects)=='string')||(Objects===null))Params.error=Objects;Available=true;if(!processEvents('onAfterLoad',Params))return false};var sUrl='/admin/'+ModuleName+'/'+LoadMethod+'.xml'+assembleQueryString(_Filter,true);requestGet(sUrl,Callback)};this.refresh=function(_Branches){if(!Available)return false;if(!processEvents('onBeforeRefresh'))return false;if(StoredFilters.length){var sUrl='/admin/'+ModuleName+'/'+LoadMethod+'.xml';var iFilterIndex=0;var ContinuousCallback=function(_Req,_Filter){var paging=new Object();var Objects=ParseDOM(_Req.responseXML,false,paging);var Params={'objects':Objects,'filter':_Filter,'paging':paging};if((typeof(Objects)=='string')||(Objects===null))Params.error=Objects;processEvents('onAfterPieceLoad',Params);iFilterIndex++;if(iFilterIndex>=StoredFilters.length){Available=true;if(!processEvents('onAfterRefresh',{'objects':LoadedTree}))return false}else{requestGet(sUrl+assembleQueryString(StoredFilters[iFilterIndex]),ContinuousCallback,StoredFilters[iFilterIndex])}};Available=false;requestGet(sUrl+assembleQueryString(StoredFilters[iFilterIndex]),ContinuousCallback,StoredFilters[iFilterIndex])}else{var SimpleCallback=function(_Req,_Filter){var paging=new Object();var Objects=ParseDOM(_Req.responseXML,false,paging);var Params={'objects':Objects,'filter':new filter(),'paging':paging};if((typeof(Objects)=='string')||(Objects===null))Params.error=Objects;Available=true;processEvents('onAfterPieceLoad',Params);processEvents('onAfterRefresh',{'objects':LoadedTree})};var aIDs=new Array();var Field='';if(_Branches==undefined||_Branches==false)Field='id';else Field='rel';for(var i=0;i<LoadedTree.length;i++){aIDs.push(LoadedTree[i][Field])}Available=false;var sUrl='/admin/'+ModuleName+'/'+LoadMethod+'.xml?'+Field+'='+aIDs.join(',');LoadedTree=new Array();requestGet(sUrl,SimpleCallback)}};this.isMethodSupported=function(_sMethodName,_returnName){var methodName=_sMethodName.toUpperCase();var returnName=(_returnName!=undefined&&_returnName==true)?true:false;for(var i in MethodList){if(typeof(MethodList[i])==='function')continue;if(MethodList[i].name.toUpperCase()==methodName){return returnName?MethodList[i].name:true}for(var j=0;j<MethodList[i].aliases.length;j++){if(MethodList[i].aliases[j].toUpperCase()==methodName){return returnName?MethodList[i].name:true}}}return false};this.getMethodsList=function(){return MethodList};this.getCommonFields=function(){return CommonFields};this.getDefaultFields=function(){return DefaultFields};this.getFieldsStoplist=function(){return FieldsStoplist};this.getCommonTypeId=function(){return CommonTypeId};this.execute=function(_sMethodName,_ParamHash){if(!Available)return false;var methodName=this.isMethodSupported(_sMethodName,true);if(!methodName)return false;var Params={'method':_sMethodName,'params':_ParamHash,'objects':new Array()};if(!processEvents('onBeforeExecute',Params))return false;var Callback=function(_Req){Control.enabled=true;var paging=new Object();var Objects=ParseDOM(_Req.responseXML,true,paging);updateTree(Objects);Params.objects=Objects;Params.paging=paging;if((typeof(Objects)=='string')||(Objects===null))Params['error']=Objects;Available=true;if(!processEvents('onAfterExecute',Params))return false};var currentModule=getModuleForMethod(methodName);var sUrl=window.pre_lang+'/admin/'+currentModule+'/'+methodName+'.xml';var aQuery=new Array();for(var PropName in _ParamHash){if(_ParamHash[PropName]instanceof Array){for(var i=0;i<_ParamHash[PropName].length;i++){aQuery.push(PropName+'[]='+_ParamHash[PropName][i])}}else{aQuery.push(PropName+'='+_ParamHash[PropName])}}Available=false;sUrl=sUrl+'?'+aQuery.join('&');requestGet(sUrl,Callback)};this.getLoadedTree=function(){return LoadedTree};this.isAvailable=function(){return Available};this.clearFiltersCache=function(){StoredFilters=new Array()};this.setDefaultFilter=function(_Filter){DefaultFilter=_Filter};this.getDefaultFilter=function(){return DefaultFilter};this.addEventHandler=function(_sEventKind,_EvHandler){var EventHandlers=chooseHandlers(_sEventKind);if(EventHandlers===null)return false;EventHandlers[EventHandlers.length]={active:true,handler:_EvHandler};return EventHandlers.length-1};this.removeEventHandler=function(_sEventKind,_iHandlerId){var EventHandlers=chooseHandlers(_sEventKind);if(EventHandlers===null)return false;EventHandlers[_iHandlerId].active=false};var getModuleForMethod=function(_sMethodName){var methodName=_sMethodName.toUpperCase();for(var i=0;i<MethodList.length;i++){if(MethodList[i].name.toUpperCase()==methodName&&MethodList[i].module){return MethodList[i].module}}return ModuleName};var processEvents=function(_sEventKind,_EventParams){if(!Inited)return false;var HandlerResult=true;var EventHandlers=chooseHandlers(_sEventKind);if(EventHandlers===null)return false;for(var i in EventHandlers){if(EventHandlers[i].active){HandlerResult=HandlerResult&&(EventHandlers[i].handler(_EventParams)!==false)}}return HandlerResult};var chooseHandlers=function(_sEventKind){var EventHandlers=null;switch(_sEventKind.toUpperCase()){case'ONINITCOMPLETE':return onInitComplete;case'ONBEFORELOAD':return onBeforeLoad;case'ONAFTERLOAD':return onAfterLoad;case'ONBEFOREEXECUTE':return onBeforeExecute;case'ONAFTEREXECUTE':return onAfterExecute;case'ONBEFOREREFRESH':return onBeforeRefresh;case'ONAFTERREFRESH':return onAfterRefresh;case'ONAFTERPIECELOAD':return onAfterPieceLoad;case'ONREQUESTFAILED':return onRequestFailed;default:return null}};var createRequestObject=function(){if(window.XMLHttpRequest){try{return new XMLHttpRequest()}catch(e){}}else if(window.ActiveXObject){try{return new ActiveXObject('Msxml2.XMLHTTP')}catch(e){}try{return new ActiveXObject('Microsoft.XMLHTTP')}catch(e){}}return null};var requestGet=function(_sUrl,_Callback,_Filter){var Request=createRequestObject();Request.onreadystatechange=function(){if(Request.readyState!=4)return;ReqCounter++;if(Request.status==200){_Callback(Request,_Filter)}else{processEvents('onRequestFailed')}};Request.open('GET',_sUrl,true);Request.send(null)};var assembleQueryString=function(_Filter,_Store){var sQString='';if(_Filter instanceof Object){if(!DefaultFilter.Full){_Filter.setViewMode(false)}sQString=_Filter.getQueryString(DefaultFilter);if(_Store!=undefined&&_Store===true)StoredFilters.push(_Filter)}else if(_Filter instanceof Object){var Pieces=new Array();if(_Filter.id!=undefined){var Param;if(_Filter.id instanceof Array){Param=_Filter.id}else{Param=new Array();Param.push(_Filter.id)}Pieces.push('id='+Param.join(','))}if(_Filter.rel!=undefined){var Param;if(_Filter.rel instanceof Array){Param=_Filter.rel}else{Param=new Array();Param.push(_Filter.rel)}Pieces.push('rel='+Param.join(','))}if(Pieces.length){sQString='?'+Pieces.join('&');if(_Store!=undefined&&_Store===true)StoredFilters.push(_Filter)}}return sQString+"&r="+Math.random()};var ParseDOM=function(_XMLDOM,_bIgnoreTree,pagingParams){var Objects=new Array();var DataNode=_XMLDOM.getElementsByTagName('data');if(!DataNode.length)return Objects;else DataNode=DataNode[0];var Data=DataNode.childNodes;for(var i=0;i<Data.length;i++){var Node=Data[i];if(Node.nodeName=='error'){return Node.firstChild.nodeValue}if(Node.nodeName!='page'&&Node.nodeName!='object'&&Node.nodeName!='type'&&Node.nodeName!='response')continue;var o=new Object();for(var j=0;j<Node.attributes.length;j++){var Attribute=Node.attributes[j];o[Attribute.nodeName]=Attribute.nodeValue}WalkDOM(o,Node.childNodes);Objects.push(o);if(_bIgnoreTree==undefined||_bIgnoreTree===false)LoadedTree.push(o)}if(pagingParams!=undefined&&(pagingParams instanceof Object)){pagingParams.total=parseInt(DataNode.getAttribute('total'))||Objects.length;pagingParams.offset=parseInt(DataNode.getAttribute('offset'))||0;pagingParams.limit=parseInt(DataNode.getAttribute('limit'))||Objects.length}return Objects};var WalkDOM=function(_Acceptor,DOM){if(DOM.length==1&&DOM[0].nodeType==3){_Acceptor['_value']=DOM[0].nodeValue;return}for(var i=0;i<DOM.length;i++){var Node=DOM[i];var o=new Object();if(Node.nodeType!=1){o=Node.nodeValue}else if(!Node.attributes.length&&Node.childNodes.length==1&&Node.childNodes[0].nodeType==3){o=Node.childNodes[0].nodeValue}else{for(var j=0;j<Node.attributes.length;j++){var Attribute=Node.attributes[j];o[Attribute.nodeName]=Attribute.nodeValue}WalkDOM(o,Node.childNodes)}if(_Acceptor[Node.nodeName]==undefined){_Acceptor[Node.nodeName]=o}else{if(_Acceptor[Node.nodeName]instanceof Array){_Acceptor[Node.nodeName].push(o)}else{var Tmp=new Array();Tmp.push(_Acceptor[Node.nodeName]);Tmp.push(o);_Acceptor[Node.nodeName]=Tmp}}}};var updateTree=function(_UpdateHashes){if(!(_UpdateHashes instanceof Array))return;for(var i=0;i<_UpdateHashes.length;i++){for(var j=0;j<LoadedTree.length;j++){if(_UpdateHashes[i].id==LoadedTree[j].id){for(var item in _UpdateHashes[i]){LoadedTree[j][item]=_UpdateHashes[i][item]}break}}}};if((typeof(_bSuspendInit)=='undefined')||(_bSuspendInit==false)){this.init()}};SettingsStore.instance=null;SettingsStore.getInstance=function(){if(!SettingsStore.instance){SettingsStore.instance=new SettingsStore()}return SettingsStore.instance};function SettingsStore(){var keys=window.settingsStoreData||{};var __self=this;var onLoadComplete=new Array();this.loaded=window.settingsStoreData?true:false;this.get=function(key,target_tag){target_tag=checkTagsArray(target_tag);if(keys[key]){return(keys[key][target_tag])?keys[key][target_tag]:false}else{return false}};this.set=function(key,value,filter_tags){if(!key)return false;filter_tags=checkTagsArray(filter_tags);var sUrl="/admin/users/saveUserSettings/?key="+key+"&value="+value;if(filter_tags){for(var i=0;i<filter_tags.length;i++){sUrl+="&tags[]="+filter_tags[i]}}else{filter_tags={}}var Callback=function(request){};requestGet(sUrl,Callback);for(var i=0;i<filter_tags.length;i++){var tag=filter_tags[i];if(!keys[key]){keys[key]={}}if(value){keys[key][tag]=value}else{keys[key][tag]=undefined}}};this.list=function(target_tags){target_tags=checkTagsArray(target_tags);var result=new Array();for(key in keys){var values=keys[key];var value=false;for(var i in target_tags){var tag=target_tags[i];for(var valueTag in values){if(valueTag==tag){value=values[valueTag]}}}if(value){result[key]=value}}return result};this.callback=function(func){if(typeof func=="function"){callback=func}return this};this.load=function(){if(this.loaded)return true;setTimeout(function(){var sUrl="/admin/users/loadUserSettings/?r="+Math.random();var Callback=function(request){__self.loaded=true;parseXmlDom(request.responseXML);processEvents('onLoadComplete')};requestGet(sUrl,Callback)},50)};this.addEventHandler=function(_sEventKind,_EvHandler){var EventHandlers=chooseHandlers(_sEventKind);if(EventHandlers===null)return false;EventHandlers[EventHandlers.length]={active:true,handler:_EvHandler};if(this.loaded&&_sEventKind.toUpperCase()=='ONLOADCOMPLETE')_EvHandler();return EventHandlers.length-1};var processEvents=function(_sEventKind,_EventParams){var EventHandlers=chooseHandlers(_sEventKind);if(EventHandlers===null)return false;for(var i in EventHandlers){if(EventHandlers[i].active){EventHandlers[i].handler(_EventParams)}}};var chooseHandlers=function(_sEventKind){var EventHandlers=null;switch(_sEventKind.toUpperCase()){case'ONLOADCOMPLETE':return onLoadComplete;default:return null}};var checkTagsArray=function(tags){var typeofTagsVar=typeof tags;if(typeofTagsVar=="object"){if(tags.length>0){return tags}else{tags.push('common');return tags}}else if(typeofTagsVar=="string"){return new Array(tags)}else if(typeofTagsVar=="undefined"){return new Array('common')}else{return false}};var createRequestObject=function(){if(window.XMLHttpRequest){try{return new XMLHttpRequest()}catch(e){}}else if(window.ActiveXObject){try{return new ActiveXObject('Msxml2.XMLHTTP')}catch(e){}try{return new ActiveXObject('Microsoft.XMLHTTP')}catch(e){}}return null};var requestGet=function(_sUrl,_Callback){var Request=createRequestObject();Request.onreadystatechange=function(){if(Request.readyState!=4)return;if(Request.status==200){_Callback(Request)}else{processEvents('onRequestFailed')}};Request.open('GET',_sUrl,true);Request.send(null)};var parseXmlDom=function(xmldom){var data=xmldom.getElementsByTagName('item');for(var i=0;i<data.length;i++){var entry=data[i];var key=entry.getAttribute('key');keys[key]={};var childs=entry.childNodes;var value="",tag="";for(var j=0;j<childs.length;j++){var node=childs[j];if(node.nodeName=="value"){value=node.firstChild.nodeValue;tag=node.getAttribute('tag');keys[key][tag]=value;continue}}}};if(this.loaded){processEvents('onLoadComplete')}};$(document).ready(function(){SettingsStore.getInstance().load()});var editableCell=function(_TableItem,_Cell,_PropInfo){var __self=this;var PropInfo=_PropInfo;var PropName=_PropInfo.fieldName||_PropInfo.name;var PropId=_PropInfo.id;var Item=_TableItem;var FlatMode=Item.control.flatMode;var editControl=null;var OldValue="";var OldCellContent="";var DataType=_PropInfo['dataType']||'';this.element=_Cell;this.prepareSaveData=function(){if(editControl)__self.save(editControl.value)};var __constructor=function(){if(jQuery.inArray(DataType,editableCell.ignoreDataTypes)!=-1)return false;if(jQuery.inArray(PropName,editableCell.ignorePropNames)!=-1)return false;if(!editableCell.helper){editableCell.helper=document.createElement('div');editableCell.helper.className='c-helper';$(editableCell.helper).css({position:'absolute',width:'16px',height:'16px',background:'url(/images/cms/admin/mac/tree/edit.png)',display:'none',cursor:'pointer'});document.body.appendChild(editableCell.helper);$(editableCell.helper).bind('mouseover',function(){editableCell.hideHelper=false});$(editableCell.helper).bind('mouseout',function(){editableCell.handleCell=false;editableCell.helper.style.display='none'});$(editableCell.helper).bind('click',function(){editableCell.helper.style.display='none';var hc=editableCell.handleCell;var ac=editableCell.activeCell;if(hc){if(ac)ac.prepareSaveData();hc.makeEditable()}})}$(__self.element).bind('mouseover',function(){if(!Control.enabled)return false;editableCell.hideHelper=false;var ac=editableCell.activeCell;if(ac&&ac==__self)return;editableCell.handleCell=__self;var pos=$(_Cell).position();var cpos=$(Item.control.initContainer).position();cpos.left-=Item.control.initContainer.scrollLeft;$(editableCell.helper).css({top:pos.top+cpos.top+3,left:pos.left+cpos.left+this.offsetWidth-16,display:'block'})});$(__self.element).bind('mouseout',function(evnt){editableCell.hideHelper=true;var hc=__self;setTimeout(function(){if(editableCell.hideHelper)editableCell.helper.style.display='none'},10)})};this.makeEditable=function(){editableCell.activeCell=__self;editableCell.handleCell=false;__getData()};var __getData=function(){var sDataSrc='/admin/content/get_editable_region/'+Item.id+"/"+PropName+'.xml';if(FlatMode)sDataSrc+='?is_object=1';$.ajax({type:"GET",url:sDataSrc,dataType:"xml",success:function(data,status){__onGetData(data)},error:function(rq,status,err){__onGetDataError(err)}})};var __reportError=function(err){editableCell.activeCell=false;editableCell.handleCell=false;$.jGrowl(err,{header:getLabel('js-error-header')})};var __onGetData=function(oXMLResponse){Item.control.container.style.background='#FFF';var arrEls=oXMLResponse.getElementsByTagName("property");if(typeof(arrEls[0])!=='undefined'){sType=arrEls[0].getAttribute('type')||""}var errs=oXMLResponse.getElementsByTagName("error");if(errs.length){__reportError(errs[0].firstChild.nodeValue);return false}if(PropName=='name'){sType='name'}var vals=oXMLResponse.getElementsByTagName('value');var val=false;switch(sType){case'wysiwyg':case'text':case'string':case'int':case'price':case'float':case'tags':case'date':case'counter':if(vals.length){val=vals[0].firstChild?vals[0].firstChild.nodeValue:''}if(!val){val=''}__makeEditableStringFld(val);break;case'boolean':if(vals.length){val=vals[0].firstChild?vals[0].firstChild.nodeValue:''}__makeEditablBooleanFld(val);break;case'relation':var vals=oXMLResponse.getElementsByTagName('item');__makeEditableRelationFld(vals,arrEls[0].getAttribute('multiple')=='multiple');break;case'name':var vals=oXMLResponse.getElementsByTagName('name');if(vals.length){val=vals[0].firstChild?vals[0].firstChild.nodeValue:''}__makeEditableStringFld(val);break;default:__reportError(getLabel("js-edcell-unsupported-type"));return false;break}Control.recalcItemsPosition()};var __onSetData=function(oXMLResponse,sResponseTxt){var el=$('div',__self.element);var errs=oXMLResponse.getElementsByTagName("error");if(errs.length){__reportError(errs[0].firstChild.nodeValue);__self.restore();return false}var arrEls=oXMLResponse.getElementsByTagName("property");if(typeof(arrEls[0])!=='undefined'){sType=arrEls[0].getAttribute('type')||""}if(PropName=='name'){sType='name'}var vals=oXMLResponse.getElementsByTagName('value');var val='';switch(sType){case'wysiwyg':case'text':case'string':case'int':case'price':case'float':case'tags':case'date':case'counter':var vals=oXMLResponse.getElementsByTagName('value');if(vals.length){val=vals[0].firstChild?vals[0].firstChild.nodeValue:''}el.html(val);OldValue=val;break;case'boolean':if(vals.length){val=vals[0].firstChild?vals[0].firstChild.nodeValue:''}el.html(val?'<img alt="" style="width:13px;height:13px;" src="/images/cms/admin/mac/tree/checked.png" />':'');OldValue=val;break;case'relation':var vals=oXMLResponse.getElementsByTagName('item');if(vals.length){for(var i=0;i<vals.length;i++){val+=vals[i].getAttribute('name');if(i<vals.length-1)val+=', '}}el.html(val);OldValue=val;break;case'name':var vals=oXMLResponse.getElementsByTagName('name');if(vals.length){val=vals[0].firstChild?vals[0].firstChild.nodeValue:''}el.html(OldCellContent);var anchor=$('a',__self.element);anchor.html(val);OldValue=val;break;default:__reportError(getLabel("js-edcell-unsupported-type"));return false;break}$.jGrowl(getLabel('js-property-saved-success'));OldCellContent=$('div',__self.element).html();Control.recalcItemsPosition()};var __makeEditableStringFld=function(sVal){OldValue=sVal;var el=__self.element;OldCellContent=$('div',__self.element).html();editControl=document.createElement('input');editControl.setAttribute('type','text');editControl.value=sVal;editControl.className='editableCtrl';editControl.onblur=function(){__self.prepareSaveData();return true};editControl.onkeydown=function(evnt){var iKCode=window.event?window.event.keyCode:evnt.which;if(iKCode==27)__self.restore();if(iKCode==13)__self.prepareSaveData();return true};var el=$('div',__self.element);el.html('');el.append(editControl);editControl.focus()};var __makeEditableRelationFld=function(vals,multiple){var el=$('div',__self.element);OldCellContent=el.html();editControl=document.createElement('select');editControl.id='relationSelect'+Item.id+PropName;editControl.className='editableCtrl';if(multiple){editControl.multiple=true;editControl.size=3}else{editControl.onchange=function(){__self.save(this.value,true);return true}}for(var i=0;i<vals.length;i++){var val=vals[i];var o=document.createElement('option');o.value=val.getAttribute('id');o.selected=true;o.innerHTML=val.getAttribute('name');editControl.appendChild(o)}var el=$('div',__self.element);el.html('');el.append(editControl);var relInput=document.createElement('input');relInput.id='relationInput'+Item.id+PropName;relInput.className='relInput';var el=$('div',__self.element);el.append('<br />');el.append(relInput);relInput.focus();new relationControl(PropInfo.guideId,Item.id+PropName);__self.prepareSaveData=function(){if(editControl.multiple){var aVals=[];for(var i=0;i<editControl.options.length;i++){if(editControl.options[i].selected)aVals.push(editControl.options[i].value)}__self.save(aVals)}else{__self.save(editControl.value)}};$(relInput).add($(editControl)).keydown(function(evnt){var iKCode=evnt.keyCode;if(iKCode==27)__self.restore();if(iKCode==13)__self.prepareSaveData();return true})};var __makeEditablBooleanFld=function(val){var el=$('div',__self.element);OldCellContent=el.html();editControl=document.createElement('input');editControl.type='checkbox';editControl.checked=val;editControl.className='editableCtrl check';editControl.onchange=function(){__self.save(this.checked?1:0,true);return true};$(editControl).keydown(function(evnt){var iKCode=evnt.keyCode;if(iKCode==27)__self.restore();if(iKCode==13)__self.prepareSaveData();return true});var el=$('div',__self.element);el.html('');el.append(editControl);editControl.focus()};var __onGetDataError=function(oException){__reportError(getLabel('js-edcell-get-error')+oException)};var __setData=function(content){var sDataSrc='/admin/content/save_editable_region/'+Item.id+"/"+PropName+'.xml';if(FlatMode)sDataSrc+='?is_object=1';$.ajax({type:"POST",url:sDataSrc,dataType:"xml",success:function(data,status){__onSetData(data,status)},data:({'data[]':content}),error:function(rq,status,err){__onSetDataError(err)},complete:function(rq,status){if(editableCell.activeCell==__self)editableCell.activeCell=false;if(!editableCell.activeCell)Item.control.container.style.background='none';if(editableCell.handleCell==__self)editableCell.handleCell=false}})};var __onSetDataError=function(oException){__reportError(getLabel('js-edcell-save-error')+oException)};this.save=function(newValue,force){editableCell.activeCell=false;if(!force&&OldValue==newValue){this.restore();return false}__setData(newValue)};this.restore=function(){editableCell.activeCell=false;var div=$('div',__self.element);div.html(OldCellContent);Item.control.container.style.background='none';Control.recalcItemsPosition()};this.getEditControl=function(){return editControl};__constructor()};editableCell.activeCell=false;editableCell.handleCell=false;editableCell.helper=false;editableCell.hideHelper=false;editableCell.ignoreDataTypes=['wysiwyg'];editableCell.ignorePropNames=[];var TreeItem=function(_oControl,_oParent,_oData,_oSiblingItem,_sInsertMode){var id=parseInt(_oData.id);var __self=this;var Data=_oData;var Parent=_oParent;var SiblingItem=_oSiblingItem||null;var InsertMode=_sInsertMode||'after';var ForceDraw=typeof(_oData['force-draw'])!=='undefined'?parseInt(_oData['force-draw']):1;var CountChilds=typeof(_oData['childs'])!=='undefined'?parseInt(_oData['childs']):0;var typeName=(typeof(_oData['basetype'])!=='undefined'&&typeof(_oData['basetype']['_value'])==='string')?_oData['basetype']['_value']:"";var IconsPath=_oControl.iconsPath;var baseModule=(typeof(_oData['basetype'])!=='undefined'&&typeof(_oData['basetype']['module'])==='string')?_oData['basetype']['module']:"content";var baseMethod=(typeof(_oData['basetype'])!=='undefined'&&typeof(_oData['basetype']['method'])==='string')?_oData['basetype']['method']:"";var iconSrc=typeof(_oData['iconbase'])!=='undefined'?_oData['iconbase']:IconsPath+'ico_'+baseModule+'_'+baseMethod+'.png';var toggleCtrl=null;var labelCtrl=null;var labelText=null;var itemIcon=null;var Settings=SettingsStore.getInstance();var AutoexpandAllowed=true;var oldClassName=null;var selected=false;var maxChildsCount=49;this.element=null;this.control=_oControl;this.childsContainer=null;this.id=id;this.name=typeof(_oData['name'])!=='undefined'?_oData['name']:'noname';this.isRoot=(id===0);this.loaded=false;this.viewLink=typeof(_oData['link'])!=='undefined'?_oData['link']:false;this.editLink=typeof(_oData['edit-link'])!=='undefined'?_oData['edit-link']:false;this.createLink=typeof(_oData['create-link'])!=='undefined'?_oData['create-link']:false;this.permissions=typeof(_oData['permissions'])!=='undefined'?parseInt(_oData['permissions']):0;this.isActive=typeof(_oData['is-active'])!=='undefined'?parseInt(_oData['is-active']):0;this.isVirtualCopy=typeof(_oData['virtual-copy'])!=='undefined'?true:false;this.lockedBy=typeof(_oData['locked-by'])==='object'?_oData['locked-by']:null;this.expiration=typeof(_oData['expiration'])==='object'?_oData['expiration']:null;this.isDefault=typeof(_oData['is-default'])!=='undefined'?true:false;this.templateId=typeof(_oData['template-id'])!=='undefined'?_oData['template-id']:null;this.langId=typeof(_oData['lang-id'])!=='undefined'?_oData['lang-id']:null;this.domainId=typeof(_oData['domain-id'])!=='undefined'?_oData['domain-id']:null;this.allowCopy=typeof(_oData['allow-copy'])!=='undefined'?parseInt(_oData['allow-copy']):true;this.allowActivity=typeof(_oData['allow-activity'])!=='undefined'?parseInt(_oData['allow-activity']):true;this.allowDrag=typeof(_oData['allow-drag'])!=='undefined'?_oData['allow-drag']:true;this.parent=Parent;this.childs=[];this.hasChilds=(CountChilds>0||id==0);this.labelControl=null;this.position=false;this.isExpanded=false;this.filter=new filter;this.filter.setParentElements(id);this.pageing={'total':0,'limit':0,'offset':0};this.baseModule=(typeof(_oData['basetype'])!=='undefined'&&typeof(_oData['basetype']['module'])==='string')?_oData['basetype']['module']:"content";this.baseMethod=(typeof(_oData['basetype'])!=='undefined'&&typeof(_oData['basetype']['method'])==='string')?_oData['basetype']['method']:"";var __constructor=function(){if(_oParent){_oParent.childs[_oParent.childs.length]=id;__draw(Parent.childsContainer)}else{__drawRoot()}};var __draw=function(_oContainerEl){var element=document.createElement('li');element.setAttribute('rel',id);element.className='ti';element.rel=id;element.className='ti';element.onmousedown=function(){return false};labelCtrl=document.createElement('div');labelCtrl.className='ti';if(__self.isVirtualCopy)labelCtrl.className+=' virtual';if(__self.isDefault)labelCtrl.className+=' main-page';toggleCtrl=document.createElement('img');toggleCtrl.className='ti-toggle';var tsrc=__self.hasChilds?IconsPath+'expand.png':IconsPath+'collapse-disabled.png';toggleCtrl.setAttribute('src',tsrc);toggleCtrl.onclick=function(){__self.toggle();return false};labelCtrl.appendChild(toggleCtrl);itemIcon=document.createElement('img');itemIcon.style.border='0px';itemIcon.setAttribute('alt',typeName);itemIcon.setAttribute('title',typeName);itemIcon.setAttribute('src',iconSrc);itemIcon.className='ti-icon';itemIcon.onmousedown=function(){return false};if(__self.control.allowDrag&&__self.allowDrag)itemIcon.style.cursor='move';labelCtrl.appendChild(itemIcon);if(__self.expiration){var oStatus=__self.expiration['status'];if(oStatus){var statusSID=oStatus['id'];var statusName=oStatus['_value'];if(statusSID){var expInd=document.createElement('img');var ico=IconsPath+'ico_'+statusSID+'.png';expInd.setAttribute("src",ico);expInd.setAttribute("alt",statusName);expInd.setAttribute("title",statusName);expInd.className='page-status';labelCtrl.appendChild(expInd)}}}labelText=document.createElement('a');var title=__self.name;if(typeof title!='string'){title=getLabel('js-smc-noname-page')}if(title.length>45){title=title.substring(0,45)+"&#8230;"}labelText.innerHTML=title;if(__self.viewLink){labelText.title=__self.viewLink}if(__self.editLink){labelText.setAttribute('href',__self.editLink);labelText.onclick=function(){return __self.control.applyBehaviour(__self)}}else{labelText.setAttribute('href','#');labelText.onclick=function(){return false}}labelCtrl.appendChild(labelText);if(__self.isVirtualCopy){var virtualLabel=document.createElement('span');virtualLabel.className='label-virtual';virtualLabel.innerHTML=getLabel('js-smc-virtual-copy');labelCtrl.appendChild(virtualLabel)}__self.labelControl=element.appendChild(labelCtrl);if(!__self.isActive){$(itemIcon).fadeTo(1,0.5);$(labelText).fadeTo(1,0.5);$(toggleCtrl).fadeTo(1,0.5)}childsContainer=document.createElement('ul');childsContainer.className='ti-childs-container';childsContainer.style.display='none';__self.childsContainer=element.appendChild(childsContainer);if(SiblingItem){var prevEl=null;if(InsertMode.toLowerCase()=='after'){prevEl=SiblingItem.element.nextSibling}else{prevEl=SiblingItem.element}if(prevEl){__self.element=_oContainerEl.insertBefore(element,prevEl)}else{__self.element=_oContainerEl.appendChild(element)}}else{__self.element=_oContainerEl.appendChild(element)}if(__self.control.dragAllowed&&__self.allowDrag){var DropMode='child';$(labelCtrl).draggable({distance:Control.DragSensitivity,handle:'.ti-icon, a',helper:function(){var el=__self.element;var drag_el=document.createElement('div');drag_el.innerHTML='<div>'+__self.name+'</div>';drag_el.className='ti-draggable';$(drag_el).css({'position':'absolute','background':'url('+iconSrc+') no-repeat 0 4px'});return drag_el},start:function(){Control.DraggableItem=__self;Control.DragMode=true;if(__self.control.toolbar)__self.control.toolbar.hide()},stop:function(){if(Control.HandleItem){Control.HandleItem.deInitDroppable();if(Control.DraggableItem){Control.DraggableItem.tryMoveTo(Control.HandleItem,DropMode)}}Control.DraggableItem=null;Control.DragMode=false},drag:function(event,ui){var x=event.pageX;var y=event.pageY;var hItem=Control.detectItemByMousePointer(x,y);var oldHItem=Control.HandleItem;if(oldHItem){oldHItem.deInitDroppable()}Control.HandleItem=hItem;if(hItem){var cpos=$(hItem.control.initContainer).position();var itmHeight=hItem.position.bottom-hItem.position.top;var itmDelta=y-cpos.top-hItem.position.top;if(itmDelta<itmHeight/3){DropMode='before'}if(itmDelta>itmHeight/3&&itmDelta<2*itmHeight/3){DropMode='child'}if(itmDelta>2*itmHeight/3){DropMode='after'}if(hItem.isRoot)DropMode='child';hItem.initDroppable(DropMode)}}})}};var __drawRoot=function(){if(!Control.dropIndicator){var dropIndicator=document.createElement('div');dropIndicator.className='ti-drop';Control.dropIndicator=document.body.appendChild(dropIndicator)}__draw(__self.control.container)};var __autoExpandSelf=function(){if(AutoexpandAllowed&&__self===Control.HandleItem){__self.expand()}};this.draw=function(){if(_oParent){if(!ForceDraw)__draw(Parent.childsContainer)}else{if(!ForceDraw)__drawRoot()}};this.appendChild=function(_oChildData){return new TreeItem(this.control,__self,_oChildData)};this.appendAfter=function(_oChildData,oItem){return new TreeItem(this.control,__self,_oChildData,oItem,'after')};this.appendBefore=function(_oChildData,oItem){return new TreeItem(this.control,__self,_oChildData,oItem,'before')};this.appendFirst=function(_oChildData){if(!this.childsContainer.childNodes.length){return this.appendChild(_oChildData)}else if(typeof(this.childsContainer.childNodes[0].rel)!='undefined'){return this.appendBefore(_oChildData,this.control.getItem(this.childsContainer.childNodes[0].rel))}};this.getPreviousSibling=function(){var prevEl=this.element.previousSibling;if(prevEl&&prevEl.rel){return this.control.getItem(prevEl.rel)}return null};this.getNextSibling=function(){var prevEl=this.element.nextSibling;if(prevEl&&prevEl.rel){return this.control.getItem(prevEl.rel)}return null};this.clear=function(){if(this.element.parentNode){this.element.parentNode.removeChild(this.element)}};this.checkIsChild=function(oItem){var parent=this.parent;while(parent){if(oItem===parent)return true;parent=parent.parent}return false};this.recalcPosition=function(){try{var pos=$(labelCtrl).position();this.position={'left':pos.left,'top':pos.top,'right':this.control.initContainer.offsetWidth,'bottom':pos.top+labelCtrl.offsetHeight};return this.position}catch(e){return false}};this.getValue=function(fieldName){if(!Data['properties'])return false;if(!Data['properties']['group'])return false;var Groups=typeof(Data['properties']['group'][0])!='undefined'?Data['properties']['group']:[Data['properties']['group']];for(var i=0;i<Groups.length;i++){if(!Groups[i]['property'])continue;var Props=typeof(Groups[i]['property'][0])!='undefined'?Groups[i]['property']:[Groups[i]['property']];for(var j=0;j<Props.length;j++){if(Props[j]['name']==fieldName){return Props[j]['value']}}}return false};this.getData=function(){return Data};this.setLoaded=function(loaded){this.loaded=loaded;var ico=loaded?IconsPath+'collapse.png':IconsPath+'expand.png';toggleCtrl.setAttribute('src',IconsPath+'collapse.png')};this.setPageing=function(pageing){if(!pageing)return false;this.pageing=pageing};this.expand=function(){if(!this.hasChilds)return false;this.isExpanded=true;if(!this.loaded){if(CountChilds>maxChildsCount){var self=this;openDialog({'title':getLabel('js-expand-big-title'),'text':getLabel('js-expand-big-shured'),'OKText':getLabel('js-expand-do'),'cancelText':getLabel('js-cancel'),'OKCallback':function(){self.control.load(self.filter);toggleCtrl.setAttribute('src',IconsPath+'loading.gif');self.childsContainer.style.display='';Control.recalcItemsPosition();self.control.saveItemState(self.id)}});return}this.control.load(this.filter);toggleCtrl.setAttribute('src',IconsPath+'loading.gif')}else{toggleCtrl.setAttribute('src',IconsPath+'collapse.png')}this.childsContainer.style.display='';Control.recalcItemsPosition();this.control.saveItemState(this.id)};this.collapse=function(){if(!this.hasChilds)return false;this.isExpanded=false;toggleCtrl.setAttribute('src',IconsPath+'expand.png');this.childsContainer.style.display='none';Control.recalcItemsPosition();this.control.saveItemState(this.id)};this.toggle=function(){if(this.hasChilds){this.isExpanded?this.collapse():this.expand()}};this.update=function(_oNewData){if(_oNewData){if(this.id!=_oNewData.id)return false;if(typeof(_oNewData['template-id'])!=='undefined')this.templateId=_oNewData['template-id'];if(typeof(_oNewData['link'])!=='undefined'&&_oNewData['link']!=this.viewLink){this.viewLink=_oNewData['link'];labelCtrl.setAttribute('href',this.viewLink)}if(typeof(_oNewData['childs'])!=='undefined'&&parseInt(_oNewData['childs'])!==CountChilds){CountChilds=parseInt(_oNewData['childs']);this.hasChilds=CountChilds>0||id==0;var tsrc=IconsPath+'collapse-disabled.png';if(this.hasChilds){tsrc=this.isExpanded?IconsPath+'collapse.png':IconsPath+'expand.png'}toggleCtrl.setAttribute('src',tsrc)}var newActive=typeof(_oNewData['is-active'])!=='undefined'?parseInt(_oNewData['is-active']):0;if(newActive!==this.isActive){this.isActive=newActive;if(!this.isActive){$(itemIcon).fadeTo(300,0.5);$(toggleCtrl).fadeTo(300,0.5);$(labelText).fadeTo(300,0.5)}else{$(itemIcon).fadeTo(300,1);$(toggleCtrl).fadeTo(300,1);$(labelText).fadeTo(300,1)}}if(typeof(_oNewData['name'])!=='undefined'&&_oNewData['name']!=this.name){this.name=_oNewData['name'];labelText.innerHTML=this.name}}};this.tryMoveTo=function(Item,MoveMode){if(Item){var before=this.control.getRootNodeId();var rel=Item.id;var asSibling=MoveMode!=='child'?1:0;if(MoveMode=='before'){before=Item.id;rel=Item.parent.id}if(MoveMode=='after'){var s=Item.getNextSibling();rel=Item.parent.id;before=s?s.id:this.control.getRootNodeId()}if(Item===this)return false;if(Item.checkIsChild(this))return false;if(before==this.id)return false;var receiver=Item;if(asSibling){receiver=Item.parent?Item.parent:Item.control.getRoot()}this.control.dataSet.execute('tree_move_element',{'element':this.id,'before':before,'rel':rel,'as-sibling':asSibling,'domain':Item.control.getRoot().name,'childs':1,'links':1,'virtuals':1,'permissions':1,'templates':1,'receiver_item':receiver,'handle_item':this})}};this.initDroppable=function(DropMode){var DropMode=DropMode||'child';var di=Control.DraggableItem;var cpos=$(this.control.initContainer).position();if(di){if(di===this)return false;if(this.checkIsChild(di))return false;var ind=Control.dropIndicator;if(DropMode=='after'){ind.style.top=this.position.bottom+cpos.top+'px';ind.style.left=this.position.left+cpos.left+'px';ind.style.width=this.position.right-this.position.left}if(DropMode=='before'){ind.style.top=this.position.top+cpos.top+ind.offsetHeight+'px';ind.style.left=this.position.left+cpos.left+'px';ind.style.width=this.position.right-this.position.left+'px'}if(DropMode=='child'){ind.style.top=this.position.bottom+cpos.top+'px';ind.style.left=this.position.left+cpos.left+20+'px';ind.style.width=this.position.right+cpos.left-20-this.position.left+'px'}ind.style.display='';setTimeout(__autoExpandSelf,3239)}};this.deInitDroppable=function(){if(!Control.dropIndicator)return;Control.dropIndicator.style.display='none'};this.applyFilter=function(_Filter,ignoreHierarchy){if(_Filter instanceof Object){this.filter=_Filter}else{this.filter.clear()}if(!ignoreHierarchy)this.filter.setParentElements(id);if(this.loaded){this.control.removeItem(id,true);this.loaded=false;if(this.isExpanded)this.expand()}};this.setSelected=function(_selected){if(_selected){if(!oldClassName){oldClassName='ti';labelCtrl.className='ti selected-highlight';if(__self.isDefault)labelCtrl.className+=' main-page'}selected=true}else{if(oldClassName){labelCtrl.className=oldClassName;if(__self.isDefault)labelCtrl.className+=' main-page';oldClassName=null}selected=false}};this.getSelected=function(){return selected};__constructor()};ContextMenu={};ContextMenu.itemHandlers={};ContextMenu.itemHandlers.viewElement=function(action){if(!Control.HandleItem)return false;if(!Control.HandleItem.id)return false;var items=Control.HandleItem.control.selectedList;var i,item,size=0;for(i in items){item=items[i];size++}if(!item)return false;var viewLink=item.getData()['link'];if(!viewLink){return false}var disabled=(size!=1);return{caption:getLabel('js-'+action[0]),icon:action[1],visible:true,disabled:disabled,execute:function(){window.location=viewLink;return false}}};ContextMenu.itemHandlers.editItem=function(action){if(!Control.HandleItem)return false;if(!Control.HandleItem.id)return false;var items=Control.HandleItem.control.selectedList;var i,item,size=0;for(i in items){item=items[i];size++}if(!item)return false;var editLink=item.editLink;if(!editLink){return false}var disabled=(size!=1||!editLink);return{caption:getLabel('js-'+action[0]),icon:action[1],visible:true,disabled:disabled,execute:function(){window.location=editLink;return false}}};ContextMenu.itemHandlers.addItem=function(action){if(!Control.HandleItem)return false;var items=Control.HandleItem.control.selectedList;var i,item,size=0;for(i in items){item=items[i];size++}if(!item)return false;var createLink=item.createLink;if(!createLink){return false}var disabled=(size!=1||!createLink);return{caption:getLabel('js-'+action[0]),icon:action[1],visible:true,disabled:disabled,execute:function(){window.location=createLink;return false}}};ContextMenu.itemHandlers.filterItem=function(action){if(!Control.HandleItem)return false;if(!Control.HandleItem.id)return false;if(Control.HandleItem.control.flatMode||Control.HandleItem.control.objectTypesMode){return false}var control=Control.HandleItem.control;var items=Control.HandleItem.control.selectedList,i,n=0;var hasTrue=false,hasFalse=false;for(i in items){var item=items[i];if(control.isTarget(item)){hasTrue=true}else{hasFalse=true}n++}var disabled=false;if(n==1){if(!item.hasChilds){disabled=true}}return{caption:getLabel('js-'+action[0]),icon:hasTrue?'checked':'undefined',visible:true,disabled:disabled,execute:function(){var control=Control.HandleItem.control;control.setTargetItems(hasTrue?{}:control.selectedList);return false}}};ContextMenu.itemHandlers.activeItem=function(action){if(!Control.HandleItem)return false;if(!Control.HandleItem.id)return false;if(Control.HandleItem.control.flatMode||Control.HandleItem.control.objectTypesMode){return false}var items=Control.HandleItem.control.selectedList,i;var hasTrue=false,hasFalse=false;for(i in items){if(items[i].isActive){hasTrue=true}else{hasFalse=true}}var checked=(hasTrue&&!hasFalse);return{caption:getLabel('js-'+action[0]),icon:checked?'ico_unblock':'ico_block',visible:true,execute:function(){var control=Control.HandleItem.control,i,ids=new Array();for(i in items){ids.push(i)}control.dataSet.execute('tree_set_activity',{'element':ids,'selected_items':items,'active':(checked?0:1)});return false}}};ContextMenu.itemHandlers.activeObjectItem=function(){if(!Control.HandleItem)return false;if(!Control.HandleItem.id)return false;if(!Control.HandleItem.control.flatMode){return false}var items=Control.HandleItem.control.selectedList,i;var hasTrue=false,hasFalse=false;for(i in items){var item=items[i];if(item.getValue('is_activated')||item.getValue('is_active')||item.getValue('activated')){hasTrue=true}else{hasFalse=true}}var checked=(hasTrue&&!hasFalse);return{caption:getLabel('js-'+action[0]),icon:checked?'ico_unblock':'ico_block',visible:true,execute:function(){var control=Control.HandleItem.control,i,ids=new Array();for(i in items){ids.push(i)}control.dataSet.execute('tree_set_activity',{'object':ids,'selected_items':items,'viewMode':'full','active':(checked?0:1)});return false}}};ContextMenu.itemHandlers.activeObjectItem=function(action){if(!Control.HandleItem)return false;if(!Control.HandleItem.id)return false;if(!Control.HandleItem.control.flatMode){return false}var items=Control.HandleItem.control.selectedList,i;var hasTrue=false,hasFalse=false;for(i in items){var item=items[i];if(item.getValue('is_activated')||item.getValue('is_active')||item.getValue('activated')){hasTrue=true}else{hasFalse=true}}var checked=(hasTrue&&!hasFalse);return{caption:getLabel('js-'+action[0]),icon:action[1],visible:true,execute:function(){var control=Control.HandleItem.control,i,ids=new Array();for(i in items){ids.push(i)}control.dataSet.execute('tree_set_activity',{'object':ids,'selected_items':items,'viewMode':'full','active':(checked?0:1)});return false}}};ContextMenu.itemHandlers.deleteItem=function(action){if(!Control.HandleItem)return false;if(!Control.HandleItem.id)return false;var items=Control.HandleItem.control.selectedList;if(items.length<1){return false}return{caption:getLabel('js-'+action[0]),icon:action[1],visible:true,execute:function(){var control=Control.HandleItem.control,i,ids=new Array();var items=control.selectedList;for(i in items){var item=items[i];if(item.lockedBy){alert(getLabel('js-page-is-locked')+"\n"+getLabel('js-steal-lock-question'));ContextMenu.getInstance().terminate();return false}ids.push(i)}control.dataSet.execute('tree_delete_element',{'element':ids,'selected_items':items});return false}}};ContextMenu.itemHandlers.templatesItem=function(action){if(!Control.HandleItem)return false;if(!Control.HandleItem.id)return false;if(Control.HandleItem.control.flatMode||Control.HandleItem.control.objectTypesMode){return false}var items=Control.HandleItem.control.selectedList;var i,langId=false,domainId=false,templateId=false,multipleTemplates=false;for(i in items){var item=items[i];if(!langId||!domainId){langId=item.langId;domainId=item.domainId}if(templateId&&multipleTemplates){if(templateId!=item.templateId){templateId=false}}if(!templateId&&!multipleTemplates){templateId=item.templateId;multipleTemplates=true}}var tds=TemplatesDataSet.getInstance();var i,templateItems={},templates=tds.getTemplatesList(domainId,langId);var getClickCallback=function(template_id){return function(){if(!Control.HandleItem)return false;var control=Control.HandleItem.control,i,ids=new Array();for(i in items){ids.push(i)}control.dataSet.execute('change_template',{'element':ids,'selected_items':items,'template-id':template_id,'templates':1,'childs':1,'permissions':1,'virtuals':1,'links':1});return false}};for(i in templates){var template=templates[i];var id=template['id'],title=template['title'],checked=false;if(!id)continue;if(templateId&&templateId==id){checked=true}templateItems[id]={icon:checked?'checked':'undefined',caption:title,execute:getClickCallback(id)}}return{caption:getLabel('js-'+action[0]),icon:action[1],visible:true,execute:function(){return false},submenu:templateItems}};ContextMenu.itemHandlers.moveItem=function(action){if(!Control.HandleItem)return false;if(!Control.HandleItem.id)return false;if(Control.HandleItem.control.flatMode||Control.HandleItem.control.objectTypesMode){return false}var items=Control.HandleItem.control.selectedList;var i,item,langId=false;for(i in items){var item=items[i];langId=item.langId}var tds=TemplatesDataSet.getInstance();var langsList=tds.getLangsList(),i;var getClickCallback=function(langId){return function(){var control=Control.HandleItem.control,i,ids=new Array();for(i in items){ids.push(i)}control.dataSet.execute('move_to_lang',{'element':ids,'selected_items':items,'lang-id':langId,'templates':1,'childs':1,'permissions':1,'virtuals':1,'links':1});return false}};var menuItems={};for(var i=0;i<langsList.length;i++){var lang=langsList[i];var checked=(langId==lang['id']);menuItems[lang['id']]={icon:checked?'checked':'undefined',caption:lang['nodeValue'],execute:getClickCallback(lang['id'])}}return{caption:getLabel('js-'+action[0]),visible:true,execute:function(){return false},submenu:menuItems}};ContextMenu.itemHandlers.storeGoodsItem=function(){if(!Control.HandleItem)return false;if(!Control.HandleItem.id)return false;var items=Control.HandleItem.control.selectedList;var i,item,size=0;for(i in items){item=items[i];size++}if(!item)return false;var viewLink=window.pre_lang+"/admin/eshop/store_view/"+item.id+"/";if(!viewLink){return false}var disabled=(size!=1);return{'title':getLabel('js-view-store-goods'),'callback':function(){window.location=viewLink;return false},'disabled':disabled}};ContextMenu.itemHandlers.guideViewItem=function(){if(!Control.HandleItem)return false;if(!Control.HandleItem.id)return false;var items=Control.HandleItem.control.selectedList;var i,item,size=0;for(i in items){item=items[i];size++}if(!item)return false;var viewLink=window.pre_lang+"/admin/data/guide_items/"+item.id+"/";if(!viewLink){return false}var _disabled=(size>1);return{caption:getLabel('js-view-guide-items'),icon:'view',execute:function(){window.location=viewLink;return false},disabled:_disabled}};ContextMenu.itemHandlers.csvExport=function(action){if(!Control.HandleItem)return false;if(!Control.HandleItem.id)return false;if(Control.HandleItem.control.objectTypesMode||Control.HandleItem.control.flatMode)return false;var items=Control.HandleItem.control.selectedList;var i,item,size=0;for(i in items){item=items[i];size++}if(!item.hasChilds){return false}if(size!=1){return false}var elementId=item.id;var _item=item;return{caption:getLabel('js-csv-export'),icon:action[1],visible:true,execute:function(){var link=_item.getExportLink(elementId);window.location=link;return false}}};ContextMenu.itemHandlers.csvImport=function(action){if(!Control.HandleItem)return false;if(!Control.HandleItem.id)return false;if(Control.HandleItem.control.objectTypesMode||Control.HandleItem.control.flatMode)return false;var items=Control.HandleItem.control.selectedList;var i,item,size=0;for(i in items){item=items[i];size++}if(!item.hasChilds){}if(size!=1){return false}var elementId=item.id;var _item=item;return{caption:getLabel('js-csv-import'),icon:action[1],visible:true,execute:function(){var link=_item.getImportLink(elementId);_item.callCsvImport(link);return false}}};ContextMenu.itemHandlers.restoreItem=function(action){if(!Control.HandleItem)return false;if(!Control.HandleItem.id)return false;var items=Control.HandleItem.control.selectedList;if(items.length<1){return false}return{caption:getLabel('js-trash-restore'),icon:action[1],visible:true,execute:function(){var control=Control.HandleItem.control,i,ids=new Array();var items=control.selectedList;for(i in items){ids.push(i)}control.dataSet.execute('restore_element',{'element':ids,'selected_items':items});return false}}};ContextMenu.itemHandlers.typeRemove=function(){};ContextMenu.itemHandlers.typeEdit=function(){};ContextMenu.allowControlEnable=true;