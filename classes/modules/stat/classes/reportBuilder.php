<?php
class reportBuilder{const DATE_FORMAT = 'Y-m-d';protected $start;protected $finish;protected $interval = '-10 days';protected $host_id;protected $graphType = 'graphic';protected $groupby;protected $groupByValid = array('day' => '`day`, `month`', 'week' => '`week`', 'month' => '`month`');private $filters = array();private $index;private $index2;public function __construct()    {$this->setDomain($_SERVER['SERVER_NAME']);}public function setIndex($v6a992d5529f459a44fee58c733255e86)    {$this->index = $v6a992d5529f459a44fee58c733255e86;}public function setIndex2($v6a992d5529f459a44fee58c733255e86)    {$this->index2 = $v6a992d5529f459a44fee58c733255e86;}public function addFilter($vb068931cc450442b63f5b3d276ea4297, $v2063c1608d6e0baf80249c42e2be5804)    {$this->filters[] = array('name' => $vb068931cc450442b63f5b3d276ea4297, 'value' => $v2063c1608d6e0baf80249c42e2be5804);}public function build()    {$result = $this->doQuery($this->index);if (!empty($this->index2)) {$v486a9bbc2c582b30c8899b6f20a7e59e = $this->doQuery($this->index2);$vfa816edb83e95bf0c8da580bdfd491ef = array();foreach ($result as $v3a6d0284e743dc4a9b86f97d6dd1a3bf) {$vfa816edb83e95bf0c8da580bdfd491ef[$v3a6d0284e743dc4a9b86f97d6dd1a3bf['period']] = $v3a6d0284e743dc4a9b86f97d6dd1a3bf;}foreach ($v486a9bbc2c582b30c8899b6f20a7e59e as $v3a6d0284e743dc4a9b86f97d6dd1a3bf) {$vfa816edb83e95bf0c8da580bdfd491ef[$v3a6d0284e743dc4a9b86f97d6dd1a3bf['period']]['cnt2'] = $v3a6d0284e743dc4a9b86f97d6dd1a3bf['cnt'];}$result = $vfa816edb83e95bf0c8da580bdfd491ef;}echo '<pre>';var_dump($result);echo '</pre>';}public function doQuery($v6a992d5529f459a44fee58c733255e86)    {if ($v6a992d5529f459a44fee58c733255e86 == 'visitersCount' || $v6a992d5529f459a44fee58c733255e86 == 'refusesCount') {$v6bf9e70a1f928aba143ef1eebe2720b5 = 'SELECT `p`.`id` FROM `cms_stat_paths` `p`';}else {$v6bf9e70a1f928aba143ef1eebe2720b5 = 'SELECT `h`.`id` FROM `cms_stat_paths` `p`
                     INNER JOIN `cms_stat_hits` `h` ON `h`.`path_id` = `p`.`id`';}if (empty($this->filters)) {$ve1f7b2da8430ed229617339c5e6817e9 = 'tmp_filtered0';l_mysql_query($v49b91458994a9d56cc11a6be194be525 = "DROP TEMPORARY TABLE IF EXISTS `" . $ve1f7b2da8430ed229617339c5e6817e9 . "`");l_mysql_query($v90e981b07f44c647ceda11f6ba0d5e4e = "CREATE TEMPORARY TABLE `" . $ve1f7b2da8430ed229617339c5e6817e9 . "` (`id` INT, KEY `id` (`id`)) ENGINE = MEMORY");l_mysql_query($v5c7334b14af0f97c2c16121a62990f9c = "INSERT INTO `" . $ve1f7b2da8430ed229617339c5e6817e9 . "` " . $v6bf9e70a1f928aba143ef1eebe2720b5 . " WHERE `p`.`date` BETWEEN " . $this->getQueryInterval() . " " . $this->getHostSQL("p") . "");}foreach ($this->filters as $v3c6e0b8a9c15224a8228b9a98ca1531d => $v3a6d0284e743dc4a9b86f97d6dd1a3bf) {$ve1f7b2da8430ed229617339c5e6817e9 = 'tmp_filtered' . $v3c6e0b8a9c15224a8228b9a98ca1531d;$vf09cc7ee3a9a93273f4b80601cafb00c = '';if (is_array($v3a6d0284e743dc4a9b86f97d6dd1a3bf['value'])) {foreach ($v3a6d0284e743dc4a9b86f97d6dd1a3bf['value'] as $v9e3669d19b675bd57058fd4664205d2a) {$vf09cc7ee3a9a93273f4b80601cafb00c .= "'" . mysql_real_escape_string($v9e3669d19b675bd57058fd4664205d2a) . "', ";}$vf09cc7ee3a9a93273f4b80601cafb00c = substr($vf09cc7ee3a9a93273f4b80601cafb00c, 0, -2);}else {$vf09cc7ee3a9a93273f4b80601cafb00c = "'" . mysql_real_escape_string($v3a6d0284e743dc4a9b86f97d6dd1a3bf['value']) . "'";}l_mysql_query("DROP TEMPORARY TABLE IF EXISTS `" . $ve1f7b2da8430ed229617339c5e6817e9 . "`");l_mysql_query("CREATE TEMPORARY TABLE `" . $ve1f7b2da8430ed229617339c5e6817e9 . "` (`id` INT, KEY `id` (`id`)) ENGINE = MEMORY");if ($v3a6d0284e743dc4a9b86f97d6dd1a3bf['name'] == 'searchEngine') {$v36f75e2036c54462c47b965f4a581cff = 'INSERT INTO `' . $ve1f7b2da8430ed229617339c5e6817e9 . '` ' . $v6bf9e70a1f928aba143ef1eebe2720b5 . " INNER JOIN `cms_stat_sources` `s` ON `p`.`source_id` = `s`.`id`
                         INNER JOIN `cms_stat_sources_search` `ss` ON `ss`.`id` = `s`.`concrete_src_id`
                          INNER JOIN `cms_stat_sources_search_engines` `sse` ON `sse`.`id` = `ss`.`engine_id` " .                          ($v3c6e0b8a9c15224a8228b9a98ca1531d > 0 ? ' INNER JOIN `tmp_filtered' . ($v3c6e0b8a9c15224a8228b9a98ca1531d - 1) . '` `t` ON `t`.`id` = `p`.`id`' : '') .                          "WHERE `p`.`date` BETWEEN " . $this->getQueryInterval() . "  " . $this->getHostSQL("p") . " AND `s`.`src_type` = 2  AND `sse`.`name` IN (" . $vf09cc7ee3a9a93273f4b80601cafb00c . ")";}elseif ($v3a6d0284e743dc4a9b86f97d6dd1a3bf['name'] == 'searchQuery') {$v36f75e2036c54462c47b965f4a581cff = 'INSERT INTO `' . $ve1f7b2da8430ed229617339c5e6817e9 . '` ' . $v6bf9e70a1f928aba143ef1eebe2720b5 . " INNER JOIN `cms_stat_sources` `s` ON `p`.`source_id` = `s`.`id`
                         INNER JOIN `cms_stat_sources_search` `ss` ON `ss`.`id` = `s`.`concrete_src_id`
                          INNER JOIN `cms_stat_sources_search_queries` `ssq` ON `ssq`.`id` = `ss`.`text_id` " .                          ($v3c6e0b8a9c15224a8228b9a98ca1531d > 0 ? ' INNER JOIN `tmp_filtered' . ($v3c6e0b8a9c15224a8228b9a98ca1531d - 1) . '` `t` ON `t`.`id` = `p`.`id`' : '') .                          "WHERE `p`.`date` BETWEEN " . $this->getQueryInterval() . " " . $this->getHostSQL("p") . " AND `s`.`src_type` = 2  AND `ssq`.`text` IN (" . $vf09cc7ee3a9a93273f4b80601cafb00c . ")";}elseif ($v3a6d0284e743dc4a9b86f97d6dd1a3bf['name'] == 'linkedSites') {$v36f75e2036c54462c47b965f4a581cff = "INSERT INTO `' . $ve1f7b2da8430ed229617339c5e6817e9 . '` " .                $v6bf9e70a1f928aba143ef1eebe2720b5 .                " INNER JOIN `cms_stat_sources` `s` ON `p`.`source_id` = `s`.`id`
                              INNER JOIN `cms_stat_sources_sites` `ss` ON `ss`.`id` = `s`.`concrete_src_id`
                               INNER JOIN `cms_stat_sources_sites_domains` `ssd` ON `ssd`.`id` = `ss`.`domain`
                                WHERE `p`.`date` BETWEEN " . $this->getQueryInterval() . " " . $this->getHostSQL("p") . " AND `s`.`src_type` = 1 AND `ssd`.`name` IN (" . $vf09cc7ee3a9a93273f4b80601cafb00c . ")";}elseif ($v3a6d0284e743dc4a9b86f97d6dd1a3bf['name'] == 'goals') {$v36f75e2036c54462c47b965f4a581cff = 'INSERT INTO `' . $ve1f7b2da8430ed229617339c5e6817e9 . '` ' . $v6bf9e70a1f928aba143ef1eebe2720b5 . " INNER JOIN `cms_stat_hits` `h2` ON `h2`.`path_id` = `p`.`id`
                          INNER JOIN `cms_stat_events_collected` `ec` ON `ec`.`hit_id` = `h2`.`id`
                           INNER JOIN `cms_stat_events` `e` ON `e`.`id` = `ec`.`event_id`
                            WHERE `p`.`date` BETWEEN " . $this->getQueryInterval() . " " . $this->getHostSQL("p") . " AND `e`.`name` = (" . $vf09cc7ee3a9a93273f4b80601cafb00c . ") AND `e`.`type` = 1";}l_mysql_query($v36f75e2036c54462c47b965f4a581cff) or die(mysql_error());}if ($this->graphType != 'histogramVertical') {if ($v6a992d5529f459a44fee58c733255e86 == 'visitersCount') {$v36f75e2036c54462c47b965f4a581cff = "SELECT COUNT(*) AS `cnt`, UNIX_TIMESTAMP(`date`) AS `ts`, DATE_FORMAT(`date`, '%d') AS `day`, DATE_FORMAT(`date`, '%c') AS `month`, DATE_FORMAT(`date`, '%Y') AS `year`, DATE_FORMAT(`date`, '%u') AS `week`, DATE_FORMAT(`date`, '" . $this->getGroupBySign() . "') AS `period`
                     FROM `" . $ve1f7b2da8430ed229617339c5e6817e9 . "` `tmp`
                      INNER JOIN `cms_stat_paths` `p` ON `tmp`.`id` = `p`.`id`
                       GROUP BY " . $this->calcGroupby() . ", `year`
                        ORDER BY " . $this->getOrderByField();}elseif ($v6a992d5529f459a44fee58c733255e86 == 'refusesCount') {$v36f75e2036c54462c47b965f4a581cff = "SELECT COUNT(*) AS `cnt`, `ts`, `period` FROM (
                     SELECT MAX(`number_in_path`) AS `level`, `h`.`day`, `h`.`month`, `h`.`year`, `h`.`week`, UNIX_TIMESTAMP(`h`.`date`) AS `ts`, `h`." . $this->calcGroupby() . " AS `period` FROM `" . $ve1f7b2da8430ed229617339c5e6817e9 . "` `tmp`
                      INNER JOIN `cms_stat_hits` `h` ON `h`.`path_id` = `tmp`.`id`
                       WHERE `h`.`date` BETWEEN " . $this->getQueryInterval() . "
                        GROUP BY `tmp`.`id`
                         HAVING `level` = 1
                         ) AS `h`
                    GROUP BY " . $this->calcGroupby() . ", `year`
                     ORDER BY " . $this->getOrderByField();}elseif ($v6a992d5529f459a44fee58c733255e86 == 'events') {$v36f75e2036c54462c47b965f4a581cff = "SELECT COUNT(*) AS `cnt`, UNIX_TIMESTAMP(`h`.`date`) AS `ts`, `h`." . $this->calcGroupby() . " AS `period` FROM `" . $ve1f7b2da8430ed229617339c5e6817e9 . "` `tmp`
                     INNER JOIN `cms_stat_hits` `h` ON `h`.`id` = `tmp`.`id`
                      INNER JOIN `cms_stat_events_collected` `ec` ON `ec`.`hit_id` = `tmp`.`id`
                       INNER JOIN `cms_stat_events` `e` ON `e`.`id` = `ec`.`event_id`
                        GROUP BY " . $this->calcGroupby() . ", `year`
                         ORDER BY " . $this->getOrderByField();}elseif ($v6a992d5529f459a44fee58c733255e86 == 'profit') {$v36f75e2036c54462c47b965f4a581cff = "SELECT SUM(`profit`) AS `cnt`, UNIX_TIMESTAMP(`h`.`date`) AS `ts`, `h`." . $this->calcGroupby() . " AS `period` FROM `" . $ve1f7b2da8430ed229617339c5e6817e9 . "` `tmp`
                     INNER JOIN `cms_stat_hits` `h` ON `h`.`id` = `tmp`.`id`
                      INNER JOIN `cms_stat_events_collected` `ec` ON `ec`.`hit_id` = `tmp`.`id`
                       INNER JOIN `cms_stat_events` `e` ON `e`.`id` = `ec`.`event_id`
                        GROUP BY " . $this->calcGroupby() . ", `year`
                         ORDER BY " . $this->getOrderByField();}else {throw new Exception('Недопустимый параметр');}}else {if ($v6a992d5529f459a44fee58c733255e86 == 'visitersCount') {$v36f75e2036c54462c47b965f4a581cff = "SELECT COUNT(*) AS `cnt`, IF(`count` > 10, IF(`count` > 20, IF(`count` > 30, IF(`count` > 40, IF(`count` > 50, 51, 41), 31), 21), 11), `count`) AS `count`, DATE_FORMAT(`date`, '" . $this->getGroupBySign() . "') AS `period`
                         FROM

                        (SELECT COUNT(*) AS `count`, `date`  FROM `" . $ve1f7b2da8430ed229617339c5e6817e9 . "` `tmp`
                         INNER JOIN `cms_stat_paths` `p` ON `p`.`id` = `tmp`.`id`
                          GROUP BY `user_id`) `x`

                          GROUP BY `x`.`count`";}elseif ($v6a992d5529f459a44fee58c733255e86 == 'refusesCount') {$v36f75e2036c54462c47b965f4a581cff = "SELECT COUNT(*) AS `cnt`, IF(`count` > 10, IF(`count` > 20, IF(`count` > 30, IF(`count` > 40, IF(`count` > 50, 51, 41), 31), 21), 11), `count`) AS `count`, DATE_FORMAT(`date`, '" . $this->getGroupBySign() . "') AS `period`
                        FROM
                        (
                        SELECT COUNT(*) AS `count`, `date` FROM

                        (
                        SELECT MAX(`h`.`number_in_path`) AS `level`, `p`.`id`, `p`.`user_id`, `p`.`date` FROM `" . $ve1f7b2da8430ed229617339c5e6817e9 . "` `tmp`
                         INNER JOIN `cms_stat_paths` `p` ON `p`.`id` = `tmp`.`id`
                          INNER JOIN `cms_stat_hits` `h` ON `h`.`path_id` = `p`.`id`
                           GROUP BY `p`.`id`
                            HAVING `level` = 1
                        ) `inn`
                        GROUP BY `inn`.`user_id`
                        ) `out`
                        GROUP BY `out`.`count`";}}$v9b207167e5381c47682c6b4f58a623fb = l_mysql_query($v36f75e2036c54462c47b965f4a581cff);$result = array();while ($vf1965a857bc285d26fe22023aa5ab50d = mysql_fetch_assoc($v9b207167e5381c47682c6b4f58a623fb)) {$result[] = $vf1965a857bc285d26fe22023aa5ab50d;}return $result;}public function setGraphType($v599dcce2998a6b40b1e38e8c6006cb0a)    {$v9b0328f6538320b019c56e7a2e6d64ad = array('graphic', 'histogramHorizontal', 'histogramVertical', 'pieChart');$this->graphType = in_array($v599dcce2998a6b40b1e38e8c6006cb0a, $v9b0328f6538320b019c56e7a2e6d64ad) ? $v599dcce2998a6b40b1e38e8c6006cb0a : $v9b0328f6538320b019c56e7a2e6d64ad[0];}public function setFinish($v3248bc7547ce97b2a197b2a06cf7283d)    {if (!is_integer($v3248bc7547ce97b2a197b2a06cf7283d)) {throw new invalidParameterException('Значение свойства finish должно быть целочисленного типа и > 0', $v3248bc7547ce97b2a197b2a06cf7283d);}$this->finish = $v3248bc7547ce97b2a197b2a06cf7283d;$this->setInterval($this->interval);}public function setInterval($vd2e16d3f793e62737a6cdf2d54b0d9c1)    {$vea2b2676c28c0db26d39331a336c6b92 = strtotime($vd2e16d3f793e62737a6cdf2d54b0d9c1, $this->finish);if (!is_integer($vea2b2676c28c0db26d39331a336c6b92)) {throw new invalidParameterException('Интервал должен задаваться в соответствии с требованиями к входным параметрам функции strtotime', $vd2e16d3f793e62737a6cdf2d54b0d9c1);}$this->start = $vea2b2676c28c0db26d39331a336c6b92;}public function setDomain($vad5f82e879a9c5d6b5b442eb37e50551)    {$this->host_id = $this->searchHostIdByHostname($vad5f82e879a9c5d6b5b442eb37e50551);}protected function searchHostIdByHostname($v0897acf49c7c1ea9f76efe59187aa046)    {$v9b207167e5381c47682c6b4f58a623fb = l_mysql_query("SELECT `group_id` AS `id` FROM `cms_stat_sites`
                             WHERE `name` = '" . mysql_real_escape_string($v0897acf49c7c1ea9f76efe59187aa046) . "'");$vf1965a857bc285d26fe22023aa5ab50d = mysql_fetch_assoc($v9b207167e5381c47682c6b4f58a623fb);return (int)$vf1965a857bc285d26fe22023aa5ab50d['id'];}protected function formatDate($v5fc732311905cb27e82d67f4f6511f7f)    {return date(self::DATE_FORMAT, $v5fc732311905cb27e82d67f4f6511f7f);}protected function getQueryInterval()    {return "'" . $this->formatDate($this->start) . "' AND '" . $this->formatDate($this->finish) . "'";}private function calcGroupby()    {if (!empty($this->groupby)) {return $this->groupByValid[$this->groupby];}$v480b0ab43f368eb46e331029cacb5d1e = ceil(($this->finish - $this->start) / (3600 * 24));if ($v480b0ab43f368eb46e331029cacb5d1e > 180) {return $this->groupByValid['month'];}elseif ($v480b0ab43f368eb46e331029cacb5d1e > 30) {return $this->groupByValid['week'];}return $this->groupByValid['day'];}private function getGroupBySign()    {$va5111ae8faeabbeecb633cbcf2f0a04a = $this->calcGroupby();return $va5111ae8faeabbeecb633cbcf2f0a04a == '`day`' ? '%d' : $va5111ae8faeabbeecb633cbcf2f0a04a == '`week`' ? '%u' : '%c';}public function setGroupBy($va5111ae8faeabbeecb633cbcf2f0a04a)    {if (isset($this->groupByValid[$va5111ae8faeabbeecb633cbcf2f0a04a])) {$this->groupby = $va5111ae8faeabbeecb633cbcf2f0a04a;}}private function getOrderByField()    {if ($this->graphType == 'histogramHorizontal') {return '`cnt` DESC';}elseif ($this->graphType == 'graphic') {return '`ts` ASC';}else {return '`cnt` ASC';}}}?>