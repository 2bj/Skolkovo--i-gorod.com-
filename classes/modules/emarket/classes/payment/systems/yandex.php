<?php
 class yandexPayment extends payment {const STATUS_SUCCESS    = 0;const STATUS_AUTHERROR     = 1;const STATUS_DECLINE    = 100;const STATUS_REQUESTERROR  = 200;const STATUS_INTERNALERROR = 1000;private static $BILLING_IP = array('77.75.152.36', '77.75.157.172', '77.75.157.163', '77.75.152.36', '77.75.157.172');public function validate() {return true;}public function process($v66f6181bcb4cff4cd38fbc804a036db6 = null) {$v77ae253367b37a7ffeed106cfba63d37 = $this->object->shop_id;$ve78cbbe1114af26550a6322904a07657 = $this->object->bank_id;$v09e60502ecf8daf9fb79c130fb21043a   = $this->object->scid;if(!strlen($v77ae253367b37a7ffeed106cfba63d37) || !strlen($v09e60502ecf8daf9fb79c130fb21043a)) {throw new publicException(getLabel('error-payment-wrong-settings'));}$vf577972c317be099478aeac2a0f911ff = (float) $this->order->getActualPrice();$veca07335a33c5aeb5e1bc7c98b4b9d80 = array();$veca07335a33c5aeb5e1bc7c98b4b9d80['shopId'] = $v77ae253367b37a7ffeed106cfba63d37;$veca07335a33c5aeb5e1bc7c98b4b9d80['Sum']    = $vf577972c317be099478aeac2a0f911ff;$veca07335a33c5aeb5e1bc7c98b4b9d80['BankId'] = $ve78cbbe1114af26550a6322904a07657;$veca07335a33c5aeb5e1bc7c98b4b9d80['scid']   = $v09e60502ecf8daf9fb79c130fb21043a;$veca07335a33c5aeb5e1bc7c98b4b9d80['CustomerNumber'] = $this->order->getId();$veca07335a33c5aeb5e1bc7c98b4b9d80['formAction']     = $this->object->demo_mode ? 'https://demomoney.yandex.ru/eshop.xml' : 'https://money.yandex.ru/eshop.xml';$veca07335a33c5aeb5e1bc7c98b4b9d80['orderId']   = $this->order->getId();$this->order->setPaymentStatus('initialized');list($v78325ef2910aaa327bba1fde7d68bbf9) = def_module::loadTemplates("tpls/emarket/payment/yandex/".$v66f6181bcb4cff4cd38fbc804a036db6.".tpl", "form_block");return def_module::parseTemplate($v78325ef2910aaa327bba1fde7d68bbf9, $veca07335a33c5aeb5e1bc7c98b4b9d80);}public function poll() {$v7f2db423a49b305459147332fb01cf87 = outputBuffer::current();$v7f2db423a49b305459147332fb01cf87->clear();$v7f2db423a49b305459147332fb01cf87->contentType('text/xml');$v418c5509e2171d55b0aee5c2ea4442b5    = getRequest('action');$v77ae253367b37a7ffeed106cfba63d37    = getRequest('shopId');$v0371dd8f7494d065a0901e9eb8e359d5 = getRequest('invoiceId');$v30f8cc0a3ad81545f79b55cd4a8d8c8e = yandexPayment::STATUS_SUCCESS;if(!$this->checkSignature()) {$v30f8cc0a3ad81545f79b55cd4a8d8c8e = yandexPayment::STATUS_AUTHERROR;}else if(is_null($v77ae253367b37a7ffeed106cfba63d37) || is_null($v0371dd8f7494d065a0901e9eb8e359d5)) {$v30f8cc0a3ad81545f79b55cd4a8d8c8e = yandexPayment::STATUS_REQUESTERROR;}else {switch(strtolower($v418c5509e2171d55b0aee5c2ea4442b5)) {case 'check'    : $v30f8cc0a3ad81545f79b55cd4a8d8c8e = $this->checkDetails();break;case 'paymentsuccess' : $v30f8cc0a3ad81545f79b55cd4a8d8c8e = $this->acceptPaymentResult();break;default      : $v30f8cc0a3ad81545f79b55cd4a8d8c8e = yandexPayment::STATUS_REQUESTERROR;}}$this->order->payment_document_num = $v0371dd8f7494d065a0901e9eb8e359d5;$v7f2db423a49b305459147332fb01cf87->push( $this->getResponseXML($v418c5509e2171d55b0aee5c2ea4442b5, $v30f8cc0a3ad81545f79b55cd4a8d8c8e, $v77ae253367b37a7ffeed106cfba63d37, $v0371dd8f7494d065a0901e9eb8e359d5) );$v7f2db423a49b305459147332fb01cf87->end();}private function checkDetails() {$v3290dbac659f8ec34f4c5fb89765f2ef     = yandexPayment::STATUS_SUCCESS;$vf7042fb9f54ee40c84f71d125e164d2f = (float) getRequest('orderSumAmount');try {$v928419bc24fdb7d83103496423c71f5c = (float) $this->order->getActualPrice();if($vf7042fb9f54ee40c84f71d125e164d2f != $v928419bc24fdb7d83103496423c71f5c) {$this->order->setPaymentStatus('declined');$v3290dbac659f8ec34f4c5fb89765f2ef = yandexPayment::STATUS_DECLINE;}else {$this->order->setPaymentStatus('validated');$v3290dbac659f8ec34f4c5fb89765f2ef = yandexPayment::STATUS_SUCCESS;}}catch (Exception $ve1671797c52e15f763380b45e841ec32) {$v3290dbac659f8ec34f4c5fb89765f2ef = yandexPayment::STATUS_INTERNALERROR;}return $v3290dbac659f8ec34f4c5fb89765f2ef;}private function acceptPaymentResult() {$v3290dbac659f8ec34f4c5fb89765f2ef = yandexPayment::STATUS_SUCCESS;try {$this->order->setPaymentStatus('accepted');}catch(Exception $ve1671797c52e15f763380b45e841ec32) {$v3290dbac659f8ec34f4c5fb89765f2ef = yandexPayment::STATUS_INTERNALERROR;}return $v3290dbac659f8ec34f4c5fb89765f2ef;}public function checkSignature() {if(!in_array(getServer('REMOTE_ADDR'), yandexPayment::$BILLING_IP)) return false;$v5f4dcc3b5aa765d61d8327deb882cf99 = (string) $this->object->shop_password;if(!strlen($v5f4dcc3b5aa765d61d8327deb882cf99)) return false;$v2fccdd1d76f2ebec965d2bb8830adf54   = array();$v2fccdd1d76f2ebec965d2bb8830adf54[] = getRequest('orderIsPaid');$v2fccdd1d76f2ebec965d2bb8830adf54[] = getRequest('orderSumAmount');$v2fccdd1d76f2ebec965d2bb8830adf54[] = getRequest('orderSumCurrencyPaycash');$v2fccdd1d76f2ebec965d2bb8830adf54[] = getRequest('orderSumBankPaycash');$v2fccdd1d76f2ebec965d2bb8830adf54[] = getRequest('shopId');$v2fccdd1d76f2ebec965d2bb8830adf54[] = getRequest('invoiceId');$v2fccdd1d76f2ebec965d2bb8830adf54[] = getRequest('customerNumber');$v2fccdd1d76f2ebec965d2bb8830adf54[] = $v5f4dcc3b5aa765d61d8327deb882cf99;$v8185eea876d5ab9883766ce81a97660c   = md5(implode(';', $v2fccdd1d76f2ebec965d2bb8830adf54));if(strcasecmp($v8185eea876d5ab9883766ce81a97660c, getRequest('md5') ) == 0) {return true;}return false;}public function getResponseXML($v418c5509e2171d55b0aee5c2ea4442b5, $vc13367945d5d4c91047b3b50234aa7ab, $v77ae253367b37a7ffeed106cfba63d37, $v0371dd8f7494d065a0901e9eb8e359d5) {$vdcf569ee792f42313127137ca01badc2 = date('c');$result   = "<"."?xml version=\"1.0\" encoding=\"windows-1251\" ?".">" . <<<XML
<response performedDatetime="{$vdcf569ee792f42313127137ca01badc2}" >
    <result code="{$vc13367945d5d4c91047b3b50234aa7ab}" action="{$v418c5509e2171d55b0aee5c2ea4442b5}" shopId="{$v77ae253367b37a7ffeed106cfba63d37}" invoiceId="{$v0371dd8f7494d065a0901e9eb8e359d5}" />
</response>
XML;   return $result;}};?>