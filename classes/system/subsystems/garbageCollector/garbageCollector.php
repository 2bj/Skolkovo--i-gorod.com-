<?php
 class garbageCollector implements iGarbageCollector {protected $maxStaticCacheLifeTime = 86400;protected $maxIterations = 5000, $executedIterations;public function run() {$this->executedIterations = 0;$this->deleteStaticCache();$this->deleteBrokenDBRelations();}protected function deleteStaticCache($v1bc13205737b819ad6b8146ad6658d76 = false) {if($v1bc13205737b819ad6b8146ad6658d76) {$vc431a4425bc56080c868435c8d910f83 = 0;}else {$vc431a4425bc56080c868435c8d910f83 = (int) $this->maxStaticCacheLifeTime;}$this->deleteDirectory("./static/userCache", $vc431a4425bc56080c868435c8d910f83);$this->deleteDirectory("./static/cacheElementsRelations", $vc431a4425bc56080c868435c8d910f83);$this->deleteDirectory("./static/cacheObjectsRelations", $vc431a4425bc56080c868435c8d910f83);}protected function deleteDirectory($v06f0066e65410a0a1c9f39991a3f3b01, $vc431a4425bc56080c868435c8d910f83 = 0) {$v07cc694b9b3fc636710fa08b6922c42b = time();if($this->checkDirectory($v06f0066e65410a0a1c9f39991a3f3b01) == false) {return false;}$v736007832d2167baaae763fd3a3f3cf1 = new umiDirectory($v06f0066e65410a0a1c9f39991a3f3b01);foreach($v736007832d2167baaae763fd3a3f3cf1 as $v447b7147e84be512208dcc0995d67ebc) {$this->checkMaxIterations();if($v447b7147e84be512208dcc0995d67ebc instanceof umiDirectory) {$this->deleteDirectory($v447b7147e84be512208dcc0995d67ebc->getPath(), $vc431a4425bc56080c868435c8d910f83);$v447b7147e84be512208dcc0995d67ebc->delete();}else if ($v447b7147e84be512208dcc0995d67ebc instanceof umiFile) {if($v447b7147e84be512208dcc0995d67ebc->getModifyTime() <= ($v07cc694b9b3fc636710fa08b6922c42b - $vc431a4425bc56080c868435c8d910f83)) {$v447b7147e84be512208dcc0995d67ebc->delete();}}else {throw new coreException("Got unexpected result of type \"" . gettype($v447b7147e84be512208dcc0995d67ebc) . "\"");}}}protected function checkDirectory($v06f0066e65410a0a1c9f39991a3f3b01) {if(is_dir($v06f0066e65410a0a1c9f39991a3f3b01)) {if(is_writable($v06f0066e65410a0a1c9f39991a3f3b01)) {return true;}}return false;}public function checkMaxIterations() {if(++$this->executedIterations > $this->maxIterations) {throw new maxIterationsExeededException("Maximum iterations count reached: " . $this->maxIterations);}}protected function deleteBrokenDBRelations() {if(defined("DB_DRIVER")) {if(DB_DRIVER == "xml") {return false;}}$this->deleteBrokenForeignRelations("cms3_hierarchy", "obj_id", "cms3_objects", "id");$this->deleteBrokenForeignRelations("cms3_objects", "type_id", "cms3_object_types", "id");$this->deleteBrokenForeignRelations("cms3_hierarchy", "rel", "cms3_hierarchy", "id");}protected function deleteBrokenForeignRelations($v4d3f0fefb6805c1ec6f97b3bc9458bc6, $v4955407e3442306fd4b6dfb686ae7c15, $v307b2810524c158bf4698c4582f50a61, $v1503560471ee6995d52307ced65b703c) {$vac5c74b64b4b8352ef2f181affb5ac2a = "SELECT `id`, `{$v4955407e3442306fd4b6dfb686ae7c15}` FROM `{$v4d3f0fefb6805c1ec6f97b3bc9458bc6}`";$result = l_mysql_query($vac5c74b64b4b8352ef2f181affb5ac2a, true);if($v56bd7107802ebe56c6918992f0608ec6 = mysql_error()) {throw new coreException($v56bd7107802ebe56c6918992f0608ec6);}while(list($vb80bb7740288fda1f201890375a60c8f, $v8b93e238b2f356a070d51c99fb681a0e) = mysql_fetch_row($result)) {$this->checkMaxIterations();if(!$v8b93e238b2f356a070d51c99fb681a0e) {continue;}$v63d2929cb7bcee804ab8720960e91195 = "SELECT COUNT(*) FROM `{$v307b2810524c158bf4698c4582f50a61}` WHERE `{$v1503560471ee6995d52307ced65b703c}` = '{$v8b93e238b2f356a070d51c99fb681a0e}'";$v1804956abd21cd701c0e7931d7ebf5df = l_mysql_query($v63d2929cb7bcee804ab8720960e91195, true);if($v56bd7107802ebe56c6918992f0608ec6 = mysql_error()) {throw new coreException($v56bd7107802ebe56c6918992f0608ec6);}if(list($ve2942a04780e223b215eb8b663cf5353) = mysql_fetch_row($v1804956abd21cd701c0e7931d7ebf5df)) {if($ve2942a04780e223b215eb8b663cf5353 > 0) {continue;}}$v63d2929cb7bcee804ab8720960e91195 = "DELETE FROM `{$v4d3f0fefb6805c1ec6f97b3bc9458bc6}` WHERE `id` = '{$vb80bb7740288fda1f201890375a60c8f}'";mysql_query($v63d2929cb7bcee804ab8720960e91195);if($v56bd7107802ebe56c6918992f0608ec6 = mysql_error()) {throw new coreException($v56bd7107802ebe56c6918992f0608ec6);}}}};?>