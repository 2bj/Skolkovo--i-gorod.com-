$.ajaxSetup({cache:false});var uPageEditor=function(){var editNodes=[],listNodes=[],self=this,highlighted=false,previousEditBox=null;var enabled=false;this.queue=new uRevisionsQueue(this);this.enable=function(){finishLast();self.inspectDocument();self.highlight();uPageEditor.normalizeBoxes();setTimeout(function(){uPageEditor.normalizeBoxes()},1000);enabled=true;var date=new Date();date.setTime(date.getTime()+(3*24*60*60*1000));jQuery.cookie('eip-editor-state','enabled',{path:'/',expires:date});uPageEditor.onEnable();uPageEditor.message('Редактирование страницы включено.')};this.disable=function(){finishLast();self.unhighlight();enabled=false;jQuery.cookie('eip-editor-state','',{path:'/',expires:0});uPageEditor.onDisable();uPageEditor.message('Редактирование страницы отключено.');if(self.queue.isModified()){if(confirm('Сохранить изменения?')){self.submit()}}};this.isEnabled=function(){return enabled};this.cancel=function(){finishLast();this.queue.cancel();uPageEditor.message('Все изменения отменены.')};this.submit=function(){finishLast();this.queue.submit()};this.back=function(step){finishLast();this.queue.back(step)};this.forward=function(step){finishLast();this.queue.forward(step)};this.inspectDocument=function(){editNodes=[];listNodes=[];var regions=uPageEditor.getRegions();regions.each(function(index,node){if(jQuery(node).css('display')=='none')return;inspectNode(node)})};var isParentOf=function(seekNode,excludeNode){if(!excludeNode||!seekNode)return false;if(excludeNode==seekNode)return true;if(seekNode.parentNode){return isParentOf(seekNode.parentNode,excludeNode)}return false};var htmlTrim=function(html){html=jQuery.trim(html);return html.replace(/<br ?\/?>/g,'').replace(/<p><\/p>/g,'')};this.highlight=function(excludeNode,skipListNodes){if(highlighted)this.unhighlight();highlighted=true;jQuery(editNodes).each(function(index,node){if(isParentOf(node,excludeNode)==false)self.highlightNode(node)});if(!skipListNodes){jQuery(listNodes).each(function(index,node){if(isParentOf(node,excludeNode)==false){self.highlightListNode(node)}})}uPageEditor.onRepaint();setTimeout(function(){jQuery('.u-eip-edit-box').each(function(i,node){var color=new RGBColor(jQuery(node).css('color'));var colorHash=color.toHash();var alpha=(colorHash['red']/ 255 + colorHash['green'] /255+colorHash['blue']/ 224) /3;if(alpha>=0.9){jQuery(node).addClass('u-eip-edit-box-inversed')}})},500)};this.unhighlight=function(){jQuery('.u-eip-edit-box').each(function(index,node){node=jQuery(node);var empty=node.attr('umi:empty');if(empty&&(node.attr('tagName')!='IMG')&&(node.html()==empty)){node.html('')}node.attr('title','')});var n=jQuery('.u-eip-edit-box');n.removeClass('u-eip-edit-box u-eip-edit-box-hover u-eip-modified u-eip-deleted u-eip-edit-box-inversed');n.unbind('click');n.unbind('mouseover');n.unbind('mouseout');n.unbind('mousedown');n.unbind('mouseup');jQuery('.u-eip-add-box, .u-eip-add-button, .u-eip-del-button').remove();jQuery('.u-eip-sortable').sortable('destroy');jQuery('.u-eip-sortable').removeClass('u-eip-sortable')};this.edit=function(node){finishLast();jQuery('.eip-del-button').remove();previousEditBox=new editBox(this,node);jQuery(node).removeClass('u-eip-edit-box u-eip-edit-box-hover u-eip-modified u-eip-deleted u-eip-empty-field');jQuery(node).addClass('u-eip-editing');var empty=htmlTrim(jQuery(node).attr('umi:empty'));if(empty&&htmlTrim(jQuery(node).html())==empty){jQuery(node).html('&nbsp;');var className=jQuery(node).attr('class');jQuery(node).removeClass('u-eip-empty-field')}};var finishLast=function(){if(previousEditBox){previousEditBox.finish(true);previousEditBox=null}};var inspectNode=function(node){if(node.tagName=='TABLE')return;if(jQuery(node).attr('umi:field-name'))editNodes.push(node);if(jQuery(node).attr('umi:module'))listNodes.push(node);if(jQuery.browser.msie){jQuery(node).parents("a:first").each(function(){var href=this.href;jQuery(this).click(function(e){if(e.ctrlKey)window.location.href=href});this.removeAttribute("href")})}};this.getEditNodes=function(){return editNodes};this.getListNodes=function(){return listNodes};this.highlightNode=function(node){var x,y,width,height;if(!jQuery(node).attr('umi:field-name'))return;if(!uPageEditor.searchAttr(node,20))return;var empty=htmlTrim(jQuery(node).attr('umi:empty'));if(empty&&htmlTrim(jQuery(node).html())==''&&(jQuery(node).attr('tagName')!='IMG')){try{jQuery(node).html(empty)}catch(e){}jQuery(node).addClass('u-eip-empty-field')}jQuery(node).addClass('u-eip-edit-box');if(node.tagName=='A'||node.parentNode.tagName=='A'||jQuery('a',node).size()>0){jQuery(node).attr('title','Нажмите Ctrl+левая кнопка мыши, чтобы перейти по ссылке.')}else{jQuery(node).attr('title','')}};this.highlightListNode=function(node){var x,y,width,height;if(!jQuery(node).attr('umi:module'))return;var box=document.createElement('div');document.body.appendChild(box);node.boxNode=box;var position=uPageEditor.nodePositionInfo(node);if(!position.x&&!position.y)return;jQuery(box).attr('class','u-eip-add-box');jQuery(box).css({'position':'absolute','width':position.width,'height':position.height,'left':position.x,'top':position.y});var button=document.createElement('img');node.addButtonNode=button;jQuery(button).attr({'class':'u-eip-add-button','src':'/images/cms/eip/add-button.gif'});jQuery(button).hover(function(){jQuery(this).addClass('u-eip-add-button-hover')},function(){jQuery(this).removeClass('u-eip-add-button-hover')});var fDim='bottom';var sDim='left';var userPos;if(userPos=jQuery(node).attr('umi:button-position')){var arr=userPos.split(/ /);if(arr.length==2){fDim=arr[0];sDim=arr[1]}}if(jQuery(node).attr('umi:add-method')!='none'){uPageEditor.placeWith(node,button,fDim,sDim);var elementId=jQuery(node).attr('umi:element-id');var module=jQuery(node).attr('umi:module');var method=jQuery(node).attr('umi:method');jQuery(button).bind('mouseup',function(){var regionType=jQuery(node).attr('umi:region');var addMethod=jQuery(node).attr('umi:add-method');var rowNode=uPageEditor.searchRow(node);if(rowNode&&(regionType=='list'||addMethod!='popup')){self.inlineAddPage(node)}else{if(self.queue.isModified()){uPageEditor.message('Остались несохраненные именения, которые нужно либо сохранить, либо отменить перед созданием новой страницы.');return}var url='/admin/content/eip_add_page/choose/'+parseInt(elementId)+'/'+module+'/'+method+'/';jQuery.openPopupLayer({'name':"CreatePage",'title':"Создание страницы",'url':url})}});jQuery(button).hover(function(){jQuery(box).addClass('u-eip-add-box-hover')},function(){jQuery(box).removeClass('u-eip-add-box-hover')});document.body.appendChild(button)}var oldNextItem=null,oldParentId=null,isSorting=false;if('sortable'==jQuery(node).attr('umi:sortable')){jQuery(node).addClass('u-eip-sortable');var connectedLists=new Array();var i=0;jQuery('*',document.body).each(function(i,n){if(n.tagName=='TABLE')return;if(jQuery(n).attr('umi:sortable')!='sortable')return;if(jQuery(n).attr('umi:module')!=module)return;connectedLists.push(n)});jQuery(node).sortable({'tolerance':'pointer','cursor':'move','connectWith':connectedLists,'start':function(event,ui){var movingItem=ui.item[0];var nextItem=movingItem.nextSibling;do{if(!nextItem)break;if(nextItem.nodeType!=1)continue;if(uPageEditor.searchRowId(nextItem))break}while(nextItem=nextItem.nextSibling);oldNextItem=nextItem;var parentInfo=uPageEditor.searchAttr(movingItem.parentNode,function(node){return jQuery(node).attr('umi:region')=='list'});oldParentId=parseInt(parentInfo?parentInfo['element-id']:null);isSorting=true},'update':function(event,ui){if(!isSorting)return;else isSorting=false;var movedItem=ui.item[0];var movedItemId=uPageEditor.searchRowId(movedItem);var nextItem=movedItem.nextSibling;do{if(!nextItem)break;if(nextItem.nodeType!=1)continue;if(uPageEditor.searchRowId(nextItem))break}while(nextItem=nextItem.nextSibling);var nextItemId=nextItem?uPageEditor.searchRowId(nextItem):null;var parentInfo=uPageEditor.searchAttr(movedItem.parentNode,function(node){return jQuery(node).attr('umi:region')=='list'});var parentId=parseInt(parentInfo?parentInfo['element-id']:null);if(parentId==0||oldParentId==0){if(parentId!=oldParentId)return false}jQuery.get('/admin/content/eip_move_page/'+movedItemId+'/'+nextItemId+'.xml?parent-id='+parentId,function(data){uPageEditor.message('Страница перемещена')});oldNextItem=null;oldParentId=null;uPageEditor.normalizeBoxes()}})}return box};var cleanupAddRow=function(originalRow,elementId,objectId,prepend){var rowNode=jQuery(originalRow).clone();var _id=elementId?elementId:objectId;var _attr=elementId?'umi:element-id':'umi:object-id';var cleanTags=function(node){if(jQuery(node).attr('tagName')=='TABLE')return;if(jQuery(node).attr('umi:field-name')){var empty=jQuery(node).attr('umi:empty');if(jQuery(node).attr('tagName')=='IMG'&&empty){jQuery(node).attr('src',empty)}else{jQuery(node).html(empty?empty:'')}jQuery(node).addClass('u-eip-empty-field');editNodes[editNodes.length]=node}if(jQuery(node).attr(_attr)){jQuery(node).attr(_attr,_id)}};if(!originalRow){alert("Error, umi:region=row is not defined");return false}jQuery('*',rowNode).each(function(index,node){var node=jQuery(node);if(node.attr('umi:region')=='row'){node.remove()}});var parentNode=originalRow.parentNode;var newRowNode=(prepend)?rowNode.prependTo(parentNode):rowNode.appendTo(parentNode);if(jQuery(newRowNode).attr(_attr)){jQuery(newRowNode).attr(_attr,_id)}cleanTags(newRowNode);var subnodes=jQuery('*',newRowNode);subnodes.each(function(index,node){cleanTags(node)});uPageEditor.onAfterInlineAdd(newRowNode)};this.inlineAddPage=function(node){var parentId=parseInt(jQuery(node).attr('umi:element-id'));var typeId=jQuery(node).attr('umi:type-id');var rowNode=uPageEditor.searchRow(node);var prepend=(jQuery(node).attr('umi:method')=='lastlist');var uri='/admin/content/eip_quick_add/'+parentId+'.xml?type-id='+typeId;if(jQuery(node).attr('umi:module')!='data'){uri+='&force-hierarchy=1'}jQuery.get(uri,function(data){var elementId=parseInt(jQuery('data',data).attr('element-id'));var objectId=parseInt(jQuery('data',data).attr('object-id'));cleanupAddRow(rowNode,elementId,objectId,prepend);uPageEditor.normalizeBoxes()})};this.bindEvents=function(){var nodes=jQuery('.u-eip-edit-box');nodes.die('click');nodes.unbind('click');nodes.live('click',function(e){var node=e.target;if(e.ctrlKey){return true}var handler=(typeof node.onclick=='function')?node.onclick:function(){};var nullHandler=function(){return false};node.onclick=nullHandler;setTimeout(function(){if(node&&handler!=nullHandler){node.onclick=handler}},100);for(var i=0;i<25;i++){if(!node)return false;if(node.tagName!='TABLE'&&jQuery(node).attr('umi:field-name'))break;node=node.parentNode}if(!node)return;self.edit(node);return false});jQuery(document).unbind('keydown');jQuery(document).keydown(function(e){if(e.keyCode==113){if(enabled)self.disable();else self.enable();return false}if(e.ctrlKey){switch(e.keyCode){case 83:self.submit();break;case 90:self.back(1);break;case 89:self.forward(1);break;default:return true}return false}return true});window.onbeforeunload=function(){if(self.queue.isModified()){return"Остались несохраненные изменения. Если вы покинете эту страницу, то эти изменения будут утеряны."}}};this.deletePage=function(elementId,objectId){this.queue.add({'element-id':elementId,'object-id':objectId,'delete-action':true});uPageEditor.normalizeBoxes();uPageEditor.message('<strong>Страница будет удалена после нажатия на кнопку "Сохранить".</strong>')};var init=function(){var timeoutId=null;var dropDeleteButtons=function(){jQuery('.eip-del-button').remove()};jQuery('.u-eip-edit-box').live('mouseover',function(){jQuery(this).addClass('u-eip-edit-box-hover');var info=uPageEditor.searchAttr(this,20);if(jQuery(this).attr('umi:delete')&&(info['element-id']||info['object-id'])){if(timeoutId)clearInterval(timeoutId);dropDeleteButtons();var deleteButton=document.createElement('div');jQuery(deleteButton).attr('class','eip-del-button');document.body.appendChild(deleteButton);uPageEditor.placeWith(this,deleteButton,'right','middle');jQuery(deleteButton).bind('mouseover',function(){if(timeoutId)clearInterval(timeoutId)});jQuery(deleteButton).bind('mouseout',function(){timeoutId=setTimeout(dropDeleteButtons,500)});var elementId=info['element-id'];var objectId=info['object-id'];jQuery(deleteButton).bind('click',function(){self.deletePage(elementId,objectId)})}else dropDeleteButtons();this.onclick=function(e){this.onclick=function(){return true};if(window.event){return window.event.ctrlKey}else{return e.ctrlKey}}});jQuery('.u-eip-edit-box-hover').live('mouseout',function(e){jQuery(this).removeClass('u-eip-edit-box-hover');if(jQuery(this).attr('umi:delete')){var node=this;timeoutId=setTimeout(dropDeleteButtons,500)}this.onclick=function(){return true}});window.onresize=function(){uPageEditor.normalizeBoxes()};self.bindEvents()};init()};uPageEditor.onInit=typeof uPageEditorOnInit=='function'?uPageEditorOnInit:function(){};if(typeof uPageEditor.onStep!='function')uPageEditor.onStep=function(){};if(typeof uPageEditor.onEnable!='function')uPageEditor.onEnable=function(){};if(typeof uPageEditor.onDisable!='function')uPageEditor.onDisable=function(){};if(typeof uPageEditor.onRepaint!='function')uPageEditor.onRepaint=function(){};uPageEditor.nodePositionInfo=function(node){var node=jQuery(node),cssDisplay=jQuery(node).css('display');return{'width':node.innerWidth(),'height':node.innerHeight(),'x':node.offset().left,'y':node.offset().top}};uPageEditor.applyStyles=function(originalNode,targetNode){var styles=['font-size','font-family','font-name','margin-left','margin-right','margin-top','margin-bottom','font-weight'],i;originalNode=jQuery(originalNode);targetNode=jQuery(targetNode);for(i in styles){var ruleName=styles[i];targetNode.css(ruleName,originalNode.css(ruleName))}targetNode.width(originalNode.outerWidth());targetNode.height(originalNode.outerHeight())};uPageEditor.getRegions=function(){var Mozilla=(navigator.appName.indexOf("Netscape")!=-1);if(Mozilla){var nodes=jQuery('*[umi\\:field-name], *[umi\\:module]');if(nodes.size())return nodes}return jQuery('*',document.body)};uPageEditor.message=function(msg){jQuery.jGrowl('<p>'+msg+'</p>',{'header':'UMI.CMS','life':10000})};uPageEditor.normalizeBoxes=function(nodes){var editor=uPageEditor.get();jQuery(editor.getEditNodes()).each(function(index,node){uPageEditor.markBoxes(node)});jQuery(editor.getListNodes()).each(function(index,node){if(!node.boxNode)return;var oldPosition=uPageEditor.nodePositionInfo(node.boxNode);var position=uPageEditor.nodePositionInfo(node);jQuery(node.boxNode).css({'width':position.width,'height':position.height,'left':position.x,'top':position.y});var button=node.addButtonNode;var fDim='bottom',sDim='left';if(button){var userPos;if(userPos=jQuery(node).attr('umi:button-position')){var arr=userPos.split(/ /);if(arr.length==2){fDim=arr[0];sDim=arr[1]}}uPageEditor.placeWith(node,button,fDim,sDim)}});uPageEditor.onRepaint()};uPageEditor.markBoxes=function(node){var editor=uPageEditor.get(),region=jQuery(node);var info=uPageEditor.searchAttr(node,10),revision;info['field-name']=region.attr('umi:field-name');if(revision=editor.queue.searchByInfo(info)){jQuery(node).addClass('u-eip-modified');if(revision.isDeleteAction()){jQuery(node).addClass('u-eip-deleted')}}else{jQuery(node).unbind('mouseover');jQuery(node).unbind('mouseout');jQuery(node).removeClass('u-eip-modified u-eip-deleted')}};uPageEditor.searchAttr=function(node,deep,first,callback){if(!deep||!node)return false;if(node.tagName=='BODY'||node.tagName=='TABLE')return false;if(true||jQuery(node).attr('umi:field-name')||first){if(typeof callback!='function'||callback(node)){if(jQuery(node).attr('umi:element-id'))return{'element-id':jQuery(node).attr('umi:element-id')};if(jQuery(node).attr('umi:object-id'))return{'object-id':jQuery(node).attr('umi:object-id')}}}if(node.parentNode)return uPageEditor.searchAttr(node.parentNode,--deep,false,callback);return false};uPageEditor.searchRow=function(node){var result=null;jQuery('*',node).each(function(index,cNode){if(result)return;var regionType=jQuery(cNode).attr('umi:region');if(!regionType)return;result=cNode});return result};uPageEditor.searchRowId=function(node){var elementId=null;if(elementId=jQuery(node).attr('umi:element-id')){return elementId}jQuery('*',node).each(function(index,cNode){if(elementId)return;elementId=jQuery(cNode).attr('umi:element-id')});return elementId};uPageEditor.placeWith=function(placer,node,fDim,sDim){if(!placer||!node)return;var position=uPageEditor.nodePositionInfo(placer);var x,y;switch(fDim){case'top':y=position.y-parseInt(jQuery(node).css('height'));break;case'right':x=position.x+position.width;break;case'left':x=position.x-jQuery(node).width();break;default:y=position.y+position.height}if(fDim=='top'||fDim=='bottom'){switch(sDim){case'right':x=position.x+position.width-jQuery(node).width();break;case'middle':case'center':if(position.width-parseInt(jQuery(node).css('width'))>0){x=position.x+Math.round((position.width-jQuery(node).width())/2)}else x=position.x;break;default:x=position.x;x+=parseInt(jQuery(placer).css('padding-left'))}}else{switch(sDim){case'top':y=position.y;break;case'bottom':y=position.y+position.height-parseInt(jQuery(node).css('height'));break;default:if(position.height-parseInt(jQuery(node).css('height'))>0){y=position.y+Math.round((position.height-parseInt(jQuery(node).css('height')))/2)}else y=position.y}}try{jQuery(node).css({'position':'absolute','left':x+'px','top':y+'px','z-index':560})}catch(e){}};uPageEditor.instance=null;uPageEditor.get=function(){if(!uPageEditor.instance){uPageEditor.instance=new uPageEditor;uPageEditor.onInit()}return uPageEditor.instance};uPageEditor.cleanupHTML=function(html){var strict=true;html=html.replace(/<![\s\S]*?--[ \t\n\r]*>/ig,' ');html=html.replace(/<!--.*?-->/ig,' ');html=html.replace(/<\/?(title|style|font|meta)\s*[^>]*>/ig,'');html=html.replace(/\s*mso-[^:]+:[^;""]+;?/ig,'');html=html.replace(/<\/?o:[^>]*\/?>/ig,'');html=html.replace(/ style=['"]?[^'"]*['"]?/ig,'');if(strict)html=html.replace(/ class=['"]?[^'">]*['"]?/ig,'');html=html.replace(/<span\s*[^>]*>\s*&nbsp;\s*<\/span>/ig,'');html=html.replace(/<span\s*[^>]*>/ig,'');html=html.replace(/<\/span\s*[^>]*>/ig,'');html=html.replace(/<\/(b|i|s|u|strong|center)>[\t\n]*<\1[^>]*>/gi,"");html=html.replace(/<\/(b|i|s|u|strong|center)>\s*<\1[^>]*>/gi," ");html=html.replace(/<(b|i|s|u|strong|center)[^>]*>[\s\t\n\xC2\xA0]*<\/\1>/gi,"");html=html.replace(/(\t|\n)/gi," ");html=html.replace(/[\s]{2,}/gi," ");if(jQuery.browser.safari){html=html.replace(/\bVersion:\d+\.\d+\s+StartHTML:\d+\s+EndHTML:\d+\s+StartFragment:\d+\s+EndFragment:\d+\s*\b/gi,"")}return html};Date.prototype.getFormattedDate=function(full){var format=function(num){return(num>=10)?num:'0'+num};var year=this.getFullYear();var month=format(this.getMonth()+1);var day=format(this.getDate());var hours=format(this.getHours());var minutes=format(this.getMinutes());if(full){return year+'-'+month+'-'+day+' '+hours+':'+minutes}else{return hours+':'+minutes}};Date.createDate=function(str){var date=new Date;var year=str.substr(0,4);var month=str.substr(5,2)-1;var day=str.substr(8,2);var hours=str.substr(11,2);var minutes=str.substr(14,2);date.setYear(year);date.setMonth(month);date.setDate(day);date.setHours(hours);date.setMinutes(minutes);return date};uPageEditor.onPasteCleanup=true;uPageEditor.onAfterInlineAdd=function(){};var editBox=function(editor,node,boxNode){var editorInstance,boxDomNode,domNode,elementId='',objectId='',fieldName,fieldType,originalValue,newValue,fieldParams;var self=this,cleanedUp=false;var voidFinish=function(apply){self.cleanup()};this.finish=voidFinish;this.cleanup=function(){if(cleanedUp)return;else cleanedUp=true;editorInstance.bindEvents();this.finish=voidFinish;editorInstance.highlightNode(domNode);jQuery('.u-eip-add-button').css('display','block');uPageEditor.normalizeBoxes();editBox.currentInstance=null;domNode.blur();jQuery(domNode).removeClass('u-eip-editing')};var onLoadValue=function(value,type,params){originalValue=value;fieldType=type;fieldParams=params;switch(fieldType){case'relation':drawRelationEditor();break;case'video_file':case'file':drawImageEditor(false);break;case'img_file':drawImageEditor(true);break;case'date':drawDateEditor();break;case'wysiwyg':drawHTMLEditor(true);break;case'boolean':drawBooleanEditor();break;case'text':case'int':case'counter':case'string':case'float':case'tags':case'price':drawTextEditor();break;case'symlink':drawSymlinkEditor();break;default:alert("Unkown field type \""+fieldType+"\"")}jQuery('.u-eip-add-button, .u-eip-add-box').css('display','none')};var commit=function(){if(fieldType=='string'&&typeof newValue=='string'){newValue=newValue.replace(/\n/g,' ').replace(/<br>/g,' ').replace(/[\s]{2,}/g,' ');jQuery(domNode).html(newValue)}if(newValue!=originalValue){var revision=editorInstance.queue.add({'element-id':elementId,'object-id':objectId,'field-name':fieldName,'original-value':originalValue,'new-value':newValue,'field-type':fieldType,'params':fieldParams});revision.apply()}};var bindFinishEvent=function(){jQuery(document).bind('click',function(e){if(jQuery(e.target).attr('contentEditable')=='true')return true;if(jQuery(e.target).attr('class')=='eip-ui-element')return true;if(jQuery(e.target).attr('class')=='ui-datepicker')return true;if(jQuery(e.target).parents('.eip-ui-element, .ui-datepicker, .ui-datepicker-title, .ui-datepicker-header, .ui-datepicker-calendar').size())return true;var parents=jQuery(e.target).parents();for(var i=0;i<parents.size();i++){var pNode=parents[i];if(pNode.tagName=='TABLE')continue;if(pNode.tagName=='BODY')break;if(jQuery(pNode).attr('contentEditable')=='true')return true}self.finish(true)})};var drawTextEditor=function(allowHTMLTags){var sourceValue=jQuery(domNode).html();jQuery(domNode).attr('contentEditable',true);jQuery(domNode).html(originalValue?originalValue:'&nbsp;');jQuery(domNode).focus();self.finish=function(apply){self.finish=function(){};jQuery(document).unbind('keyup');jQuery(document).unbind('keydown');jQuery(document).unbind('click');jQuery(domNode).attr('contentEditable',false);jQuery('.u-eip-sortable').sortable('enable');if(apply){newValue=jQuery(domNode).html();if(newValue==' '||newValue=='&nbsp;'){newValue='';jQuery(domNode).html(newValue)}if(fieldType!='wysiwyg'&&fieldType!='text'){newValue=jQuery.trim(newValue);if(newValue.substr(-4,4)=='<br>'){newValue=newValue.substr(0,newValue.length-4)}}commit()}else jQuery(domNode).html(sourceValue);self.cleanup()};bindFinishEvent();var prevWidth=jQuery(domNode).width();var prevHeight=jQuery(domNode).height();var timeoutId=null;jQuery(document).bind('keyup',function(){if(prevWidth!=jQuery(domNode).width()||prevHeight!=jQuery(domNode).height()){prevWidth=jQuery(domNode).width();prevHeight=jQuery(domNode).height();if(timeoutId)clearTimeout(timeoutId);timeoutId=setTimeout(function(){uPageEditor.normalizeBoxes();timeoutId=null},1000)}});if(!allowHTMLTags&&fieldType!='wysiwyg'){jQuery(document).bind('keyup',function(e){var html=jQuery(domNode).html();var originalHtml=html;html=html.replace(/<!--[\w\W\n]*?-->/mig,'');html=html.replace(/<style[^>]*>[\w\W\n]*?<\/style>/mig,'');html=html.replace(/<([^>]+)>/mg,'');html=html.replace(/(\t|\n)/gi," ");html=html.replace(/[\s]{2,}/gi," ");if(jQuery.browser.safari){html=html.replace(/\bVersion:\d+\.\d+\s+StartHTML:\d+\s+EndHTML:\d+\s+StartFragment:\d+\s+EndFragment:\d+\s*\b/gi,"")}if(html!=originalHtml){jQuery(domNode).html(html)}})}jQuery('.u-eip-sortable').sortable('disable');domNode.focus();jQuery(document).bind('keydown',function(e){if(e.keyCode==13&&fieldType!='wysiwyg'&&fieldType!='text'){self.finish(true);return false}if(e.keyCode==27){self.finish(false);return false}return true})};var drawHTMLEditor=function(){drawTextEditor();jQuery(document).unbind('keydown');if(uPageEditor.onPasteCleanup){jQuery(document).bind('keyup',function(e){if((e.keyCode==86&&e.ctrlKey)||(e.keyCode==45&&e.shiftKey)){var html=uPageEditor.cleanupHTML(jQuery(domNode).html());if(html!=jQuery(domNode).html()){jQuery(domNode).html(html)}}})}var editor=new inlineWYSIWYG(domNode);var finish=self.finish;self.finish=function(apply){editor.destroy();finish(apply);uPageEditor.get().bindEvents()}};var drawImageEditor=function(imageOnly){var folder='./images/cms/data/',filename='';self.finish=function(apply){if(apply)commit();self.cleanup()};if(originalValue){originalValue=originalValue.toString();var arr=originalValue.split(/\//g);fileName=arr[arr.length-1];folder='.'+originalValue.substr(0,originalValue.length-fileName.length-1)}var qs='folder='+folder;if(originalValue)qs+='&file='+originalValue;if(imageOnly)qs+='&image=1';jQuery.openPopupLayer({name:"Filemanager",title:"Файловый менеджер",width:660,height:460,url:"/styles/common/other/filebrowser/umifilebrowser.html?"+qs,afterClose:function(value){if(value){if(typeof value=='object')value=value[0];newValue=value?value.toString():'';self.finish(true)}else self.finish()}})};var drawDateEditor=function(){var date=Date.createDate(originalValue);if(!date)date=new Date;originalValue=date.getFormattedDate(true);drawTextEditor();var textFinish=self.finish;var position=uPageEditor.nodePositionInfo(domNode);var node=jQuery('#u-datepicker-input');if(!node.size()){node=document.createElement('input');node.id='u-datepicker-input';document.body.appendChild(node)}self.finish=function(apply){jQuery(node).datepicker('destroy');jQuery('.ui-datepicker-trigger').remove();textFinish(apply)};jQuery(node).css({'position':'absolute','left':(position.x+position.width+5),'top':(position.y),'width':'1','height':'1','visibility':'hidden','font-size':'62.5%'});var time=date.getFormattedDate(false);jQuery(node).datepicker(jQuery.extend({showOn:'button',buttonImage:'/styles/common/other/calendar/icons_calendar_buttrefly.png',buttonImageOnly:true,'dateFormat':'yy-mm-dd','defaultDate':date,'onSelect':function(dateText){newValue=dateText+' '+time;jQuery(domNode).html(newValue);jQuery(domNode).focus()}},jQuery.datepicker.regional["ru"]));uPageEditor.placeWith(domNode,jQuery('.ui-datepicker-trigger'),'right','middle')};var drawRelationEditor=function(){jQuery(document).one('mouseup',function(){setTimeout(function(){bindFinishEvent()},100)});setTimeout(function(){jQuery(document).die('mouseup');bindFinishEvent()},1000);var position=uPageEditor.nodePositionInfo(domNode);var selectBox=document.createElement('select');var searchBox=document.createElement('input');document.body.appendChild(selectBox);if(fieldParams['guide-id']&&fieldParams['public']){var relationButton=document.createElement('input');relationButton.type='button';relationButton.value=' ';relationButton.id='relationButton'+fieldParams['guide-id'];relationButton.className='relationAddButton';document.body.appendChild(relationButton)}jQuery(selectBox).attr('class','eip-ui-element');jQuery(selectBox).css({'position':'absolute','left':position.x,'top':position.y,'z-index':1100});uPageEditor.applyStyles(domNode,selectBox);jQuery(domNode).css('visibility','hidden');if(fieldParams['multiple']){jQuery(selectBox).attr('multiple','multiple');jQuery(selectBox).attr('size',3)}var i;for(i in originalValue){var option=document.createElement('option');jQuery(option).attr('value',i);jQuery(option).attr('selected','selected');jQuery(option).html(originalValue[i]);selectBox.appendChild(option)}jQuery(selectBox).focus();jQuery(selectBox).attr('name','rel_input');jQuery(selectBox).attr('id','relationSelect'+fieldParams['guide-id']);document.body.appendChild(searchBox);uPageEditor.applyStyles(domNode,searchBox);jQuery(searchBox).attr({'id':'relationInput'+fieldParams['guide-id'],'class':'eip-ui-element','name':'rel_input_new'});var sourceUri=uRevisionsQueue.getEditUri(fieldName,'guides');var control=new relationControl(fieldParams['guide-id'],null,true,sourceUri);self.finish=function(){jQuery(domNode).css('visibility','visible');newValue=control.getValue();commit();jQuery(selectBox).resizable('destroy');jQuery(selectBox).remove();jQuery(searchBox).remove();jQuery(relationButton).remove();jQuery('#u-ep-search-trigger').remove();self.cleanup()};control.loadItemsAll();if(fieldParams['multiple']){var minHeight=jQuery(selectBox).height(),maxHeight=350;if(minHeight<150){minHeight=75;jQuery(selectBox).css('height',minHeight)}jQuery(selectBox).resizable({'minWidth':jQuery(selectBox).width(),'maxWidth':jQuery(selectBox).width(),'minHeight':minHeight,'maxHeight':maxHeight});jQuery('.ui-wrapper').css('z-index','1100')}jQuery(searchBox).css({'position':'absolute','width':jQuery(selectBox).width(),'left':position.x,'top':(position.y+jQuery(selectBox).height()+5),'z-index':1011});jQuery(relationButton).css({'position':'absolute','left':(position.x+jQuery(searchBox).width()+5),'top':(position.y+jQuery(selectBox).height()+Math.round((jQuery(searchBox).height()-jQuery(relationButton).height())/2)),'z-index':1012})};var drawSymlinkEditor=function(){alert("В данный момент поля типа \"Ссылка на дерево\" редактировать через edit-in-place нельзя")};var drawBooleanEditor=function(){var position=uPageEditor.nodePositionInfo(domNode);if(jQuery(domNode).attr('tagName')=='INPUT'&&jQuery(domNode).attr('type')=='checkbox'){setTimeout(function(){newValue=originalValue?0:1;jQuery(domNode).attr('checked',newValue);commit();self.cleanup()},300);return}var checkboxNode=document.createElement('input');checkboxNode.type='checkbox';document.body.appendChild(checkboxNode);self.finish=function(apply){if(apply){newValue=checkboxNode.checked?1:0;commit()}jQuery(checkboxNode).remove();jQuery(domNode).css('visibility','visible');self.cleanup()};checkboxNode.checked=originalValue;jQuery(checkboxNode).attr('class','eip-ui-element eip-ui-boolean');jQuery(checkboxNode).css({'position':'absolute','left':position.x,'top':position.y,'z-index':1100});uPageEditor.applyStyles(domNode,checkboxNode);jQuery(domNode).css('visibility','hidden');jQuery(checkboxNode).click(function(){self.finish(true)})};var init=function(node){if(editBox.currentInstance){editBox.currentInstance.finish(true)}editBox.currentInstance=self;domNode=node;if(ids=uPageEditor.searchAttr(node,20,true)){if(ids['element-id'])elementId=parseInt(ids['element-id']);if(ids['object-id'])objectId=parseInt(ids['object-id'])}fieldName=jQuery(node).attr('umi:field-name');if(!elementId&&!objectId)alert("You should specify umi:element-id or umi:object attribute");if(!fieldName)alert("You should specify umi:field-name attribute");editorInstance.queue.getValue({'element-id':elementId,'object-id':objectId,'field-name':fieldName,'field-type':fieldType},onLoadValue)};boxDomNode=boxNode;editorInstance=editor;init(node)};editBox.currentInstance=null;var uRevisionsQueue=function(editor){var queue=new Array,index=-1,editorInstance=editor;this.submit=function(){var submitQueue=new Array();for(var i=index;i>=0;i--){var revision=queue[i];if(!revision)continue;for(var j=i;j>=0;j--){if(queue[j]&&queue[j].id()==revision.id()){queue[j]=undefined}}submitQueue.push(revision)}if(submitQueue.length==0){uPageEditor.message('Нет изменений, которые можно было бы сохранить.');return}for(var i=0;i<submitQueue.length;i++){submitQueue[i].save(function(){if(editorInstance.isEnabled()){editorInstance.highlight()}})}reset();uPageEditor.onStep(index,queue.length);uPageEditor.message('Изменения сохранены.');uPageEditor.normalizeBoxes()};this.cancel=function(){this.back(this.length());reset()};this.back=function(steps){steps=parseInt(steps);var s=0;while(steps--&&index>=0){this.get(index--).cancel();s++}uPageEditor.normalizeBoxes();uPageEditor.onStep(index,queue.length);return(s>0)};this.forward=function(steps){steps=parseInt(steps);var s=0;while(steps--&&index<(queue.length-1)){this.get(++index).apply();s++}uPageEditor.normalizeBoxes();uPageEditor.onStep(index,queue.length);return(s>0)};this.add=function(info){if(this.length()-1>index){for(var i=index;i<queue.length;i++){queue[i]=undefined}}var result=queue[++index]=new uRevision(info);uPageEditor.onStep(index,queue.length);return result};this.get=function(i){return queue[i]?queue[i]:null};this.searchByInfo=function(info){for(var i=index;i>=0;i--){var revision=this.get(i);if(revision&&revision.matchByInfo(info)){return revision}}return null};this.getValue=function(info,callback){var revision=this.searchByInfo(info);var dt=new Date;var qSuffix="?qt="+dt.getTime();if(revision){callback(revision.value(),revision.fieldType(),revision.fieldParams())}else{var uri=uRevisionsQueue.getEditUri(info['field-name'],'load');jQuery.get(uri+qSuffix,info,function(data){var params={};var prop=jQuery('property',data);var error=jQuery('error',data);if(error.size()){uPageEditor.message(error.text());return false}var userType=jQuery('user',data);if(userType.size()&&userType.attr('type')=='guest'){uPageEditor.message(getLabel('error-auth-required'));return false}value=prop.text();fieldType=jQuery(prop).attr('type');if(fieldType=='relation'){var items=jQuery('item',prop),value={};for(var i=0;i<items.length;i++){var id=jQuery(items[i]).attr('id');var name=jQuery(items[i]).attr('name');value[id]=name}params['guide-id']=jQuery(prop).attr('guide-id');params['multiple']=(jQuery(prop).attr('multiple')=='multiple');params['public']=(jQuery(prop).attr('public')=='public')}callback(value,fieldType,params)},'xml')}};this.length=function(){return queue.length};this.index=function(){return index};this.isModified=function(){return(this.length()>0)&&(this.index()>=0)};var reset=function(){queue=new Array();index=-1}};uRevisionsQueue.customHandlers={};uRevisionsQueue.getEditUri=function(fieldName,key){var desc=uRevisionsQueue.customHandlers[fieldName];if((typeof desc!='undefined')&&(typeof desc[key]!='undefined')){return desc[key]}if(key=='guides'){return'/admin/data/guide_items_all/'}return'/content/editValue/'+key+'.xml'};uPageEditor.get();var uRevision=function(info){var elementId=info['element-id'];var objectId=info['object-id'];var fieldName=info['field-name'];var originalValue=info['original-value'];var newValue=info['new-value'];var fieldType=info['field-type'];var fieldParams=info['params'];var valuePrefix=info['valuePrefix'];var valueSuffix=info['valueSuffix'];var deleteAction=info['delete-action'];var self=this;this.getOriginalValue=function(){return originalValue};this.getNewValue=function(){return newValue};this.getFieldType=function(){return fieldType};this.save=function(callback){var dt=new Date;var qSuffix="?qt="+dt.getTime();if(deleteAction){jQuery.post('/content/eip_del_page.xml'+qSuffix,{'element-id':elementId,'object-id':objectId},function(data){var error=jQuery('error',data);if(error.size()){uPageEditor.message(error.text())}else{var searchRow=function(node,depth){if(!node.parentNode)return depth;var tagName=node.tagName;if(tagName!='TABLE'){if(jQuery(node).attr('umi:element-id')){if(jQuery(node).attr('umi:element-id')!=elementId)return 2}if(jQuery(node).attr('umi:object-id')){if(jQuery(node).attr('umi:object-id')!=objectId)return 2}if(jQuery(node).attr('umi:region')=='row'){return node}}if(--depth){return searchRow(node.parentNode,depth)}else return 3};var nodes=getNodes(true);jQuery(nodes).each(function(index,node){var rowNode=searchRow(node,10);if(rowNode)jQuery(rowNode).remove()});uPageEditor.normalizeBoxes()}});return}var queryParams={'element-id':elementId,'object-id':objectId,'field-name':fieldName};if(typeof newValue=='object'){var value=new Array(),i;for(i in newValue)value.push(i);queryParams['value']=value}else{queryParams['value']=newValue}var uri=uRevisionsQueue.getEditUri(info['field-name'],'save');jQuery.post(uri+qSuffix,queryParams,function(data){var params={};var prop=jQuery('property',data);var error=jQuery('error',data);var oldLink=jQuery('links previous',data);var newLink=jQuery('links current',data);if(error.size()){uPageEditor.message(error.text());return false}value=prop.text();fieldType=jQuery(prop).attr('type');if(fieldType=='relation'){var items=jQuery('item',prop),value={};for(var i=0;i<items.length;i++){var id=jQuery(items[i]).attr('id');var name=jQuery(items[i]).attr('name');value[id]=name}params['guide-id']=jQuery(prop).attr('guide-id');params['multiple']=(jQuery(prop).attr('multiple')=='multiple')}if(oldLink.size()&&newLink.size()){oldLink=oldLink.text();newLink=newLink.text();var nodes=getNodes();jQuery(nodes).each(function(index,node){jQuery(node).attr('href',newLink);node.onclick=node.onmouseup=node.onmousedown=function(){return true};jQuery('a',node).each(function(index,node){jQuery(node).attr('href',newLink);node.onclick=node.onmouseup=node.onmousedown=function(){return true}})})}callback(value,fieldType,params);if(typeof callback=='function'){callback()}})};this.apply=function(){if(deleteAction)return false;replaceValues(getNodes(),newValue,originalValue)};this.cancel=function(){if(deleteAction)return false;replaceValues(getNodes(),originalValue,newValue)};this.value=function(){return newValue};this.fieldType=function(){return fieldType};this.fieldParams=function(){return fieldParams};this.matchByInfo=function(info){if(deleteAction&&elementId&&elementId==info['element-id']){return true}if(deleteAction&&objectId&&objectId==info['object-id']){return true}if(fieldName=='h1'||fieldName=='name'){if(info['field-name']!='name'&&info['field-name']!='h1')return false}else{if(info['field-name']!=fieldName)return false}if((elementId&&info['element-id']==elementId)||(objectId&&info['object-id']==objectId))return true;return false};this.id=function(){return(elementId?('page-'+elementId):('object-'+objectId))+'-'+fieldName};this.isDeleteAction=function(){return deleteAction?true:false};var getNodes=function(returnPlainNodes){var nodes=uPageEditor.getRegions();var result=new Array(),info;for(var i=0;i<nodes.length;i++){var originalNode=nodes[i];var node=jQuery(originalNode);if(jQuery(nodes[i]).attr('tagName')=='TABLE')continue;if(!deleteAction){if(fieldName=='h1'||fieldName=='name'){if(node.attr('umi:field-name')!='h1'&&node.attr('umi:field-name')!='name')continue}else{if(node.attr('umi:field-name')!=fieldName)continue}}if(info=uPageEditor.searchAttr(nodes[i],20)){if((elementId&&info['element-id']==elementId)||(objectId&&info['object-id']==objectId)){result.push(returnPlainNodes?originalNode:node)}}}return result};var replaceValues=function(nodes,value,previousValue){jQuery(nodes).each(function(i,node){switch(fieldType){case'img_file':return replaceImage(node,value,previousValue);break;case'relation':return replaceRelation(node,value,previousValue);break;case'video_file':return replaceVideo(node,value,previousValue);break;case'boolean':return replaceBoolean(node,value,previousValue);break;default:return jQuery(node).html(value)}})};var replaceImage=function(node,value,previousValue){var isModified=false;if(jQuery(node).attr('tagName')=='IMG'){if(compareImages(node.attr('src'),previousValue)){node.attr('src',value);isModified=true}else if(checkIsThumb(node.attr('src'))){var width=node.width();var height=node.height();var tSrc=node.attr('src');if(tSrc.indexOf(width)!=-1&&tSrc.indexOf(height)==-1)height='auto';if(tSrc.indexOf(width)==-1&&tSrc.indexOf(height)!=-1)width='auto';value=makeNewThumb(value,width,height);node.attr('src',value);isModified=true}jQuery(node).one('load',function(){uPageEditor.normalizeBoxes()})}var cssBackground=node.css('background-image');if(cssBackground.substr(0,4)!='url('){if(!isModified&&node.attr('childNodes')){var childs=node.attr('childNodes');for(var i=0;i<childs.length;i++){var subNode=childs.item(i);if(subNode&&jQuery(subNode).attr('tagName')){replaceImage(jQuery(subNode),value,previousValue)}}}return}cssBackground=cssBackground.substring(4,cssBackground.length-1);var httpHost=window.location.protocol+'//'+window.location.host;if(cssBackground.substr(0,httpHost.length)!=httpHost)return;cssBackground=cssBackground.substr(httpHost.length);if(!cssBackground)return;if(compareImages(cssBackground,previousValue)){node.css('background-image','url('+value+')');isModified=true}if(!isModified&&node.attr('childNodes')){var childs=node.attr('childNodes');for(var i=0;i<childs.length;i++){var subNode=childs.item(i);if(subNode&&jQuery(subNode).attr('tagName')){replaceImage(jQuery(subNode),value,previousValue)}}}};var compareImages=function(left,right){return left==right};var checkIsThumb=function(src){if(src.indexOf('/images/cms/thumbs/')>=0)return true;if(src.indexOf('/images/autothumbs/')>=0)return true;return false};var makeNewThumb=function(src,width,height){src=src.toString();var tempArr=src.split(/\./g);if(tempArr.length<2)return false;var ext=tempArr[tempArr.length-1].toString();var tempArr=tempArr[tempArr.length-2].toString().split(/\//g);var filename=tempArr[tempArr.length-1].toString();var dirname=src.substr(0,src.length-filename.length-ext.length-1);return'/images/autothumbs'+dirname+filename+'_'+width+'_'+height+'.'+ext};var replaceRelation=function(node,value,previousValue){var html='',i;for(i in value){html+=value[i]+', '}if(html)html=html.substr(0,html.length-2);jQuery(node).html(html)};var replaceVideo=function(node,value,previousValue){var getFlexApp=function(appName){return(navigator.appName.indexOf("Microsoft")!=-1)?window[appName]:document[appName]};getFlexApp('UmiVideoPlayer').setVideoFile(value)};var replaceBoolean=function(node,value,previousValue){if(node.attr('tagName')=='INPUT'&&node.attr('type')=='checkbox'){node.attr('checked',value?true:false)}else{jQuery(node).html(value?'Да':'Нет')}}};var inlineWYSIWYG=function(node){var self=this;var targetNode=node;var toolboxNode=null;var drawToolbox=function(){var position=uPageEditor.nodePositionInfo(targetNode);toolboxNode=document.createElement('div');jQuery(toolboxNode).attr('class','eip-wysiwyg-toolbox eip-ui-element eip-wysiwyg_buttons');document.body.appendChild(toolboxNode);uPageEditor.placeWith(targetNode,toolboxNode,'top','left');jQuery(toolboxNode).draggable()};var drawButtons=function(){var i;for(i in inlineWYSIWYG.buttons){self.callButton(i,'init',{'toolbox':toolboxNode,'editor':self})}};var checkButtons=function(){var i,selectedNode=self.sels.getNode();var checkedTags=new Array();for(i in inlineWYSIWYG.buttons){var status=self.callButton(i,'status');var node=jQuery('.eip-wysiwyg_button_'+i);if(node.size()){if(status)node.addClass('act');else node.removeClass('act')}var requireTag=inlineWYSIWYG.buttons[i].requireTag;if(requireTag){var n,isOk=false;if(selectedNode){for(n in requireTag){if(typeof checkedTags[requireTag[n]]!='undefined'){isOk=checkedTags[requireTag[n]];break}if(inlineWYSIWYG.seekTag(selectedNode,requireTag[n])){isOk=true;checkedTags[requireTag[n]]=true;break}else{checkedTags[requireTag[n]]=false}}}node.css('display',isOk?'':'none')}}};var init=function(){drawToolbox();drawButtons();self.sels=new selections(window,targetNode);jQuery(targetNode).bind('click',function(){checkButtons()});jQuery(targetNode).bind('keyup',function(){checkButtons()});if(!targetNode.firstChild||targetNode.firstChild.tagName!='P'){var html=jQuery.trim(jQuery(targetNode).html());jQuery(targetNode).html('<p>'+html+'</p>')}};this.getToolBox=function(){return toolboxNode};this.callButton=function(name,funcName,params){var button=inlineWYSIWYG.buttons[name];if(button){var func=button[funcName];if(typeof func=='function'){var result=func(params,targetNode,self.sels);if(funcName=='execute'){setTimeout(function(){checkButtons()},150)}return result}}else alert("Button \""+name+"\" not found");return false};this.refocus=function(){node.focus()};this.destroy=function(){jQuery(toolboxNode).remove();jQuery(targetNode).unbind('click');jQuery(targetNode).unbind('keyup');jQuery(targetNode).unbind('mouseover');jQuery(targetNode).unbind('mouseout')};init()};inlineWYSIWYG.buttons=[];inlineWYSIWYG.button=function(name,params){inlineWYSIWYG.buttons[name]=params};inlineWYSIWYG.createSimpleButton=function(editor,name,prefix,noSelReset){var node=document.createElement('a');jQuery(node).attr({'href':'#','className':'eip-wysiwyg_button_'+prefix,'type':'button'});editor.getToolBox().appendChild(node);noSelReset=true;var _editor=editor,_name=name,_noReset=noSelReset;jQuery(node).bind('click',function(){_editor.callButton(_name,'execute');return false});return node};function createSimple(inName,inParams){return function(){inlineWYSIWYG.button(inName,{init:function(params){var button=inlineWYSIWYG.createSimpleButton(params['editor'],inName,inName);jQuery(button).attr({'value':inParams['button-label'],'title':inParams['button-title']});if(inParams['letter']){jQuery(button).html(inParams['letter'])}},execute:function(params,targetNode,sels){var selectedNode=sels.getNode();if(jQuery(selectedNode).attr('umi:field-name')||selectedNode==targetNode){return false}var align,aligns={JustifyLeft:'left',JustifyCenter:'center',JustifyRight:'right'};if(align=aligns[inName]){if(targetNode.firstChild==selectedNode&&selectedNode.tagName=='P'){jQuery(selectedNode).css('text-align',align);return true}}setTimeout(function(){try{return document.execCommand(inName,false,null)}catch(exception){return false}},110)},status:function(){try{return document.queryCommandState(inName)}catch(exception){return false}},params:inParams})}};inlineWYSIWYG.seekTag=function(node,tagName){do{if(!node)return false;if(node.nodeType!=1)continue;if(node.tagName==tagName)return node;if(jQuery(node).hasClass('u-eip-editing'))return false}while(node=node.parentNode);return false};var selections=function(targetWindow,container){var _window=targetWindow,_container=container,_rng=null;var ie=document.selection&&window.ActiveXObject&&/MSIE/.test(navigator.userAgent);var _getSelection=function(){var doc=_window.document;if(doc.selection){var type=doc.selection.type;return(type=="Text"||type=="None")?doc.selection:null}if(_window.getSelection){return _window.getSelection()}return null};var _createRange=function(){var sel=_getSelection();if(sel){if(sel.createRange){return sel.createRange()}if(sel.rangeCount&&sel.getRangeAt){return sel.getRangeAt(0)}}return null};var _select=function(range){if(range.select){range.select()}else{var sel=_getSelection();if(sel.removeAllRanges&&sel.addRange){sel.removeAllRanges();sel.addRange(range)}}};var _createNode=function(tag,attrs,html){var node=document.createElement(tag),i;for(i in attrs){node.setAttribute(i,attrs[i])}if(html)node.innerHTML=html;return node};var _selectionRange=function(){var sel=_getSelection();return(!sel||sel.rangeCount==0)?false:sel.getRangeAt(0)};var _isAncestorOf=function(childNode,parentNode){if(!childNode||!parentNode)return false;for(var i=0;i<150;i++){if(childNode==parentNode){return true}if(childNode.tagName=='HTML'){return false}childNode=childNode.parentNode}return false};var _commonParent=function(leftNode,rightNode){var getParents=function(node){var parents=new Array;do{if(node==_container.parentNode||node.tagName=='HTML')break;if(node.nodeType!=1)continue;parents.push(node)}while(node=node.parentNode);return parents};var leftParents=getParents(leftNode);var rightParents=getParents(rightNode);for(var i=0;i<leftParents.length;i++){for(var j=0;j<rightParents.length;j++){if(leftParents[i]==rightParents[j]){return leftParents[i]}}}return false};this.load=function(){if(_rng){_select(_rng)}};this.save=function(){_rng=_createRange()};this.expand=ie?function(start){}:function(start){var range=_createRange(),node=this.getNode(start);if(this.isSomethingSelected()&&range&&node&&node.nextSibling){range.setStart(node,0);range.setEnd(node.nextSibling,0);var sel=_getSelection();sel.removeAllRanges();sel.addRange(range)}};this.getNode=ie?function(start,ignoreNullSelection){var range=_createRange();if(range&&(ignoreNullSelection||this.isSomethingSelected(true))){var node=range.parentElement();if(_isAncestorOf(node,_container)){return node}}return false}:function(start,ignoreNullSelection){var range=_selectionRange();if(range&&(ignoreNullSelection||this.isSomethingSelected(true))){var node=_commonParent(range.startContainer,range.endContainer);while(node.nodeType!=1){node=node.parentNode}if(node!=_container.parentNode){if(_isAncestorOf(node,_container)){return node}}}return false};this.surround=ie?function(tag,attrs){if(this.isSomethingSelected()){var range=_createRange();return this.insert(tag,attrs,range.htmlText)}else return false}:function(tag,attrs){if(this.isSomethingSelected()){var range=_createRange();var node=_createNode(tag,attrs);range.surroundContents(node);return true}else return false};this.insert=ie?function(tag,attrs,innerHTML){var selection=window.document.selection;if(this.isSomethingSelected()&&selection){var html=_createNode(tag,attrs,innerHTML).outerHTML;var range=selection.createRange();range.pasteHTML(html);range.collapse(false);range.select();return true}else return false}:function(tag,attrs,innerHTML){var range=_createRange();if(this.isSomethingSelected()&&range){var node=_createNode(tag,attrs,innerHTML);range.deleteContents();range.insertNode(node);range=_window.document.createRange();range.selectNode(node);range.collapse(false);selectRange(range,_window);return true}else return false};this.isSomethingSelected=ie?function(disableNodeCheck){var sel=_window.document.selection;return sel&&(sel.createRange().text!="")&&(disableNodeCheck||this.getNode())}:function(disableNodeCheck){var range=_createRange(_window);return range&&!range.collapsed&&(disableNodeCheck||this.getNode())}};var stylesFormats={'':'','P':'Абзац','PRE':'Форматированный','H1':'Заголовок 1','H2':'Заголовок 2','H3':'Заголовок 3','H4':'Заголовок 4','H5':'Заголовок 5','H6':'Заголовок 6'};inlineWYSIWYG.button('StylesFormatting',{init:function(params){var node=document.createElement('select');node.className='eip-wysiwyg_select_format';params['editor'].getToolBox().appendChild(node);var i;for(i in stylesFormats){var option=document.createElement('option');option.value=i;option.innerHTML=stylesFormats[i];node.appendChild(option)}var _editor=params['editor'];jQuery(node).bind('change',function(){_editor.callButton('StylesFormatting','execute',{'tag':this.value})})},execute:function(params,targetNode,sels){if(!params['tag'])return;var node=sels.getNode(false,true);if(node&&node.tagName!=params['tag']){document.execCommand('formatBlock',false,'<'+params['tag']+'>')}},status:function(params,targetNode,sels){var tagName=sels.getNode(false,true).tagName;if(stylesFormats[tagName]){jQuery('.eip-wysiwyg_select_format').each(function(i,select){select.value=tagName})}},params:{}});var ie=document.selection&&window.ActiveXObject&&/MSIE/.test(navigator.userAgent);createSimple('Bold',{'button-label':'Bold','button-title':'Жирный','prefix':'b'})();createSimple('Italic',{'button-label':'Italic','button-title':'Курсив','prefix':'i'})();createSimple('Underline',{'button-label':'Underlined','button-title':'Подчеркнутый','prefix':'u'})();createSimple('JustifyLeft',{'button-label':'Left','button-title':'Выравнивание по левому краю','prefix':'l'})();createSimple('JustifyCenter',{'button-label':'Center','button-title':'Выравнивание по центру','prefix':'c'})();createSimple('JustifyRight',{'button-label':'Right','button-title':'Выравнивание по правому краю','prefix':'r'})();createSimple('InsertOrderedList',{'button-label':'InsertOrderedList','button-title':'Нумерованный список','prefix':'ol'})();createSimple('InsertUnorderedList',{'button-label':'InsertUnorderedList','button-title':'Маркированный список','prefix':'ul'})();inlineWYSIWYG.button('AddLink',{init:function(params){var button=inlineWYSIWYG.createSimpleButton(params['editor'],'AddLink','addlink',true);jQuery(button).attr({'value':'AddLink','title':'Создать ссылку'})},execute:function(params,targetNode,sels){var node=sels.getNode(),url='';if(node.nodeType==1&&node.tagName=='A'){url=jQuery(node).attr('href')}var date=new Date;var ts=date.getTime();var url='/styles/common/other/inline-wysiwyg/createLink.html?ts='+ts+'&url='+url;var _sels=sels;sels.save();jQuery.openPopupLayer({'name':"CreateLink",'title':"Создание ссылки",'url':url,'width':490,'height':95,'afterClose':function(value){_sels.load();if(typeof value=='undefined')return true;if(value){document.execCommand('createlink',false,value)}else{document.execCommand('unlink',false,false)}}})},status:function(){return false},params:{}});inlineWYSIWYG.button('UnLink',{init:function(params){var button=inlineWYSIWYG.createSimpleButton(params['editor'],'UnLink','unlink',true);jQuery(button).attr({'value':'Unlink','title':'Удалить ссылку'})},execute:function(params,targetNode,sels){sels.expand();document.execCommand('unlink',false,false)},status:function(){return false},params:{}});inlineWYSIWYG.button('InsertImage',{init:function(params){var button=inlineWYSIWYG.createSimpleButton(params['editor'],'InsertImage','insertimage',true);jQuery(button).attr({'value':'InsertImage','title':'Вставить изображение'})},execute:function(params,targetNode,sels){var node=sels.getNode(),src='',folder='./images/cms/data',fileName='';if(node.nodeType==1&&node.tagName=='IMG'){src=jQuery(node).attr('src');src=src.toString();var arr=src.split(/\//g);fileName=arr[arr.length-1];folder='.'+src.substr(0,src.length-fileName.length-1)}var date=new Date;var ts=date.getTime();var url='/styles/common/other/filebrowser/umifilebrowser.html?ts='+ts+'&image=1&folder='+folder;if(fileName)url+='&file='+fileName;var _sels=sels;if(ie&&!sels.isSomethingSelected()){alert("Выделите фрагмент текста");return false}sels.save();jQuery.openPopupLayer({'name':"Filemanager",'title':"Менеджер изображений",'width':660,'height':460,'url':url,'afterClose':function(value){if(typeof value=='undefined')return;if(typeof value=='object')value=value.toString();if(value.length>0){_sels.load();setTimeout(function(){document.execCommand('InsertImage',false,value)},100)}}})},status:function(){return false},params:{}});inlineWYSIWYG.button('XmlOff',{init:function(params){var button=inlineWYSIWYG.createSimpleButton(params['editor'],'XmlOff','xmloff');jQuery(button).attr({'value':'XmlOff','title':'Очистить код'})},execute:function(params,targetNode){var html=jQuery(targetNode).html();var strict=true;html=html.replace(/<![\s\S]*?--[ \t\n\r]*>/ig,' ');html=html.replace(/<!--[\w\W\n]*?-->/ig,' ');html=html.replace(/<\/?(title|style|font|meta)\s*[^>]*>/ig,'');html=html.replace(/\s*mso-[^:]+:[^;""]+;?/ig,'');html=html.replace(/<\/?o:[^>]*\/?>/ig,'');html=html.replace(/ style=['"]?[^'"]*['"]?/ig,'');if(strict)html=html.replace(/ class=['"]?[^'">]*['"]?/ig,'');html=html.replace(/<span\s*[^>]*>\s*&nbsp;\s*<\/span>/ig,'');html=html.replace(/<span\s*[^>]*>/ig,'');html=html.replace(/<\/span\s*[^>]*>/ig,'');html=html.replace(/<\/(b|i|s|u|strong|center)>[\t\n]*<\1[^>]*>/gi,"");html=html.replace(/<\/(b|i|s|u|strong|center)>\s*<\1[^>]*>/gi," ");html=html.replace(/<(b|i|s|u|strong|center)[^>]*>[\s\t\n\xC2\xA0]*<\/\1>/gi,"");html=html.replace(/(\t|\n)/gi," ");html=html.replace(/[\s]{2,}/gi," ");if(jQuery.browser.safari){html=html.replace(/\bVersion:\d+\.\d+\s+StartHTML:\d+\s+EndHTML:\d+\s+StartFragment:\d+\s+EndFragment:\d+\s*\b/gi,"")}jQuery(targetNode).html(html)},status:function(){return false},params:{}});inlineWYSIWYG.button('ClipboardPaste',{init:function(params){var button=inlineWYSIWYG.createSimpleButton(params['editor'],'ClipboardPaste','clipboardpaste');var toolbox=jQuery(params['toolbox']);var tip=jQuery("<div class='eip-wysiwyg-toolbox eip-ui-element eip-wysiwyg_tip'>Для вставки из буфера обмена нажмите Ctrl+V</div>");jQuery(button).attr({'value':'ClipboardPaste'}).mouseenter(function(){jQuery(document.body).append(tip);tip.css({position:'absolute',display:'none',top:(parseInt(toolbox.css('top'))-parseInt(tip.height()))+"px",left:toolbox.css('left'),width:(parseInt(toolbox.outerWidth())-10)+"px"}).fadeIn(400)}).mouseleave(function(){tip.fadeOut(400,function(){tip.remove()})})},execute:function(params,targetNode){},status:function(){return false},params:{}});function RGBColor(color_string){this.ok=false;if(color_string.charAt(0)=='#'){color_string=color_string.substr(1,6)}color_string=color_string.replace(/ /g,'');color_string=color_string.toLowerCase();var simple_colors={aliceblue:'f0f8ff',antiquewhite:'faebd7',aqua:'00ffff',aquamarine:'7fffd4',azure:'f0ffff',beige:'f5f5dc',bisque:'ffe4c4',black:'000000',blanchedalmond:'ffebcd',blue:'0000ff',blueviolet:'8a2be2',brown:'a52a2a',burlywood:'deb887',cadetblue:'5f9ea0',chartreuse:'7fff00',chocolate:'d2691e',coral:'ff7f50',cornflowerblue:'6495ed',cornsilk:'fff8dc',crimson:'dc143c',cyan:'00ffff',darkblue:'00008b',darkcyan:'008b8b',darkgoldenrod:'b8860b',darkgray:'a9a9a9',darkgreen:'006400',darkkhaki:'bdb76b',darkmagenta:'8b008b',darkolivegreen:'556b2f',darkorange:'ff8c00',darkorchid:'9932cc',darkred:'8b0000',darksalmon:'e9967a',darkseagreen:'8fbc8f',darkslateblue:'483d8b',darkslategray:'2f4f4f',darkturquoise:'00ced1',darkviolet:'9400d3',deeppink:'ff1493',deepskyblue:'00bfff',dimgray:'696969',dodgerblue:'1e90ff',feldspar:'d19275',firebrick:'b22222',floralwhite:'fffaf0',forestgreen:'228b22',fuchsia:'ff00ff',gainsboro:'dcdcdc',ghostwhite:'f8f8ff',gold:'ffd700',goldenrod:'daa520',gray:'808080',green:'008000',greenyellow:'adff2f',honeydew:'f0fff0',hotpink:'ff69b4',indianred:'cd5c5c',indigo:'4b0082',ivory:'fffff0',khaki:'f0e68c',lavender:'e6e6fa',lavenderblush:'fff0f5',lawngreen:'7cfc00',lemonchiffon:'fffacd',lightblue:'add8e6',lightcoral:'f08080',lightcyan:'e0ffff',lightgoldenrodyellow:'fafad2',lightgrey:'d3d3d3',lightgreen:'90ee90',lightpink:'ffb6c1',lightsalmon:'ffa07a',lightseagreen:'20b2aa',lightskyblue:'87cefa',lightslateblue:'8470ff',lightslategray:'778899',lightsteelblue:'b0c4de',lightyellow:'ffffe0',lime:'00ff00',limegreen:'32cd32',linen:'faf0e6',magenta:'ff00ff',maroon:'800000',mediumaquamarine:'66cdaa',mediumblue:'0000cd',mediumorchid:'ba55d3',mediumpurple:'9370d8',mediumseagreen:'3cb371',mediumslateblue:'7b68ee',mediumspringgreen:'00fa9a',mediumturquoise:'48d1cc',mediumvioletred:'c71585',midnightblue:'191970',mintcream:'f5fffa',mistyrose:'ffe4e1',moccasin:'ffe4b5',navajowhite:'ffdead',navy:'000080',oldlace:'fdf5e6',olive:'808000',olivedrab:'6b8e23',orange:'ffa500',orangered:'ff4500',orchid:'da70d6',palegoldenrod:'eee8aa',palegreen:'98fb98',paleturquoise:'afeeee',palevioletred:'d87093',papayawhip:'ffefd5',peachpuff:'ffdab9',peru:'cd853f',pink:'ffc0cb',plum:'dda0dd',powderblue:'b0e0e6',purple:'800080',red:'ff0000',rosybrown:'bc8f8f',royalblue:'4169e1',saddlebrown:'8b4513',salmon:'fa8072',sandybrown:'f4a460',seagreen:'2e8b57',seashell:'fff5ee',sienna:'a0522d',silver:'c0c0c0',skyblue:'87ceeb',slateblue:'6a5acd',slategray:'708090',snow:'fffafa',springgreen:'00ff7f',steelblue:'4682b4',tan:'d2b48c',teal:'008080',thistle:'d8bfd8',tomato:'ff6347',turquoise:'40e0d0',violet:'ee82ee',violetred:'d02090',wheat:'f5deb3',white:'ffffff',whitesmoke:'f5f5f5',yellow:'ffff00',yellowgreen:'9acd32'};for(var key in simple_colors){if(color_string==key){color_string=simple_colors[key]}}var color_defs=[{re:/^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/,example:['rgb(123, 234, 45)','rgb(255,234,245)'],process:function(bits){return[parseInt(bits[1]),parseInt(bits[2]),parseInt(bits[3])]}},{re:/^(\w{2})(\w{2})(\w{2})$/,example:['#00ff00','336699'],process:function(bits){return[parseInt(bits[1],16),parseInt(bits[2],16),parseInt(bits[3],16)]}},{re:/^(\w{1})(\w{1})(\w{1})$/,example:['#fb0','f0f'],process:function(bits){return[parseInt(bits[1]+bits[1],16),parseInt(bits[2]+bits[2],16),parseInt(bits[3]+bits[3],16)]}}];for(var i=0;i<color_defs.length;i++){var re=color_defs[i].re;var processor=color_defs[i].process;var bits=re.exec(color_string);if(bits){channels=processor(bits);this.r=channels[0];this.g=channels[1];this.b=channels[2];this.ok=true}}this.r=(this.r<0||isNaN(this.r))?0:((this.r>255)?255:this.r);this.g=(this.g<0||isNaN(this.g))?0:((this.g>255)?255:this.g);this.b=(this.b<0||isNaN(this.b))?0:((this.b>255)?255:this.b);this.toRGB=function(){return'rgb('+this.r+', '+this.g+', '+this.b+')'};this.toHash=function(){return{'red':this.r,'green':this.g,'blue':this.b}};this.inverse=function(){this.r=255-this.r;this.g=255-this.g;this.b=255-this.b};this.toHex=function(){var r=this.r.toString(16);var g=this.g.toString(16);var b=this.b.toString(16);if(r.length==1)r='0'+r;if(g.length==1)g='0'+g;if(b.length==1)b='0'+b;return'#'+r+g+b}};var uPanel=function(_params){var params=_params,self=this,editor=null;var renderPanel=function(){jQuery(params['placeholder']).html(uPanel.getSource());if(jQuery.cookie('eip-panel-state')=='collapsed'){}jQuery('#u-show_hide_btn').click(function(){self.swap(this)});jQuery('#u-quickpanel #last_doc, #changelog_dd').click(function(){changeClassName(this)});jQuery('#u-quickpanel #edit').click(function(){self.swapEditor()});jQuery('#u-quickpanel #save_edit #save').click(function(){uPageEditor.get().submit();return false});jQuery('#u-quickpanel #save_edit #edit_back').click(function(){uPageEditor.get().back(1);return false});jQuery('#u-quickpanel #save_edit #edit_next').click(function(){uPageEditor.get().forward(1);return false});jQuery('#u-quickpanel #exit').click(function(){window.location='/users/logout/';return false});jQuery('#u-quickpanel #note').click(function(){if(!window.ticketCreated){alert('Теперь нужно выделить область страницы, к которой Вы собираетесь создать заметку.');window.ticketCreated=true}window.initNewTicket();return false});jQuery('#u-quickpanel #help').click(function(){window.location="http://help.umi-cms.ru/";return false});if(jQuery.cookie('eip-editor-state')){changeClassName(jQuery('#u-quickpanel #edit'));self.swapEditor()}};var onLoadData=function(data){jQuery('recent page',data).each(function(index,page){var node=document.createElement('li');var name=jQuery('name',page).text();var link=jQuery(page).attr('link');jQuery(node).html("<a href='"+link+"'>"+name+"</a>");jQuery('ul#u-docs-recent').append(node)});var i=0;jQuery('editable page',data).each(function(index,page){var module=jQuery('basetype',page).attr("module");var hasPerm=false;jQuery('modules module',data).each(function(){if(jQuery(this).text()==module){hasPerm=true}});if(!hasPerm)return;var node=document.createElement('li');var name=jQuery('name',page).text();var link=jQuery('edit-link',page).text();jQuery(node).html("<a href='"+link+"'>"+name+"</a>");jQuery('#u-quickpanel ul#u-docs-edit').append(node);i++});if(i){jQuery("#u-quickpanel #edit_menu").click(function(){changeClassName(this)})}else{jQuery("#u-quickpanel #edit_menu").hide(0)}i=0;jQuery('modules module',data).each(function(index,module){var node=document.createElement('li');var label=jQuery(module).attr('label');var name=jQuery(module).text();var link='/admin/'+name+'/';var type=jQuery(module).attr('type');var selector;if(type=='system'){selector='ul#u-mods-admin'}else if(type=='util'){selector='ul#u-mods-utils'}else{selector=(++i%2)?'ul#u-mods-cont-left':'ul#u-mods-cont-right'}jQuery(node).html("<a href='"+link+"'>"+label+"</a>");jQuery('#u-quickpanel '+selector).append(node)});if(i){jQuery("#u-quickpanel #butterfly").click(function(){changeClassName(this)}).addClass("butterfly_hover")}var currentLocation=window.location.pathname;if(jQuery('changelog',data).size()>0){jQuery('changelog revision',data).each(function(index,revision){var node=document.createElement('li');var time=jQuery('date',revision).text();var login=jQuery('author',revision).attr('name');var link=jQuery('link',revision).text();var active=(jQuery(revision).attr('active')=='active');var label=time;if(login){label+=' - '+login}link+='?force-redirect='+window.location.pathname;if(active){label+='&nbsp;&nbsp;&nbsp;&larr;'}jQuery(node).html("<a href='"+link+"'>"+label+"</a>");jQuery('#u-changelog').append(node)});jQuery('#changelog_dd').css('display','')}else{jQuery('#changelog_dd').css('display','none')}if(jQuery('tickets',data).size()&&(typeof tickets!='undefined')){tickets(jQuery,data)}else{jQuery('#u-quickpanel #note').remove()}};var loadData=function(){var url='/admin/content/frontendPanel.xml?links';url+='&ts='+Math.round(Math.random()*1000);jQuery.get(url,{referer:window.location.toString()},onLoadData)};var uPageEditorOnInit=function(){var h=(typeof uPageEditor.onEnable=='function')?uPageEditor.onEnable:function(){};uPageEditor.onEnable=function(){h();changeClassName(jQuery('#edit'))};var h=(typeof uPageEditor.onDisable=='function')?uPageEditor.onDisable:function(){};uPageEditor.onDisable=function(){h();changeClassName(jQuery('#edit'))};uPageEditor.onStep=function(index,size){jQuery('#u-quickpanel #save_edit #edit_back').attr('class',(index==-1)?'':'ac');jQuery('#u-quickpanel #save_edit #edit_next').attr('class',((size-index)==1)?'':'ac')}};renderPanel();uPageEditorOnInit();loadData()};uPanel.prototype.swapEditor=function(){var editor=uPageEditor.get();if(editor.isEnabled()){editor.disable();jQuery('#u-quickpanel #edit').html(getLabel('js-panel-edit')+' (F2)')}else{editor.enable();jQuery('#u-quickpanel #edit').html(getLabel('js-panel-view')+' (F2)')}};uPanel.prototype.swap=function(el){var quickpanel_width=jQuery("#u-quickpanel").css("width");if(quickpanel_width=="0px"){return this.expand(el)}else{return this.collapse(el)}};uPanel.prototype.expand=function(el){var quickpanel=jQuery("#u-quickpanel");quickpanel.css('overflow','visible');quickpanel.animate({width:"100%"},500);el.style.background='url(\'/js/client/panel/quickpanel_bg.png\') no-repeat -635px -33px';jQuery.cookie('eip-panel-state','',{path:'/',expires:0})};uPanel.prototype.collapse=function(el){var quickpanel=jQuery("#u-quickpanel");quickpanel.css('overflow','hidden');quickpanel.animate({width:"0"},500);el.style.background='url(\'/js/client/panel/quickpanel_bg.png\') no-repeat -635px 1px';var date=new Date();date.setTime(date.getTime()+(30*24*60*60*1000));jQuery.cookie('eip-panel-state','collapsed',{path:'/',expires:date})};uPanel.loadRes=function(type,src,callback){var node;switch(type){case'js':case'text/javascript':node=document.createElement('script');node.src=src;node.charset='utf-8';break;case'css':case'text/css':node=document.createElement('link');node.href=src;node.rel='stylesheet';break;default:return}document.body.parentNode.firstChild.appendChild(node);if(typeof callback=='function')jQuery(document).one('ready',callback)};uPanel.getSource=function(){return'<div id="u-show_hide_btn"/>\<div id="u-quickpanel">\<div id="exit"title="Выход">&#160;</div>\<div id="help"title="Документация">&#160;</div>\<div id="butterfly"title="Модули">&#160;\<div>\<div class="bg">\<ul id="u-mods-cont-left"/>\<ul id="u-mods-cont-right"/>\<div class="clear"style="border-top:solid 1px #b2c7d5; border-bottom:solid 1px white;"/>\<ul id="u-mods-admin"/>\<ul id="u-mods-utils"/>\<div class="clear"/>\</div>\<div class="bottom_bg"/>\</div>\</div>\<div id="edit">' + getLabel('js-panel-edit') + '(F2)' + '</div>\<div id="save_edit">\<div id="save"title="Сохранить">&#160;</div>\<div id="edit_back"title="Отменить">&#160;</div>\<div id="edit_next"title="Повторить">&#160;</div>\</div>\<div id="edit_menu"title="Редактировать в админке (Shift+D)">&#160;\<div>\<ul id="u-docs-edit"/>\<div class="bottom_bg"/>\</div>\</div>\<div id="last_doc">\Последние документы\<div>\<ul id="u-docs-recent"/>\<div class="bottom_bg"/>\</div>\</div>\<div id="changelog_dd">\История изменений\<div>\<ul id="u-changelog"/>\<div class="bottom_bg"/>\</div>\</div>\<div id="note">Заметка(Shift+C)</div>\</div>'};jQuery(document).ready(function(){var placeholder=jQuery('#u-panel-holder');if(placeholder.size()==0){var div=document.createElement('div');div.id='u-panel-holder';document.body.appendChild(div);placeholder=jQuery('#u-panel-holder')}jQuery('html').addClass('u-eip');var panel=new uPanel({'placeholder':placeholder});jQuery(document).keypress(function(e){var code=e.charCode||e.keyCode;if(e.shiftKey&&(code==68||code==100||code==1042||code==1074)){jQuery('#u-quickpanel #edit_menu').each(function(i,node){changeClassName(node)})}})});function changeClassName(el){var eCond=(uPageEditor.get().isEnabled())?'[id != \'edit\']':'';if(!jQuery(el).hasClass('act')){var act_arr=jQuery('#u-quickpanel .act');if(act_arr.size()){jQuery('#u-quickpanel .act div:first').hide();jQuery('#u-quickpanel .act'+eCond).removeClass('act');if(el.id=='edit'&&!eCond)jQuery("#save_edit").css('display','none')}jQuery(el).addClass('act');jQuery('#u-quickpanel .act div:first').show();if(jQuery(el).attr('id')=='edit')jQuery("#save_edit").css('display','block')}else{jQuery('#u-quickpanel .act div:first').hide();jQuery('#u-quickpanel .act'+eCond).removeClass('act');if(jQuery(el).attr('id')=='edit')jQuery("#save_edit").css('display','none')}};var tickets=function($,data){var tickets=new Array;var user=$('user',data);var ticket=function(params){var self=this,params=params,node,messageNode;var x=params.x,y=params.y,width=params.width,height=params.height;var resetSelection=function(){var sel;if(document.selection&&document.selection.empty){document.selection.empty()}else if(window.getSelection){sel=window.getSelection();if(sel&&sel.removeAllRanges){sel.removeAllRanges()}}};var createMessage=function(){messageNode=$('<div class="u-ticket-comment"><div /><textarea /><a /></div>');$(document.body).append(messageNode);if(params['message']){$('div',messageNode).html(params.message.authorName+' ('+params.message.authorLogin+')');$('textarea',messageNode).attr('value',params.message.text)}$('a',messageNode).html(getLabel('js-ticket-delete'));$('textarea',messageNode).bind('change blur',function(){self.save()});$('a',messageNode).bind('click',function(){self.del()})};self.del=function(){if(node)node.remove();if(messageNode)messageNode.remove();if(params.id){var url='/content/tickets/delete/'+params.id+'/';$.get(url)}};self.save=function(){var mode=params.id?'modify':'create';var url='/content/tickets/'+mode+'/'+params.id+'/';url+='?ts='+Math.round(Math.random()*1000);$.ajax({url:url,dataType:'json',data:{x:x,y:y,width:width,height:height,message:$('textarea',messageNode).attr('value'),referer:window.location.toString()},success:function(resp){params.id=resp.id}})};self.update=function(){node.css({top:y,left:x,width:width,height:height,opacity:0.3});if(messageNode){messageNode.css({top:parseInt(y)+parseInt(height),left:parseInt(x)+parseInt(width)})}};self.listen=function(){$(document).bind('mousemove',function(event){resetSelection();width=event.clientX-x;height=event.clientY-y;self.update()});$(document).one('mouseup',function(event){$(document).unbind('mousemove');self.update()})};(function init(){node=$('<div class="u-ticket" />');$(document.body).append(node);if(params.message){createMessage()}self.update()})()};var initNewTicket=function(){changeClassName(jQuery('#u-quickpanel #note').get(0));$(document).one('mousedown',function(event){var newTicket=new ticket({x:event.clientX,y:event.clientY,width:1,height:1,message:{authorName:user.attr('fname')+' '+user.attr('lname'),authorLogin:user.attr('login'),text:getLabel('js-ticket-empty')}});newTicket.listen();changeClassName(jQuery('#u-quickpanel #note').get(0))})};window.initNewTicket=initNewTicket;$(document).bind('keydown',function(event){if(event.shiftKey&&(event.keyCode==67||event.keyCode==99)){initNewTicket();return true}});(function draw(data){$('ticket',data).each(function(index,node){var node=$(node);var pos=$('position',node);var author=$('author',node);var message=$('message',node);var t=new ticket({id:node.attr('id'),x:pos.attr('x'),y:pos.attr('y'),width:pos.attr('width'),height:pos.attr('height'),message:{authorName:author.attr('fname')+' '+author.attr('lname'),authorLogin:author.attr('login'),text:message.text()}});t.update()})})(data)};function relationControl(_typeId,_fieldSuffix,_prependEmpty,_sourceUri){var _self=this;var typeId=_typeId;var fieldSuffix=_fieldSuffix||_typeId;var needLoad=true;var selectInput=null;var textInput=null;var addButton=null;var addedOption=null;var useSearchOption=null;var suggestDiv=null;var timeHandler=null;var suggestItems=null;var suggestIndex=null;var mouseX=0;var mouseY=0;var sourceUri=_sourceUri||'/admin/data/guide_items_all/';var init=function(){selectInput=document.getElementById('relationSelect'+fieldSuffix);textInput=document.getElementById('relationInput'+fieldSuffix);addButton=document.getElementById('relationButton'+fieldSuffix);if(!selectInput){alert('Select input for field #'+fieldSuffix+' not found');return}if(addButton){addButton.onclick=function(){_self.addItem()}}if(textInput){textInput.onkeyup=function(keyEvent){var code=keyEvent?keyEvent.keyCode:event.keyCode;if(code==13&&addButton){_self.addItem();return false}else{_self.doSearch()}};textInput.onkeydown=function(keyEvent){var code=keyEvent?keyEvent.keyCode:event.keyCode;if(code==13){return false}}}var onLoadItems=function(){if(needLoad){_self.loadItemsAll();needLoad=false}};selectInput.onmouseover=onLoadItems;selectInput.onfocus=onLoadItems;for(var i=0;i<selectInput.childNodes.length;i++){if(selectInput.childNodes[i].nodeType!=1){selectInput.removeChild(selectInput.childNodes[i]);i=0}}if(_prependEmpty&&$("option[value='']",selectInput).size()==0){$(selectInput).prepend("<option value=''></option>")}};this.rescan=function(){textInput=document.getElementById('relationInput'+fieldSuffix);if(textInput){textInput.onkeyup=function(keyEvent){var code=keyEvent?keyEvent.keyCode:event.keyCode;if(code==13&&addButton){_self.addItem()}else{_self.doSearch()}}}};this.getValue=function(){var opts=$("option[selected]",$(selectInput));var values=[];for(var i=0;i<opts.length;i++){values[opts[i].value]=$(opts[i]).text()}return values};this.loadItems=function(startsWith){$.ajax({url:sourceUri+typeId+".xml?limit&search[]="+encodeURIComponent(startsWith),type:"get",complete:function(r,t){_self.updateItems(r)}})};this.loadItemsAll=function(){$.ajax({url:sourceUri+typeId+".xml?allow-empty",type:"get",complete:function(r,t){_self.updateItemsAll(r)}})};this.updateItemsAll=function(response){if(response.responseXML.getElementsByTagName('empty').length){if(textInput){textInput.onkeyup=function(keyEvent){var code=keyEvent?keyEvent.keyCode:event.keyCode;switch(code){case 38:{if(suggestItems.length&&(suggestIndex>0||suggestIndex==null)){highlightSuggestItem((suggestIndex===null)?(suggestItems.length-1):(suggestIndex-1))}break}case 40:{if(suggestItems.length&&(suggestIndex<(suggestItems.length-1)||suggestIndex==null)){highlightSuggestItem((suggestIndex===null)?0:(suggestIndex+1))}break}case 13:{addHighlitedItem();hideSuggest();break}case 27:{hideSuggest();break}default:{clearTimeout(timeHandler);timeHandler=setTimeout(function(){_self.doSearchAjax()},500)}}};textInput.onblur=function(){if(suggestDiv){if(mouseX<parseInt(suggestDiv.style.left)||mouseX>(parseInt(suggestDiv.style.left)+parseInt(suggestDiv.offsetWidth))||mouseY<parseInt(suggestDiv.style.top)||mouseY>(parseInt(suggestDiv.style.top)+parseInt(suggestDiv.offsetHeight))){hideSuggest()}}};var total=response.responseXML.getElementsByTagName('empty')[0].getAttribute('total');if(!useSearchOption){useSearchOption=new Option(' ','');useSearchOption.innerHTML=getLabel('js-relation-total')+total+". "+getLabel('js-relation-use_search');selectInput.insertBefore(useSearchOption,selectInput.firstChild)}}return}var items=response.responseXML.getElementsByTagName('object');var selection=[];var i=0;for(i=0;i<selectInput.options.length;i++){if(selectInput.options[i].selected){selection.push(selectInput.options[i].value)}}$("option:not([selected])",selectInput).remove();$("option[value='']",selectInput).remove();if(_prependEmpty)$(selectInput).prepend("<option value=''> </option>");for(i=0;i<items.length;i++){var itemId=items[i].getAttribute('id');var hasItem=false;for(var idx in selection){if(selection[idx]==itemId){hasItem=true;delete selection[idx];break}}if(!hasItem){var text=items[i].getAttribute('name');var opt=new Option(text,itemId);opt.innerHTML=text;selectInput.appendChild(opt)}}if($.browser.msie){var d=selectInput.style.display;selectInput.style.display='none';selectInput.style.display=d}};this.updateItems=function(response){suggestIndex=null;suggestItems=response.responseXML.getElementsByTagName('object');if(!suggestItems.length)return;var ul=null;if(!suggestDiv){suggestDiv=document.createElement('div');suggestDiv.className='relationAutosuggest';var pos=$(textInput).offset();suggestDiv.style.position='absolute';suggestDiv.style.zIndex=1050;suggestDiv.style.width=textInput.clientWidth+"px";suggestDiv.style.top=(pos.top+textInput.offsetHeight)+"px";suggestDiv.style.left=pos.left+"px";ul=document.createElement('ul');suggestDiv.appendChild(ul);document.body.appendChild(suggestDiv)}suggestDiv.style.display='';$(document).mousemove(documentMouseMoveHandler);ul=suggestDiv.firstChild;while(ul.firstChild){ul.removeChild(ul.firstChild)}for(i=0;i<suggestItems.length;i++){var text=suggestItems[i].getAttribute('name');var li=document.createElement('li');li.innerHTML=text;li.onmouseover=function(){highlightSuggestItem(this.suggestIndex)};li.onmouseout=function(){this.className=''};li.onclick=function(){addHighlitedItem();hideSuggest()};li.suggestIndex=i;ul.appendChild(li)}};var documentMouseMoveHandler=function(e){if(!e){mouseX=event.clientX+document.body.scrollLeft;mouseY=event.clientY+document.body.scrollTop}else{mouseX=e.pageX;mouseY=e.pageY}return true};this.addItem=function(_text,_value){if(!(_text&&_text.length)&&!(textInput&&textInput.value.length)){return}clearSearch();removeGroups();if(!selectInput.multiple&&addedOption&&!_text&&!_value){addedOption.innerHTML=(_value?'':'&rarr;&nbsp;&nbsp;')+textInput.value;addedOption.value=_value?_value:textInput.value;selectInput.selectedIndex=0}else{addedOption=new Option(_text?_text:textInput.value,_value?_value:textInput.value);addedOption.innerHTML=(_value?'':'&rarr;&nbsp;&nbsp;')+(_text?_text:textInput.value);if(selectInput.options.length){selectInput.insertBefore(addedOption,selectInput.firstChild)}else{selectInput.appendChild(addedOption)}}textInput.value='';addedOption.selected=true;if(jQuery.browser.msie){setTimeout(function(){addedOption.selected=false;addedOption.selected=true},20)}};var highlightSuggestItem=function(itemIndex){if(suggestDiv.style.display!='none'){var list=suggestDiv.firstChild;var oldHighlited=list.childNodes.item(suggestIndex);if(oldHighlited){oldHighlited.className=''}list.childNodes.item(itemIndex).className='active';suggestIndex=itemIndex}};var addHighlitedItem=function(){if(suggestDiv&&suggestDiv.style.display!='none'&&suggestIndex!==null){var text=suggestItems[suggestIndex].getAttribute('name');var value=suggestItems[suggestIndex].getAttribute('id');var found=false;for(var i=0;i<selectInput.options.length;i++){if(selectInput.options[i].value==value){found=true;selectInput.options[i].selected=true;break}}if(!found){_self.addItem(text,value)}}else if(textInput.value.length&&addButton){_self.addItem()}};var hideSuggest=function(){if(suggestDiv&&suggestDiv.style.display!='none'){suggestDiv.style.display='none';$(document).unbind('mousemove',documentMouseMoveHandler)}};this.doSearch=function(){var text=textInput.value.toLowerCase();clearSearch();if(text==''){if(selectInput.multiple)removeGroups();return}for(var i=0;i<selectInput.options.length;i++){var optionText=selectInput.options[i].text;var optionText2=optionText.replace(/^.\s\s/,'');if(optionText.substring(0,text.length).toLowerCase()===text||optionText2.substring(0,text.length).toLowerCase()===text){if(selectInput.multiple){if(selectInput.firstChild.nodeName.toLowerCase()!='optgroup'){createGroups();searchGroup=selectInput.firstChild;itemsGroup=selectInput.lastChild}var currentItem=selectInput.options[i];if(currentItem.parentNode==searchGroup)continue;currentItem.oldPrevSibling=currentItem.previousSibling;itemsGroup.removeChild(currentItem);searchGroup.appendChild(currentItem);if(searchGroup.childNodes.length==5)return}else{selectInput.selectedIndex=i;return}}}};this.doSearchAjax=function(){if(textInput.value){this.loadItems(textInput.value)}};var createGroups=function(){var searchGroup=document.createElement('optgroup');searchGroup.label='Search results';var itemsGroup=document.createElement('optgroup');itemsGroup.label='------------------------------------------------';while(selectInput.firstChild){var child=selectInput.firstChild;selectInput.removeChild(child);itemsGroup.appendChild(child)}selectInput.appendChild(searchGroup);selectInput.appendChild(itemsGroup)};var removeGroups=function(){if(selectInput.firstChild&&selectInput.firstChild.nodeName.toLowerCase()=='optgroup'){selectInput.removeChild(selectInput.firstChild);var itemsGroup=selectInput.firstChild;while(itemsGroup.firstChild){var child=itemsGroup.firstChild;itemsGroup.removeChild(child);selectInput.appendChild(child)}selectInput.removeChild(itemsGroup)}};var clearSearch=function(){if(selectInput.firstChild&&selectInput.firstChild.nodeName.toLowerCase()=='optgroup'){var searchGroup=selectInput.firstChild;var itemsGroup=selectInput.lastChild;while(searchGroup.firstChild){var child=searchGroup.firstChild;searchGroup.removeChild(child);if(child.oldPrevSibling!==undefined||child.oldPrevSibling==null){if(child.oldPrevSibling&&child.oldPrevSibling.nextSibling){itemsGroup.insertBefore(child,child.oldPrevSibling.nextSibling)}else if(child.oldPrevSibling===null){itemsGroup.insertBefore(child,itemsGroup.firstChild)}else{itemsGroup.appendChild(child)}child.oldPrevSibling=undefined}}}};init()}