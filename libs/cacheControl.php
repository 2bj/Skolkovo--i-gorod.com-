<?php
 class staticCache {protected $config, $enabled, $splitLevel = 5,     $requestUri, $isAdmin = false, $cacheFolder, $cacheFilePath;public function __construct() {$this->config = mainConfiguration::getInstance();$this->enabled = (bool) $this->config->get('cache', 'static.enabled');if($this->enabled) {$this->setRequestUri(getServer('REQUEST_URI'));$this->setCacheFolder($this->config->includeParam('system.static-cache'));$this->cacheFilePath = $this->prepareCacheFile();}}public function setRequestUri($vb6ee27ee7fe19b0c0dd907d5f947aa12) {$vb6ee27ee7fe19b0c0dd907d5f947aa12 = trim($vb6ee27ee7fe19b0c0dd907d5f947aa12, '/');if(!$vb6ee27ee7fe19b0c0dd907d5f947aa12) $vb6ee27ee7fe19b0c0dd907d5f947aa12 = '__splash';$this->requestUri = $vb6ee27ee7fe19b0c0dd907d5f947aa12;$v5fdedfe381eef204ab3354d244885a40 = false;if(substr($vb6ee27ee7fe19b0c0dd907d5f947aa12, 0, strlen('admin')) == 'admin') {$v5fdedfe381eef204ab3354d244885a40 = true;}elseif (substr($vb6ee27ee7fe19b0c0dd907d5f947aa12, 3, strlen('admin')) == 'admin') {$v5fdedfe381eef204ab3354d244885a40 = true;}$this->isAdmin = $v5fdedfe381eef204ab3354d244885a40;}public function setCacheFolder($v7f6a05a4bb9b16a1f4b36e9000d1bc3c) {if(is_dir($v7f6a05a4bb9b16a1f4b36e9000d1bc3c)) {$this->cacheFolder = $v7f6a05a4bb9b16a1f4b36e9000d1bc3c;return true;}else {mkdir($v7f6a05a4bb9b16a1f4b36e9000d1bc3c, 0777, true);if(is_dir($v7f6a05a4bb9b16a1f4b36e9000d1bc3c)) {$this->cacheFolder = $v7f6a05a4bb9b16a1f4b36e9000d1bc3c;return true;}else {return false;}}}public function cleanup() {$this->deleteElementsRelatedPages();}public function load() {$v2245023265ae4cf87d02c8b6ba991139 = mainConfiguration::getInstance();$vf5ff5d5b5b4c9e0d71455ae2afb95b85 = $this->cacheFilePath;$vafd4ff790ba767d5b9ae3316b7f2c526 = $this->cacheFilePath . '.store.php';if(sizeof($_POST) > 0 || $this->isAdmin || !file_exists($vf5ff5d5b5b4c9e0d71455ae2afb95b85)) {return false;}switch($v2245023265ae4cf87d02c8b6ba991139->get('cache', 'static.mode')) {case 'short':     $vcd91e7679d575a2c548bd2c889c23b9e = 10 * 60;break;case 'login':     $vcd91e7679d575a2c548bd2c889c23b9e = 3600*2*365;break;default: $vcd91e7679d575a2c548bd2c889c23b9e = 3600 * 24;break;}if((filemtime($vf5ff5d5b5b4c9e0d71455ae2afb95b85) + $vcd91e7679d575a2c548bd2c889c23b9e) < time()) {$this->deleteFileIfExists($vf5ff5d5b5b4c9e0d71455ae2afb95b85);return false;}if(file_exists($vafd4ff790ba767d5b9ae3316b7f2c526)) {include $vafd4ff790ba767d5b9ae3316b7f2c526;}$v9a0364b9e99bb480dd25e1f0284c8555 = trim(file_get_contents($vf5ff5d5b5b4c9e0d71455ae2afb95b85));if($v9a0364b9e99bb480dd25e1f0284c8555) {if(!$v2245023265ae4cf87d02c8b6ba991139->get('cache', 'static.ignore-stat')) {$this->saveStatInfo();}$v7f2db423a49b305459147332fb01cf87 = outputBuffer::current();$v7f2db423a49b305459147332fb01cf87->contentType('text/html');$v7f2db423a49b305459147332fb01cf87->charset('utf-8');$v7f2db423a49b305459147332fb01cf87->clear();$v7f2db423a49b305459147332fb01cf87->push($v9a0364b9e99bb480dd25e1f0284c8555);$v7f2db423a49b305459147332fb01cf87->end();}}public function save($v9a0364b9e99bb480dd25e1f0284c8555) {if(!$this->enabled || !$v9a0364b9e99bb480dd25e1f0284c8555) return false;if($this->isAdmin) return false;$v9a0364b9e99bb480dd25e1f0284c8555 = str_replace(array('<?', '?>'), array('&lt?;', '?&gt;'), $v9a0364b9e99bb480dd25e1f0284c8555);$vd6fe1d0be6347b8ef2427fa629c04485 = $this->cacheFilePath;file_put_contents($vd6fe1d0be6347b8ef2427fa629c04485, $v9a0364b9e99bb480dd25e1f0284c8555);@chmod($vd6fe1d0be6347b8ef2427fa629c04485, 0777);$this->saveCacheElementsRelations();$v7d9152a42bd82ef96bb3148be1410ef4 = base64_encode(serialize(headers_list()));$v5376b187dc221b98a66278e571cafbe3 = base64_encode(serialize($_SESSION));$v8cd892b7b97ef9489ae4479d3f4ef0fc = <<<END
<?php
	\$headers = unserialize(base64_decode('$v7d9152a42bd82ef96bb3148be1410ef4'));
	\$session = unserialize(base64_decode('$v5376b187dc221b98a66278e571cafbe3'));
	
	if(is_array(\$headers)) {
		\$cmp = strtolower("Set-Cookie");
		
		for(\$i = 0; \$i < sizeof(\$headers); \$i++) {
			if(substr(strtolower(\$headers[\$i]), 0, strlen(\$cmp)) == \$cmp) {
				continue;
			} else {
				header(\$headers[\$i]);
			}
		}
	}
	if (!session_id()) session_start();
	\$_SESSION = \$session;
?>
END;   file_put_contents($vd6fe1d0be6347b8ef2427fa629c04485 . ".store.php", $v8cd892b7b97ef9489ae4479d3f4ef0fc);@chmod($vd6fe1d0be6347b8ef2427fa629c04485 . ".store.php", 0777);}protected function saveCacheElementsRelations() {$vb81ca7c0ccaa77e7aa91936ab0070695 = umiHierarchy::getInstance();$v6a7f245843454cf4f28ad7c5e2572aa2 = $vb81ca7c0ccaa77e7aa91936ab0070695->getCollectedElements();$v6a7f245843454cf4f28ad7c5e2572aa2 = array_unique($v6a7f245843454cf4f28ad7c5e2572aa2);foreach($v6a7f245843454cf4f28ad7c5e2572aa2 as $v7552cd149af7495ee7d8225974e50f80) {$this->saveCacheElementRelation($v7552cd149af7495ee7d8225974e50f80);}}protected function saveCacheElementRelation($v7552cd149af7495ee7d8225974e50f80) {$v47826cacc65c665212b821e6ff80b9b0 = $this->cacheFolder . 'cacheElementsRelations/' . $this->defragmentDirPath($v7552cd149af7495ee7d8225974e50f80, 3);if($this->createDirectory($v47826cacc65c665212b821e6ff80b9b0) == false) return;$v47826cacc65c665212b821e6ff80b9b0 .= $v7552cd149af7495ee7d8225974e50f80 . '.tmp';if(!file_exists($v47826cacc65c665212b821e6ff80b9b0)) {touch($v47826cacc65c665212b821e6ff80b9b0);@chmod($v47826cacc65c665212b821e6ff80b9b0, 0777);}if(!file_exists($v47826cacc65c665212b821e6ff80b9b0)) return false;$v8fa14cdd754f91cc6554c9e71929cce7 = fopen($v47826cacc65c665212b821e6ff80b9b0, "a+");fwrite($v8fa14cdd754f91cc6554c9e71929cce7, $this->cacheFilePath . "\n");fclose($v8fa14cdd754f91cc6554c9e71929cce7);$this->cleanupRelationsFile($v47826cacc65c665212b821e6ff80b9b0);return true;}protected function deleteElementsRelatedPages() {$vb81ca7c0ccaa77e7aa91936ab0070695 = umiHierarchy::getInstance();$v5e9298abf28337d6b7f5ab24a28c62f9 = $vb81ca7c0ccaa77e7aa91936ab0070695->getUpdatedElements();foreach($v5e9298abf28337d6b7f5ab24a28c62f9 as $v7552cd149af7495ee7d8225974e50f80) {$this->deleteElementRelatedPages($v7552cd149af7495ee7d8225974e50f80);}}protected function deleteElementRelatedPages($v7552cd149af7495ee7d8225974e50f80) {$v47826cacc65c665212b821e6ff80b9b0 = $this->cacheFolder . 'cacheElementsRelations/' . $this->defragmentDirPath($v7552cd149af7495ee7d8225974e50f80) . '/' . $v7552cd149af7495ee7d8225974e50f80 . '.tmp';if(!file_exists($v47826cacc65c665212b821e6ff80b9b0)) return false;$v8fa14cdd754f91cc6554c9e71929cce7 = fopen($v47826cacc65c665212b821e6ff80b9b0, "r");if($v8fa14cdd754f91cc6554c9e71929cce7 !== false) {while(!feof($v8fa14cdd754f91cc6554c9e71929cce7)) {$vd6fe1d0be6347b8ef2427fa629c04485 = trim(fgets($v8fa14cdd754f91cc6554c9e71929cce7, 1024));if($this->deleteFileIfExists($vd6fe1d0be6347b8ef2427fa629c04485)) {$this->deleteFileIfExists($vd6fe1d0be6347b8ef2427fa629c04485 . ".store.php");}$this->deleteFolderIfEmpty(dirname($vd6fe1d0be6347b8ef2427fa629c04485));}fclose($v8fa14cdd754f91cc6554c9e71929cce7);unlink($v47826cacc65c665212b821e6ff80b9b0);}$this->deleteFolderIfEmpty(dirname($v47826cacc65c665212b821e6ff80b9b0));$v6a7f245843454cf4f28ad7c5e2572aa2 = umiHierarchy::getInstance()->getObjectInstances($v7057e8409c7c531a1a6e9ac3df4ed549);if(is_array($v6a7f245843454cf4f28ad7c5e2572aa2)) {foreach($v6a7f245843454cf4f28ad7c5e2572aa2 as $vb80bb7740288fda1f201890375a60c8f) {if($vb80bb7740288fda1f201890375a60c8f != $v7057e8409c7c531a1a6e9ac3df4ed549) {deleteElementRelatedPages($vb80bb7740288fda1f201890375a60c8f);}}}}protected function prepareCacheFile() {$v8e44f0089b076e18a718eb9ca3d94674 = getSession('user_id');if(!$v8e44f0089b076e18a718eb9ca3d94674) $v8e44f0089b076e18a718eb9ca3d94674 = 2373;$v5dc5f5c1868869a921d4a2797a6d5ae5 = sha1($this->requestUri);$vcfa2e053ded063885fb26d60239eded5 = sha1(getServer('HTTP_HOST'));$v1942208c934304d81de0a3afb17d293a = substr($v5dc5f5c1868869a921d4a2797a6d5ae5, 0, $this->splitLevel);$vcbf56cfaa0d6ce4269c1e0ab4f5eeff4 =  "{$this->cacheFolder}userCache/{$v8e44f0089b076e18a718eb9ca3d94674}/{$vcfa2e053ded063885fb26d60239eded5}/";$vcbf56cfaa0d6ce4269c1e0ab4f5eeff4 .= $this->defragmentDirPath($v1942208c934304d81de0a3afb17d293a, $this->splitLevel);$vcb423dbc0d39eaf2392d7e258b11545c = $vcbf56cfaa0d6ce4269c1e0ab4f5eeff4 . substr($v5dc5f5c1868869a921d4a2797a6d5ae5, $this->splitLevel);if($v8e44f0089b076e18a718eb9ca3d94674 == 2373 && getSession('is_human')) {$vcb423dbc0d39eaf2392d7e258b11545c .= '_human';}if(!$this->isAdmin && $this->createDirectory($vcbf56cfaa0d6ce4269c1e0ab4f5eeff4) == false) {return false;}return $vcb423dbc0d39eaf2392d7e258b11545c . '.tmp';}protected function defragmentDirPath($vd6fe1d0be6347b8ef2427fa629c04485, $vc9e9a848920877e76685b2e4e76de38d = 5) {$result = "";if(strlen($vd6fe1d0be6347b8ef2427fa629c04485) < $vc9e9a848920877e76685b2e4e76de38d) {$vc9e9a848920877e76685b2e4e76de38d = strlen($vd6fe1d0be6347b8ef2427fa629c04485);}for($v865c0c0b4ab0e063e5caa3387c1a8741 = 0;$v865c0c0b4ab0e063e5caa3387c1a8741 < $vc9e9a848920877e76685b2e4e76de38d;$v865c0c0b4ab0e063e5caa3387c1a8741++) {$result .= substr($vd6fe1d0be6347b8ef2427fa629c04485, $v865c0c0b4ab0e063e5caa3387c1a8741, 1) . "/";}$result .= substr($vd6fe1d0be6347b8ef2427fa629c04485, $v865c0c0b4ab0e063e5caa3387c1a8741);if($v865c0c0b4ab0e063e5caa3387c1a8741 < strlen($vd6fe1d0be6347b8ef2427fa629c04485)) {$result .= "/";}return $result;}protected function createDirectory($vd6fe1d0be6347b8ef2427fa629c04485) {return is_dir($vd6fe1d0be6347b8ef2427fa629c04485) ? is_writable($vd6fe1d0be6347b8ef2427fa629c04485) : mkdir($vd6fe1d0be6347b8ef2427fa629c04485, 0777, true);}protected function cleanupRelationsFile($v47826cacc65c665212b821e6ff80b9b0) {if(rand(0, 25) == 3) {file_put_contents($v47826cacc65c665212b821e6ff80b9b0, array_unique(file($v47826cacc65c665212b821e6ff80b9b0)));}}protected function deleteFileIfExists($v47826cacc65c665212b821e6ff80b9b0) {if(is_file($v47826cacc65c665212b821e6ff80b9b0)) {return is_writable($v47826cacc65c665212b821e6ff80b9b0) ? unlink($v47826cacc65c665212b821e6ff80b9b0) : false;}return true;}protected function deleteFolderIfEmpty($vd6fe1d0be6347b8ef2427fa629c04485) {$vd6fe1d0be6347b8ef2427fa629c04485 = realpath($vd6fe1d0be6347b8ef2427fa629c04485);if(!is_dir($vd6fe1d0be6347b8ef2427fa629c04485)) return false;$v736007832d2167baaae763fd3a3f3cf1 = opendir($vd6fe1d0be6347b8ef2427fa629c04485);while(($vbe8f80182e0c983916da7338c2c1c040 = readdir($v736007832d2167baaae763fd3a3f3cf1)) !== false) {if($vbe8f80182e0c983916da7338c2c1c040 == "." || $vbe8f80182e0c983916da7338c2c1c040 == "..") continue;return false;}if(is_writable($vd6fe1d0be6347b8ef2427fa629c04485)) {$v2405a5d61f2f462a1371b33338295c09 = realpath($vd6fe1d0be6347b8ef2427fa629c04485 . "/../");rmdir($vd6fe1d0be6347b8ef2427fa629c04485);$this->deleteFolderIfEmpty($v2405a5d61f2f462a1371b33338295c09);return true;}else return false;}protected function saveStatInfo() {$v8b1dc169bf460ee884fceef66c6607d6 = cmsController::getInstance();$v8b1dc169bf460ee884fceef66c6607d6->analyzePath();if($va55bfe58c5374dd01c2bd30c25648906 = $v8b1dc169bf460ee884fceef66c6607d6->getModule("stat")) {$va55bfe58c5374dd01c2bd30c25648906->pushStat();}}};?>