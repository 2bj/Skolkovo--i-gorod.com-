<?php
 abstract class __events_handlers_forum {public function onElementActivity(iUmiEventPoint $v161c9aaa4fe035e7b2f465bc59f3ab45) {if ($v161c9aaa4fe035e7b2f465bc59f3ab45->getMode() === 'after') {if ($v161c9aaa4fe035e7b2f465bc59f3ab45->getMode() === 'after') {$v0d4be57f7618c008934d1d1e80b96bd5 = $v161c9aaa4fe035e7b2f465bc59f3ab45->getRef('element');if ($v0d4be57f7618c008934d1d1e80b96bd5 instanceof umiHierarchyElement) {$v75c278e5864f2169d67750fe2a77aefc = intval($v0d4be57f7618c008934d1d1e80b96bd5->getTypeId());if ($v75c278e5864f2169d67750fe2a77aefc && ($v75c278e5864f2169d67750fe2a77aefc === $this->getHTypeByName('topic') || $v75c278e5864f2169d67750fe2a77aefc === $this->getHTypeByName('message'))) {$this->recalcCounts($v0d4be57f7618c008934d1d1e80b96bd5);}}}}}public function onElementRemove(iUmiEventPoint $v161c9aaa4fe035e7b2f465bc59f3ab45) {if ($v161c9aaa4fe035e7b2f465bc59f3ab45->getMode() === 'after') {$v0d4be57f7618c008934d1d1e80b96bd5 = $v161c9aaa4fe035e7b2f465bc59f3ab45->getRef('element');if ($v0d4be57f7618c008934d1d1e80b96bd5 instanceof umiHierarchyElement) {$v75c278e5864f2169d67750fe2a77aefc = intval($v0d4be57f7618c008934d1d1e80b96bd5->getTypeId());if ($v75c278e5864f2169d67750fe2a77aefc && ($v75c278e5864f2169d67750fe2a77aefc === $this->getHTypeByName('topic') || $v75c278e5864f2169d67750fe2a77aefc === $this->getHTypeByName('message'))) {$this->recalcCounts($v0d4be57f7618c008934d1d1e80b96bd5);}}}}public function onElementAppend(iUmiEventPoint $v161c9aaa4fe035e7b2f465bc59f3ab45) {if ($v161c9aaa4fe035e7b2f465bc59f3ab45->getMode() === 'after') {$v0d4be57f7618c008934d1d1e80b96bd5 = $v161c9aaa4fe035e7b2f465bc59f3ab45->getRef('element');if ($v0d4be57f7618c008934d1d1e80b96bd5 instanceof umiHierarchyElement) {$v75c278e5864f2169d67750fe2a77aefc = intval($v0d4be57f7618c008934d1d1e80b96bd5->getTypeId());if ($v75c278e5864f2169d67750fe2a77aefc && ($v75c278e5864f2169d67750fe2a77aefc === $this->getHTypeByName('topic') || $v75c278e5864f2169d67750fe2a77aefc === $this->getHTypeByName('message'))) {$this->recalcCounts($v0d4be57f7618c008934d1d1e80b96bd5);$v0faea619a3eb6dfca4ced9bbe5bf4c9a = new umiDate(time());$v0d4be57f7618c008934d1d1e80b96bd5->setValue("publish_time", $v0faea619a3eb6dfca4ced9bbe5bf4c9a);$v0d4be57f7618c008934d1d1e80b96bd5->commit();}}}}public function recalcCounts(iUmiHierarchyElement $v8e2dcfd7e7e24b1ca76c1193f645902b) {$v8e2dcfd7e7e24b1ca76c1193f645902b = selector::get('page')->id($v8e2dcfd7e7e24b1ca76c1193f645902b->getRel());if(!$v8e2dcfd7e7e24b1ca76c1193f645902b) return false;if(!defined('DISABLE_SEARCH_REINDEX')) {define('DISABLE_SEARCH_REINDEX', '1');}switch($v8e2dcfd7e7e24b1ca76c1193f645902b->getMethod()) {case 'conf':     $v8e2dcfd7e7e24b1ca76c1193f645902b->messages_count = $this->calculateCount($v8e2dcfd7e7e24b1ca76c1193f645902b, 'message');$v8e2dcfd7e7e24b1ca76c1193f645902b->topics_count = $this->calculateCount($v8e2dcfd7e7e24b1ca76c1193f645902b, 'topic');$v8e2dcfd7e7e24b1ca76c1193f645902b->last_message = $this->calculateLastMessageId($v8e2dcfd7e7e24b1ca76c1193f645902b);$v8e2dcfd7e7e24b1ca76c1193f645902b->commit();break;case 'topic':     $v8e2dcfd7e7e24b1ca76c1193f645902b->messages_count = $this->calculateCount($v8e2dcfd7e7e24b1ca76c1193f645902b, 'message');$v8e2dcfd7e7e24b1ca76c1193f645902b->last_message = $this->calculateLastMessageId($v8e2dcfd7e7e24b1ca76c1193f645902b);$v8e2dcfd7e7e24b1ca76c1193f645902b->commit();$this->recalcCounts($v8e2dcfd7e7e24b1ca76c1193f645902b);break;}}public function calculateCount(iUmiHierarchyElement $v8e2dcfd7e7e24b1ca76c1193f645902b, $v84aa805a9d919179ab8f8b24376e2ed7) {$vc9e9a848920877e76685b2e4e76de38d = ($v84aa805a9d919179ab8f8b24376e2ed7 == 'message' && $v8e2dcfd7e7e24b1ca76c1193f645902b->getMethod() == 'conf') ? 2 : 1;$v8be74552df93e31bbdd6b36ed74bdb6a = new selector('pages');$v8be74552df93e31bbdd6b36ed74bdb6a->types('hierarchy-type')->name('forum', $v84aa805a9d919179ab8f8b24376e2ed7);$v8be74552df93e31bbdd6b36ed74bdb6a->where('hierarchy')->page($v8e2dcfd7e7e24b1ca76c1193f645902b->id)->childs($vc9e9a848920877e76685b2e4e76de38d);return $v8be74552df93e31bbdd6b36ed74bdb6a->length;}public function calculateLastMessageId(iUmiHierarchyElement $v8e2dcfd7e7e24b1ca76c1193f645902b) {$v8be74552df93e31bbdd6b36ed74bdb6a = new selector('pages');$v8be74552df93e31bbdd6b36ed74bdb6a->types('hierarchy-type')->name('forum', 'message');$v8be74552df93e31bbdd6b36ed74bdb6a->order('publish_time')->desc();$v8be74552df93e31bbdd6b36ed74bdb6a->limit(0, 1);if($v8e2dcfd7e7e24b1ca76c1193f645902b->getMethod() == 'conf') {$v84f218c1723d824adcefea5bf3bfb369 = new selector('pages');$v84f218c1723d824adcefea5bf3bfb369->types('hierarchy-type')->name('forum', 'topic');$v84f218c1723d824adcefea5bf3bfb369->where('hierarchy')->page($v8e2dcfd7e7e24b1ca76c1193f645902b->id)->childs(1);$v84f218c1723d824adcefea5bf3bfb369->order('last_post_time')->desc();$v84f218c1723d824adcefea5bf3bfb369->limit(0, 1);if($v84f218c1723d824adcefea5bf3bfb369->first) {$v8be74552df93e31bbdd6b36ed74bdb6a->where('hierarchy')->page($v84f218c1723d824adcefea5bf3bfb369->first->id)->childs(1);}else {return null;}}else {$v8be74552df93e31bbdd6b36ed74bdb6a->where('hierarchy')->page($v8e2dcfd7e7e24b1ca76c1193f645902b->id)->childs(1);}return $v8be74552df93e31bbdd6b36ed74bdb6a->first;}}?>