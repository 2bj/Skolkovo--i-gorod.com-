<?php
class vote extends def_module {public function __construct() {parent::__construct();if(cmsController::getInstance()->getCurrentMode() == "admin") {$this->__loadLib("__admin.php");$this->__implement("__vote");}else {$this->__loadLib("__rate.php");$this->__implement("__rate_vote");$this->__loadLib("__custom.php");$this->__implement("__custom_vote");}$this->__loadLib("__events_handlers.php");$this->__implement("__eventsHandlers");$this->is_private = intval(regedit::getInstance()->getVal("//modules/vote/is_private"));}public function poll($vd6fe1d0be6347b8ef2427fa629c04485 = "", $v66f6181bcb4cff4cd38fbc804a036db6 = "default") {if($this->breakMe()) return;$v7057e8409c7c531a1a6e9ac3df4ed549 = $this->analyzeRequiredPath($vd6fe1d0be6347b8ef2427fa629c04485);$v8e2dcfd7e7e24b1ca76c1193f645902b = umiHierarchy::getInstance()->getElement($v7057e8409c7c531a1a6e9ac3df4ed549);if(!$v8e2dcfd7e7e24b1ca76c1193f645902b) return "";if($this->checkIsVoted($v8e2dcfd7e7e24b1ca76c1193f645902b->getObject()->getId())||$v8e2dcfd7e7e24b1ca76c1193f645902b->getValue('is_closed')) {return $this->results($v7057e8409c7c531a1a6e9ac3df4ed549, $v66f6181bcb4cff4cd38fbc804a036db6);}else {return $this->insertvote($v7057e8409c7c531a1a6e9ac3df4ed549, $v66f6181bcb4cff4cd38fbc804a036db6);}}public function insertvote($vd6fe1d0be6347b8ef2427fa629c04485 = "", $v66f6181bcb4cff4cd38fbc804a036db6 = "default") {if($this->breakMe()) return;list($v364f9b183bd2dd9e0beb45c754830a6c, $vb1c0ed8b2e25638833f73a19e1954309, $v7a5cf2bf5a519dcdbcca4513449d8d15) = def_module::loadTemplates("tpls/vote/{$v66f6181bcb4cff4cd38fbc804a036db6}.tpl", "vote_block", "vote_block_line", "vote_block_submit");$vb81ca7c0ccaa77e7aa91936ab0070695 = umiHierarchy::getInstance();$v5891da2d64975cae48d175d1e001f5da = umiObjectsCollection::getInstance();$v7552cd149af7495ee7d8225974e50f80 = $this->analyzeRequiredPath($vd6fe1d0be6347b8ef2427fa629c04485);$v8e2dcfd7e7e24b1ca76c1193f645902b = $vb81ca7c0ccaa77e7aa91936ab0070695->getElement($v7552cd149af7495ee7d8225974e50f80);if(!$v8e2dcfd7e7e24b1ca76c1193f645902b) {throw new publicException(getLabel('error-page-does-not-exist', null, $vd6fe1d0be6347b8ef2427fa629c04485));}$vfca1bff8ad8b3a8585abfb0ad523ba42 = array(   'id' => $v7552cd149af7495ee7d8225974e50f80,   'text' => $v8e2dcfd7e7e24b1ca76c1193f645902b->question  );$result = $v8e2dcfd7e7e24b1ca76c1193f645902b->answers;if(!is_array($result)) $result = array();$v980da98409d058c365664ff7ea33dd6b = array();foreach($result as $v82bfda7962fd12f51163ae45886c4c62) {$v447b7147e84be512208dcc0995d67ebc = $v5891da2d64975cae48d175d1e001f5da->getObject($v82bfda7962fd12f51163ae45886c4c62);$v69ba0c89abba8a3e9cc0c5e32be0d35d = array();$v69ba0c89abba8a3e9cc0c5e32be0d35d['attribute:id'] = $v69ba0c89abba8a3e9cc0c5e32be0d35d['void:item_id'] = $v82bfda7962fd12f51163ae45886c4c62;$v69ba0c89abba8a3e9cc0c5e32be0d35d['node:item_name'] = $v447b7147e84be512208dcc0995d67ebc->name;$v980da98409d058c365664ff7ea33dd6b[] = self::parseTemplate($vb1c0ed8b2e25638833f73a19e1954309, $v69ba0c89abba8a3e9cc0c5e32be0d35d, false, $v82bfda7962fd12f51163ae45886c4c62);}$v8da26ba680a4bc49270f115861546f0e = (bool) $v8e2dcfd7e7e24b1ca76c1193f645902b->getValue("is_closed");$vfca1bff8ad8b3a8585abfb0ad523ba42['submit'] = ($v8da26ba680a4bc49270f115861546f0e) ? "" : $v7a5cf2bf5a519dcdbcca4513449d8d15;$vfca1bff8ad8b3a8585abfb0ad523ba42['subnodes:items'] = $vfca1bff8ad8b3a8585abfb0ad523ba42['void:lines'] = $v980da98409d058c365664ff7ea33dd6b;$vfca1bff8ad8b3a8585abfb0ad523ba42['link'] = $v8e2dcfd7e7e24b1ca76c1193f645902b->link;return self::parseTemplate($v364f9b183bd2dd9e0beb45c754830a6c, $vfca1bff8ad8b3a8585abfb0ad523ba42, $v7552cd149af7495ee7d8225974e50f80);}public function results($vd6fe1d0be6347b8ef2427fa629c04485, $v66f6181bcb4cff4cd38fbc804a036db6 = "default") {if($this->breakMe()) return;if(!$v66f6181bcb4cff4cd38fbc804a036db6) $v66f6181bcb4cff4cd38fbc804a036db6 = "default";list($v364f9b183bd2dd9e0beb45c754830a6c, $vb1c0ed8b2e25638833f73a19e1954309) = def_module::loadTemplates("tpls/vote/{$v66f6181bcb4cff4cd38fbc804a036db6}.tpl", "result_block", "result_block_line");$v7057e8409c7c531a1a6e9ac3df4ed549 = $this->analyzeRequiredPath($vd6fe1d0be6347b8ef2427fa629c04485);$v8e2dcfd7e7e24b1ca76c1193f645902b = umiHierarchy::getInstance()->getElement($v7057e8409c7c531a1a6e9ac3df4ed549);if(!$v8e2dcfd7e7e24b1ca76c1193f645902b) return false;$vfca1bff8ad8b3a8585abfb0ad523ba42 = Array();$vfca1bff8ad8b3a8585abfb0ad523ba42['id']          = $v7057e8409c7c531a1a6e9ac3df4ed549;$vfca1bff8ad8b3a8585abfb0ad523ba42['text']        = $v8e2dcfd7e7e24b1ca76c1193f645902b->getValue("question");$vfca1bff8ad8b3a8585abfb0ad523ba42['vote_header'] = $v8e2dcfd7e7e24b1ca76c1193f645902b->getValue("h1");$vfca1bff8ad8b3a8585abfb0ad523ba42['alt_name']    = $v8e2dcfd7e7e24b1ca76c1193f645902b->getAltName();$result                   = $v8e2dcfd7e7e24b1ca76c1193f645902b->getValue('answers');$v691d502cfd0e0626cd3b058e5682ad1c = Array();$vfbb44b4487415b134bce9c790a27fe5e = 0;foreach($result as $v82bfda7962fd12f51163ae45886c4c62) {$v447b7147e84be512208dcc0995d67ebc = umiObjectsCollection::getInstance()->getObject($v82bfda7962fd12f51163ae45886c4c62);$vfbb44b4487415b134bce9c790a27fe5e += (int) $v447b7147e84be512208dcc0995d67ebc->getPropByName("count")->getValue();$v691d502cfd0e0626cd3b058e5682ad1c[] = $v447b7147e84be512208dcc0995d67ebc;}$v980da98409d058c365664ff7ea33dd6b = Array();foreach($v691d502cfd0e0626cd3b058e5682ad1c as $v447b7147e84be512208dcc0995d67ebc) {$v69ba0c89abba8a3e9cc0c5e32be0d35d = Array();$v69ba0c89abba8a3e9cc0c5e32be0d35d['node:item_name'] = $v447b7147e84be512208dcc0995d67ebc->getName();$v69ba0c89abba8a3e9cc0c5e32be0d35d['attribute:score'] = $v69ba0c89abba8a3e9cc0c5e32be0d35d['void:item_result'] = $v4a8a08f09d37b73795649038408b5f33 = (int) $v447b7147e84be512208dcc0995d67ebc->getValue("count");$vc7aaeb58cde352ed5cf7465950555931 = ($vfbb44b4487415b134bce9c790a27fe5e > 0) ? round((100 * $v4a8a08f09d37b73795649038408b5f33) / $vfbb44b4487415b134bce9c790a27fe5e) : 0;$v69ba0c89abba8a3e9cc0c5e32be0d35d['attribute:score-rel'] = $v69ba0c89abba8a3e9cc0c5e32be0d35d['void:item_result_proc'] = $vc7aaeb58cde352ed5cf7465950555931;$v69ba0c89abba8a3e9cc0c5e32be0d35d['void:item_result_proc_reverce'] = 100 - $vc7aaeb58cde352ed5cf7465950555931;$v980da98409d058c365664ff7ea33dd6b[] = self::parseTemplate($vb1c0ed8b2e25638833f73a19e1954309, $v69ba0c89abba8a3e9cc0c5e32be0d35d, false, $v447b7147e84be512208dcc0995d67ebc->getId());}$vfca1bff8ad8b3a8585abfb0ad523ba42['subnodes:items'] = $vfca1bff8ad8b3a8585abfb0ad523ba42['void:lines'] = $v980da98409d058c365664ff7ea33dd6b;$vfca1bff8ad8b3a8585abfb0ad523ba42['total_posts'] = $vfbb44b4487415b134bce9c790a27fe5e;$vfca1bff8ad8b3a8585abfb0ad523ba42['link'] = umiHierarchy::getInstance()->getPathById($v7057e8409c7c531a1a6e9ac3df4ed549);return self::parseTemplate($v364f9b183bd2dd9e0beb45c754830a6c, $vfca1bff8ad8b3a8585abfb0ad523ba42, $v7057e8409c7c531a1a6e9ac3df4ed549);}public function post($v66f6181bcb4cff4cd38fbc804a036db6 = "default") {if(!$v66f6181bcb4cff4cd38fbc804a036db6) $v66f6181bcb4cff4cd38fbc804a036db6 = getRequest('template');if(!$v66f6181bcb4cff4cd38fbc804a036db6) $v66f6181bcb4cff4cd38fbc804a036db6 = "default";xslTemplater::getInstance()->setIsInited(false);list($v364f9b183bd2dd9e0beb45c754830a6c, $vefd50533bf75fdf49ff5f30b48ad73b1, $v95923212530daac06bfaeeb0d13b9ce3, $vaf3a9932c3881dfc62fff2c6f5130478) = def_module::loadTemplates("tpls/vote/{$v66f6181bcb4cff4cd38fbc804a036db6}.tpl", "js_block", "js_block_voted", "js_block_closed", "js_block_ok");$v82bfda7962fd12f51163ae45886c4c62 = (int) getRequest('param0');$v447b7147e84be512208dcc0995d67ebc = umiObjectsCollection::getInstance()->getObject($v82bfda7962fd12f51163ae45886c4c62);$v0504d6cf3ce18fceaa8907884de4715f = $v447b7147e84be512208dcc0995d67ebc->getPropByName("poll_rel")->getValue();$vaf31437ce61345f416579830a98c91e5 = $v0504d6cf3ce18fceaa8907884de4715f;$va8cfde6331bd59eb2ac96f8911c4b666 = umiObjectsCollection::getInstance()->getObject($vaf31437ce61345f416579830a98c91e5);if($this->checkIsVoted($vaf31437ce61345f416579830a98c91e5)) {$v9b207167e5381c47682c6b4f58a623fb = ($vefd50533bf75fdf49ff5f30b48ad73b1) ? $vefd50533bf75fdf49ff5f30b48ad73b1 : "Вы уже проголосовали";}else {if($va8cfde6331bd59eb2ac96f8911c4b666->getValue("is_closed")) {$v9b207167e5381c47682c6b4f58a623fb = ($v95923212530daac06bfaeeb0d13b9ce3) ? $v95923212530daac06bfaeeb0d13b9ce3 : "Ошибка. Голосование не активно, либо закрыто.";}else {$ve2942a04780e223b215eb8b663cf5353 = $v447b7147e84be512208dcc0995d67ebc->getValue("count");$v447b7147e84be512208dcc0995d67ebc->setValue("count", ++$ve2942a04780e223b215eb8b663cf5353);$v447b7147e84be512208dcc0995d67ebc->setValue("poll_rel", $v0504d6cf3ce18fceaa8907884de4715f);$v447b7147e84be512208dcc0995d67ebc->commit();if ($this->is_private) {$v186ba0d5990f6e43e7ad46f0dbaa47fb = cmsController::getInstance()->getModule("users");if ($v186ba0d5990f6e43e7ad46f0dbaa47fb) {$v9fe0bb93b257b012f0c9427fb1d48ffd = umiObjectsCollection::getInstance()->getObject($v186ba0d5990f6e43e7ad46f0dbaa47fb->user_id);if ($v9fe0bb93b257b012f0c9427fb1d48ffd instanceof umiObject) {$v89cc48bebd35732ad6dc42be1ae88d5a = $v9fe0bb93b257b012f0c9427fb1d48ffd->getValue("rated_pages");$v02ad9f1c295c8794f1e42c9969dea74a = array();foreach ($v89cc48bebd35732ad6dc42be1ae88d5a as $ve0c750ab2ba65ff988478860712c5ff2) {if ($ve0c750ab2ba65ff988478860712c5ff2 instanceof umiHierarchyElement) {$v02ad9f1c295c8794f1e42c9969dea74a[] = intval($ve0c750ab2ba65ff988478860712c5ff2->getId());}else {$v02ad9f1c295c8794f1e42c9969dea74a[] = intval($ve0c750ab2ba65ff988478860712c5ff2);}}$v9bf2596c434c16a863cbc68d717b2867 = umiHierarchy::getInstance()->getObjectInstances($vaf31437ce61345f416579830a98c91e5);$v9bf2596c434c16a863cbc68d717b2867 = array_map("intval", $v9bf2596c434c16a863cbc68d717b2867);$vd4ad5940b8c4e12a022962ad624920aa = array_merge($v02ad9f1c295c8794f1e42c9969dea74a, $v9bf2596c434c16a863cbc68d717b2867);$v9fe0bb93b257b012f0c9427fb1d48ffd->setValue("rated_pages", array_unique($vd4ad5940b8c4e12a022962ad624920aa));$v9fe0bb93b257b012f0c9427fb1d48ffd->commit();}}}$v9b207167e5381c47682c6b4f58a623fb = ($vaf3a9932c3881dfc62fff2c6f5130478) ? $vaf3a9932c3881dfc62fff2c6f5130478 : "Ваше мнение учтено";}if(!isset($_SESSION['vote_polled']) || !is_array($_SESSION['vote_polled'])) {$_SESSION['vote_polled'] = Array();}}$_SESSION['vote_polled'][] = $vaf31437ce61345f416579830a98c91e5;$v9b207167e5381c47682c6b4f58a623fb = templater::getInstance()->putLangs($v9b207167e5381c47682c6b4f58a623fb);if($v364f9b183bd2dd9e0beb45c754830a6c) {$vfca1bff8ad8b3a8585abfb0ad523ba42 = Array();$vfca1bff8ad8b3a8585abfb0ad523ba42['res'] = $v9b207167e5381c47682c6b4f58a623fb;$v4b43b0aee35624cd95b910189b3dc231 = $this->parseTemplate($v364f9b183bd2dd9e0beb45c754830a6c, $vfca1bff8ad8b3a8585abfb0ad523ba42);$this->flush($v4b43b0aee35624cd95b910189b3dc231, "text/javascript");}else {$this->flush("alert('{$v9b207167e5381c47682c6b4f58a623fb}');", "text/javascript");}}private function checkIsVoted($vaf31437ce61345f416579830a98c91e5) {$v23ce198eb49bd779e3fe13c5a792de7d = getSession('vote_polled');if ($this->is_private) {$v186ba0d5990f6e43e7ad46f0dbaa47fb = cmsController::getInstance()->getModule("users");if ($v186ba0d5990f6e43e7ad46f0dbaa47fb) {$v9fe0bb93b257b012f0c9427fb1d48ffd = umiObjectsCollection::getInstance()->getObject($v186ba0d5990f6e43e7ad46f0dbaa47fb->user_id);if ($v9fe0bb93b257b012f0c9427fb1d48ffd instanceof umiObject) {$v89cc48bebd35732ad6dc42be1ae88d5a = $v9fe0bb93b257b012f0c9427fb1d48ffd->getValue("rated_pages");$v02ad9f1c295c8794f1e42c9969dea74a = array();foreach ($v89cc48bebd35732ad6dc42be1ae88d5a as $ve0c750ab2ba65ff988478860712c5ff2) {if ($ve0c750ab2ba65ff988478860712c5ff2 instanceof umiHierarchyElement) {$v02ad9f1c295c8794f1e42c9969dea74a[] = intval($ve0c750ab2ba65ff988478860712c5ff2->getId());}else {$v02ad9f1c295c8794f1e42c9969dea74a[] = intval($ve0c750ab2ba65ff988478860712c5ff2);}}$v9bf2596c434c16a863cbc68d717b2867 = umiHierarchy::getInstance()->getObjectInstances($vaf31437ce61345f416579830a98c91e5);$v89cc48bebd35732ad6dc42be1ae88d5a = array_map("intval", $v89cc48bebd35732ad6dc42be1ae88d5a);$v9bf2596c434c16a863cbc68d717b2867 = array_map("intval", $v9bf2596c434c16a863cbc68d717b2867);$v69d117aa67d34a9c64327817f0c9a3dc = array_intersect($v9bf2596c434c16a863cbc68d717b2867, $v02ad9f1c295c8794f1e42c9969dea74a);return (bool) count($v69d117aa67d34a9c64327817f0c9a3dc);}}}if(is_array($v23ce198eb49bd779e3fe13c5a792de7d)) {return in_array($vaf31437ce61345f416579830a98c91e5, $v23ce198eb49bd779e3fe13c5a792de7d);}else {return false;}}public function insertlast($v66f6181bcb4cff4cd38fbc804a036db6 = "default") {if(!$v66f6181bcb4cff4cd38fbc804a036db6) $v66f6181bcb4cff4cd38fbc804a036db6 = "default";$v94757cae63fd3e398c0811a976dd6bbe = umiObjectTypesCollection::getInstance()->getBaseType("vote", "poll");$v599dcce2998a6b40b1e38e8c6006cb0a = umiObjectTypesCollection::getInstance()->getType($v94757cae63fd3e398c0811a976dd6bbe);$v85b2deee74c0798cd7fc9760a3c12e20 = $v599dcce2998a6b40b1e38e8c6006cb0a->getFieldId("publish_time");$v0715f6d9497f93911417c9c324265771 = umiHierarchyTypesCollection::getInstance()->getTypeByName("vote", "poll")->getId();$v8be74552df93e31bbdd6b36ed74bdb6a = new umiSelection();$v8be74552df93e31bbdd6b36ed74bdb6a->setHierarchyFilter();$v8be74552df93e31bbdd6b36ed74bdb6a->addElementType($v0715f6d9497f93911417c9c324265771);$v8be74552df93e31bbdd6b36ed74bdb6a->setLimitFilter();$v8be74552df93e31bbdd6b36ed74bdb6a->addLimit(1);$v8be74552df93e31bbdd6b36ed74bdb6a->setOrderFilter();$v8be74552df93e31bbdd6b36ed74bdb6a->setOrderByProperty($v85b2deee74c0798cd7fc9760a3c12e20, false);$v8be74552df93e31bbdd6b36ed74bdb6a->addPermissions();$v8be74552df93e31bbdd6b36ed74bdb6a->forceHierarchyTable();$result = umiSelectionsParser::runSelection($v8be74552df93e31bbdd6b36ed74bdb6a);if(sizeof($result)) {list($v7057e8409c7c531a1a6e9ac3df4ed549) = $result;}else {$v7057e8409c7c531a1a6e9ac3df4ed549 = false;}if($v7057e8409c7c531a1a6e9ac3df4ed549) {return $this->poll($v7057e8409c7c531a1a6e9ac3df4ed549, $v66f6181bcb4cff4cd38fbc804a036db6);}}public function config() {return __vote::config();}};?>
