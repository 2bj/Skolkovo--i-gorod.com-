<?php
 abstract class __exchange_auto {protected function saveIncomingFile() {$v3090ad88ff7c9ca191579b709069fe64 = getRequest('filename');$v7f2db423a49b305459147332fb01cf87 = outputBuffer::current('HTTPOutputBuffer');$v9a0364b9e99bb480dd25e1f0284c8555 = $v7f2db423a49b305459147332fb01cf87->getHTTPRequestBody();if (!strlen($v3090ad88ff7c9ca191579b709069fe64)) return "failure\nEmpty filename.";list($v564d2b9af333438eae1e54afd64dfd91, , $v566bbee0f961ad71b54c3c2fd36db053) = array_values(pathinfo($v3090ad88ff7c9ca191579b709069fe64));if (!strlen($v566bbee0f961ad71b54c3c2fd36db053)) return "failure\nUnknown file type.";$vaf18a48c389c1fbf844dc3a7e7661ec1 = substr($v3090ad88ff7c9ca191579b709069fe64, 0, strlen($v3090ad88ff7c9ca191579b709069fe64) - strlen($v566bbee0f961ad71b54c3c2fd36db053) - 1);$v857a5246dff0c3c79e476b004684f6d3 = "./sys-temp/1c_import/";if (!is_dir($v857a5246dff0c3c79e476b004684f6d3)) mkdir($v857a5246dff0c3c79e476b004684f6d3, 0777, true);if (strtolower($v566bbee0f961ad71b54c3c2fd36db053) == "xml") {file_put_contents($v857a5246dff0c3c79e476b004684f6d3 . $vaf18a48c389c1fbf844dc3a7e7661ec1 . "." . $v566bbee0f961ad71b54c3c2fd36db053, $v9a0364b9e99bb480dd25e1f0284c8555, FILE_APPEND);}else {$v1e295790d15933b531ffecb905536d24 = "./images/cms/data/" . $v564d2b9af333438eae1e54afd64dfd91 . "/";if (!is_dir($v1e295790d15933b531ffecb905536d24)) mkdir($v1e295790d15933b531ffecb905536d24, 0777, true);file_put_contents("./images/cms/data/" . $v3090ad88ff7c9ca191579b709069fe64, $v9a0364b9e99bb480dd25e1f0284c8555);}return "success";}protected function importCommerceML() {$v3090ad88ff7c9ca191579b709069fe64 = getRequest('filename');$v97fd815a3803a0588876bdd862014fed = "./sys-temp/1c_import/" . $v3090ad88ff7c9ca191579b709069fe64;if (!is_file($v97fd815a3803a0588876bdd862014fed)) return "failure\nFile $v97fd815a3803a0588876bdd862014fed not exists.";$vd329d4f3c7be72761631509333155d22 = (int) getSession("1c_import_offset");$ved8430dc53fe9c99911b7c85e45aa6a2 = umiImportSplitter::get("commerceML2");$ved8430dc53fe9c99911b7c85e45aa6a2->load($v97fd815a3803a0588876bdd862014fed, 25, $vd329d4f3c7be72761631509333155d22);$v9a09b4dfda82e3e665e31092d1c3ec8d = $ved8430dc53fe9c99911b7c85e45aa6a2->getDocument();$v0f635d0e0f3874fff8b581c132e6c7a7 = $ved8430dc53fe9c99911b7c85e45aa6a2->translate($v9a09b4dfda82e3e665e31092d1c3ec8d);$v1bc49dba86c5074c5266c6d38c301a46 = new xmlImporter();$v1bc49dba86c5074c5266c6d38c301a46->loadXmlString($v0f635d0e0f3874fff8b581c132e6c7a7);$v1bc49dba86c5074c5266c6d38c301a46->execute();$_SESSION['1c_import_offset'] = $ved8430dc53fe9c99911b7c85e45aa6a2->getOffset();if ($ved8430dc53fe9c99911b7c85e45aa6a2->getIsComplete()) {$_SESSION['1c_import_offset'] = 0;return "success\nComplete. Imported elements: " . $ved8430dc53fe9c99911b7c85e45aa6a2->getOffset();}return "progress\nImported elements: " . $ved8430dc53fe9c99911b7c85e45aa6a2->getOffset();}protected function exportOrders() {$ved780287e302ec3b9fd3c5e78771919f = umiExporter::get("ordersCommerceML");$ved780287e302ec3b9fd3c5e78771919f->setOutputBuffer();$result = $ved780287e302ec3b9fd3c5e78771919f->export(array());return $result;}protected function markExportedOrders() {$v8be74552df93e31bbdd6b36ed74bdb6a = new selector('objects');$v8be74552df93e31bbdd6b36ed74bdb6a->types('object-type')->name('emarket', 'order');$v8be74552df93e31bbdd6b36ed74bdb6a->where('need_export')->equals(1);$v12c500ed0b7879105fb46af0f246be87 = $v8be74552df93e31bbdd6b36ed74bdb6a->result;foreach ($v12c500ed0b7879105fb46af0f246be87 as $v70a17ffa722a3985b86d30b034ad06d7) {$v70a17ffa722a3985b86d30b034ad06d7->need_export = 0;}return "success";}protected function importOrders() {self::saveIncomingFile();$v3090ad88ff7c9ca191579b709069fe64 = getRequest('filename');$v97fd815a3803a0588876bdd862014fed = "./sys-temp/1c_import/" . $v3090ad88ff7c9ca191579b709069fe64;if (!is_file($v97fd815a3803a0588876bdd862014fed)) return "failure\nFile $v97fd815a3803a0588876bdd862014fed not exists.";$ved8430dc53fe9c99911b7c85e45aa6a2 = umiImportSplitter::get("commerceML2");$ved8430dc53fe9c99911b7c85e45aa6a2->load($v97fd815a3803a0588876bdd862014fed);$v9a09b4dfda82e3e665e31092d1c3ec8d = $ved8430dc53fe9c99911b7c85e45aa6a2->getDocument();$v0f635d0e0f3874fff8b581c132e6c7a7 = $ved8430dc53fe9c99911b7c85e45aa6a2->translate($v9a09b4dfda82e3e665e31092d1c3ec8d);$v1bc49dba86c5074c5266c6d38c301a46 = new xmlImporter();$v1bc49dba86c5074c5266c6d38c301a46->loadXmlString($v0f635d0e0f3874fff8b581c132e6c7a7);$v1bc49dba86c5074c5266c6d38c301a46->execute();return "success";}public function auto() {$v7f2db423a49b305459147332fb01cf87 = outputBuffer::current('HTTPOutputBuffer');$v7f2db423a49b305459147332fb01cf87->charset('utf-8');$v7f2db423a49b305459147332fb01cf87->contentType('text/plain');$v599dcce2998a6b40b1e38e8c6006cb0a = getRequest("type");$v15d61712450a686a7f365adf4fef581f = getRequest("mode");if (!permissionsCollection::getInstance()->isSv()) {$v7f2db423a49b305459147332fb01cf87->push("failure\nNot authorized as supervisor.");$v7f2db423a49b305459147332fb01cf87->end();exit();}switch($v599dcce2998a6b40b1e38e8c6006cb0a . "-" . $v15d61712450a686a7f365adf4fef581f) {case "catalog-checkauth":     removeDirectory("./sys-temp/1c_import/");case "sale-checkauth": {$v7f2db423a49b305459147332fb01cf87->push("success\nPHPSESSID\n" . session_id());}break;case "catalog-init":    case "sale-init": {removeDirectory("./sys-temp/1c_import/");$v7f2db423a49b305459147332fb01cf87->push("zip=no\nfile_limit=102400");}break;case "catalog-file": {$v7f2db423a49b305459147332fb01cf87->push(self::saveIncomingFile());}break;case "catalog-import" : {$v7f2db423a49b305459147332fb01cf87->push(self::importCommerceML());}break;case "sale-query" : {$v7f2db423a49b305459147332fb01cf87->push(self::exportOrders());}break;case "sale-success" : {$v7f2db423a49b305459147332fb01cf87->push(self::markExportedOrders());}break;case "sale-file" : {$v7f2db423a49b305459147332fb01cf87->push(self::importOrders());}break;default:     $v7f2db423a49b305459147332fb01cf87->push("failure\nUnknown import type ($v599dcce2998a6b40b1e38e8c6006cb0a) or mode ($v15d61712450a686a7f365adf4fef581f).");}$v7f2db423a49b305459147332fb01cf87->end();}}?>