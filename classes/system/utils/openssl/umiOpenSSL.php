<?php
 class umiOpenSSL implements iUmiOpenSSL {protected $privateKeyFilePath = false,    $publicKeyFilePath = false,    $certificateFilePath = false,        $privateKey,    $publicKey;public  $dn = Array( "countryName" => 'RU',      "stateOrProvinceName" => 'none',      "localityName" => 'Saint-Petersburg',      "organizationName" => 'MySelf',      "organizationalUnitName" => 'Whatever',      "commonName" => 'mySelf',      "emailAddress" => 'user@domain.com');public function __construct() {if(function_exists('openssl_pkey_new') == false) {throw new publicAdminException("No openSSL extenstion");}}public function setPrivateKeyFilePath($v3edcf4274a4c94269f9123499d7c9ba6) {if($this->checkFilePath($v3edcf4274a4c94269f9123499d7c9ba6)) {$this->privateKeyFilePath = $v3edcf4274a4c94269f9123499d7c9ba6;return true;}else {throw new coreException("No file {$v3edcf4274a4c94269f9123499d7c9ba6}");return false;}}public function getPrivateKeyFilePath() {return $this->privateKeyFilePath;}public function setPublicKeyFilePath($v3edcf4274a4c94269f9123499d7c9ba6) {if($this->checkFilePath($v3edcf4274a4c94269f9123499d7c9ba6)) {$this->publicKeyFilePath = $v3edcf4274a4c94269f9123499d7c9ba6;return true;}else {throw new coreException("No file {$v3edcf4274a4c94269f9123499d7c9ba6}");return false;}}public function getPublicKeyFilePath() {return $this->publicKeyFilePath;}public function setCertificateFilePath($v47826cacc65c665212b821e6ff80b9b0) {if($this->checkFilePath($v47826cacc65c665212b821e6ff80b9b0)) {$this->certificateFilePath = $v47826cacc65c665212b821e6ff80b9b0;return true;}else {throw new coreException("No file {$v47826cacc65c665212b821e6ff80b9b0}");return false;}}public function getCertificateFilePath() {return $this->certificateFilePath;}public function loadSettingsFromRegedit() {$vb1444fb0c07653567ad325aa25d4e37a = regedit::getInstance();$v4a11fbb0c88341975a76f1dc4b658304 = $vb1444fb0c07653567ad325aa25d4e37a->getVal("//settings/openssl_private_key");$v3401a69ed2a320ee10fa5bc0a6fa1395 = $vb1444fb0c07653567ad325aa25d4e37a->getVal("//settings/openssl_public_key");$v9f735923585d489d8baaf23faba610bc = false;try {$v9f735923585d489d8baaf23faba610bc = ($this->setPrivateKeyFilePath($v4a11fbb0c88341975a76f1dc4b658304) && $this->setPublicKeyFilePath($v3401a69ed2a320ee10fa5bc0a6fa1395));}catch (coreException $ve1671797c52e15f763380b45e841ec32) {}return $v9f735923585d489d8baaf23faba610bc;}public function createPrivateKeyFile($v3edcf4274a4c94269f9123499d7c9ba6) {$this->privateKey = $v5ea63d3bc3e5afd2b8bd0605f68d9ce1 = openssl_pkey_new();openssl_pkey_export($v5ea63d3bc3e5afd2b8bd0605f68d9ce1, $v156a17333e77a3c504018cae5ada8c3b);$v954eef6d6eac59aca304b6d7abb4fb3e = dirname($v3edcf4274a4c94269f9123499d7c9ba6);if($this->checkFolderPath($v954eef6d6eac59aca304b6d7abb4fb3e, true)) {file_put_contents($v3edcf4274a4c94269f9123499d7c9ba6, $v156a17333e77a3c504018cae5ada8c3b);return $this->setPrivateKeyFilePath($v3edcf4274a4c94269f9123499d7c9ba6);}else {throw new coreException("Can't save private key file. Folder \"{$v954eef6d6eac59aca304b6d7abb4fb3e}\" is not writable.");}}public function createCertificateFile($v47826cacc65c665212b821e6ff80b9b0) {if($this->getPrivateKeyFilePath()) {$v328008858471c657239879e93eab77e2 = $this->getPrivateKey();$v1f8c50db95e9ead5645e32f8df5baa7b = openssl_csr_new($this->dn, $v328008858471c657239879e93eab77e2);$v0d2faad4cfcceb5381d65e733cab0635 = openssl_csr_sign($v1f8c50db95e9ead5645e32f8df5baa7b, null, $v328008858471c657239879e93eab77e2, 100);if(openssl_x509_export($v0d2faad4cfcceb5381d65e733cab0635, $vb6ba9fa6ea18201bf39ea635ecca9f13)) {file_put_contents($v47826cacc65c665212b821e6ff80b9b0, $vb6ba9fa6ea18201bf39ea635ecca9f13);$this->setCertificateFilePath($v47826cacc65c665212b821e6ff80b9b0);return true;}else {throw new coreException("Can't export x509 certificate");return false;}}else {throw new coreException("Private key requred");return false;}}public function createPublicKeyFile($v47826cacc65c665212b821e6ff80b9b0) {if($this->privateKeyFilePath && $this->certificateFilePath) {$vc36853ea059e0d71a67557e5ee54b835 = $this->getPublicKey();$ve4e982efdb477cef1e07996a1cac0a61 = openssl_pkey_get_details($vc36853ea059e0d71a67557e5ee54b835);$v8bda0de4dccede40c15833bf26ec8fb8 = $ve4e982efdb477cef1e07996a1cac0a61['key'];file_put_contents($v47826cacc65c665212b821e6ff80b9b0, $v8bda0de4dccede40c15833bf26ec8fb8);return true;}else {throw new coreException("Private key and certificate required");return false;}}public function encrypt($v8d777f385d3dfec8815d20f7496026dc, $vc68271a63ddbc431c307beb7d2918275 = true) {if($vc68271a63ddbc431c307beb7d2918275) {$v06254869b9374e7900af74555c87ad99 = "getPrivateKey";$v7a27564737def226c26245eaac37d9a1 = "openssl_private_encrypt";}else {$v06254869b9374e7900af74555c87ad99 = "getPublicKey";$v7a27564737def226c26245eaac37d9a1 = "openssl_public_encrypt";}if($v3c6e0b8a9c15224a8228b9a98ca1531d = $this->$v06254869b9374e7900af74555c87ad99()) {$v7a27564737def226c26245eaac37d9a1($v8d777f385d3dfec8815d20f7496026dc, $result, $v3c6e0b8a9c15224a8228b9a98ca1531d);return $result;}else {throw new coreException("Unnable to load key");}}public function decrypt($v41bb118a714b344c24603304cf716c96, $vc68271a63ddbc431c307beb7d2918275 = true) {if($vc68271a63ddbc431c307beb7d2918275) {$v06254869b9374e7900af74555c87ad99 = "getPublicKey";$v03fa9edf5f37da3d359df4095d4d2aef = "openssl_public_decrypt";}else {$v06254869b9374e7900af74555c87ad99 = "getPrivateKey";$v03fa9edf5f37da3d359df4095d4d2aef = "openssl_private_decrypt";}if($v3c6e0b8a9c15224a8228b9a98ca1531d = $this->$v06254869b9374e7900af74555c87ad99()) {$v03fa9edf5f37da3d359df4095d4d2aef($v41bb118a714b344c24603304cf716c96, $result, $v3c6e0b8a9c15224a8228b9a98ca1531d);return $result;}else {throw new coreException("Unnable to load key");}}private function getPrivateKey() {if($this->privateKey) {return $this->privateKey;}else {$v3edcf4274a4c94269f9123499d7c9ba6 = "file://" . $this->getPrivateKeyFilePath();return $this->privateKey = openssl_pkey_get_private($v3edcf4274a4c94269f9123499d7c9ba6);}}private function getPublicKey() {if($this->publicKey) {return $this->publicKey;}else {if($this->publicKeyFilePath) {$v3401a69ed2a320ee10fa5bc0a6fa1395 = $this->getPublicKeyFilePath();return $this->publicKey = openssl_pkey_get_public(file_get_contents($v3401a69ed2a320ee10fa5bc0a6fa1395));}if($this->certificateFilePath) {$v31e9771ba0f30676b686ec1ea309954b = $this->getCertificateFilePath();return $this->publicKey = openssl_pkey_get_public(file_get_contents($v31e9771ba0f30676b686ec1ea309954b));}throw new coreException("Can't get public key.");return false;}}private function checkFileOrFolderPath($v47826cacc65c665212b821e6ff80b9b0, $vd8851ee7ff3a6ceffe23520401fa30f3 = false) {if(is_readable($v47826cacc65c665212b821e6ff80b9b0)) {if($vd8851ee7ff3a6ceffe23520401fa30f3) {if(is_writable($v47826cacc65c665212b821e6ff80b9b0)) {return true;}else {return false;}}else {return true;}}else {return false;}}private function checkFilePath($v47826cacc65c665212b821e6ff80b9b0, $vd8851ee7ff3a6ceffe23520401fa30f3 = false) {if(file_exists($v47826cacc65c665212b821e6ff80b9b0)) {return $this->checkFileOrFolderPath($v47826cacc65c665212b821e6ff80b9b0, $vd8851ee7ff3a6ceffe23520401fa30f3);}else {return false;}}private function checkFolderPath($v335e5656746940bfa10649e34be58887, $vd8851ee7ff3a6ceffe23520401fa30f3 = false) {if(is_dir($v335e5656746940bfa10649e34be58887)) {return $this->checkFileOrFolderPath($v335e5656746940bfa10649e34be58887, $vd8851ee7ff3a6ceffe23520401fa30f3);}else {return false;}}public function supplyDefaultKeyFiles() {$v9f735923585d489d8baaf23faba610bc = false;$v9f735923585d489d8baaf23faba610bc = $this->loadSettingsFromRegedit();if (!$v9f735923585d489d8baaf23faba610bc) {$vd48dea5a583bdcf4e59602469862f0b1 = $_SERVER['DOCUMENT_ROOT'].'/ssl';$v96dd9beb262852c82c7d6a65211780ca = @mkdir($vd48dea5a583bdcf4e59602469862f0b1);$vabf801691a3dbac4cfbf512c4f631ba5 = new umiDirectory($vd48dea5a583bdcf4e59602469862f0b1);if ($vabf801691a3dbac4cfbf512c4f631ba5 instanceof umiDirectory && !$vabf801691a3dbac4cfbf512c4f631ba5->getIsBroken()) {$v0329f9c3b5132d4a84f9cb582e0a9bc1 = false;$v47f6b58da1ad4b0b9ee14699f786a3b3 = $vd48dea5a583bdcf4e59602469862f0b1.'/'.uniqid('');$vda8db4130c73e043de1e28d921ac88f0 = false;$vc0e89e8a0bccf1d8404826d95479696b = $vd48dea5a583bdcf4e59602469862f0b1.'/'.uniqid('');$vab9a2aefae42c960ff04825ddb593024 = false;$v10f3c284f068198554f554eff91e77be = $vd48dea5a583bdcf4e59602469862f0b1.'/'.uniqid('');$v6da648158add0c53655351ff6ac29a12 = $this->createPrivateKeyFile($vc0e89e8a0bccf1d8404826d95479696b);if ($v6da648158add0c53655351ff6ac29a12) $vda8db4130c73e043de1e28d921ac88f0 = $this->setPrivateKeyFilePath($vc0e89e8a0bccf1d8404826d95479696b);if ($vda8db4130c73e043de1e28d921ac88f0) {$v6da648158add0c53655351ff6ac29a12 = $this->createCertificateFile($v47f6b58da1ad4b0b9ee14699f786a3b3);if ($v6da648158add0c53655351ff6ac29a12) $v0329f9c3b5132d4a84f9cb582e0a9bc1 = $this->setCertificateFilePath($v47f6b58da1ad4b0b9ee14699f786a3b3);}if ($v0329f9c3b5132d4a84f9cb582e0a9bc1) {$v6da648158add0c53655351ff6ac29a12 = $this->createPublicKeyFile($v10f3c284f068198554f554eff91e77be);if ($v6da648158add0c53655351ff6ac29a12) $vab9a2aefae42c960ff04825ddb593024 = $this->setPublicKeyFilePath($v10f3c284f068198554f554eff91e77be);}if ($vab9a2aefae42c960ff04825ddb593024) {$vb1444fb0c07653567ad325aa25d4e37a = regedit::getInstance();if ($vb1444fb0c07653567ad325aa25d4e37a instanceof regedit) {$v36605b97eda4fc867327f7fd9a219c6a = $vb1444fb0c07653567ad325aa25d4e37a->setVar("//settings/openssl_private_key", $vc0e89e8a0bccf1d8404826d95479696b);$va4a1cd1a45550d63e6b5c92811bf1b3b = $vb1444fb0c07653567ad325aa25d4e37a->setVar("//settings/openssl_public_key", $v10f3c284f068198554f554eff91e77be);$v9f735923585d489d8baaf23faba610bc = ($v36605b97eda4fc867327f7fd9a219c6a && $va4a1cd1a45550d63e6b5c92811bf1b3b);}}}}return $v9f735923585d489d8baaf23faba610bc;}};?>