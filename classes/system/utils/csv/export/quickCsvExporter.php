<?php
 interface iQuickCsvExporter {public function __construct(selector $v8be74552df93e31bbdd6b36ed74bdb6a);public function setResultsMode($vc3d24071ee2877ffeffbdff86dbb1ba1);public function exportToFile($v47826cacc65c665212b821e6ff80b9b0);public static function autoExport(selector $v8be74552df93e31bbdd6b36ed74bdb6a, $vb8c8ec69026adfe891bf5e618eabb17b = false);};class quickCsvExporter implements iQuickCsvExporter {protected   $sel,   $filepath,   $fileHandler,   $resultsMode = "element",   $fields = array(),   $foundFields = array(),   $objectTypes = array();const columnSeparator = ";";public function __construct(selector $v8be74552df93e31bbdd6b36ed74bdb6a) {$vcf9f8edd116e66068dfac6911bd99e56 = $v8be74552df93e31bbdd6b36ed74bdb6a;$vcf9f8edd116e66068dfac6911bd99e56->limit(0, 1000000);$this->sel = $vcf9f8edd116e66068dfac6911bd99e56;}public function setResultsMode($vc3d24071ee2877ffeffbdff86dbb1ba1) {if(in_array($vc3d24071ee2877ffeffbdff86dbb1ba1, Array('object', 'element'))) {$this->resultsMode = $vc3d24071ee2877ffeffbdff86dbb1ba1;return true;}else {return false;}}public function exportToFile($v6a2a431fe8b621037ea949531c28551d) {if($this->checkFilePath($v6a2a431fe8b621037ea949531c28551d)) {touch($v6a2a431fe8b621037ea949531c28551d);$this->filepath = realpath($v6a2a431fe8b621037ea949531c28551d);}else {throw new coreException("Can't access store file \"{$v6a2a431fe8b621037ea949531c28551d}\"");}$vd0e4d9e29d18ca7e07f55215f7cdc09a = $this->getSelectionResults();$this->exportResults($vd0e4d9e29d18ca7e07f55215f7cdc09a);return new umiFile($v6a2a431fe8b621037ea949531c28551d);}public function setObjectTypeId($v6301cee35ea764a1e241978f93f01069) {$v726e8e4809d4c1b28a6549d86436a124 = umiObjectTypesCollection::getInstance()->getType($v6301cee35ea764a1e241978f93f01069);if($v726e8e4809d4c1b28a6549d86436a124 instanceof umiObjectType) {$this->objectTypes[] = $v726e8e4809d4c1b28a6549d86436a124;}else {throw new coreException("Object type #{$v6301cee35ea764a1e241978f93f01069} doesn't exists");}}public function setUsedFields($vd05b6ed7d2345020440df396d6da7f73) {if(is_array($vd05b6ed7d2345020440df396d6da7f73)) {$this->fields = $vd05b6ed7d2345020440df396d6da7f73;return true;}else {return false;}}public static function autoExport(selector $v8be74552df93e31bbdd6b36ed74bdb6a, $vb8c8ec69026adfe891bf5e618eabb17b = false) {$v4aed429835809b0214b31d7ff74f05ba = new quickCsvExporter($v8be74552df93e31bbdd6b36ed74bdb6a);$v0e8133eb006c0f85ed9444ae07a60842 = umiObjectTypesCollection::getInstance();foreach($v8be74552df93e31bbdd6b36ed74bdb6a->types as $v599dcce2998a6b40b1e38e8c6006cb0a) {if(is_null($v599dcce2998a6b40b1e38e8c6006cb0a->objectType) == false) {$v6301cee35ea764a1e241978f93f01069 = $v599dcce2998a6b40b1e38e8c6006cb0a->objectType->getId();$v4aed429835809b0214b31d7ff74f05ba->setObjectTypeId($v6301cee35ea764a1e241978f93f01069);}if(is_null($v599dcce2998a6b40b1e38e8c6006cb0a->hierarchyType) == false) {$vacf567c9c3d6cf7c6e2cc0ce108e0631 = $v599dcce2998a6b40b1e38e8c6006cb0a->hierarchyType->getId();$v6301cee35ea764a1e241978f93f01069 = $v0e8133eb006c0f85ed9444ae07a60842->getTypeByHierarchyTypeId($vacf567c9c3d6cf7c6e2cc0ce108e0631);$v4aed429835809b0214b31d7ff74f05ba->setObjectTypeId($v6301cee35ea764a1e241978f93f01069);}}if($v8be74552df93e31bbdd6b36ed74bdb6a->hierarchy || $vb8c8ec69026adfe891bf5e618eabb17b) {$v4aed429835809b0214b31d7ff74f05ba->setResultsMode("element");}else {$v4aed429835809b0214b31d7ff74f05ba->setResultsMode("object");}$v52a43e48ec4649dee819dadabcab1bde = cmsController::getInstance()->getCurrentModule();$v2245023265ae4cf87d02c8b6ba991139 = mainConfiguration::getInstance();$v435ed7e9f07f740abf511a62c00eef6e = ($v52a43e48ec4649dee819dadabcab1bde) ? $v52a43e48ec4649dee819dadabcab1bde . "-" . date("Y-m-d_H.i.s") : "csv-export-" . uniqid();$vedcf819b71ce7a0689cd83e44f16b702 = $v2245023265ae4cf87d02c8b6ba991139->includeParam('system.runtime-cache') . $v435ed7e9f07f740abf511a62c00eef6e . ".csv";$v4aed429835809b0214b31d7ff74f05ba->setUsedFields(getRequest('used-fields'));$v4aed429835809b0214b31d7ff74f05ba->exportToFile($vedcf819b71ce7a0689cd83e44f16b702);$v8c7dd922ad47494fc02c388e12c00eac = new umiFile($vedcf819b71ce7a0689cd83e44f16b702);$v8c7dd922ad47494fc02c388e12c00eac->download(true);}protected function checkFilePath($v6a2a431fe8b621037ea949531c28551d) {if(is_file($v6a2a431fe8b621037ea949531c28551d)) {return is_writable($v6a2a431fe8b621037ea949531c28551d);}else {$v954eef6d6eac59aca304b6d7abb4fb3e = dirname($v6a2a431fe8b621037ea949531c28551d);if(is_dir($v954eef6d6eac59aca304b6d7abb4fb3e)) {return is_writable($v954eef6d6eac59aca304b6d7abb4fb3e);}else {return false;}}}protected function getSelectionResults() {return $this->sel->result;}protected function exportResults($v53e61336bb49ec978968786b07dea50b) {$v8d777f385d3dfec8815d20f7496026dc = array();if($this->resultsMode == "object") {$v5891da2d64975cae48d175d1e001f5da = umiObjectsCollection::getInstance();foreach($v53e61336bb49ec978968786b07dea50b as $va8cfde6331bd59eb2ac96f8911c4b666) {$v8d777f385d3dfec8815d20f7496026dc[] = $this->storeObjectData($va8cfde6331bd59eb2ac96f8911c4b666);$v5891da2d64975cae48d175d1e001f5da->unloadObject($va8cfde6331bd59eb2ac96f8911c4b666->id);}}if($this->resultsMode == "element") {$vb81ca7c0ccaa77e7aa91936ab0070695 = umiHierarchy::getInstance();foreach($v53e61336bb49ec978968786b07dea50b as $v8e2dcfd7e7e24b1ca76c1193f645902b) {$v8d777f385d3dfec8815d20f7496026dc[] = $this->storeElementData($v8e2dcfd7e7e24b1ca76c1193f645902b);$vb81ca7c0ccaa77e7aa91936ab0070695->unloadElement($v8e2dcfd7e7e24b1ca76c1193f645902b->id);}}$this->openFile();$this->writeHeader();foreach($v8d777f385d3dfec8815d20f7496026dc as $vf1965a857bc285d26fe22023aa5ab50d) {foreach($vf1965a857bc285d26fe22023aa5ab50d as $v972bf3f05d14ffbdb817bef60638ff00 => $v1afd32818d1c9525f82aff4c09efd254) {if(!is_numeric($v972bf3f05d14ffbdb817bef60638ff00) && !in_array($v972bf3f05d14ffbdb817bef60638ff00, $this->foundFields)) {unset($vf1965a857bc285d26fe22023aa5ab50d[$v972bf3f05d14ffbdb817bef60638ff00]);}}$this->writeFileLine($vf1965a857bc285d26fe22023aa5ab50d);}$this->closeFile();}protected function openFile() {$this->fileHandler = fopen($this->filepath, "w");}protected function writeHeader() {$v8d777f385d3dfec8815d20f7496026dc = Array(    Array('string', 'Id'),    Array('string', getLabel('label-name'))   );$vd14a8022b085f9ef19d479cbdd581127 = $this->objectTypes;$v8797e64b0b663bbad43134e3003a4ef4 = umiFieldsCollection::getInstance();$v0e8133eb006c0f85ed9444ae07a60842 = umiObjectTypesCollection::getInstance();$vb7c425be9cc8b8cd2f514126b634bf33 = Array();foreach($vd14a8022b085f9ef19d479cbdd581127 as $v726e8e4809d4c1b28a6549d86436a124) {$v6301cee35ea764a1e241978f93f01069 = $v726e8e4809d4c1b28a6549d86436a124->getId();$vb7c425be9cc8b8cd2f514126b634bf33 += $v0e8133eb006c0f85ed9444ae07a60842->getChildClasses($v6301cee35ea764a1e241978f93f01069);$vb7c425be9cc8b8cd2f514126b634bf33[] = $v6301cee35ea764a1e241978f93f01069;}$v220aa887e031ffda4e634a5584f939bc = Array();foreach($this->fields as $v972bf3f05d14ffbdb817bef60638ff00) {if(!in_array($v972bf3f05d14ffbdb817bef60638ff00, $this->foundFields)) continue;$v6d58e323dd91f19ec80d313941942f94 = $v972bf3f05d14ffbdb817bef60638ff00;foreach($vb7c425be9cc8b8cd2f514126b634bf33 as $v6301cee35ea764a1e241978f93f01069) {$v599dcce2998a6b40b1e38e8c6006cb0a = $v0e8133eb006c0f85ed9444ae07a60842->getType($v6301cee35ea764a1e241978f93f01069);if($v599dcce2998a6b40b1e38e8c6006cb0a instanceof iUmiObjectType) {if($v945100186b119048837b9859c2c46410 = $v599dcce2998a6b40b1e38e8c6006cb0a->getFieldId($v972bf3f05d14ffbdb817bef60638ff00)) {$v06e3d36fa30cea095545139854ad1fb9 = $v8797e64b0b663bbad43134e3003a4ef4->getField($v945100186b119048837b9859c2c46410);if($v06e3d36fa30cea095545139854ad1fb9 instanceof iUmiField) {$v6d58e323dd91f19ec80d313941942f94 = $v06e3d36fa30cea095545139854ad1fb9->getTitle();break;}}}}$v220aa887e031ffda4e634a5584f939bc[] = $v6d58e323dd91f19ec80d313941942f94;}if($this->resultsMode == "element") {$v8d777f385d3dfec8815d20f7496026dc[] = array('string', getLabel('label-alt-name'));$v8d777f385d3dfec8815d20f7496026dc[] = array('string', getLabel('field-is_active'));}foreach($v220aa887e031ffda4e634a5584f939bc as $v6d58e323dd91f19ec80d313941942f94) {$v8d777f385d3dfec8815d20f7496026dc[] = array('string', $v6d58e323dd91f19ec80d313941942f94);}$this->writeFileLine($v8d777f385d3dfec8815d20f7496026dc);}protected function writeFileLine($v8d777f385d3dfec8815d20f7496026dc) {$v341be97d9aff90c9978347f66f945b77 = "";foreach($v8d777f385d3dfec8815d20f7496026dc as $v972bf3f05d14ffbdb817bef60638ff00 => $v5f8c1f469bff67574591cee469f4d37f) {if(is_array($v5f8c1f469bff67574591cee469f4d37f)) {$v341be97d9aff90c9978347f66f945b77 .= $this->prepareCsvColumn($v5f8c1f469bff67574591cee469f4d37f[0], $v5f8c1f469bff67574591cee469f4d37f[1]);}$v341be97d9aff90c9978347f66f945b77 .= self::columnSeparator;}$v341be97d9aff90c9978347f66f945b77 .= "\n";fwrite($this->fileHandler, $v341be97d9aff90c9978347f66f945b77);}protected function prepareCsvColumn($v870b60148237c1452dfb337fdd19c314, $v2063c1608d6e0baf80249c42e2be5804) {switch($v870b60148237c1452dfb337fdd19c314) {case "relation": {$v2063c1608d6e0baf80249c42e2be5804 = $this->getRelationValue($v2063c1608d6e0baf80249c42e2be5804);break;}case "tags": {$v2063c1608d6e0baf80249c42e2be5804 = implode(", ", $v2063c1608d6e0baf80249c42e2be5804);break;}case "date": {if($v2063c1608d6e0baf80249c42e2be5804 instanceof umiDate) {$v2063c1608d6e0baf80249c42e2be5804 = $v2063c1608d6e0baf80249c42e2be5804->getFormattedDate("Y-m-d H:i");}break;}}$vd98a07f84921b24ee30f86fd8cd85c3c = Array('\n', ';', '"');$v01b6e20344b68835c5ed1ddedf20d531 = Array('\\n', '\;', '""');$v2063c1608d6e0baf80249c42e2be5804 = str_replace($vd98a07f84921b24ee30f86fd8cd85c3c, $v01b6e20344b68835c5ed1ddedf20d531, $v2063c1608d6e0baf80249c42e2be5804);if(!is_numeric($v2063c1608d6e0baf80249c42e2be5804)) {$v2063c1608d6e0baf80249c42e2be5804 = iconv("UTF-8", "CP1251", $v2063c1608d6e0baf80249c42e2be5804);$v2063c1608d6e0baf80249c42e2be5804 = '"' . $v2063c1608d6e0baf80249c42e2be5804 . '"';}return $v2063c1608d6e0baf80249c42e2be5804;}protected function closeFile() {fclose($this->fileHandler);}protected function getObject($v59a814aa020a1b32c4674a5887a35022) {$v5891da2d64975cae48d175d1e001f5da = umiObjectsCollection::getInstance();switch($this->resultsMode) {case "object": {return $v5891da2d64975cae48d175d1e001f5da->getObject($v59a814aa020a1b32c4674a5887a35022);break;}case "element": {$vb81ca7c0ccaa77e7aa91936ab0070695 =  umiHierarchy::getInstance();$v8e2dcfd7e7e24b1ca76c1193f645902b = $vb81ca7c0ccaa77e7aa91936ab0070695->getElement($v59a814aa020a1b32c4674a5887a35022);if($v8e2dcfd7e7e24b1ca76c1193f645902b instanceof umiHierarchyElement) {return $v8e2dcfd7e7e24b1ca76c1193f645902b;}else {return false;}break;}default: {throw new coreException("Unknown results type \"{$this->resultsMode}\"");}}}protected function storeObjectData(umiObject $va8cfde6331bd59eb2ac96f8911c4b666) {$v8d777f385d3dfec8815d20f7496026dc = array(    array("int", $va8cfde6331bd59eb2ac96f8911c4b666->getId()),    array("string", $va8cfde6331bd59eb2ac96f8911c4b666->getName())   );foreach($this->fields as $v972bf3f05d14ffbdb817bef60638ff00) {$v23a5b8ab834cb5140fa6665622eb6417 = $va8cfde6331bd59eb2ac96f8911c4b666->getPropByName($v972bf3f05d14ffbdb817bef60638ff00);if($v23a5b8ab834cb5140fa6665622eb6417 instanceof umiObjectProperty) {$v870b60148237c1452dfb337fdd19c314 = $v23a5b8ab834cb5140fa6665622eb6417->getDataType();$v2063c1608d6e0baf80249c42e2be5804 = $va8cfde6331bd59eb2ac96f8911c4b666->getValue($v972bf3f05d14ffbdb817bef60638ff00);$v8d777f385d3dfec8815d20f7496026dc[$v972bf3f05d14ffbdb817bef60638ff00] = array($v870b60148237c1452dfb337fdd19c314, $v2063c1608d6e0baf80249c42e2be5804);if(!in_array($v972bf3f05d14ffbdb817bef60638ff00, $this->foundFields)) {$this->foundFields[] = $v972bf3f05d14ffbdb817bef60638ff00;}}else {$v8d777f385d3dfec8815d20f7496026dc[$v972bf3f05d14ffbdb817bef60638ff00] = NULL;}}return $v8d777f385d3dfec8815d20f7496026dc;}protected function storeElementData(umiHierarchyElement $v8e2dcfd7e7e24b1ca76c1193f645902b) {$v8d777f385d3dfec8815d20f7496026dc = array(    array("int", $v8e2dcfd7e7e24b1ca76c1193f645902b->getId()),    array("string", $v8e2dcfd7e7e24b1ca76c1193f645902b->getName()),    array("string", $v8e2dcfd7e7e24b1ca76c1193f645902b->getAltName()),    array("int", $v8e2dcfd7e7e24b1ca76c1193f645902b->getIsActive())   );$va8cfde6331bd59eb2ac96f8911c4b666 = $v8e2dcfd7e7e24b1ca76c1193f645902b->getObject();foreach($this->fields as $v972bf3f05d14ffbdb817bef60638ff00) {$v23a5b8ab834cb5140fa6665622eb6417 = $va8cfde6331bd59eb2ac96f8911c4b666->getPropByName($v972bf3f05d14ffbdb817bef60638ff00);if($v23a5b8ab834cb5140fa6665622eb6417 instanceof umiObjectProperty) {$v870b60148237c1452dfb337fdd19c314 = $v23a5b8ab834cb5140fa6665622eb6417->getDataType();$v2063c1608d6e0baf80249c42e2be5804 = $va8cfde6331bd59eb2ac96f8911c4b666->getValue($v972bf3f05d14ffbdb817bef60638ff00);$v8d777f385d3dfec8815d20f7496026dc[] = Array($v870b60148237c1452dfb337fdd19c314, $v2063c1608d6e0baf80249c42e2be5804);if(!in_array($v972bf3f05d14ffbdb817bef60638ff00, $this->foundFields)) {$this->foundFields[] = $v972bf3f05d14ffbdb817bef60638ff00;}}else {$v8d777f385d3dfec8815d20f7496026dc[] = NULL;}}return $v8d777f385d3dfec8815d20f7496026dc;}protected function getRelationValue($v2063c1608d6e0baf80249c42e2be5804) {$v5891da2d64975cae48d175d1e001f5da = umiObjectsCollection::getInstance();if(is_array($v2063c1608d6e0baf80249c42e2be5804)) {$vfa816edb83e95bf0c8da580bdfd491ef = Array();foreach($v2063c1608d6e0baf80249c42e2be5804 as $v16b2b26000987faccb260b9d39df1269) {$va8cfde6331bd59eb2ac96f8911c4b666 = $v5891da2d64975cae48d175d1e001f5da->getObject($v16b2b26000987faccb260b9d39df1269);if($va8cfde6331bd59eb2ac96f8911c4b666 instanceof umiObject) {$vfa816edb83e95bf0c8da580bdfd491ef[] = $va8cfde6331bd59eb2ac96f8911c4b666->getName();}}return implode(", ", $vfa816edb83e95bf0c8da580bdfd491ef);}else if(is_numeric($v2063c1608d6e0baf80249c42e2be5804)) {$va8cfde6331bd59eb2ac96f8911c4b666 = $v5891da2d64975cae48d175d1e001f5da->getObject($v2063c1608d6e0baf80249c42e2be5804);if($va8cfde6331bd59eb2ac96f8911c4b666 instanceof umiObject) {return $va8cfde6331bd59eb2ac96f8911c4b666->getName();}else {return false;}}else {return false;}}};?>